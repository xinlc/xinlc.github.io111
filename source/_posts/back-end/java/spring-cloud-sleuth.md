---
title: å¾®æœåŠ¡æ¶æ„ä¹‹è°ƒç”¨é“¾ç›‘æ§ï¼šSpring Cloud Sleuth & CAT & Skywalking
date: 2020-03-21 13:30:00
categories: Java
tags:
  - MicroServices
  - SpringCloud
---

éšç€ç³»ç»Ÿè§„æ¨¡è¶Šæ¥è¶Šåºå¤§ï¼ŒæœåŠ¡æ•°ç›®å¢åŠ ï¼Œå„ä¸ªæœåŠ¡é—´çš„è°ƒç”¨å…³ç³»ä¹Ÿå˜å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚å½“å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œè¿™ä¸ªè¯·æ±‚ç»è¿‡å¤šä¸ªæœåŠ¡åï¼Œæœ€ç»ˆè¿”å›äº†ç»“æœï¼Œç»è¿‡çš„æ¯ä¸€ä¸ªæœåŠ¡éƒ½æœ‰å¯èƒ½å‘ç”Ÿå»¶è¿Ÿæˆ–é”™è¯¯ï¼Œä»è€Œå¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦è¯·æ±‚é“¾è·¯è·Ÿè¸ªå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬ï¼Œç†æ¸…è¯·æ±‚è°ƒç”¨çš„æœåŠ¡é“¾è·¯ï¼Œè§£å†³é—®é¢˜ã€‚

<!--more-->

## è°ƒç”¨é“¾ç›‘æ§ä¸šåŠ¡éœ€æ±‚

åœ¨å¾®æœåŠ¡æ—¶ä»£ï¼Œå†…éƒ¨ç³»ç»Ÿåº”ç”¨éƒ½æ˜¯åˆ†å¸ƒå¼çš„å¯èƒ½æœ‰å‡ åç”šè‡³ä¸Šç™¾ä¸ªæœåŠ¡ï¼ŒæœåŠ¡é—´çš„è°ƒç”¨ä¼šå½¢æˆå¤æ‚çš„ç½‘çŠ¶ç»“æ„ï¼Œå¦‚æœæ²¡æœ‰ç›‘æ§æ‰‹æ®µä¸€æ—¦å‡ºç°é—®é¢˜å¾ˆéš¾å®šä½ã€‚è°ƒç”¨é“¾ç›‘æ§ä¸€æ–¹é¢å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½é”™è¯¯é—®é¢˜å’Œæ€§èƒ½é—®é¢˜ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ¯”è¾ƒå…¨é¢çš„ç†è§£æ•´ä¸ªç³»ç»Ÿçš„å¾®æœåŠ¡ä½“ç³»ã€‚

åº”ç”¨ç›‘æ§ç¼ºå¤±é€ æˆçš„å‘ï¼š

- çº¿ä¸Šå‘å¸ƒäº†æœåŠ¡ï¼Œæ€ä¹ˆçŸ¥é“ä¸€åˆ‡æ­£å¸¸ï¼Ÿ
- å¤§é‡æŠ¥é”™ï¼Œåˆ°åº•å“ªé‡Œäº§ç”Ÿçš„ï¼Œè°æ‰æ˜¯æ ¹å› ï¼Ÿ
- äººå·¥é…ç½®é”™è¯¯ï¼Œé€šå®µæ’é”™ï¼ŒåŠ³æ°‘ä¼¤è´¢ï¼
- åº”ç”¨ç¨‹åºæœ‰æ€§èƒ½é—®é¢˜ï¼Œæ€ä¹ˆå°½æ—©å‘ç°é—®é¢˜ï¼Ÿ
- æ•°æ®åº“é—®é¢˜ï¼Œåœ¨å‡ºé—®é¢˜ä¹‹å‰èƒ½æ´å¯Ÿå—ï¼Ÿ
- â€œç½‘ç»œé—®é¢˜â€æˆä¸ºâ€œæœ€å¥½å€Ÿå£â€ï¼Œè¿ç»´å¦‚ä½•åå‡»ï¼Ÿ
- ä»»ä½•å¯èƒ½å‡ºé—®é¢˜çš„åœ°æ–¹éƒ½ä¼šå‡ºé”™ï¼ï¼ï¼(åº·å¨å®šå¾‹)
- å¾®æœåŠ¡éœ€è¦åº”ç”¨ç›‘æ§ï¼ï¼ï¼

DevOps å®è·µï¼š

- è¦æå‡å¿…å…ˆæµ‹é‡ï¼šç»™å¼€å‘äººå‘˜ä¸€æŠŠæµ‹é‡åé¦ˆâ€œå°ºâ€ï¼›
- ç ”å‘è‡ªåŠ©ç›‘æ§ï¼šYou build it, you run it, you monitor it.

## è°ƒç”¨é“¾ç›‘æ§åŸç†

### Google Dapper è®ºæ–‡

è°ˆåˆ°è°ƒç”¨é“¾ç›‘æ§å°±ä¸å¾—ä¸æ Google Dapper è®ºæ–‡ï¼ŒGoogle åœ¨2010å¹´ä¹‹å‰å°±ç ”å‘äº† Dapper åˆ†å¸ƒå¼è°ƒç”¨é“¾ç›‘æ§ç³»ç»Ÿï¼Œåœ¨ Google å†…éƒ¨æœ‰å¤§è§„æ¨¡çš„åº”ç”¨ï¼Œåœ¨2010å¹´çš„æ—¶å€™ Google æŠŠ Dapper çš„ç»éªŒæ€»ç»“å‡ºæ¥å†™æˆäº† [è®ºæ–‡ ã€ŠDapper, a Large-Scale Distributed Systems Tracing Infrastructureã€‹](http://research.google.com/pubs/archive/36356.pdf)ã€‚åæ¥ç¤¾åŒºä¸­å¾ˆå¤šåŸºäº Dapper çš„è®ºæ–‡å®ç°äº†è°ƒç”¨é“¾ç›‘æ§æ¯”å¦‚ Zipkinã€‚

Dapper Deploymentï¼š

![1][1]

Dapper è®ºæ–‡é‡Œè®²è§£äº†å®ƒå†…éƒ¨å‘å¸ƒçš„æ¶æ„å¦‚ä¸Šå›¾ã€‚Google çš„ç”Ÿäº§æœºå™¨ä¸Šé¢éƒ½ä¼šå®‰è£… Dapper daemon ç»„ä»¶ï¼Œåº”ç”¨ç¨‹åºä¼šä½¿ç”¨ Dapper åŸ‹ç‚¹è¿‡çš„åº“ï¼Œåº”ç”¨ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™å°±ä¼šæŠŠè°ƒç”¨é“¾å†™åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼ŒDapper daemon å°±ä¼šå®šæœŸåˆ°æ—¥å¿—æ–‡ä»¶ä¸­æŠŠè°ƒç”¨é“¾æŠ“å–å‡ºæ¥å‘é€åˆ°åç«¯ Dapper Collectors é›†ç¾¤ã€‚è°ƒç”¨é“¾æœ€ç»ˆå­˜å‚¨åˆ° Bigtable ä¸­ï¼ŒåæœŸå°±å¯ä»¥å» Bigtable ä¸­æŸ¥è¯¢è°ƒç”¨é“¾ä¿¡æ¯ã€‚

Dapper UIï¼š

![2][2]

å¼€å‘äººå‘˜å°±å¯ä»¥é€šè¿‡ Dapper UI æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨é“¾æƒ…å†µã€‚

### è°ƒç”¨é“¾æ ¸å¿ƒæ¦‚å¿µ

![3][3]

ç”¨æˆ·çš„ä¸€ä¸ªè¯·æ±‚è°ƒç”¨äº† Service1 è¿›æ¥çš„è¯·æ±‚å’Œå‡ºå»çš„å“åº”ï¼ˆæ©™è‰²æ ‡æ³¨çš„ï¼‰å«ä¸€ä¸ª Spanï¼ˆsidï¼‰ï¼Œ Service1 å»è°ƒç”¨äº† Redis è¿›æ¥å’Œå›å»ä¹Ÿå«ä¸€ä¸ª Spanï¼ŒService1 åˆè°ƒç”¨äº† Service2 åˆäº§ç”Ÿäº†ä¸€ä¸ª Spanï¼Œä»»ä½•ä¸€æ¬¡è°ƒç”¨éƒ½ä¼šäº§ç”Ÿ Spanï¼Œè¿™ä¸€æ•´ä¸ªè°ƒç”¨å«ä¸€ä¸ª Traceï¼ˆtidï¼‰ï¼Œå…¶ä¸­ ParentIdï¼ˆpidï¼‰æ˜¯æ ‡è¯†çˆ¶å­å…³ç³»æŒ‡å‘ sidã€‚

- Traceï¼šä¸€æ¬¡åˆ†å¸ƒå¼è°ƒç”¨çš„é“¾è·¯è¸ªè¿¹ï¼›
- Spanï¼šä¸€ä¸ªæ–¹æ³•ï¼ˆå±€éƒ¨æˆ–è¿œç¨‹ï¼‰è°ƒç”¨è¸ªè¿¹ï¼›
- Annotationï¼šé™„ç€åœ¨ Spane ä¸Šçš„æ—¥å¿—ä¿¡æ¯ï¼›
- Samplingï¼šé‡‡æ ·ç‡ï¼ˆ0-1ï¼Œ1æ˜¯å…¨é‡‡æ ·ï¼‰ï¼›

## è°ƒç”¨é“¾ç›‘æ§äº§å“æ¼”è¿›å†å²

![4][4]

2002 å¹´ eBay å†…éƒ¨æ¯”è¾ƒæ—©å°±ä½¿ç”¨äº†è°ƒç”¨é“¾ç›‘æ§äº§å“å«CALï¼ˆCentralized Application Loggingï¼‰ã€‚

è¿™ä¸ªæ—¶é—´ Google å†…éƒ¨ä¹Ÿç ”å‘äº† Dapperï¼Œ2010å¹´ Google è™½æ²¡æœ‰å¼€æº Dapper ä½†æ˜¯å‘è¡¨äº† Dapper è®¾è®¡çš„è®ºæ–‡ï¼Œè¿™ç¯‡è®ºæ–‡å¯ä»¥è¯´æ˜¯ç°ä»£è°ƒç”¨é“¾ç›‘æ§çš„é¼»ç¥–ã€‚

2011å¹´å‰ eBay æ¶æ„å¸ˆå´å…¶æ•æ¥åˆ°å¤§ä¼—ç‚¹è¯„ï¼Œä¸»å¯¼äº†ç‚¹è¯„çš„è°ƒç”¨é“¾ç³»ç»Ÿ CATï¼ˆCentralized Application Trackingï¼‰çš„ç ”å‘ï¼Œå´å…¶æ•åœ¨ eBayå·¥ä½œé•¿è¾¾åå‡ å¹´ï¼Œå¯¹ CAL ç³»ç»Ÿæœ‰æ·±åˆ»çš„ç†è§£ï¼ŒCAT ä¸ä»…å¢å¼ºäº† CAL ç³»ç»Ÿæ ¸å¿ƒæ¨¡å‹ï¼Œè¿˜æ·»åŠ äº†æ›´ä¸°å¯Œçš„æŠ¥è¡¨ã€‚2014å¹´åœ¨ç¤¾åŒºå¼€æºã€‚

2012å¹´ Twitter å‚è€ƒäº† Google Dapper è®ºæ–‡ç ”å‘äº† Zipkin è°ƒç”¨é“¾äº§å“å¹¶å¼€æºã€‚åŒå¹´ä¸€å®¶éŸ©å›½å…¬å¸ä¹Ÿå‚è€ƒäº† Dapper è®ºæ–‡ ç ”å‘äº† Pinpoint ç›‘æ§äº§å“å¹¶å¼€æºï¼Œè¿™ä¸ªäº§å“ç‹¬æ ‘ä¸€å¸œé‡‡ç”¨å­—èŠ‚ç æ³¨å…¥æ— ä¾µå…¥çš„æ–¹å¼ã€‚

2015å¹´å·¥ç¨‹å¸ˆå´æ™Ÿå¼€å‘äº† Skywalking å¹¶å€Ÿé‰´äº† Pinpoint æ€è·¯ä¹Ÿé‡‡ç”¨å­—èŠ‚ç æ³¨å…¥æ–¹å¼ã€‚åæ¥ä»–åŠ å…¥äº†åä¸ºå¹¶æŠŠè¿™ä¸ªäº§å“æ¨èåˆ°äº† Apache å­µåŒ–å™¨ï¼Œç°åœ¨å·²ç»æˆä¸º Apache é¡¶çº§é¡¹ç›®ã€‚

2016å¹´Uberå…¬å¸å€Ÿé‰´äº† Zipkin ä½¿ç”¨ Golang ç ”å‘äº† Jaegerï¼Œç°åœ¨æ˜¯ CNCF ç»„ç»‡æ¨èçš„äº‘åŸç”Ÿäº§å“ã€‚

## Zipkin ç®€ä»‹

Zipkin æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç åˆ†å¸ƒå¼çš„è·Ÿè¸ªç³»ç»Ÿï¼Œç”± Twitter å…¬å¸å¼€æºï¼Œå®ƒè‡´åŠ›äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ï¼ŒåŒ…æ‹¬æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ï¼ŒZipkin çš„è®¾è®¡æ˜¯åŸºäºè°·æ­Œçš„ Google Dapper è®ºæ–‡ã€‚

![5][5]

Zipkin çš„æœåŠ¡ç«¯å·²ç»æ‰“åŒ…æˆäº†ä¸€ä¸ª jarï¼Œä½¿ç”¨ java -jar zipkin-server.jar å¯åŠ¨ï¼Œè®¿é—® http://localhost:9411 æŸ¥çœ‹ zipkin ä¸»é¡µã€‚

![6][6]

å¯ä»¥ç”¨ docker æˆ– jar æ–¹å¼è¿è¡Œ Zipkinï¼š

```bash
docker run -d -p 9411:9411 openzipkin/zipkin

# https://repo1.maven.org/maven2/io/zipkin/zipkin-server/2.20.2/zipkin-server-2.20.2-exec.jar
curl -sSL https://zipkin.io/quickstart.sh | bash -s
java -jar zipkin.jar
```

## Spring Cloud Sleuth ç®€ä»‹

Spring Cloud Sleuth å¯ä»¥ç†è§£ä¸ºæ˜¯ Zipkin çš„å®¢æˆ·ç«¯ã€‚Zipkin æ”¶é›† Sleuth äº§ç”Ÿçš„æ•°æ®ï¼Œå¹¶ä»¥ç•Œé¢çš„å½¢å¼å‘ˆç°å‡ºæ¥ã€‚

- Spring Cloud å°è£…çš„ Zipkin å…¼å®¹å®¢æˆ·ç«¯ Tracer
- æ·»åŠ  traceId å’Œ spanId åˆ° Slf4J MDC
- æ”¯æŒåŸ‹ç‚¹çš„åº“
  - Hystrix
  - RestTemplate
  - Feign
  - Messaging with Spring Integration
  - Zuul
  - ...
- æ”¯æŒé‡‡æ ·ç­–ç•¥
- è€ç‰ˆæœ¬åŸºäº HTraceï¼Œæœ€æ–°ç‰ˆæœ¬åŸºäº Brave
- ä¾èµ–
  - spring-cloud-sleuth-zipkin
  - spring-cloud-sleuth-stream

### Sleuth é›†æˆæ¶æ„

![7][7]

Spring Cloud çš„ç»„ä»¶å¤§éƒ¨åˆ†éƒ½è¿›è¡Œäº†åŸ‹ç‚¹ï¼Œåªè¦è¿›å…¥ç›¸å…³çš„ starter å°±å¯ä»¥è¿›è¡Œç›‘æ§ã€‚æ—¥å¿—çš„ä¼ é€å¯ä»¥å‘é€åˆ° MQ ä¸­æˆ–ç›´æ¥ç”¨ Http å‘é€åˆ° Zipkin æœåŠ¡ç«¯ï¼Œå­˜å‚¨å¯ä»¥ç”¨ Elasticsearchã€‚

## ç¯å¢ƒ

- JDKï¼š1.8
- Spring Bootï¼š2.2.4.RELEASE
- Spring Cloudï¼šHoxton.SR1

## ç»™æœåŠ¡æ·»åŠ è¯·æ±‚é“¾è·¯è·Ÿè¸ª

æ·»åŠ ä¾èµ–ï¼š

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-zipkin</artifactId>
</dependency>
```

ä¿®æ”¹ application.yml æ–‡ä»¶ï¼Œé…ç½®æ”¶é›†æ—¥å¿—çš„ zipkin-server è®¿é—®åœ°å€ï¼š

```yaml
spring:
  zipkin:
    base-url: http://localhost:9411
  sleuth:
    web:
      enabled: true
    sampler:
      probability: 0.1 # è®¾ç½® Sleuth çš„æŠ½æ ·æ”¶é›†æ¦‚ç‡
```

èµ·ä¸¤ä¸ªæœåŠ¡å¹¶ç”¨ Service1 ç”¨ RestTemplate è°ƒç”¨ Service 2ï¼Œç„¶ååœ¨ Zipkin ä¸ŠæŸ¥çœ‹è°ƒç”¨é“¾ä¿¡æ¯ã€‚

### ä½¿ç”¨ Elasticsearch å­˜å‚¨è·Ÿè¸ªä¿¡æ¯

å¦‚æœæŠŠ Zipkin é‡å¯ä¸€ä¸‹å°±ä¼šå‘ç°åˆšåˆšçš„å­˜å‚¨çš„è·Ÿè¸ªä¿¡æ¯å…¨éƒ¨ä¸¢å¤±äº†ï¼Œå¯è§å…¶æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œä¸€èˆ¬ä¼šå­˜å‚¨åˆ° Elasticsearch ä¸­ã€‚[ä¸‹è½½ ES](https://www.elastic.co/cn/downloads/elasticsearch/)

```bash
# å¯åŠ¨ ES å•èŠ‚ç‚¹
bin/elasticsearch -E node.name=node0 -E cluster.name=zk -E path.data=node0_data

# STORAGE_TYPEï¼šè¡¨ç¤ºå­˜å‚¨ç±»å‹ ES_HOSTSï¼šè¡¨ç¤ºESçš„è®¿é—®åœ°å€
java -jar zipkin.jar --STORAGE_TYPE=elasticsearch --ES_HOSTS=localhost:9200
```

## CAT ç®€ä»‹

CATæ˜¯å¤§ä¼—ç‚¹è¯„å¼€æºçš„åŸºç¡€ç›‘æ§æ¡†æ¶ï¼Œåœ¨ä¸­é—´ä»¶ï¼ˆMVCæ¡†æ¶ã€RPCæ¡†æ¶ã€æ•°æ®åº“æ¡†æ¶ã€ç¼“å­˜æ¡†æ¶ç­‰ï¼‰å¾—åˆ°å¹¿æ³›åº”ç”¨ï¼Œä¸ºç‚¹è¯„å„ä¸ªä¸šåŠ¡çº¿æä¾›ç³»ç»Ÿçš„æ€§èƒ½æŒ‡æ ‡ã€å¥åº·çŠ¶å†µå’ŒåŸºç¡€å‘Šè­¦ã€‚

- CAT æ˜¯åŸºäº Java å¼€å‘çš„å®æ—¶åº”ç”¨ç›‘æ§å¹³å°ï¼Œä¸ºç¾å›¢ç‚¹è¯„æä¾›äº†å…¨é¢çš„å®æ—¶ç›‘æ§å‘Šè­¦æœåŠ¡ã€‚
- CAT ä½œä¸ºæœåŠ¡ç«¯é¡¹ç›®åŸºç¡€ç»„ä»¶ï¼Œæä¾›äº† Java, C/C++, Node.js, Python, Go ç­‰å¤šè¯­è¨€å®¢æˆ·ç«¯ï¼Œå·²ç»åœ¨ç¾å›¢ç‚¹è¯„çš„åŸºç¡€æ¶æ„ä¸­é—´ä»¶æ¡†æ¶ï¼ˆMVCæ¡†æ¶ï¼ŒRPCæ¡†æ¶ï¼Œæ•°æ®åº“æ¡†æ¶ï¼Œç¼“å­˜æ¡†æ¶ç­‰ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œé…ç½®ç³»ç»Ÿç­‰ï¼‰æ·±åº¦é›†æˆï¼Œä¸ºç¾å›¢ç‚¹è¯„å„ä¸šåŠ¡çº¿æä¾›ç³»ç»Ÿä¸°å¯Œçš„æ€§èƒ½æŒ‡æ ‡ã€å¥åº·çŠ¶å†µã€å®æ—¶å‘Šè­¦ç­‰ã€‚
- CAT å¾ˆå¤§çš„ä¼˜åŠ¿æ˜¯å®ƒæ˜¯ä¸€ä¸ªå®æ—¶ç³»ç»Ÿï¼ŒCAT å¤§éƒ¨åˆ†ç³»ç»Ÿæ˜¯åˆ†é’Ÿçº§ç»Ÿè®¡ï¼Œä½†æ˜¯ä»æ•°æ®ç”Ÿæˆåˆ°æœåŠ¡ç«¯å¤„ç†ç»“æŸæ˜¯ç§’çº§åˆ«ï¼Œç§’çº§å®šä¹‰æ˜¯48åˆ†é’Ÿ40ç§’ï¼ŒåŸºæœ¬ä¸Šçœ‹åˆ°48åˆ†é’Ÿ38ç§’æ•°æ®ï¼Œæ•´ä½“æŠ¥è¡¨çš„ç»Ÿè®¡ç²’åº¦æ˜¯åˆ†é’Ÿçº§ï¼›ç¬¬äºŒä¸ªä¼˜åŠ¿ï¼Œç›‘æ§æ•°æ®æ˜¯å…¨é‡ç»Ÿè®¡ï¼Œå®¢æˆ·ç«¯é¢„è®¡ç®—ï¼›é“¾è·¯æ•°æ®æ˜¯é‡‡æ ·è®¡ç®—ã€‚

CAT äº§å“ä»·å€¼ï¼š

- å‡å°‘æ•…éšœå‘ç°æ—¶é—´
- é™ä½æ•…éšœå®šä½æˆæœ¬
- è¾…åŠ©åº”ç”¨ç¨‹åºä¼˜åŒ–

CAT ä¼˜åŠ¿ï¼š

- å®æ—¶å¤„ç†ï¼šä¿¡æ¯çš„ä»·å€¼ä¼šéšæ—¶é—´é”å‡ï¼Œå°¤å…¶æ˜¯äº‹æ•…å¤„ç†è¿‡ç¨‹ä¸­
- å…¨é‡æ•°æ®ï¼šå…¨é‡é‡‡é›†æŒ‡æ ‡æ•°æ®ï¼Œä¾¿äºæ·±åº¦åˆ†ææ•…éšœæ¡ˆä¾‹
- é«˜å¯ç”¨ï¼šæ•…éšœçš„è¿˜åŸä¸é—®é¢˜å®šä½ï¼Œéœ€è¦é«˜å¯ç”¨ç›‘æ§æ¥æ”¯æ’‘
- æ•…éšœå®¹å¿ï¼šæ•…éšœä¸å½±å“ä¸šåŠ¡æ­£å¸¸è¿è½¬ã€å¯¹ä¸šåŠ¡é€æ˜
- é«˜ååï¼šæµ·é‡ç›‘æ§æ•°æ®çš„æ”¶é›†ï¼Œéœ€è¦é«˜ååèƒ½åŠ›åšä¿è¯
- å¯æ‰©å±•ï¼šæ”¯æŒåˆ†å¸ƒå¼ã€è·¨ IDC éƒ¨ç½²ï¼Œæ¨ªå‘æ‰©å±•çš„ç›‘æ§ç³»ç»Ÿ

### CAT ç›‘æ§åœºæ™¯

CAT ä¸»è¦é’ˆå¯¹ä¸šåŠ¡å±‚å’Œåº”ç”¨å±‚ç›‘æ§ã€‚

![9][9]

### CAT æ¶æ„è®¾è®¡

CATè®¾è®¡ç›®æ ‡ï¼š

- å¯¹åº”ç”¨æ— å½±å“(æœåŠ¡ç«¯ä¸Šä¸‹çº¿ã€å®•æœºç­‰)
- å®æ—¶æ€§(æ¶ˆæ¯å°½å¿«åˆ°è¾¾æœåŠ¡ç«¯)
- ååé‡(æœåŠ¡ç«¯é«˜çš„ååé‡)
- å¼€é”€ä½(å®¢æˆ·ç«¯å°½å¯èƒ½å¼€é”€ä½) (å¼€é”€2%ä»¥å†…)

ä¸æ˜¯CATçš„è®¾è®¡ç›®æ ‡ï¼š

- å¯é æ€§(æ¶ˆæ¯100%åˆ°è¾¾æœåŠ¡ç«¯)
- æœåŠ¡ç«¯100%çš„å¤„ç†åˆ°è¾¾æ¶ˆæ¯

### å®¢æˆ·ç«¯è®¾è®¡

![10][10]

CATæä¾›äº† Clientï¼ŒJava é‡Œå°±æ˜¯ä¸€ä¸ª JAR åŒ…ã€‚å†…éƒ¨åŸºäº ThreadLocal æœºåˆ¶ï¼Œæ¯æ¬¡è°ƒç”¨è¿›æ¥å¼€å§‹é˜¶æ®µå®¢æˆ·ç«¯ä¼šåˆ›å»ºæ¶ˆæ¯æ ‘ä¹‹åçš„è°ƒç”¨éƒ½ä¼šåœ¨è¿™ä¸ªæ•°é‡Œé¢åˆ›å»ºå“åº”çš„ call èŠ‚ç‚¹ï¼Œæ•´ä¸ªè°ƒç”¨ç»“æŸå°±ä¼šæ‰“åŒ…å‘é€åˆ° MQ ä¸­ï¼Œç„¶åä¼šæœ‰ä¸ª Sender å»æ‰«æ MQ å®šæœŸå‘é€åˆ°æœåŠ¡ç«¯ã€‚

> **æ³¨æ„**ï¼šSpring Cloud Gateway ä¸èƒ½ä½¿ç”¨ CATï¼ŒåŸå› æ˜¯ CAT å†…éƒ¨ Context å¯¹è±¡ä½¿ç”¨äº† ThreadLocalï¼Œè€Œ Gateway ä½¿ç”¨å¼‚æ­¥ Nettyï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å‘èµ·çœŸæ­£çš„è¯·æ±‚ä¸‹æ¸¸å‰å’Œåœ¨å¾—åˆ° response åçš„å¤„ç†å·²ç»ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹äº†ã€‚è¿™æ ·å°±ä¼šå¯¼è‡´ä½¿ç”¨ ThreadLocal äº§ç”Ÿä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œå³å‘ç”Ÿçº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚

### æœåŠ¡å™¨ç«¯è®¾è®¡

![11][11]

CAT æœåŠ¡å™¨ç«¯å«æ¶ˆæ¯æ¶ˆè´¹æœºï¼Œæœ‰å¾ˆå¤š Receiver çº¿ç¨‹æ¥å—æ¶ˆæ¯ï¼Œç„¶åä¸¢åˆ°æ¶ˆè´¹æœºçš„é˜Ÿåˆ—ä¸­ï¼Œç„¶åç”±åˆ†æå™¨æ¥è¿›è¡Œåˆ†æèšåˆï¼Œèšåˆå¥½çš„æ•°æ®å­˜å‚¨åˆ° Mysql ä¸­ï¼ŒåŸå§‹çš„æ•°æ®å­˜åˆ° HDFS æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚

### ç›‘æ§æ¨¡å‹

CAT ä¸­çš„å››ç§ç›‘æ§æ¨¡å‹ï¼š

![12][12]

### å‚è€ƒéƒ¨ç½²æ¶æ„

æœ€å°éƒ¨ç½²æ¶æ„ä¸€å°ç‰©ç†æœºå¯ä»¥æ”¯æŒä¸Šåƒä¸ªåº”ç”¨æ¥å…¥ã€‚

![13][13]

Collector å‚è€ƒç¡¬ä»¶è§„æ ¼ï¼š

- å‚è€ƒç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿé…ç½®
  - CPU 32 core
  - Mem 64g
  - 3.6T SASç›˜
  - OS centos7
- å‚è€ƒJVMå†…å­˜è®¾ç½®
  - å»ºè®®ä½¿ç”¨cmsæˆ–g1 gc
  - å»ºè®®CATä½¿ç”¨å †å¤§å°è‡³å°‘10Gä»¥ä¸Š
  - -Xms50g â€“Xmx50g â€“XX:+UseG1GC

### ç”Ÿäº§æ²»ç†å®è·µ

- æ¡†æ¶ç»Ÿä¸€åŸ‹ç‚¹
  - MVC/RPC/Cache/DAL
  - æ—¥å¿—å…³è”TraceId
  - Error logï¼ˆlog4j/logbackï¼‰é›†æˆCat
- æŠ€æœ¯å€º
  - çº¢é»‘æ¦œ
  - Matrix/Crossè°ƒç”¨å’Œä¾èµ–å…³ç³»åˆç†æ€§
  - æ•°æ®åº“N+1é—®é¢˜
- Metric
  - æ¨èä½¿ç”¨ä¸“é—¨æ—¶é—´åºåˆ—æ•°æ®åº“TSDB(KairosDB/InfluxDBç­‰)ä½œä¸ºè¡¥å……
- å‘Šè­¦
  - æ¨èä½¿ç”¨ä¸“é—¨çš„å‘Šè­¦æœåŠ¡(Zmon)ä½œä¸ºè¡¥å……
- é¡¹ç›®å®šæœŸåˆ†ç»„
- å®šæœŸå…³æ³¨StateæŠ¥è¡¨å’ŒHDFSä½¿ç”¨æƒ…å†µ

## APMç³»ç»Ÿæ¦‚è¿°

APM (Application Performance Management) å³åº”ç”¨æ€§èƒ½ç®¡ç†ç³»ç»Ÿï¼Œæ˜¯å¯¹ä¼ä¸šç³»ç»Ÿå³æ—¶ç›‘æ§ä»¥å®ç°ï¼Œå¯¹åº”ç”¨ç¨‹åºæ€§èƒ½ç®¡ç†å’Œæ•…éšœç®¡ç†çš„ç³»ç»ŸåŒ–çš„è§£å†³æ–¹æ¡ˆã€‚åº”ç”¨æ€§èƒ½ç®¡ç†ï¼Œä¸»è¦æŒ‡å¯¹ä¼ä¸šçš„å…³é”®ä¸šåŠ¡åº”ç”¨è¿›ï¼Œè¡Œç›‘æµ‹ã€ä¼˜åŒ–ï¼Œæé«˜ä¼ä¸šåº”ç”¨çš„å¯é æ€§å’Œè´¨é‡ï¼Œä¿è¯ç”¨æˆ·å¾—åˆ°è‰¯å¥½çš„æœåŠ¡ï¼Œé™ä½ITæ€»æ‹¥æœ‰æˆæœ¬ã€‚

APMç³»ç»Ÿæ˜¯å¯ä»¥å¸®åŠ©ç†è§£ç³»ç»Ÿè¡Œä¸ºã€ç”¨äºåˆ†ææ€§èƒ½é—®é¢˜çš„å·¥å…·ï¼Œä»¥ä¾¿å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚

## SkyWalking ç®€ä»‹

Skywalkingä¸2016å¹´11æœˆ2æ—¥ç”±å›½äººå´æ™Ÿåœ¨Githubä¸Šä¼ v1.0ç‰ˆæœ¬ï¼Œç”¨äºæä¾›åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªåŠŸèƒ½ï¼Œä»5.xå¼€å§‹ï¼Œæˆä¸ºä¸€ä¸ªåŠŸèƒ½è¾ƒä¸ºå®Œå–„çš„APMï¼ˆApplication Performance Managementï¼‰ç³»ç»Ÿï¼Œ2019å¹´4æœˆ17æ—¥ä»Apacheå­µåŒ–å™¨æ¯•ä¸šï¼Œæ­£å¼æˆä¸ºApacheé¡¶çº§é¡¹ç›®ã€‚æä¾›åˆ†å¸ƒå¼è¿½è¸ªã€æœåŠ¡ç½‘æ ¼é¥æµ‹åˆ†æã€åº¦é‡èšåˆå’Œå¯è§†åŒ–ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆã€‚å®˜æ–¹å¯¹è‡ªå·±ä»‹ç»æ˜¯ä¸“ä¸ºå¾®æœåŠ¡ï¼Œäº‘åŸç”Ÿå’ŒåŸºäºå®¹å™¨ï¼ˆDockerï¼ŒKubernetesï¼ŒMesosï¼‰æ¶æ„è€Œè®¾è®¡ã€‚

- SkyWalking æ˜¯è§‚å¯Ÿæ€§åˆ†æå¹³å°å’Œåº”ç”¨æ€§èƒ½ç®¡ç†ç³»ç»Ÿã€‚
- æä¾›åˆ†å¸ƒå¼è¿½è¸ªã€æœåŠ¡ç½‘æ ¼é¥æµ‹åˆ†æã€åº¦é‡èšåˆå’Œå¯è§†åŒ–ä¸€ä½“åŒ–è§£å†³æ–¹æ¡ˆ.
- æ”¯æŒJava, .Net Core, PHP, NodeJS, Golang, LUAè¯­è¨€æ¢é’ˆ
- æ”¯æŒEnvoy + Istioæ„å»ºçš„Service Mesh

### Skywalking ä¸»è¦åŠŸèƒ½

- æœåŠ¡ï¼ŒæœåŠ¡å®ä¾‹ï¼Œç«¯ç‚¹æŒ‡æ ‡åˆ†æ
- æ ¹æœ¬åŸå› åˆ†æ
- æœåŠ¡æ‹“æ‰‘å›¾åˆ†æ
- æœåŠ¡ï¼ŒæœåŠ¡å®ä¾‹å’Œç«¯ç‚¹ä¾èµ–æ€§åˆ†æ
- æ…¢æœåŠ¡æ£€æµ‹
- æ€§èƒ½ä¼˜åŒ–
- åˆ†å¸ƒå¼è·Ÿè¸ªå’Œä¸Šä¸‹æ–‡ä¼ æ’­
- æ•°æ®åº“è®¿é—®æŒ‡æ ‡ã€æ£€æµ‹æ…¢é€Ÿæ•°æ®åº“è®¿é—®è¯­å¥ï¼ˆåŒ…æ‹¬SQLï¼‰
- å‘Šè­¦

### Skywalkingä¸»è¦ç‰¹æ€§

- å¤šç§ç›‘æ§æ‰‹æ®µï¼Œè¯­è¨€æ¢é’ˆå’Œservice mesh
- å¤šè¯­è¨€è‡ªåŠ¨æ¢é’ˆï¼ŒJavaï¼Œ.NET Coreå’ŒNode.JS
- å¤šç§åç«¯å­˜å‚¨æ”¯æŒ
- è½»é‡é«˜æ•ˆ
- æ¨¡å—åŒ–ï¼ŒUIã€å­˜å‚¨ã€é›†ç¾¤ç®¡ç†å¤šç§æœºåˆ¶å¯é€‰
- æ”¯æŒå‘Šè­¦
- ä¼˜ç§€çš„å¯è§†åŒ–æ–¹æ¡ˆ

### SkyWalking æ¶æ„è®¾è®¡

![14][14]

æ•´ä¸ªæ¶æ„ï¼Œåˆ†æˆä¸Šã€ä¸‹ã€å·¦ã€å³å››éƒ¨åˆ†ï¼š

- ä¸Šéƒ¨åˆ† Agent ï¼šè´Ÿè´£ä»åº”ç”¨ä¸­ï¼Œæ”¶é›†é“¾è·¯ä¿¡æ¯ï¼Œå‘é€ç»™ SkyWalking OAP æœåŠ¡å™¨ã€‚ç›®å‰æ”¯æŒ SkyWalkingã€Zikpinã€Jaeger ç­‰æä¾›çš„ Tracing æ•°æ®ä¿¡æ¯ã€‚è€Œæˆ‘ä»¬ç›®å‰é‡‡ç”¨çš„æ˜¯ï¼ŒSkyWalking Agent æ”¶é›† SkyWalking Tracing æ•°æ®ï¼Œä¼ é€’ç»™æœåŠ¡å™¨ã€‚
- ä¸‹éƒ¨åˆ† SkyWalking OAP ï¼šè´Ÿè´£æ¥æ”¶ Agent å‘é€çš„ Tracing æ•°æ®ä¿¡æ¯ï¼Œç„¶åè¿›è¡Œåˆ†æ(Analysis Core) ï¼Œå­˜å‚¨åˆ°å¤–éƒ¨å­˜å‚¨å™¨( Storage )ï¼Œæœ€ç»ˆæä¾›æŸ¥è¯¢( Query )åŠŸèƒ½ã€‚
- å³éƒ¨åˆ† Storage ï¼šTracing æ•°æ®å­˜å‚¨ã€‚ç›®å‰æ”¯æŒ ESã€MySQLã€Sharding Sphereã€TiDBã€H2 å¤šç§å­˜å‚¨å™¨ã€‚è€Œæˆ‘ä»¬ç›®å‰é‡‡ç”¨çš„æ˜¯ ES ï¼Œä¸»è¦è€ƒè™‘æ˜¯ SkyWalking å¼€å‘å›¢é˜Ÿè‡ªå·±çš„ç”Ÿäº§ç¯å¢ƒé‡‡ç”¨ ES ä¸ºä¸»ã€‚
- å·¦éƒ¨åˆ† SkyWalking UI ï¼šè´Ÿè´£æä¾›æ§å°ï¼ŒæŸ¥çœ‹é“¾è·¯ç­‰ç­‰ã€‚

SkyWalking çš„æ ¸å¿ƒæ˜¯æ•°æ®åˆ†æå’Œåº¦é‡ç»“æœçš„å­˜å‚¨å¹³å°ï¼Œé€šè¿‡ HTTP æˆ– gRPC æ–¹å¼å‘ SkyWalking Collecter æäº¤åˆ†æå’Œåº¦é‡æ•°æ®ï¼ŒSkyWalking Collecter å¯¹æ•°æ®è¿›è¡Œåˆ†æå’Œèšåˆï¼Œå­˜å‚¨åˆ° Elasticsearchã€H2ã€MySQLã€TiDB ç­‰å…¶ä¸€å³å¯ï¼Œæœ€åæˆ‘ä»¬å¯ä»¥é€šè¿‡ SkyWalking UI çš„å¯è§†åŒ–ç•Œé¢å¯¹æœ€ç»ˆçš„ç»“æœè¿›è¡ŒæŸ¥çœ‹ã€‚Skywalking æ”¯æŒä»å¤šä¸ªæ¥æºå’Œå¤šç§æ ¼å¼æ”¶é›†æ•°æ®ï¼šå¤šç§è¯­è¨€çš„ Skywalking Agent ã€Zipkin v1/v2 ã€Istio å‹˜æµ‹ã€Envoy åº¦é‡ç­‰æ•°æ®æ ¼å¼ã€‚

è¦ç”¨ Skywalking ç›‘æ§ä¸€ä¸ªåº”ç”¨ï¼Œéœ€è¦åœ¨å…¶ VM å‚æ•°ä¸­æ·»åŠ  â€œ-javaagent:skywalking-agent.jarâ€ï¼ˆçœç•¥skywalking-agent.jarçš„å®Œæ•´è·¯å¾„ï¼‰ï¼Œè¿™å…¶å®ç”¨äº†Javaæ¢é’ˆæŠ€æœ¯ï¼Œç®—æ˜¯ä¸ªæ¯”è¾ƒè€çš„æŠ€æœ¯äº†ï¼ŒJava Agent æ˜¯ä» JDK1.5 å¼€å§‹å¼•å…¥çš„ï¼Œç”¨ä¸€å¥æ¦‚æ‹¬å…¶åŠŸèƒ½çš„è¯å°±æ˜¯â€œåœ¨main()å‡½æ•°ä¹‹å‰çš„ä¸€ä¸ªæ‹¦æˆªå™¨â€ï¼Œä¹Ÿå°±æ˜¯åœ¨æ‰§è¡Œmainå‡½æ•°å‰ï¼Œå…ˆæ‰§è¡ŒAgentä¸­çš„ä»£ç ã€‚

Skywalking Java Agent æ”¯æŒåº“ï¼š

- https://github.com/apache/skywalking/blob/master/docs/en/setup/service-agent/java-agent/Supported-list.md

### å®˜æ–¹æ–‡æ¡£

- åœ¨ https://github.com/apache/skywalking/tree/master/docs åœ°å€ä¸‹ï¼Œæä¾›äº† SkyWalking çš„è‹±æ–‡æ–‡æ¡£ã€‚
- åœ¨ https://github.com/SkyAPM/document-cn-translation-of-skywalking åœ°å€ï¼Œæä¾›äº† SkyWalking çš„ä¸­æ–‡æ–‡æ¡£ã€‚

### [ä½¿ç”¨ Docker å®‰è£… SkyWalking](https://github.com/apache/skywalking-docker)

å­˜å‚¨åº“é»˜è®¤ä½¿ç”¨ ESï¼Œå®‰è£… SkyWalking å‰è¯·å…ˆ [å®‰è£… ELK](/back-end/docker/docker-elk/#more)

æ­å»ºä¸€ä¸ª SkyWalking å•æœºç¯å¢ƒï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

- ç¬¬ä¸€æ­¥ï¼Œæ­å»ºä¸€ä¸ª Elasticsearch æœåŠ¡ã€‚
- ç¬¬äºŒæ­¥ï¼Œä¸‹è½½ SkyWalking è½¯ä»¶åŒ…ã€‚
- ç¬¬ä¸‰æ­¥ï¼Œæ­å»ºä¸€ä¸ª SkyWalking OAP æœåŠ¡ã€‚
- ç¬¬å››æ­¥ï¼Œå¯åŠ¨ä¸€ä¸ª Spring Boot åº”ç”¨ï¼Œå¹¶é…ç½® SkyWalking Agentã€‚
- ç¬¬äº”æ­¥ï¼Œæ­å»ºä¸€ä¸ª SkyWalking UI æœåŠ¡ã€‚

**docker-compose.yamlï¼š**

```yaml
version: '3.8'

services:
  oap:
    image: apache/skywalking-oap-server:8.1.0-es7
    container_name: oap
    restart: always
    ports:
      - 11800:11800
      - 12800:12800
    networks:
      - oap
      - elastic
    healthcheck:
      test: ["CMD-SHELL", "/skywalking/bin/swctl"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      SW_STORAGE: elasticsearch7
      SW_STORAGE_ES_CLUSTER_NODES: es01:9200
  ui:
    image: apache/skywalking-ui:8.1.0
    container_name: oap-ui
    depends_on:
      - oap
    restart: always
    ports:
      - 9301:8080
    networks:
      - oap
    environment:
      SW_OAP_ADDRESS: oap:12800

networks:
  oap:
    driver: bridge
  elastic:
    external: true
```

> å¦‚æœæ‚¨æ‰“ç®—è¦†ç›–é…ç½®æ–‡ä»¶ /skywalking/configï¼Œè¯·åœ¨ /skywalking/ext-config æ”¾ç½®å…¶ä»–æ–‡ä»¶ï¼Œå…·æœ‰ç›¸åŒåç§°çš„æ–‡ä»¶å°†è¢«è¦†ç›–ã€‚

### Spring Cloud æ•´åˆ SkyWalking

åˆ° http://skywalking.apache.org/downloads/ åœ°å€ä¸‹è½½Skywalkingçš„å‹ç¼©åŒ…ï¼Œè§£å‹åå°†æˆ‘ä»¬éœ€è¦å°† apache-skywalking-apm-bin-es7/agent ç›®å½•ï¼Œæ‹·è´åˆ° Java åº”ç”¨æ‰€åœ¨çš„æœåŠ¡å™¨ä¸Šã€‚

é…ç½® Java å¯åŠ¨è„šæœ¬

```bash
# SkyWalking Agent é…ç½®
export SW_AGENT_NAME=demo-app # é…ç½® Agent åå­—ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Spring Boot é¡¹ç›®çš„ `spring.application.name` æˆ–ç”¨ -Dskywalking.agent.service_name=demo-app æŒ‡å®šã€‚
export SW_AGENT_COLLECTOR_BACKEND_SERVICES=192.168.2.202:11800 # é…ç½® Collector åœ°å€ã€‚æˆ–ç”¨ -Dskywalking.collector.backend_service=192.168.2.202:11800
export SW_AGENT_SPAN_LIMIT=2000 # é…ç½®é“¾è·¯çš„æœ€å¤§ Span æ•°é‡ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸éœ€è¦é…ç½®ï¼Œé»˜è®¤ä¸º 300 ã€‚ä¸»è¦è€ƒè™‘ï¼Œæœ‰äº›æ–°ä¸Š SkyWalking Agent çš„é¡¹ç›®ï¼Œä»£ç å¯èƒ½æ¯”è¾ƒç³Ÿç³•ã€‚
export JAVA_AGENT=-javaagent:~/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar # SkyWalking Agent jar åœ°å€ã€‚

# Jar å¯åŠ¨, å¯ä»¥åœ¨ apache-skywalking-apm-bin-es7/agent/agent/logs/skywalking-api.log æŸ¥çœ‹å¯¹åº”çš„ SkyWalking Agent æ—¥å¿—ã€‚
java -jar $JAVA_AGENT -jar demo-app-1.0.0.RELEASE.jar
```

> æ›´å¤šçš„å˜é‡ï¼Œå¯ä»¥åœ¨ apache-skywalking-apm-bin-es7/agent/config/agent.config æŸ¥çœ‹ã€‚

å®Œäº‹ï¼Œå¯ä»¥å» SkyWalking UI æŸ¥çœ‹æ˜¯å¦é“¾è·¯æ”¶é›†æˆåŠŸã€‚

1. é¦–å…ˆï¼Œä½¿ç”¨æµè§ˆå™¨ï¼Œè¯·æ±‚ä¸‹ Spring Boot åº”ç”¨æä¾›çš„ APIã€‚å› ä¸ºï¼Œæˆ‘ä»¬è¦è¿½è¸ªä¸‹è¯¥é“¾è·¯ã€‚
2. ç„¶åï¼Œç»§ç»­ä½¿ç”¨æµè§ˆå™¨ï¼Œæ‰“å¼€ http://192.168.2.202:9301/ åœ°å€ï¼Œè¿›å…¥ SkyWalking UI ç•Œé¢ã€‚

> å¦‚æœçœ‹ä¸åˆ°æ•°æ®ï¼Œéœ€è¦ç¨å®šå‡ ç§’ï¼Œå› ä¸º agent ä¸Šä¼ çš„é“¾è·¯æ•°æ®ç»™ OAP æ˜¯å¼‚æ­¥çš„ã€‚

SkyWalking ä¸­éå¸¸é‡è¦çš„ä¸‰ä¸ªæ¦‚å¿µï¼š

- æœåŠ¡(Service) ï¼šè¡¨ç¤ºå¯¹è¯·æ±‚æä¾›ç›¸åŒè¡Œä¸ºçš„ä¸€ç³»åˆ—æˆ–ä¸€ç»„å·¥ä½œè´Ÿè½½ã€‚åœ¨ä½¿ç”¨ Agent æˆ– SDK çš„æ—¶å€™ï¼Œä½ å¯ä»¥å®šä¹‰æœåŠ¡çš„åå­—ã€‚å¦‚æœä¸å®šä¹‰çš„è¯ï¼ŒSkyWalking å°†ä¼šä½¿ç”¨ä½ åœ¨å¹³å°ï¼ˆä¾‹å¦‚è¯´ Istioï¼‰ä¸Šå®šä¹‰çš„åå­—ã€‚
- æœåŠ¡å®ä¾‹(Service Instance) ï¼šä¸Šè¿°çš„ä¸€ç»„å·¥ä½œè´Ÿè½½ä¸­çš„æ¯ä¸€ä¸ªå·¥ä½œè´Ÿè½½ç§°ä¸ºä¸€ä¸ªå®ä¾‹ã€‚å°±åƒ Kubernetes ä¸­çš„ pods ä¸€æ ·, æœåŠ¡å®ä¾‹æœªå¿…å°±æ˜¯æ“ä½œç³»ç»Ÿä¸Šçš„ä¸€ä¸ªè¿›ç¨‹ã€‚ä½†å½“ä½ åœ¨ä½¿ç”¨ Agent çš„æ—¶å€™, ä¸€ä¸ªæœåŠ¡å®ä¾‹å®é™…å°±æ˜¯æ“ä½œç³»ç»Ÿä¸Šçš„ä¸€ä¸ªçœŸå®è¿›ç¨‹ã€‚
- ç«¯ç‚¹(Endpoint) ï¼šå¯¹äºç‰¹å®šæœåŠ¡æ‰€æ¥æ”¶çš„è¯·æ±‚è·¯å¾„, å¦‚ HTTP çš„ URI è·¯å¾„å’Œ gRPC æœåŠ¡çš„ç±»å + æ–¹æ³•ç­¾åã€‚

> åœ¨ SkyWalking ä¸­ï¼Œæ¯ä¸ªè¢«ç›‘æ§çš„å®ä¾‹çš„åå­—ï¼Œä¼šåŒ…å« hostnameï¼Œæ ¼å¼ä¸ºï¼š{agent_name}-pid:{pid}@{hostname}ã€‚æ‰€ä»¥è¦æ­£ç¡®è®¾ç½®æœåŠ¡å™¨çš„ hostnameï¼Œä¸ç„¶ä¼šæ˜¾ç¤ºä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ã€‚

### æ­å»º SkyWalking é›†ç¾¤ç¯å¢ƒ

åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ¨èæ­å»º SkyWalking é›†ç¾¤ç¯å¢ƒã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨ SkyWalking å•æœºç¯å¢ƒï¼Œæ¯•ç«Ÿ SkyWalking æŒ‚äº†ä¹‹åï¼Œä¸å½±å“ä¸šåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚

æ­å»ºä¸€ä¸ª SkyWalking é›†ç¾¤ç¯å¢ƒï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

- ç¬¬ä¸€æ­¥ï¼Œæ­å»ºä¸€ä¸ª Elasticsearch æœåŠ¡çš„é›†ç¾¤ã€‚
- ç¬¬äºŒæ­¥ï¼Œæ­å»ºä¸€ä¸ªæ³¨å†Œä¸­å¿ƒçš„é›†ç¾¤ã€‚ç›®å‰ SkyWalking æ”¯æŒ Zookeeperã€Kubernetesã€Consulã€Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚
- ç¬¬ä¸‰æ­¥ï¼Œæ­å»ºä¸€ä¸ª SkyWalking OAP æœåŠ¡çš„é›†ç¾¤ï¼ŒåŒæ—¶å‚è€ƒ[ã€ŠSkyWalking æ–‡æ¡£ â€”â€” é›†ç¾¤ç®¡ç†ã€‹](https://github.com/SkyAPM/document-cn-translation-of-skywalking/blob/master/docs/zh/8.0.0/setup/backend/backend-cluster.md)ï¼Œå°† SkyWalking OAP æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸Šã€‚
- ç¬¬å››æ­¥ï¼Œå¯åŠ¨ä¸€ä¸ª Spring Boot åº”ç”¨ï¼Œå¹¶é…ç½® SkyWalking Agentã€‚å¦å¤–ï¼Œåœ¨è®¾ç½® SkyWaling Agent çš„ `SW_AGENT_COLLECTOR_BACKEND_SERVICES` åœ°å€æ—¶ï¼Œéœ€è¦è®¾ç½®å¤šä¸ª SkyWalking OAP æœåŠ¡çš„åœ°å€æ•°ç»„ã€‚
- ç¬¬äº”æ­¥ï¼Œæ­å»ºä¸€ä¸ª SkyWalking UI æœåŠ¡çš„é›†ç¾¤ï¼ŒåŒæ—¶ä½¿ç”¨ Nginx è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚å¦å¤–ï¼Œåœ¨è®¾ç½® SkyWalking UI çš„ `collector.ribbon.listOfServers` åœ°å€æ—¶ï¼Œä¹Ÿéœ€è¦è®¾ç½®å¤šä¸ª SkyWalking OAP æœåŠ¡çš„åœ°å€æ•°ç»„ã€‚

### å‘Šè­¦

åœ¨ SkyWaling ä¸­ï¼Œå·²ç»æä¾›äº†å‘Šè­¦åŠŸèƒ½ï¼Œå…·ä½“å¯è§[ã€ŠSkyWalking æ–‡æ¡£ â€”â€” å‘Šè­¦ã€‹](https://github.com/SkyAPM/document-cn-translation-of-skywalking/blob/master/docs/zh/8.0.0/setup/backend/backend-alarm.md)ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒSkyWalking å·²ç»[å†…ç½®å‘Šè­¦è§„åˆ™](https://github.com/SkyAPM/document-cn-translation-of-skywalking/blob/master/docs/zh/8.0.0/setup/backend/backend-alarm.md#%E9%BB%98%E8%AE%A4%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99)ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ[å‘Šè­¦è§„åˆ™](https://github.com/SkyAPM/document-cn-translation-of-skywalking/blob/master/docs/zh/8.0.0/setup/backend/backend-alarm.md#%E8%A7%84%E5%88%99)ï¼Œè¿›è¡Œè‡ªå®šä¹‰ã€‚


å› ä¸ºæœ‰äº›æœåŠ¡å™¨æœªæ­£ç¡®è®¾ç½® hostname ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å®šè¦å»ä¿®æ”¹ï¼Œä¸ç„¶éƒ½ä¸çŸ¥é“æ˜¯å“ªä¸ªæœåŠ¡å™¨ä¸Šçš„å®ä¾‹ï¼ˆğŸ˜ˆ é¬¼çŸ¥é“ "iZbp1e2xlyvr7fh67qi59oZ" ä¸€ä¸²æ˜¯å“ªä¸ªæœåŠ¡å™¨å•Šï¼‰ã€‚


## Open Tracing ç®€ä»‹

![15][15]

ç°åœ¨è°ƒç”¨é“¾ç›‘æ§å¾ˆå¤šï¼Œé‚£ä¹ˆå°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯äº’æ“ä½œçš„é—®é¢˜ï¼Œä¼ä¸šæœ‰ä¸åŒçš„è¯­è¨€ï¼Œè¦åŸ‹ç‚¹çš„åº”ç”¨å’Œåº“ä¹Ÿå¾ˆå¤šï¼Œå¦‚æœè¯´è¿™äº›å·¥å…·ä¸å…¼å®¹çš„è¯é›†æˆçš„æˆæœ¬å°±å¾ˆé«˜ã€‚Open Tracing æ˜¯ä¸€ä¸ªç»„ç»‡ï¼Œè¿™ä¸ªç»„ç»‡ä¸»è¦æ˜¯å®šä¹‰æ ‡å‡†ï¼Œè§„èŒƒè°ƒç”¨é“¾ç›‘æ§API å’Œæ ¼å¼ï¼Œåªè¦ç¬¦åˆ Open Tracing çš„æ ‡å‡†å°±å¯ä»¥ç”¨ä¸åŒçš„è°ƒç”¨é“¾ç›‘æ§äº§å“è¿›è¡Œæ”¶é›†å’Œç›‘æ§ã€‚æ¶æ„å¸ˆåœ¨é€‰å‹çš„æ—¶å°½é‡é€‰å…¼å®¹ Open Tracing æ ‡å‡†çš„äº§å“ã€‚

## å¼€æºäº§å“æ¯”è¾ƒ

|                | CAT | Zipkin | Pinpoint | Skywalking  |
| -------------- | ----------------- | ------------------- | ----------------- | ----------------- |
| è°ƒç”¨é“¾å¯è§†åŒ– | æœ‰ | æœ‰ | æœ‰ | æœ‰ |
| èšåˆæŠ¥è¡¨ | éå¸¸ä¸°å¯Œ | å°‘ | ä¸­ | è¾ƒä¸°å¯Œ |
| æœåŠ¡ä¾èµ–å›¾ | ç®€å• | ç®€å• | å¥½ | å¥½
| åŸ‹ç‚¹æ–¹å¼ | ä¾µå…¥ | ä¾µå…¥ | éä¾µå…¥å­—èŠ‚ç å¢å¼º | éä¾µå…¥ï¼Œè¿è¡ŒæœŸå­—èŠ‚ç å¢å¼º|
| VMæŒ‡æ ‡ç›‘æ§ | å¥½ | æ—  | æœ‰ | æœ‰ |
| å‘Šè­¦æ”¯æŒ | æœ‰ | æ—  |æœ‰ | æœ‰ |
| å¤šè¯­è¨€æ”¯æŒ | Java/.Net | ä¸°å¯Œ | åªæœ‰Java | Java/.Net/NodeJS/PHPè‡ªåŠ¨/Goæ‰‹åŠ¨|
| å­˜å‚¨æœºåˆ¶ | Mysql(æŠ¥è¡¨)ï¼Œæœ¬åœ°æ–‡ä»¶/HDFSï¼ˆè°ƒç”¨é“¾) | å¯é€‰in memory, mysql, ES(ç”Ÿäº§), Cassandra(ç”Ÿäº§) | HBase | H2, ES(ç”Ÿäº§) |
| ç¤¾åŒºæ”¯æŒ | ä¸»è¦åœ¨å›½å†…ï¼Œç‚¹è¯„/ç¾å›¢ | æ–‡æ¡£ä¸°å¯Œï¼Œå›½å¤–ä¸»æµ | æ–‡æ¡£ä¸€èˆ¬ï¼Œæš‚æ— ä¸­æ–‡ç¤¾åŒº | Apacheæ”¯æŒï¼Œå›½å†…ç¤¾åŒºå¥½ |
| å›½å†…æ¡ˆä¾‹ | ç‚¹è¯„ã€æºç¨‹ã€é™†é‡‘æ‰€ã€æ‹æ‹è´· | äº¬ä¸œã€é˜¿é‡Œå®šåˆ¶ä¸å¼€æº | å”¯å“ä¼šæ”¹é€ å®šåˆ¶ | åä¸ºï¼Œå°ç±³ï¼Œå½“å½“ï¼Œå¾®ä¼—é“¶è¡Œ |
|APM | Yes | No | Yes | Yes |
| ç¥–å…ˆæºå¤´ | eBay CAL | Google Dapper | Google Dapper | Google Dapper |
| åŒç±»äº§å“ | æš‚æ—  | Uber Jaeger, Spring Cloud Sleuth | Apache Skywalking | Naver Pinpoint |
| äº®ç‚¹ | ä¼ä¸šç”Ÿäº§çº§ï¼ŒæŠ¥è¡¨ä¸°å¯Œ | ç¤¾åŒºç¤¾åŒºç”Ÿæ€å¥½ | éä¾µå…¥ | éä¾µå…¥ï¼ŒApacheèƒŒä¹¦ |
| ä¸è¶³ | ç”¨æˆ·ä½“éªŒä¸€èˆ¬ï¼Œç¤¾åŒºä¸€èˆ¬ | APMæŠ¥è¡¨èƒ½åŠ›å¼± | å›½å†…ç”Ÿäº§æ¡ˆä¾‹å°‘ | æ—¶é—´ä¸é•¿ï¼Œæ–‡æ¡£ä¸€èˆ¬ï¼Œä»…é™ä¸­æ–‡
ç¤¾åŒº|

## å‚è€ƒ

- https://cloud.spring.io/spring-cloud-sleuth/reference/html/
- https://cloud.spring.io/spring-cloud-static/spring-cloud-sleuth/2.2.2.RELEASE/reference/html/
- https://cloud.spring.io/spring-cloud-sleuth/2.0.x/multi/multi__introduction.html
- http://research.google.com/pubs/archive/36356.pdf
- https://tech.meituan.com/2018/11/01/cat-in-depth-java-application-monitoring.html
- https://github.com/openzipkin/zipkin/
- https://github.com/dianping/cat/
- https://github.com/naver/pinpoint/
- https://github.com/apache/skywalking/
- https://github.com/jaegertracing/jaeger/
- https://github.com/opentracing/
- https://github.com/SkyAPM/document-cn-translation-of-skywalking
- ã€Šå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹
- ã€ŠSpring Boot & Kubernetes äº‘åŸç”Ÿå¾®æœåŠ¡å®è·µã€‹
- ã€Šä»0å¼€å§‹å­¦å¾®æœåŠ¡ã€‹
- ã€Šå¾®æœåŠ¡è®¾è®¡ã€‹

[1]: /images/java/spring-cloud-sleuth/1.jpg
[2]: /images/java/spring-cloud-sleuth/2.jpg
[3]: /images/java/spring-cloud-sleuth/3.jpg
[4]: /images/java/spring-cloud-sleuth/4.jpg
[5]: /images/java/spring-cloud-sleuth/5.jpg
[6]: /images/java/spring-cloud-sleuth/6.jpg
[7]: /images/java/spring-cloud-sleuth/7.jpg
[8]: /images/java/spring-cloud-sleuth/8.jpg
[9]: /images/java/spring-cloud-sleuth/9.jpg
[10]: /images/java/spring-cloud-sleuth/10.jpg
[11]: /images/java/spring-cloud-sleuth/11.jpg
[12]: /images/java/spring-cloud-sleuth/12.jpg
[13]: /images/java/spring-cloud-sleuth/13.jpg
[14]: /images/java/spring-cloud-sleuth/14.jpeg
[15]: /images/java/spring-cloud-sleuth/15.jpg
