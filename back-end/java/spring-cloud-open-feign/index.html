<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.lichao.xin","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"3ZZ8ITB7HE","apiKey":"062eb5a54afbcbf3f20452d58fc40035","indexName":"xinlc","hits":{"per_page":10},"labels":{"input_placeholder":"搜索","hits_empty":"未发现与「${query}」相关的内容","hits_stats":"${hits} 条相关条目，使用了 ${time} 毫秒"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="上篇 Spring Cloud Ribbon 中写到用 RestTemplate 来调用其他微服务，本篇介绍更简单好用的声明式调用工具。 Spring Cloud OpenFeign 是声明式的服务调用工具（伪 Http 客户端），它整合了 Ribbon 和 Hystrix，拥有负载均衡和服务容错功能。只需创建一个接口并用注解的方式来配置它，就可以实现对某个服务接口的调用，简化了直接使用 Rest">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务架构之声明式服务调用：Spring Cloud OpenFeign">
<meta property="og:url" content="https://blog.lichao.xin/back-end/java/spring-cloud-open-feign/index.html">
<meta property="og:site_name" content="Richard Xin&#39;s Blog">
<meta property="og:description" content="上篇 Spring Cloud Ribbon 中写到用 RestTemplate 来调用其他微服务，本篇介绍更简单好用的声明式调用工具。 Spring Cloud OpenFeign 是声明式的服务调用工具（伪 Http 客户端），它整合了 Ribbon 和 Hystrix，拥有负载均衡和服务容错功能。只需创建一个接口并用注解的方式来配置它，就可以实现对某个服务接口的调用，简化了直接使用 Rest">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-open-feign/1.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-open-feign/2.jpg">
<meta property="article:published_time" content="2020-02-18T20:07:00.000Z">
<meta property="article:modified_time" content="2021-06-14T01:33:22.391Z">
<meta property="article:author" content="Richard">
<meta property="article:tag" content="MicroServices">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lichao.xin/images/java/spring-cloud-open-feign/1.jpg">

<link rel="canonical" href="https://blog.lichao.xin/back-end/java/spring-cloud-open-feign/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>微服务架构之声明式服务调用：Spring Cloud OpenFeign | Richard Xin's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4530ac9d0bc4e258535c4a9b17029f0c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Richard Xin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Richard Xin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Quick notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">132</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">59</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.lichao.xin/back-end/java/spring-cloud-open-feign/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
      <meta itemprop="name" content="Richard">
      <meta itemprop="description" content="惶者生存，偏执者成功">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Richard Xin's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          微服务架构之声明式服务调用：Spring Cloud OpenFeign
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-18 20:07:00" itemprop="dateCreated datePublished" datetime="2020-02-18T20:07:00+00:00">2020-02-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-14 01:33:22" itemprop="dateModified" datetime="2021-06-14T01:33:22+00:00">2021-06-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>上篇 Spring Cloud Ribbon 中写到用 RestTemplate 来调用其他微服务，本篇介绍更简单好用的声明式调用工具。</p>
<p>Spring Cloud OpenFeign 是声明式的服务调用工具（伪 Http 客户端），它整合了 Ribbon 和 Hystrix，拥有负载均衡和服务容错功能。只需创建一个接口并用注解的方式来配置它，就可以实现对某个服务接口的调用，简化了直接使用 RestTemplate 来调用服务接口的开发量。</p>
<p>Feign 具备可插拔的注解支持，同时支持 Feign 注解、JAX-RS 注解及 SpringMvc 注解。当使用 Feign 时，Spring Cloud 集成了 Ribbon 和 Eureka 以提供负载均衡的服务调用及基于 Hystrix 的服务容错保护功能。</p>
<a id="more"></a>

<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>Feign 是一个伪客户端，即它不做任何的请求处理。Feign 通过处理注解生成 request，从而实现简化 HTTP API 开发的目的，即开发人员可以使用注解的方式定制 request API 模板，在发送 http request 请求之前，Feign 通过处理注解的方式替换掉 request 模板中的参数，这种实现方式显得更为直接、可理解。</p>
<p><img src="/images/java/spring-cloud-open-feign/1.jpg" alt="1"></p>
<p>当客户端发起一个请求（Request Bean），这个请求首先会被动态代理截获，然后通过相应的编码器进行编码成为 Requst Json。</p>
<p>Requst Json 根据需要可以经过一些截获器做进一步处理，处理完以后传递给 Http Client，由 Http Client 发送 Requst Json 到服务端。服务端的响应回被解码器进行解码，这个 Json 消息的互转就是序列化和反序列化，另外一个叫法叫 Json 对象绑定。</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>JDK：1.8</li>
<li>Spring Boot：2.2.4.RELEASE</li>
<li>Spring Cloud：Hoxton.SR1</li>
</ul>
<h2 id="创建一个-feign-service-模块"><a href="#创建一个-feign-service-模块" class="headerlink" title="创建一个 feign-service 模块"></a>创建一个 feign-service 模块</h2><p>feign-service 模块来演示 Feign 的常用功能，在 pom.xml 中添加相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 application.yml 中进行配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8701</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">feign-service</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8001/eureka/</span></span><br></pre></td></tr></table></figure>

<p>在启动类上添加 @EnableFeignClients 注解来启用 Feign 的客户端功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="comment">// @EnableFeignClients(basePackages = &#123;"com.leo.user"&#125;)</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignServiceApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(FeignServiceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加 FeignUserService 接口完成对 user-service 服务的接口绑定，通过 @FeignClient 注解实现了一个 Feign 客户端，其中的 value 为 user-service 表示这是对 user-service 服务的接口调用客户端，这里其实就是 user-service 中的 UserController，只是改成了接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"user-service"</span>, qualifier = <span class="string">"user-service"</span>)</span><br><span class="line"><span class="comment">// @FeignClient(name = "user-service", path = "/v1/userInfo", url = "$&#123;user.user-service-endpoint&#125;")</span></span><br><span class="line"><span class="comment">// @Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FeignUserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/user/create"</span>)</span><br><span class="line">    <span class="function">CommonResult <span class="title">create</span><span class="params">(@RequestBody User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">CommonResult&lt;User&gt; <span class="title">getUser</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/getByUsername"</span>)</span><br><span class="line">    <span class="function">CommonResult&lt;User&gt; <span class="title">getByUsername</span><span class="params">(@RequestParam(<span class="string">"username"</span>)</span> String username)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/user/update"</span>)</span><br><span class="line">    <span class="function">CommonResult <span class="title">update</span><span class="params">(@RequestBody User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/user/delete/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">CommonResult <span class="title">delete</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加 UserFeignController 调用 FeignUserService 实现服务调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserFeignController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Qualifier</span>(<span class="string">"user-service"</span>)</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FeignUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">getUser</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUser(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/getByUsername"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">getByUsername</span><span class="params">(@RequestParam String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getByUsername(username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/create"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">create</span><span class="params">(@RequestBody User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.create(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">update</span><span class="params">(@RequestBody User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.update(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/delete/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">delete</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动 eureka-service，两个 user-service，feign-service 服务，访问 <a href="http://localhost:8701/user/1" target="_blank" rel="noopener">http://localhost:8701/user/1</a> 进行测试。</p>
<h2 id="Feign-中的服务降级"><a href="#Feign-中的服务降级" class="headerlink" title="Feign 中的服务降级"></a>Feign 中的服务降级</h2><p>Feign 中的服务降级使用起来非常方便，只需要为 Feign 客户端定义的接口添加一个服务降级处理的实现类即可。</p>
<p>添加服务降级实现类 UserFallbackService，实现 FeignUserService 接口，并且对接口中的每个实现方法进行服务降级逻辑的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserFallbackService</span> <span class="keyword">implements</span> <span class="title">FeignUserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">create</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">1L</span>, <span class="string">"defaultUser"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;User&gt; <span class="title">getUser</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">1L</span>, <span class="string">"defaultUser"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;User&gt; <span class="title">getByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">1L</span>, <span class="string">"defaultUser"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">update</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="string">"调用失败，服务被降级"</span>,<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">delete</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="string">"调用失败，服务被降级"</span>,<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 FeignUserService 接口，设置服务降级处理类为 UserFallbackService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"user-service"</span>, fallback = UserFallbackService<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">FeignUserService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 application.yml，开启 Hystrix 功能：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 在 Feign 中开启 Hystrix</span></span><br></pre></td></tr></table></figure>

<p>关闭两个 user-service 服务，重新启动 feign-service。调用 <a href="http://localhost:8701/user/1" target="_blank" rel="noopener">http://localhost:8701/user/1</a> 进行测试，可以发现返回了服务降级信息。</p>
<p><strong>FallbackFactory</strong></p>
<p>除了 fallback 模式，还可以调用 fallbackFactory，这种可以记录远程调用失败的具体明细异常。建议采用此方案设置后备模式：</p>
<p>FeignUserService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"user-service"</span>, fallbackFactory = UserServiceFallbackFactory<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">FeignUserService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserServiceFallbackFactory.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.hystrix.FallbackFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="comment">// 申明后备模式</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceFallbackFactory</span> <span class="keyword">implements</span> <span class="title">FallbackFactory</span>&lt;<span class="title">FeignUserService</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FeignUserService <span class="title">create</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">        FeignUserServiceFallbackImpl feignUserServiceFallbackImpl = <span class="keyword">new</span> FeignUserServiceFallbackImpl();</span><br><span class="line">        feignUserServiceFallbackImpl.setCause(throwable);</span><br><span class="line">        <span class="keyword">return</span> feignUserServiceFallbackImpl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FeignUserServiceFallbackImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignUserServiceFallbackImpl</span> <span class="keyword">implements</span> <span class="title">FeignUserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> Throwable cause;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">create</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">"调用失败"</span>, cause);</span><br><span class="line">        User defaultUser = <span class="keyword">new</span> User(-<span class="number">1L</span>, <span class="string">"defaultUser"</span>, <span class="string">"123456"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(defaultUser);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他省略……</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="日志打印功能"><a href="#日志打印功能" class="headerlink" title="日志打印功能"></a>日志打印功能</h2><p>Feign 提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解 Feign 中 Http 请求的细节。</p>
<p>日志级别：</p>
<ul>
<li>NONE：默认的，不显示任何日志；</li>
<li>BASIC：仅记录请求方法、URL、响应状态码及执行时间；</li>
<li>HEADERS：除了 BASIC 中定义的信息之外，还有请求和响应的头信息；</li>
<li>FULL：除了 HEADERS 中定义的信息之外，还有请求和响应的正文及元数据；</li>
</ul>
<p>通过配置开启更为详细的日志：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 application.yml 中配置需要开启日志的 Feign 客户端：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.leo.demo.service.FeignUserService:</span> <span class="string">debug</span> <span class="comment"># 配置 UserService 的日志级别为 debug。</span></span><br></pre></td></tr></table></figure>

<h2 id="Feign-的常用配置"><a href="#Feign-的常用配置" class="headerlink" title="Feign 的常用配置"></a>Feign 的常用配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 在 Feign 中开启 Hystrix</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 是否对请求进行 GZIP 压缩</span></span><br><span class="line">      <span class="attr">mime-types:</span> <span class="string">text/xml,application/xml,application/json</span> <span class="comment"># 指定压缩的请求数据类型</span></span><br><span class="line">      <span class="attr">min-request-size:</span> <span class="number">2048</span> <span class="comment"># 超过该大小的请求会被压缩</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 是否对响应进行GZIP压缩</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span> <span class="comment"># 修改日志级别</span></span><br><span class="line">    <span class="attr">com.leo.demo.service.FeignUserService:</span> <span class="string">debug</span> <span class="comment"># 配置 UserService 的日志级别为 debug。</span></span><br></pre></td></tr></table></figure>

<h3 id="feign不过注册中心子系统联调的方法-开发环境常用"><a href="#feign不过注册中心子系统联调的方法-开发环境常用" class="headerlink" title="feign不过注册中心子系统联调的方法(开发环境常用)"></a>feign不过注册中心子系统联调的方法(开发环境常用)</h3><p>团队开发中通常使用同一个注册中心，为了避免联调时调用其他成员机器实例，需要配置feign不通过注册中心获取实例地址，主要有以下两种方法：</p>
<ol>
<li>通过feign注解@FeignClient的url属性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"server-a"</span>, url = <span class="string">"http://localhost:8080"</span>, fallback = FeignApiFallbackComponent<span class="class">.<span class="keyword">class</span>)</span></span><br></pre></td></tr></table></figure>

<p>这种方式将两个子系统作为无关系统直接调用，只适合与开发环境上面做联调，联调结束之后需要删除url属性。</p>
<ul>
<li>主要的缺点是如果没有删除直接上传，会导致代码结果被破坏，而且不利于调试定位。需要通过修改代码来实现</li>
<li>主要的优点是联调比较简单</li>
</ul>
<ol start="2">
<li>通过ribbon的相关配置</li>
</ol>
<p>feign在子系统间调用时，主要是借助于ribbon进行负载均衡的，因此，我们可以通过配置ribbon属性，方便的进行联调。</p>
<p>feign的配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"server-a"</span>, fallback = FeignApiFallbackComponent<span class="class">.<span class="keyword">class</span>)</span></span><br></pre></td></tr></table></figure>

<p>在spring boot开发时，我们通常会针对开发环境配置<code>application-dev.yaml</code>文件作为开发环境的配置。因此，我们可以在该文件中增加如下的配置，直接进行联调</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="comment"># eureka 注册中心</span></span><br><span class="line">  <span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># nacos 注册中心, spring.cloud.nacos.discovery.enabled=false</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">server-a:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">listOfServers:</span> <span class="string">localhost:8080</span></span><br><span class="line">    <span class="attr">ServerListRefreshInterval:</span> <span class="number">15000</span></span><br></pre></td></tr></table></figure>

<p>程序启动的时候，需要加上如下的程序参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--spring.profiles.active=dev</span><br></pre></td></tr></table></figure>

<p>通过这种方式，就可以直接在开发环境中进行联调，主要是通过spring boot的配置文件进行的。这种方式的主要优缺点如下</p>
<ul>
<li>主要的优点是，打包之后环境不同，不会相互影响，确保生产环境的正确性。在部署到生产环境之后，也可以通过该方式，测试子系统间的可用性</li>
<li>主要的缺点是，需要增加一个配置文件</li>
</ul>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><h3 id="Feign-源码执行流程"><a href="#Feign-源码执行流程" class="headerlink" title="Feign 源码执行流程"></a>Feign 源码执行流程</h3><p>Feign 的源码实现的过程如下：</p>
<ol>
<li>首先通过 @EnableFeignCleints 注解开启 FeignCleint；</li>
<li>根据 Feign 的规则实现接口，并加 @FeignCleint 注解；</li>
<li>程序启动后，会进行包扫描，扫描所有的 @FeignCleint 的注解的类，并将这些信息注入到 ioc 容器中；</li>
<li>当接口的方法被调用，通过 JDK 的代理，来生成具体的 RequesTemplate；</li>
<li>RequesTemplate 在生成 Request；</li>
<li>Request 交给 Client 去处理，其中 Client 可以是 HttpUrlConnection、HttpClient 也可以是 Okhttp；</li>
<li>最后 Client 被封装到 LoadBalanceClient 类，这个类结合类 Ribbon 做到了负载均衡；</li>
</ol>
<blockquote>
<p>在使用 Feign 的时候，要注意使用 requestBody，应该使用 @PostMapping。</p>
</blockquote>
<h3 id="Feign-和-Ribbon-比较优点"><a href="#Feign-和-Ribbon-比较优点" class="headerlink" title="Feign 和 Ribbon 比较优点"></a>Feign 和 Ribbon 比较优点</h3><ul>
<li>Feign 本身里面就包含有了 ribbon，只是对于 ribbon 进行进一步封装；</li>
<li>Feign 自身是一个声明式的伪 http 客户端，写起来更加思路清晰和方便；</li>
<li>Fegin 是一个采用基于接口的注解的编程方式，更加简便；</li>
</ul>
<h3 id="向下传递-request-信息"><a href="#向下传递-request-信息" class="headerlink" title="向下传递 request 信息"></a>向下传递 request 信息</h3><p>可以通过 RequestContextHolder 很方便的获取 request，然后通过 Feign 拦截器自动设置 requestTemplate header。比如要实现自动向下传递用户ID，代码如下：</p>
<p>AuthContext.java 用于保存当前 userId 和 authz 信息的上下文容器类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthContext</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getRequetHeader</span><span class="params">(String headerName)</span> </span>&#123;</span><br><span class="line">        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="keyword">if</span> (requestAttributes <span class="keyword">instanceof</span> ServletRequestAttributes) &#123;</span><br><span class="line">            HttpServletRequest request = ((ServletRequestAttributes)requestAttributes).getRequest();</span><br><span class="line">            String value = request.getHeader(headerName);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUserId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getRequetHeader(<span class="string">"X-current-user-id"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAuthz</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getRequetHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FeignRequestHeaderInterceptor.java Feign 拦截器，用于将 auth 信息传递到后端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.RequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> feign.RequestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignRequestHeaderInterceptor</span> <span class="keyword">implements</span> <span class="title">RequestInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestTemplate requestTemplate)</span> </span>&#123;</span><br><span class="line">        String userId = AuthContext.getUserId();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(userId)) &#123;</span><br><span class="line">            requestTemplate.header(<span class="string">"X-current-user-id"</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        // Feign 请求拦截器（设置请求头，传递请求参数）</span></span><br><span class="line"><span class="comment">        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span></span><br><span class="line"><span class="comment">        HttpServletRequest request = attributes.getRequest();</span></span><br><span class="line"><span class="comment">        Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</span></span><br><span class="line"><span class="comment">        if (headerNames != null) &#123;</span></span><br><span class="line"><span class="comment">            while (headerNames.hasMoreElements()) &#123;</span></span><br><span class="line"><span class="comment">                String name = headerNames.nextElement();</span></span><br><span class="line"><span class="comment">                String values = request.getHeader(name);</span></span><br><span class="line"><span class="comment">                requestTemplate.header(name, values);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 设置 request 中的 attribute 到 header:主要是设置自行设置的 token、userId 等信息，以便转发到 Feign 调用的服务</span></span><br><span class="line"><span class="comment">        Enumeration&lt;String&gt; reqAttrbuteNames = request.getAttributeNames();</span></span><br><span class="line"><span class="comment">        if (reqAttrbuteNames != null) &#123;</span></span><br><span class="line"><span class="comment">            while (reqAttrbuteNames.hasMoreElements()) &#123;</span></span><br><span class="line"><span class="comment">                String attrName = reqAttrbuteNames.nextElement();</span></span><br><span class="line"><span class="comment">                String values = request.getAttribute(attrName).toString();</span></span><br><span class="line"><span class="comment">                requestTemplate.header(attrName, values);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FeignConfig.java 来配置 Feign：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.RequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> feign.codec.Decoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.http.HttpMessageConverters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.SpringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义反序列化解析器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Decoder <span class="title">feignDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ObjectFactory&lt;HttpMessageConverters&gt; messageConverters = () -&gt; &#123;</span><br><span class="line">            HttpMessageConverters converters = <span class="keyword">new</span> HttpMessageConverters();</span><br><span class="line">            <span class="keyword">return</span> converters;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringDecoder(messageConverters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Feign 拦截器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestInterceptor <span class="title">feignRequestInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FeignRequestHeaderInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就可以实现自动向下传递 request 信息了，下游服务通过 <code>AuthContext.getUserId()</code> 来获取用户Id。</p>
<h3 id="强类型接口设计"><a href="#强类型接口设计" class="headerlink" title="强类型接口设计"></a>强类型接口设计</h3><p>API 控制器可能会返回正常的响应，也可能会返回异常响应。我们采用强类型接口如何能处理正常响应，又能处理异常返回呢？而且这个接口又能是统一的呢？</p>
<p>采用封装消息+捎带模式：</p>
<p><img src="/images/java/spring-cloud-open-feign/2.jpg" alt="2"></p>
<p>所有的响应都是继承自 BaseResponse 对象，异常返回 BaseResponse，正常响应返回继承自 BaseResponse 的对象，举例：</p>
<p>这里有个 ListUserResponse 继承自 BaseResponse，当客户端向 UserController 请求获取用户列表的时候，如果这个响应异常了，那么他就只返回对应 BaseResponse 异常的消息，这个异常消息可以被 Json 自动序列化自动绑定到 ListUserResponse 对象上，因为两者有继承关系。BaseResponse 是 ListUserResponse 的部分，只不过绑定的时候 ListUserResponse 对象自己扩展的字段为空。这个时候客户端根据错误 code 进行处理。</p>
<p>如果响应是正常的，客户端根据 code 成功响应码进行处理。通过这种简单的继承机制，强类型接口就可以同时处理正常异常两种情况。</p>
<p>改造模块依赖：</p>
<ol>
<li>抽出 FeignUserService 接口为 user-api 模块。</li>
<li>请求和响应对象封装在 user-api 模块 dto 中。</li>
<li>user-service 依赖 user-api 使用 dto。</li>
<li>feign-service 依赖 user-api 使用 FeignUserService 和 dto。</li>
</ol>
<p>common-lib 模块下 BaseResponse.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leo.common.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseResponse</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Builder</span>.Default</span><br><span class="line">    <span class="keyword">private</span> ResultCode code = ResultCode.SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code == ResultCode.SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>user-api 模块下 ListUserResponse.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leo.user.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.*;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.api.BaseResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span>(callSuper = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@EqualsAndHashCode</span>(callSuper = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListUserResponse</span> <span class="keyword">extends</span> <span class="title">BaseResponse</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserList userList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>feign-service 模块：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过 Feign 客户端调用 user-service 服务</span></span><br><span class="line">  ListUserResponse listUserResponse = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      listUserResponse = <span class="keyword">this</span>.userClient.getUserList();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      String errMsg = <span class="string">"unable to get user"</span>;</span><br><span class="line">      handleErrorAndThrowException(ex, errMsg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!listUserResponse.isSuccess()) &#123;</span><br><span class="line">      handleErrorAndThrowException(listUserResponse.getMessage());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>虽然我们开发出的服务是弱类型 RESTful 的服务，但是有了 Feign 的支持，我们只要简单给出一个强类型的 Java API 接口，就可以获得一个强类型的客户端。这样我们同时获得强弱类型 API 的好处，包括：编译器自动类型检查、不需要手动编码解码、不需要开发代码生成工具、而且客户端和服务端不强耦合。</p>
<blockquote>
<p>注意：这种继承关系（ListUserResponse 继承 BaseResponse ），除了这种继承关系之外 ListUserResponse 内部尽量不要再有继承关系，泛型也尽量不要采用（除了 Collection 这种泛型），否则可能会无法反序列化。因为 Java 在运行期泛型回被擦除，造成无法反序列化。</p>
<p>由于 Java 泛型的实现机制，使用了泛型的代码在运行期间相关的泛型参数的类型会被擦除，我们无法在运行期间获知泛型参数的具体类型（所有的泛型类型在运行时都是 Object 类型），但是在编译 Java 源代码成 class 文件中还是保存了泛型相关的信息，这些信息被保存在 class 字节码常量池中，使用了泛型的代码处会生成一个 signature 签名字段，通过签名 signature 字段指明这个常量池的地址。</p>
<p>Java 引入泛型擦除的原因是避免因为引入泛型而导致运行时创建不必要的类。我们其实可以通过定义类的方式，在类信息中保留泛型信息，从而获得这些泛型信息。Java 的泛型擦除是有范围的，即类定义中的泛型是不会被擦除的。</p>
</blockquote>
<h3 id="整合-Resilience4j"><a href="#整合-Resilience4j" class="headerlink" title="整合 Resilience4j"></a>整合 Resilience4j</h3><ul>
<li><a href="https://github.com/resilience4j/resilience4j" target="_blank" rel="noopener">https://github.com/resilience4j/resilience4j</a></li>
</ul>
<h3 id="使用-OkHttp3"><a href="#使用-OkHttp3" class="headerlink" title="使用 OkHttp3"></a>使用 <a href="https://github.com/square/okhttp" target="_blank" rel="noopener">OkHttp3</a></h3><p>在 Feign 中，Client 是一个非常重要的组件，Feign 最终发送 Request 请求以及接收 Response 响应都是由 Client 组件来完成的。Client 在 Feign 源码中是一个接口，在默认情况下，Client 的实现类是 Client.Default，是由 HttpURLConnection 来实现网络请求的。另外 Client 还支持以下常见客户端：</p>
<ul>
<li>LoadBalancerFeignClient：这是一个特殊的 feign.Client 客户端实现类。内部先使用 Ribbon 负载均衡算法计算 Server 服务器，然后使用包装的 Delegate 客户端实例，去完成 HTTP URL 请求处理；</li>
<li>ApacheHttpClient：内部使用 Apache HttpClient 开源组件完成 HTTP URL 请求处理；</li>
<li>WebClient：是 Spring 5 中最新引入的，可以将其理解为 Reactive 版的 RestTemplate，基于 Reactor 的 WebClient。</li>
<li>OkHttpClient：内部使用 OkHttp3 开源组件完成 HTTP URL 请求处理；</li>
</ul>
<p>引入 OkHttp3 的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>10.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改 application.yaml 配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁用 httpclient，使用 OkHttp</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>修改 FeignConfig 配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.Client;</span><br><span class="line"><span class="keyword">import</span> feign.Feign;</span><br><span class="line"><span class="keyword">import</span> feign.codec.Decoder;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> okhttp3.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.http.HttpMessageConverters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.SpringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(Feign<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">/*</span></span><br><span class="line"><span class="class"> 这里网上大部分是 @<span class="title">AutoConfigureBefore</span>，实际是行不通的，原因是 <span class="title">FeignAutoConfiguration</span> 类里面加了 @<span class="title">ConditionalOnMissingBean</span>(</span>&#123;okhttp3.OkHttpClient<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"> 只有当容器中没有 <span class="title">OkHttpClient</span> 的实例时才会运行，所以不能在 <span class="title">FeignAutoConfiguration</span> 之前注入了我们自己定义的 <span class="title">OkHttpClient</span> 实例。</span></span><br><span class="line"><span class="class">*/</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(<span class="title">FeignAutoConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">// @<span class="title">ConditionalOnWebApplication</span>(<span class="title">type</span> </span>= ConditionalOnWebApplication.Type.SERVLET)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignOkHttpConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义反序列化解析器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Decoder <span class="title">feignDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ObjectFactory&lt;HttpMessageConverters&gt; messageConverters = () -&gt; &#123;</span><br><span class="line">            HttpMessageConverters converters = <span class="keyword">new</span> HttpMessageConverters();</span><br><span class="line">            <span class="keyword">return</span> converters;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringDecoder(messageConverters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解决中文乱码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// @Bean</span></span><br><span class="line">    <span class="comment">// public Encoder encoder() &#123;</span></span><br><span class="line">    <span class="comment">//     return new FormEncoder();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 复制 FeignAutoConfiguration 类的配置。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(&#123;Client<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Client</span> <span class="title">feignClient</span>(<span class="title">OkHttpClient</span> <span class="title">client</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> feign.okhttp.OkHttpClient(client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置 OkHttp3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">okHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">                <span class="comment">// 设置读超时</span></span><br><span class="line">                .readTimeout(<span class="number">60</span>, TimeUnit.SECONDS)</span><br><span class="line">                <span class="comment">// 设置连接超时</span></span><br><span class="line">                .connectTimeout(<span class="number">60</span>, TimeUnit.SECONDS)</span><br><span class="line">                <span class="comment">// 设置写超时</span></span><br><span class="line">                .writeTimeout(<span class="number">120</span>, TimeUnit.SECONDS)</span><br><span class="line">                <span class="comment">// 错误重连</span></span><br><span class="line">                .retryOnConnectionFailure(<span class="keyword">true</span>)</span><br><span class="line">                <span class="comment">// 10个线程，保存5分钟长连接</span></span><br><span class="line">                .connectionPool(<span class="keyword">new</span> ConnectionPool(<span class="number">10</span>, <span class="number">5L</span>, TimeUnit.MINUTES))</span><br><span class="line">                <span class="comment">// 自定义 OkHttpLogInterceptor 或 添加 header</span></span><br><span class="line">                .addInterceptor(<span class="keyword">new</span> Interceptor() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                        Request request = chain.request().newBuilder()</span><br><span class="line">                                .addHeader(<span class="string">"X-Token"</span>, <span class="string">"1"</span>)</span><br><span class="line">                                .build();</span><br><span class="line"></span><br><span class="line">                        log.info(<span class="string">"OkHttpUrl : "</span> + chain.request().url());</span><br><span class="line">                        <span class="keyword">return</span> chain.proceed(request);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义 Feign 拦截器，添加请求头</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestInterceptor <span class="title">feignRequestInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FeignRequestHeaderInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-fastjson-作为默认序列化"><a href="#使用-fastjson-作为默认序列化" class="headerlink" title="使用 fastjson 作为默认序列化"></a>使用 fastjson 作为默认序列化</h3><p>pom.xml 添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.68<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：想要使 SerializerFeature 配置生效，Client 接口(FeignUserService)的返回值要是 Object 或者 JSONObject，返回 Bean 是不生效的。懒的抽离了，直接把我用到的 Feign 配置所有文件贴上。</strong></p>
<p>修改 FeignConfig 配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.support.config.FastJsonConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.support.spring.FastJsonHttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.support.springfox.SwaggerJsonSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.json.JsonMapper;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.exception.HystrixBadRequestException;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.interceptor.FeignRequestHeaderInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.interceptor.OkHttpLogInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.logger.OkHttpSlf4jLogger;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.ssl.DisableValidationTrustManager;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.ssl.TrustAllHostNames;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.utils.Holder;</span><br><span class="line"><span class="keyword">import</span> feign.Client;</span><br><span class="line"><span class="keyword">import</span> feign.Feign;</span><br><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> feign.RequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> feign.Response;</span><br><span class="line"><span class="keyword">import</span> feign.codec.Decoder;</span><br><span class="line"><span class="keyword">import</span> feign.codec.Encoder;</span><br><span class="line"><span class="keyword">import</span> feign.codec.ErrorDecoder;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> okhttp3.ConnectionPool;</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.http.HttpMessageConverters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.ResponseEntityDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.SpringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.SpringEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManager;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.X509TrustManager;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyManagementException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置 Feign</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Richard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020.02.17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(Feign<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(<span class="title">FeignAutoConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnWebApplication</span>(<span class="title">type</span> </span>= ConditionalOnWebApplication.Type.SERVLET)</span><br><span class="line"><span class="meta">@Import</span>(value = &#123;OkHttpProps<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">Slf4j</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">FeignOkHttpConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OkHttpProps okHttpProps;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据实际情况选择合适的日志 level</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	/**</span></span><br><span class="line"><span class="comment">//	 * 自定义反序列化解析器</span></span><br><span class="line"><span class="comment">//	 *</span></span><br><span class="line"><span class="comment">//	 * @return</span></span><br><span class="line"><span class="comment">//	 */</span></span><br><span class="line"><span class="comment">//	@Bean</span></span><br><span class="line"><span class="comment">//	public Decoder feignDecoder() &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//		ObjectFactory&lt;HttpMessageConverters&gt; messageConverters = () -&gt; &#123;</span></span><br><span class="line"><span class="comment">//			HttpMessageConverters converters = new HttpMessageConverters();</span></span><br><span class="line"><span class="comment">//			return converters;</span></span><br><span class="line"><span class="comment">//		&#125;;</span></span><br><span class="line"><span class="comment">//		return new SpringDecoder(messageConverters);</span></span><br><span class="line"><span class="comment">//	&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Encoder <span class="title">feignEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SpringEncoder(feignHttpMessageConverter());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Decoder <span class="title">feignDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SpringDecoder(feignHttpMessageConverter());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	@Bean</span></span><br><span class="line"><span class="comment">//	public SpringEncoder feignEncoder() &#123;</span></span><br><span class="line"><span class="comment">//		return new SpringEncoder(feignHttpMessageConverter());</span></span><br><span class="line"><span class="comment">//	&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//	@Bean</span></span><br><span class="line"><span class="comment">//	public ResponseEntityDecoder feignDecoder() &#123;</span></span><br><span class="line"><span class="comment">//		return new ResponseEntityDecoder(new SpringDecoder(feignHttpMessageConverter()));</span></span><br><span class="line"><span class="comment">//	&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 设置解码器为 fastjson</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> ObjectFactory&lt;HttpMessageConverters&gt; <span class="title">feignHttpMessageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> HttpMessageConverters httpMessageConverters = <span class="keyword">new</span> HttpMessageConverters(<span class="keyword">this</span>.getFastJsonConverter());</span><br><span class="line">		<span class="keyword">return</span> () -&gt; httpMessageConverters;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> FastJsonHttpMessageConverter <span class="title">getFastJsonConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 创建fastJson消息转换器</span></span><br><span class="line">		FastJsonHttpMessageConverter converter = <span class="keyword">new</span> FastJsonHttpMessageConverter();</span><br><span class="line"></span><br><span class="line">		List&lt;MediaType&gt; supportedMediaTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		supportedMediaTypes.add(MediaType.APPLICATION_JSON);</span><br><span class="line">		supportedMediaTypes.add(MediaType.APPLICATION_JSON_UTF8);</span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.APPLICATION_ATOM_XML);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.APPLICATION_FORM_URLENCODED);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.APPLICATION_OCTET_STREAM);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.APPLICATION_PDF);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.APPLICATION_RSS_XML);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.APPLICATION_XHTML_XML);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.APPLICATION_XML);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.IMAGE_GIF);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.IMAGE_JPEG);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.IMAGE_PNG);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.TEXT_EVENT_STREAM);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.TEXT_HTML);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.TEXT_MARKDOWN);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.TEXT_PLAIN);</span></span><br><span class="line"><span class="comment">//		supportedMediaTypes.add(MediaType.TEXT_XML);</span></span><br><span class="line">		converter.setSupportedMediaTypes(supportedMediaTypes);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 创建配置类</span></span><br><span class="line">		FastJsonConfig fastJsonConfig = <span class="keyword">new</span> FastJsonConfig();</span><br><span class="line">		<span class="comment">// 修改配置返回内容的过滤</span></span><br><span class="line">		<span class="comment">// WriteNullListAsEmpty：List 字段如果为 null, 输出为 [], 而非 null</span></span><br><span class="line">		<span class="comment">// WriteNullStringAsEmpty： 字符类型字段如果为 null, 输出为 "", 而非 null</span></span><br><span class="line">		<span class="comment">// DisableCircularReferenceDetect：消除对同一对象循环引用的问题，默认为 false（如果不配置有可能会进入死循环）</span></span><br><span class="line">		<span class="comment">// WriteNullBooleanAsFalse：Boolean 字段如果为 null, 输出为 false, 而非 null</span></span><br><span class="line">		<span class="comment">// WriteMapNullValue：是否输出值为 null 的字段,默认为 false</span></span><br><span class="line">		<span class="comment">// WriteDateUseDateFormat：时期格式格式化为 yyyy-MM-dd HH:mm:ss</span></span><br><span class="line">		fastJsonConfig.getSerializeConfig().put(JSON<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">SwaggerJsonSerializer</span>())</span>;</span><br><span class="line">		fastJsonConfig.setSerializerFeatures(</span><br><span class="line">			  <span class="comment">// 禁用循环引用</span></span><br><span class="line">				SerializerFeature.DisableCircularReferenceDetect,</span><br><span class="line">				SerializerFeature.WriteDateUseDateFormat,</span><br><span class="line">				SerializerFeature.WriteMapNullValue,</span><br><span class="line">				SerializerFeature.WriteNullNumberAsZero</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		converter.setFastJsonConfig(fastJsonConfig);</span><br><span class="line">		<span class="keyword">return</span> converter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(&#123;Client<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">	<span class="title">public</span> <span class="title">Client</span> <span class="title">feignClient</span>(<span class="title">OkHttpClient</span> <span class="title">client</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> feign.okhttp.OkHttpClient(client);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 日志拦截器</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> OkHttpLogInterceptor <span class="title">loggingInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		OkHttpLogInterceptor interceptor = <span class="keyword">new</span> OkHttpLogInterceptor(<span class="keyword">new</span> OkHttpSlf4jLogger());</span><br><span class="line">		interceptor.setLevel(okHttpProps.getLevel());</span><br><span class="line">		<span class="keyword">return</span> interceptor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 配置 OkHttp3</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">okHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> maxTotalConnections = okHttpProps.getMaxConnections();</span><br><span class="line">		<span class="keyword">long</span> timeToLive = okHttpProps.getTimeToLive();</span><br><span class="line">		TimeUnit ttlUnit = okHttpProps.getTimeUnit();</span><br><span class="line">		ConnectionPool connectionPool = <span class="keyword">new</span> ConnectionPool(maxTotalConnections, timeToLive, ttlUnit);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> createBuilder(okHttpProps.isDisableSslValidation())</span><br><span class="line">				<span class="comment">// 设置连接超时</span></span><br><span class="line">				.connectTimeout(okHttpProps.getConnectionTimeout(), ttlUnit)</span><br><span class="line">				<span class="comment">// 设置读超时</span></span><br><span class="line">				.readTimeout(okHttpProps.getReadTimeout(), ttlUnit)</span><br><span class="line">				<span class="comment">// 设置写超时</span></span><br><span class="line">				.writeTimeout(okHttpProps.getWriteTimeout(), ttlUnit)</span><br><span class="line">				<span class="comment">// 是否支持重定向</span></span><br><span class="line">				.followRedirects(okHttpProps.isFollowRedirects())</span><br><span class="line">				<span class="comment">// 错误重连</span></span><br><span class="line">				.retryOnConnectionFailure(okHttpProps.isRetryOnConnectionFailure())</span><br><span class="line">				<span class="comment">// 连接池</span></span><br><span class="line">				.connectionPool(connectionPool)</span><br><span class="line">				<span class="comment">// 拦截器</span></span><br><span class="line">				.addInterceptor(loggingInterceptor())</span><br><span class="line">				.build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 构建 SSL</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> disableSslValidation</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> OkHttpClient.<span class="function">Builder <span class="title">createBuilder</span><span class="params">(<span class="keyword">boolean</span> disableSslValidation)</span> </span>&#123;</span><br><span class="line">		OkHttpClient.Builder builder = <span class="keyword">new</span> OkHttpClient.Builder();</span><br><span class="line">		<span class="keyword">if</span> (disableSslValidation) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				X509TrustManager disabledTrustManager = DisableValidationTrustManager.INSTANCE;</span><br><span class="line">				TrustManager[] trustManagers = <span class="keyword">new</span> TrustManager[]&#123;disabledTrustManager&#125;;</span><br><span class="line">				SSLContext sslContext = SSLContext.getInstance(<span class="string">"SSL"</span>);</span><br><span class="line">				sslContext.init(<span class="keyword">null</span>, trustManagers, Holder.SECURE_RANDOM);</span><br><span class="line">				SSLSocketFactory disabledSslSocketFactory = sslContext.getSocketFactory();</span><br><span class="line">				builder.sslSocketFactory(disabledSslSocketFactory, disabledTrustManager);</span><br><span class="line">				builder.hostnameVerifier(TrustAllHostNames.INSTANCE);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (NoSuchAlgorithmException | KeyManagementException e) &#123;</span><br><span class="line">				log.warn(<span class="string">"Error setting SSLSocketFactory in OKHttpClient"</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> builder;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 定义 Feign 拦截器，添加请求头</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RequestInterceptor <span class="title">feignRequestInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FeignRequestHeaderInterceptor();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 自定义错误</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="comment">//	@Bean</span></span><br><span class="line"><span class="comment">//	public ErrorDecoder errorDecoder() &#123;</span></span><br><span class="line"><span class="comment">//		return new UserErrorDecoder();</span></span><br><span class="line"><span class="comment">//	&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 自定义错误</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="comment">//	public class UserErrorDecoder implements ErrorDecoder &#123;</span></span><br><span class="line"><span class="comment">//		private Logger logger = LoggerFactory.getLogger(getClass());</span></span><br><span class="line"><span class="comment">//		@Override</span></span><br><span class="line"><span class="comment">//		public Exception decode(String methodKey, Response response) &#123;</span></span><br><span class="line"><span class="comment">//			Exception exception = null;</span></span><br><span class="line"><span class="comment">//			try &#123;</span></span><br><span class="line"><span class="comment">//				String json = Util.toString(response.body().asReader());</span></span><br><span class="line"><span class="comment">//				exception = new RuntimeException(json);</span></span><br><span class="line"><span class="comment">//				Result result = JsonMapper.nonEmptyMapper().fromJson(json, Result.class);</span></span><br><span class="line"><span class="comment">//				// 业务异常包装成 HystrixBadRequestException，不进入熔断逻辑</span></span><br><span class="line"><span class="comment">//				if (!result.isSuccess()) &#123;</span></span><br><span class="line"><span class="comment">//					exception = new HystrixBadRequestException(result.getMessage());</span></span><br><span class="line"><span class="comment">//				&#125;</span></span><br><span class="line"><span class="comment">//			&#125; catch (IOException ex) &#123;</span></span><br><span class="line"><span class="comment">//				logger.error(ex.getMessage(), ex);</span></span><br><span class="line"><span class="comment">//			&#125;</span></span><br><span class="line"><span class="comment">//			return exception;</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//	&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FeignRequestHeaderInterceptor.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.context.AuthContext;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.bo.UserInfoBo;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.constant.AuthConstant;</span><br><span class="line"><span class="keyword">import</span> com.leo.common.utils.OkHttpUtil;</span><br><span class="line"><span class="keyword">import</span> feign.RequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> feign.RequestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Feign 请求拦截器（设置请求头，传递请求参数）</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 服务间进行 Feign 调用时，不会传递请求头信息。通过实现 RequestInterceptor 接口，完成对所有的 Feign 请求，传递请求头和请求参数。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Richard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020.02.19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignRequestHeaderInterceptor</span> <span class="keyword">implements</span> <span class="title">RequestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestTemplate requestTemplate)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Feign 请求拦截器（设置请求头，传递请求参数）</span></span><br><span class="line">		ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">null</span> != attributes) &#123;</span><br><span class="line">			HttpServletRequest request = attributes.getRequest();</span><br><span class="line">			Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</span><br><span class="line">			<span class="keyword">if</span> (headerNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">while</span> (headerNames.hasMoreElements()) &#123;</span><br><span class="line">					String name = headerNames.nextElement();</span><br><span class="line">					String values = request.getHeader(name);</span><br><span class="line">					requestTemplate.header(name, values);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 传递上下文中的用户信息</span></span><br><span class="line">		UserInfoBo userInfoBo = AuthContext.getUser();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">null</span> != userInfoBo) &#123;</span><br><span class="line">			requestTemplate.header(AuthConstant.CURRENT_USER_HEADER, OkHttpUtil.getValueEncoded(JSON.toJSONString(userInfoBo)));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OkHttpUtil.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Richard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020.02.28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 由于 OkHttp header 中的 value 不支持 null, \n 和 中文这样的特殊字符,所以这里</span></span><br><span class="line"><span class="comment">	 * 会首先替换 \n ,然后使用 OkHttp 的校验方式,校验不通过的话,就返回 encode 后的字符串</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getValueEncoded</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (value == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="string">"null"</span>;</span><br><span class="line">		String newValue = value.replace(<span class="string">"\n"</span>, <span class="string">""</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, length = newValue.length(); i &lt; length; i++) &#123;</span><br><span class="line">			<span class="keyword">char</span> c = newValue.charAt(i);</span><br><span class="line">			<span class="keyword">if</span> (c &lt;= <span class="string">'\u001f'</span> || c &gt;= <span class="string">'\u007f'</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> URLEncoder.encode(newValue, <span class="string">"UTF-8"</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> newValue;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 由于 OkHttp header 中的 value 不支持 null, \n 和 中文这样的特殊字符</span></span><br><span class="line"><span class="comment">	 * 上游传输时进行了编码，获取需要解码</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getValueDecode</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="string">"null"</span>.equals(value)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> URLDecoder.decode(value, <span class="string">"UTF-8"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OkHttpLogInterceptor.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.leo.common.emum.OkHttpLogLevelEnum;</span><br><span class="line"><span class="keyword">import</span> okhttp3.*;</span><br><span class="line"><span class="keyword">import</span> okhttp3.internal.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> okio.Buffer;</span><br><span class="line"><span class="keyword">import</span> okio.BufferedSource;</span><br><span class="line"><span class="keyword">import</span> okio.GzipSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.EOFException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OkHttp log</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Richard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020.02.28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpLogInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset UTF8 = StandardCharsets.UTF_8;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Logger logger;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> OkHttpLogLevelEnum level = OkHttpLogLevelEnum.NONE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * log</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@param</span> message message</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">log</span><span class="params">(String message)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OkHttpLogInterceptor</span><span class="params">(Logger logger)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.logger = logger;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Change the level at which this interceptor logs.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> level log Level</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> HttpLoggingInterceptor</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> OkHttpLogInterceptor <span class="title">setLevel</span><span class="params">(OkHttpLogLevelEnum level)</span> </span>&#123;</span><br><span class="line">		Objects.requireNonNull(level, <span class="string">"level == null. Use Level.NONE instead."</span>);</span><br><span class="line">		<span class="keyword">this</span>.level = level;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> OkHttpLogLevelEnum <span class="title">getLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> level;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		OkHttpLogLevelEnum level = <span class="keyword">this</span>.level;</span><br><span class="line"></span><br><span class="line">		Request request = chain.request();</span><br><span class="line">		<span class="keyword">if</span> (level == OkHttpLogLevelEnum.NONE) &#123;</span><br><span class="line">			<span class="keyword">return</span> chain.proceed(request);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">boolean</span> logBody = level == OkHttpLogLevelEnum.BODY;</span><br><span class="line">		<span class="keyword">boolean</span> logHeaders = logBody || level == OkHttpLogLevelEnum.HEADERS;</span><br><span class="line"></span><br><span class="line">		RequestBody requestBody = request.body();</span><br><span class="line">		<span class="keyword">boolean</span> hasRequestBody = requestBody != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		Connection connection = chain.connection();</span><br><span class="line">		String requestStartMessage = <span class="string">"--&gt; "</span></span><br><span class="line">				+ request.method()</span><br><span class="line">				+ <span class="string">' '</span> + request.url()</span><br><span class="line">				+ (connection != <span class="keyword">null</span> ? <span class="string">" "</span> + connection.protocol() : <span class="string">""</span>);</span><br><span class="line">		<span class="keyword">if</span> (!logHeaders &amp;&amp; hasRequestBody) &#123;</span><br><span class="line">			requestStartMessage += <span class="string">" ("</span> + requestBody.contentLength() + <span class="string">"-byte body)"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		logger.log(requestStartMessage);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (logHeaders) &#123;</span><br><span class="line">			<span class="keyword">if</span> (hasRequestBody) &#123;</span><br><span class="line">				<span class="comment">// Request body headers are only present when installed as a network interceptor. Force</span></span><br><span class="line">				<span class="comment">// them to be included (when available) so there values are known.</span></span><br><span class="line">				<span class="keyword">if</span> (requestBody.contentType() != <span class="keyword">null</span>) &#123;</span><br><span class="line">					logger.log(<span class="string">"Content-Type: "</span> + requestBody.contentType());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (requestBody.contentLength() != -<span class="number">1</span>) &#123;</span><br><span class="line">					logger.log(<span class="string">"Content-Length: "</span> + requestBody.contentLength());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			Headers headers = request.headers();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = headers.size(); i &lt; count; i++) &#123;</span><br><span class="line">				String name = headers.name(i);</span><br><span class="line">				<span class="comment">// Skip headers from the request body as they are explicitly logged above.</span></span><br><span class="line">				<span class="keyword">if</span> (!<span class="string">"Content-Type"</span>.equalsIgnoreCase(name) &amp;&amp; !<span class="string">"Content-Length"</span>.equalsIgnoreCase(name)) &#123;</span><br><span class="line">					logger.log(name + <span class="string">": "</span> + headers.value(i));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!logBody || !hasRequestBody) &#123;</span><br><span class="line">				logger.log(<span class="string">"--&gt; END "</span> + request.method());</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (bodyHasUnknownEncoding(request.headers())) &#123;</span><br><span class="line">				logger.log(<span class="string">"--&gt; END "</span> + request.method() + <span class="string">" (encoded body omitted)"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				Buffer buffer = <span class="keyword">new</span> Buffer();</span><br><span class="line">				requestBody.writeTo(buffer);</span><br><span class="line"></span><br><span class="line">				Charset charset = UTF8;</span><br><span class="line">				MediaType contentType = requestBody.contentType();</span><br><span class="line">				<span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">					charset = contentType.charset(UTF8);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				logger.log(<span class="string">""</span>);</span><br><span class="line">				<span class="keyword">if</span> (isPlaintext(buffer)) &#123;</span><br><span class="line">					logger.log(buffer.readString(charset));</span><br><span class="line">					logger.log(<span class="string">"--&gt; END "</span> + request.method()</span><br><span class="line">							+ <span class="string">" ("</span> + requestBody.contentLength() + <span class="string">"-byte body)"</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					logger.log(<span class="string">"--&gt; END "</span> + request.method() + <span class="string">" (binary "</span></span><br><span class="line">							+ requestBody.contentLength() + <span class="string">"-byte body omitted)"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">long</span> startNs = System.nanoTime();</span><br><span class="line">		Response response;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			response = chain.proceed(request);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			logger.log(<span class="string">"&lt;-- HTTP FAILED: "</span> + e);</span><br><span class="line">			<span class="keyword">throw</span> e;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">long</span> tookMs = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startNs);</span><br><span class="line"></span><br><span class="line">		ResponseBody responseBody = response.body();</span><br><span class="line">		<span class="keyword">long</span> contentLength = responseBody.contentLength();</span><br><span class="line">		String bodySize = contentLength != -<span class="number">1</span> ? contentLength + <span class="string">"-byte"</span> : <span class="string">"unknown-length"</span>;</span><br><span class="line">		logger.log(<span class="string">"&lt;-- "</span></span><br><span class="line">				+ response.code()</span><br><span class="line">				+ (response.message().isEmpty() ? <span class="string">""</span> : <span class="string">' '</span> + response.message())</span><br><span class="line">				+ <span class="string">' '</span> + response.request().url()</span><br><span class="line">				+ <span class="string">" ("</span> + tookMs + <span class="string">"ms"</span> + (!logHeaders ? <span class="string">", "</span> + bodySize + <span class="string">" body"</span> : <span class="string">""</span>) + <span class="string">')'</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (logHeaders) &#123;</span><br><span class="line">			Headers headers = response.headers();</span><br><span class="line">			<span class="keyword">int</span> count = headers.size();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">				logger.log(headers.name(i) + <span class="string">": "</span> + headers.value(i));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!logBody || !HttpHeaders.hasBody(response)) &#123;</span><br><span class="line">				logger.log(<span class="string">"&lt;-- END HTTP"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (bodyHasUnknownEncoding(response.headers())) &#123;</span><br><span class="line">				logger.log(<span class="string">"&lt;-- END HTTP (encoded body omitted)"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				BufferedSource source = responseBody.source();</span><br><span class="line">				<span class="comment">// Buffer the entire body.</span></span><br><span class="line">				source.request(Long.MAX_VALUE);</span><br><span class="line">				Buffer buffer = source.buffer();</span><br><span class="line"></span><br><span class="line">				Long gzippedLength = <span class="keyword">null</span>;</span><br><span class="line">				<span class="keyword">if</span> (<span class="string">"gzip"</span>.equalsIgnoreCase(headers.get(<span class="string">"Content-Encoding"</span>))) &#123;</span><br><span class="line">					gzippedLength = buffer.size();</span><br><span class="line">					GzipSource gzippedResponseBody = <span class="keyword">null</span>;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						gzippedResponseBody = <span class="keyword">new</span> GzipSource(buffer.clone());</span><br><span class="line">						buffer = <span class="keyword">new</span> Buffer();</span><br><span class="line">						buffer.writeAll(gzippedResponseBody);</span><br><span class="line">					&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> (gzippedResponseBody != <span class="keyword">null</span>) &#123;</span><br><span class="line">							gzippedResponseBody.close();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				Charset charset = UTF8;</span><br><span class="line">				MediaType contentType = responseBody.contentType();</span><br><span class="line">				<span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">					charset = contentType.charset(UTF8);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (!isPlaintext(buffer)) &#123;</span><br><span class="line">					logger.log(<span class="string">""</span>);</span><br><span class="line">					logger.log(<span class="string">"&lt;-- END HTTP (binary "</span> + buffer.size() + <span class="string">"-byte body omitted)"</span>);</span><br><span class="line">					<span class="keyword">return</span> response;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (contentLength != <span class="number">0</span>) &#123;</span><br><span class="line">					logger.log(<span class="string">""</span>);</span><br><span class="line">					logger.log(buffer.clone().readString(charset));</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (gzippedLength != <span class="keyword">null</span>) &#123;</span><br><span class="line">					logger.log(<span class="string">"&lt;-- END HTTP ("</span> + buffer.size() + <span class="string">"-byte, "</span></span><br><span class="line">							+ gzippedLength + <span class="string">"-gzipped-byte body)"</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					logger.log(<span class="string">"&lt;-- END HTTP ("</span> + buffer.size() + <span class="string">"-byte body)"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> response;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns true if the body in question probably contains human readable text. Uses a small sample</span></span><br><span class="line"><span class="comment">	 * of code points to detect unicode control characters commonly used in binary file signatures.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isPlaintext</span><span class="params">(Buffer buffer)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Buffer prefix = <span class="keyword">new</span> Buffer();</span><br><span class="line">			<span class="keyword">long</span> byteCount = buffer.size() &lt; <span class="number">64</span> ? buffer.size() : <span class="number">64</span>;</span><br><span class="line">			buffer.copyTo(prefix, <span class="number">0</span>, byteCount);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">				<span class="keyword">if</span> (prefix.exhausted()) &#123;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">int</span> codePoint = prefix.readUtf8CodePoint();</span><br><span class="line">				<span class="keyword">if</span> (Character.isISOControl(codePoint) &amp;&amp; !Character.isWhitespace(codePoint)) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (EOFException e) &#123;</span><br><span class="line">			<span class="comment">// Truncated UTF-8 sequence.</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bodyHasUnknownEncoding</span><span class="params">(Headers headers)</span> </span>&#123;</span><br><span class="line">		String contentEncoding = headers.get(<span class="string">"Content-Encoding"</span>);</span><br><span class="line">		<span class="keyword">return</span> contentEncoding != <span class="keyword">null</span></span><br><span class="line">				&amp;&amp; !<span class="string">"identity"</span>.equalsIgnoreCase(contentEncoding)</span><br><span class="line">				&amp;&amp; !<span class="string">"gzip"</span>.equalsIgnoreCase(contentEncoding);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OkHttpLogLevelEnum.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OkHttp 请求日志级别</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Richard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020.02.28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> OkHttpLogLevelEnum &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * No logs.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	NONE(<span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Logs request and response lines.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Example:</span></span><br><span class="line"><span class="comment">	 * &lt;pre&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">	 * --&gt; POST /greeting http/1.1 (3-byte body)</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * &lt;-- 200 OK (22ms, 6-byte body)</span></span><br><span class="line"><span class="comment">	 * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	BASIC(<span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Logs request and response lines and their respective headers.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Example:</span></span><br><span class="line"><span class="comment">	 * &lt;pre&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">	 * --&gt; POST /greeting http/1.1</span></span><br><span class="line"><span class="comment">	 * Host: example.com</span></span><br><span class="line"><span class="comment">	 * Content-Type: plain/text</span></span><br><span class="line"><span class="comment">	 * Content-Length: 3</span></span><br><span class="line"><span class="comment">	 * --&gt; END POST</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * &lt;-- 200 OK (22ms)</span></span><br><span class="line"><span class="comment">	 * Content-Type: plain/text</span></span><br><span class="line"><span class="comment">	 * Content-Length: 6</span></span><br><span class="line"><span class="comment">	 * &lt;-- END HTTP</span></span><br><span class="line"><span class="comment">	 * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	HEADERS(<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Logs request and response lines and their respective headers and bodies (if present).</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Example:</span></span><br><span class="line"><span class="comment">	 * &lt;pre&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment">	 * --&gt; POST /greeting http/1.1</span></span><br><span class="line"><span class="comment">	 * Host: example.com</span></span><br><span class="line"><span class="comment">	 * Content-Type: plain/text</span></span><br><span class="line"><span class="comment">	 * Content-Length: 3</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Hi?</span></span><br><span class="line"><span class="comment">	 * --&gt; END POST</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * &lt;-- 200 OK (22ms)</span></span><br><span class="line"><span class="comment">	 * Content-Type: plain/text</span></span><br><span class="line"><span class="comment">	 * Content-Length: 6</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Hello!</span></span><br><span class="line"><span class="comment">	 * &lt;-- END HTTP</span></span><br><span class="line"><span class="comment">	 * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	BODY(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 请求日志配置前缀</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REQ_LOG_PROPS_PREFIX = <span class="string">"okhttp.log.request"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 控制台日志是否启用</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONSOLE_LOG_ENABLED_PROP = <span class="string">"okhttp.log.console.enabled"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 级别</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> level;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 当前版本 小于和等于 比较的版本</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> level LogLevel</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 是否小于和等于</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lte</span><span class="params">(OkHttpLogLevelEnum level)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.level &lt;= level.level;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OkHttpSlf4jLogger.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.leo.common.interceptor.OkHttpLogInterceptor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OkHttp Slf4j logger</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Richard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020.02.28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpSlf4jLogger</span> <span class="keyword">implements</span> <span class="title">OkHttpLogInterceptor</span>.<span class="title">Logger</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">		log.info(message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DisableValidationTrustManager.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.net.ssl.X509TrustManager;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不进行证书校验</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Richard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020.02.28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DisableValidationTrustManager</span> <span class="keyword">implements</span> <span class="title">X509TrustManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> X509TrustManager INSTANCE = <span class="keyword">new</span> DisableValidationTrustManager();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkClientTrusted</span><span class="params">(X509Certificate[] x509Certificates, String s)</span> <span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkServerTrusted</span><span class="params">(X509Certificate[] x509Certificates, String s)</span> <span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> X509Certificate[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TrustAllHostNames.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.net.ssl.HostnameVerifier;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSession;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 信任所有 host name</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Richard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020.02.28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrustAllHostNames</span> <span class="keyword">implements</span> <span class="title">HostnameVerifier</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> TrustAllHostNames INSTANCE = <span class="keyword">new</span> TrustAllHostNames();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(String s, SSLSession sslSession)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Holder.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一些常用的单例对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Richard</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020.02.28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * RANDOM</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Random RANDOM = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * SECURE_RANDOM</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> SecureRandom SECURE_RANDOM = <span class="keyword">new</span> SecureRandom();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="支持以form表单形式提交数据（application-x-www-form-urlencoded）"><a href="#支持以form表单形式提交数据（application-x-www-form-urlencoded）" class="headerlink" title="支持以form表单形式提交数据（application/x-www-form-urlencoded）"></a>支持以form表单形式提交数据（application/x-www-form-urlencoded）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> feign.codec.Encoder;</span><br><span class="line"><span class="keyword">import</span> feign.form.FormEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.http.HttpMessageConverters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignLoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.SpringEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Scope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"service-a"</span>, configuration = TestFeignClient.FormSupportConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">TestFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/test"</span>,</span><br><span class="line">			consumes = &#123;MediaType.APPLICATION_FORM_URLENCODED_VALUE&#125;,</span><br><span class="line">			produces = &#123;MediaType.APPLICATION_JSON_UTF8_VALUE&#125;</span><br><span class="line">	)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(Map&lt;String, ?&gt; queryParam)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">FormSupportConfig</span> </span>&#123;</span><br><span class="line">		<span class="meta">@Autowired</span></span><br><span class="line">		<span class="keyword">private</span> ObjectFactory&lt;HttpMessageConverters&gt; messageConverters;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		Logger.<span class="function">Level <span class="title">feignLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	@Bean</span></span><br><span class="line">	<span class="comment">//	FeignLoggerFactory infoFeignLoggerFactory() &#123;</span></span><br><span class="line">	<span class="comment">//		return new InfoFeignLoggerFactory();</span></span><br><span class="line">	<span class="comment">//	&#125;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* new一个form编码器，实现支持form表单提交</span></span><br><span class="line"><span class="comment">		* 注意这里方法名称，也就是bean的名称是什么不重要，</span></span><br><span class="line"><span class="comment">		* 重要的是返回类型要是 Encoder 并且实现类必须是 FormEncoder 或者其子类</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">		<span class="function"><span class="keyword">public</span> Encoder <span class="title">feignFormEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> FormEncoder(<span class="keyword">new</span> SpringEncoder(<span class="keyword">this</span>.messageConverters));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="与-Spring-Cloud-Gateway-整合问题"><a href="#与-Spring-Cloud-Gateway-整合问题" class="headerlink" title="与 Spring Cloud Gateway 整合问题"></a>与 Spring Cloud Gateway 整合问题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feign.codec.DecodeException: No qualifying bean of type &#39;org.springframework.boot.autoconfigure.http.HttpMessageConverters&#39; available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: &#123;@org.springframework.beans.factory.annotation.Autowired(required&#x3D;true)&#125;</span><br></pre></td></tr></table></figure>

<p>解决：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignResponseDecoderConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Decoder <span class="title">feignDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ObjectFactory&lt;HttpMessageConverters&gt; messageConverters = () -&gt; &#123;</span><br><span class="line">            HttpMessageConverters converters = <span class="keyword">new</span> HttpMessageConverters();</span><br><span class="line">            <span class="keyword">return</span> converters;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringDecoder(messageConverters);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/spring-cloud/spring-cloud-openfeign/issues/235" target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-openfeign/issues/235</a></p>
</blockquote>
<h3 id="RequestParam-无法获取参数"><a href="#RequestParam-无法获取参数" class="headerlink" title="@RequestParam 无法获取参数"></a>@RequestParam 无法获取参数</h3><p>Client 接口中用 @RequestParam 是无法绑定参数的，必须写 name，@RequestParam(“paramName”)。@RequestBody 可以正常获取。</p>
<h3 id="启用-hystrix-后-RequestContextHolder-getRequestAttributes-返回-null"><a href="#启用-hystrix-后-RequestContextHolder-getRequestAttributes-返回-null" class="headerlink" title="启用 hystrix 后 RequestContextHolder.getRequestAttributes(); 返回 null"></a>启用 hystrix 后 RequestContextHolder.getRequestAttributes(); 返回 null</h3><p>hystrix 默认使用多线程管理请求连接池，从主线程到发送基于hystrix的feign请求线程已不在同一个线程内，而RequestContextHolder是基于ThreadLocal实现的，这就使得线程之间数据断链，需要通过线程之间的数据传递使得ThreadLocal中存储的currentRequestAttributes接上。</p>
<p><strong>解决方案一：调整隔离策略</strong></p>
<p>将隔离策略设为SEMAPHORE即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix.command.default.execution.isolation.strategy:</span> <span class="string">SEMAPHORE</span></span><br></pre></td></tr></table></figure>

<p>这样配置后，Feign可以正常工作。但该方案不是特别好。原因是Hystrix官方强烈建议使用THREAD作为隔离策略！</p>
<blockquote>
<p>Thread or Semaphore</p>
<p>The default, and the recommended setting, is to run HystrixCommands using thread isolation (THREAD) and HystrixObservableCommands using semaphore isolation (SEMAPHORE).</p>
<p>Commands executed in threads have an extra layer of protection against latencies beyond what network timeouts can offer.</p>
<p>Generally the only time you should use semaphore isolation for HystrixCommands is when the call is so high volume (hundreds per second, per instance) that the overhead of separate threads is too high; this typically only applies to non-network calls.</p>
</blockquote>
<p><strong>解决方案二：自定义并发策略</strong></p>
<p>既然Hystrix不太建议使用SEMAPHORE作为隔离策略，那么是否有其他方案呢？答案是自定义并发策略，目前，Spring Cloud Sleuth以及Spring Security都通过该方式传递 ThreadLocal 对象。</p>
<p>下面我们来编写自定义的并发策略。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestAttributeHystrixConcurrencyStrategy</span> <span class="keyword">extends</span> <span class="title">HystrixConcurrencyStrategy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(RequestHystrixConcurrencyStrategy<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestHystrixConcurrencyStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HystrixPlugins.reset();</span><br><span class="line">        HystrixPlugins.getInstance().registerConcurrencyStrategy(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Callable&lt;T&gt; <span class="title">wrapCallable</span><span class="params">(Callable&lt;T&gt; callable)</span> </span>&#123;</span><br><span class="line">        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WrappedCallable&lt;&gt;(callable, requestAttributes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WrappedCallable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Callable&lt;T&gt; target;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> RequestAttributes requestAttributes;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WrappedCallable</span><span class="params">(Callable&lt;T&gt; target, RequestAttributes requestAttributes)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.target = target;</span><br><span class="line">            <span class="keyword">this</span>.requestAttributes = requestAttributes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                RequestContextHolder.setRequestAttributes(requestAttributes);</span><br><span class="line">                <span class="keyword">return</span> target.call();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                RequestContextHolder.resetRequestAttributes();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如代码所示，我们编写了一个RequestHystrixConcurrencyStrategy ，在其中：</p>
<ul>
<li>wrapCallable 方法拿到 <code>RequestContextHolder.getRequestAttributes()</code> ，也就是我们想传播的对象；</li>
<li>在 WrappedCallable 类中，我们将要传播的对象作为成员变量，并在其中的call方法中，为静态方法设值。</li>
<li>这样，在Hystrix包裹的方法中，就可以使用<code>RequestContextHolder.getRequestAttributes()</code> 获取到相关属性——也就是说，可以拿到RequestContextHolder 中的ThreadLocal 属性。</li>
</ul>
<p>经过测试，代码能正常工作。</p>
<p><strong>新的问题</strong></p>
<p>至此，我们已经实现了ThreadLocal 属性的传递，然而Hystrix只允许有一个并发策略！这意味着——如果不做任何处理，Sleuth、Spring Security将无法正常拿到上下文！（上文说过，目前Sleuth、Spring Security都是通过自定义并发策略的方式来传递ThreadLocal对象的。）</p>
<p>如何解决这个问题呢？</p>
<p>我们知道，Spring Cloud中，Spring Cloud Security与Spring Cloud Sleuth是可以共存的！我们不妨参考下Sleuth以及Spring Security的实现：</p>
<ul>
<li>Sleuth:<code>org.springframework.cloud.sleuth.instrument.hystrix.SleuthHystrixConcurrencyStrategy</code></li>
<li>SpringSecurity:<code>org.springframework.cloud.netflix.hystrix.security.SecurityContextConcurrencyStrategy</code></li>
</ul>
<p>阅读完后，你将恍然大悟——于是，我们可以模仿它们的写法，改写上文编写的并发策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.netflix.hystrix.HystrixThreadPoolKey;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.HystrixThreadPoolProperties;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.strategy.HystrixPlugins;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.strategy.concurrency.HystrixConcurrencyStrategy;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.strategy.concurrency.HystrixRequestVariable;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.strategy.concurrency.HystrixRequestVariableLifecycle;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.strategy.eventnotifier.HystrixEventNotifier;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.strategy.executionhook.HystrixCommandExecutionHook;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.strategy.metrics.HystrixMetricsPublisher;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.strategy.properties.HystrixPropertiesStrategy;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.strategy.properties.HystrixProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义隔离策略 解决RequestContextHolder.getRequestAttributes()问题 为null</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomFeignHystrixConcurrencyStrategy</span> <span class="keyword">extends</span> <span class="title">HystrixConcurrencyStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> HystrixConcurrencyStrategy hystrixConcurrencyStrategy;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CustomFeignHystrixConcurrencyStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.hystrixConcurrencyStrategy = HystrixPlugins.getInstance().getConcurrencyStrategy();</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.hystrixConcurrencyStrategy <span class="keyword">instanceof</span> CustomFeignHystrixConcurrencyStrategy) &#123;</span><br><span class="line">				<span class="comment">// Welcome to singleton hell...</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			HystrixCommandExecutionHook commandExecutionHook =</span><br><span class="line">					HystrixPlugins.getInstance().getCommandExecutionHook();</span><br><span class="line">			HystrixEventNotifier eventNotifier = HystrixPlugins.getInstance().getEventNotifier();</span><br><span class="line">			HystrixMetricsPublisher metricsPublisher = HystrixPlugins.getInstance().getMetricsPublisher();</span><br><span class="line">			HystrixPropertiesStrategy propertiesStrategy =</span><br><span class="line">					HystrixPlugins.getInstance().getPropertiesStrategy();</span><br><span class="line">			<span class="keyword">this</span>.logCurrentStateOfHystrixPlugins(eventNotifier, metricsPublisher, propertiesStrategy);</span><br><span class="line">			HystrixPlugins.reset();</span><br><span class="line">			HystrixPlugins.getInstance().registerConcurrencyStrategy(<span class="keyword">this</span>);</span><br><span class="line">			HystrixPlugins.getInstance().registerCommandExecutionHook(commandExecutionHook);</span><br><span class="line">			HystrixPlugins.getInstance().registerEventNotifier(eventNotifier);</span><br><span class="line">			HystrixPlugins.getInstance().registerMetricsPublisher(metricsPublisher);</span><br><span class="line">			HystrixPlugins.getInstance().registerPropertiesStrategy(propertiesStrategy);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(<span class="string">"Failed to register Sleuth Hystrix Concurrency Strategy"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logCurrentStateOfHystrixPlugins</span><span class="params">(HystrixEventNotifier eventNotifier,</span></span></span><br><span class="line"><span class="function"><span class="params">												 HystrixMetricsPublisher metricsPublisher, HystrixPropertiesStrategy propertiesStrategy)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">			log.debug(<span class="string">"Current Hystrix plugins configuration is ["</span> + <span class="string">"concurrencyStrategy ["</span></span><br><span class="line">					+ <span class="keyword">this</span>.hystrixConcurrencyStrategy + <span class="string">"],"</span> + <span class="string">"eventNotifier ["</span> + eventNotifier + <span class="string">"],"</span> + <span class="string">"metricPublisher ["</span></span><br><span class="line">					+ metricsPublisher + <span class="string">"],"</span> + <span class="string">"propertiesStrategy ["</span> + propertiesStrategy + <span class="string">"],"</span> + <span class="string">"]"</span>);</span><br><span class="line">			log.debug(<span class="string">"Registering Sleuth Hystrix Concurrency Strategy."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">Callable&lt;T&gt; <span class="title">wrapCallable</span><span class="params">(Callable&lt;T&gt; callable)</span> </span>&#123;</span><br><span class="line">		RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> WrappedCallable&lt;&gt;(callable, requestAttributes);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ThreadPoolExecutor <span class="title">getThreadPool</span><span class="params">(HystrixThreadPoolKey threadPoolKey,</span></span></span><br><span class="line"><span class="function"><span class="params">											HystrixProperty&lt;Integer&gt; corePoolSize, HystrixProperty&lt;Integer&gt; maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">											HystrixProperty&lt;Integer&gt; keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.hystrixConcurrencyStrategy.getThreadPool(threadPoolKey, corePoolSize, maximumPoolSize, keepAliveTime,</span><br><span class="line">				unit, workQueue);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ThreadPoolExecutor <span class="title">getThreadPool</span><span class="params">(HystrixThreadPoolKey threadPoolKey,</span></span></span><br><span class="line"><span class="function"><span class="params">											HystrixThreadPoolProperties threadPoolProperties)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.hystrixConcurrencyStrategy.getThreadPool(threadPoolKey, threadPoolProperties);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BlockingQueue&lt;Runnable&gt; <span class="title">getBlockingQueue</span><span class="params">(<span class="keyword">int</span> maxQueueSize)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.hystrixConcurrencyStrategy.getBlockingQueue(maxQueueSize);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">HystrixRequestVariable&lt;T&gt; <span class="title">getRequestVariable</span><span class="params">(HystrixRequestVariableLifecycle&lt;T&gt; rv)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.hystrixConcurrencyStrategy.getRequestVariable(rv);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WrappedCallable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Callable&lt;T&gt; target;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> RequestAttributes requestAttributes;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">WrappedCallable</span><span class="params">(Callable&lt;T&gt; target, RequestAttributes requestAttributes)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.target = target;</span><br><span class="line">			<span class="keyword">this</span>.requestAttributes = requestAttributes;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> T <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				RequestContextHolder.setRequestAttributes(requestAttributes);</span><br><span class="line">				<span class="keyword">return</span> target.call();</span><br><span class="line">			&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">				RequestContextHolder.resetRequestAttributes();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单讲解下：</p>
<ul>
<li>将现有的并发策略作为新并发策略的成员变量</li>
<li>在新并发策略中，返回现有并发策略的线程池、Queue。</li>
</ul>
<p>hystrix 配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hystrix配置</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">shareSecurityContext:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">60000</span></span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/OpenFeign/feign/" target="_blank" rel="noopener">https://github.com/OpenFeign/feign/</a></li>
<li><a href="https://cloud.spring.io/spring-cloud-openfeign/reference/html/" target="_blank" rel="noopener">https://cloud.spring.io/spring-cloud-openfeign/reference/html/</a></li>
<li><a href="https://juejin.im/post/5d9c85c3e51d45782c23fab6/" target="_blank" rel="noopener">https://juejin.im/post/5d9c85c3e51d45782c23fab6/</a></li>
<li><a href="http://www.itmuch.com/spring-cloud-sum/hystrix-threadlocal/" target="_blank" rel="noopener">http://www.itmuch.com/spring-cloud-sum/hystrix-threadlocal/</a></li>
<li>《微服务架构实战》</li>
<li>《Spring Boot &amp; Kubernetes 云原生微服务实践》</li>
<li>《从0开始学微服务》</li>
<li>《微服务设计》</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MicroServices/" rel="tag"># MicroServices</a>
              <a href="/tags/SpringCloud/" rel="tag"># SpringCloud</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/back-end/java/spring-cloud-ribbon/" rel="prev" title="微服务架构之客户端负载均衡：Spring Cloud Ribbon">
      <i class="fa fa-chevron-left"></i> 微服务架构之客户端负载均衡：Spring Cloud Ribbon
    </a></div>
      <div class="post-nav-item">
    <a href="/back-end/java/spring-cloud-hystrix/" rel="next" title="微服务架构之服务容错：Spring Cloud Hystrix">
      微服务架构之服务容错：Spring Cloud Hystrix <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#工作原理"><span class="nav-number">1.</span> <span class="nav-text">工作原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境"><span class="nav-number">2.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建一个-feign-service-模块"><span class="nav-number">3.</span> <span class="nav-text">创建一个 feign-service 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Feign-中的服务降级"><span class="nav-number">4.</span> <span class="nav-text">Feign 中的服务降级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志打印功能"><span class="nav-number">5.</span> <span class="nav-text">日志打印功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Feign-的常用配置"><span class="nav-number">6.</span> <span class="nav-text">Feign 的常用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#feign不过注册中心子系统联调的方法-开发环境常用"><span class="nav-number">6.1.</span> <span class="nav-text">feign不过注册中心子系统联调的方法(开发环境常用)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展"><span class="nav-number">7.</span> <span class="nav-text">扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign-源码执行流程"><span class="nav-number">7.1.</span> <span class="nav-text">Feign 源码执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign-和-Ribbon-比较优点"><span class="nav-number">7.2.</span> <span class="nav-text">Feign 和 Ribbon 比较优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#向下传递-request-信息"><span class="nav-number">7.3.</span> <span class="nav-text">向下传递 request 信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#强类型接口设计"><span class="nav-number">7.4.</span> <span class="nav-text">强类型接口设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#整合-Resilience4j"><span class="nav-number">7.5.</span> <span class="nav-text">整合 Resilience4j</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-OkHttp3"><span class="nav-number">7.6.</span> <span class="nav-text">使用 OkHttp3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-fastjson-作为默认序列化"><span class="nav-number">7.7.</span> <span class="nav-text">使用 fastjson 作为默认序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#支持以form表单形式提交数据（application-x-www-form-urlencoded）"><span class="nav-number">7.8.</span> <span class="nav-text">支持以form表单形式提交数据（application&#x2F;x-www-form-urlencoded）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题"><span class="nav-number">8.</span> <span class="nav-text">问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#与-Spring-Cloud-Gateway-整合问题"><span class="nav-number">8.1.</span> <span class="nav-text">与 Spring Cloud Gateway 整合问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RequestParam-无法获取参数"><span class="nav-number">8.2.</span> <span class="nav-text">@RequestParam 无法获取参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启用-hystrix-后-RequestContextHolder-getRequestAttributes-返回-null"><span class="nav-number">8.3.</span> <span class="nav-text">启用 hystrix 后 RequestContextHolder.getRequestAttributes(); 返回 null</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">9.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Richard"
      src="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
  <p class="site-author-name" itemprop="name">Richard</p>
  <div class="site-description" itemprop="description">惶者生存，偏执者成功</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xinlc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/xinlc" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://learnxinyminutes.com/" title="https:&#x2F;&#x2F;learnxinyminutes.com" rel="noopener" target="_blank">Learn X in Y minutes</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://justjavac.com/" title="http:&#x2F;&#x2F;justjavac.com" rel="noopener" target="_blank">justjavac</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.ruanyifeng.com/blog/" title="http:&#x2F;&#x2F;www.ruanyifeng.com&#x2F;blog&#x2F;" rel="noopener" target="_blank">阮一峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.liaoxuefeng.com/" title="https:&#x2F;&#x2F;www.liaoxuefeng.com" rel="noopener" target="_blank">廖雪峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tech.meituan.com/" title="https:&#x2F;&#x2F;tech.meituan.com" rel="noopener" target="_blank">美团技术</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.v2ex.com/" title="https:&#x2F;&#x2F;www.v2ex.com" rel="noopener" target="_blank">V2EX</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://caniuse.com/" title="https:&#x2F;&#x2F;caniuse.com" rel="noopener" target="_blank">caniuse/工具</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.css88.com/nav/" title="http:&#x2F;&#x2F;www.css88.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">css88/doc</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://overapi.com/" title="http:&#x2F;&#x2F;overapi.com&#x2F;" rel="noopener" target="_blank">OverAPI/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://devdocs.io/" title="http:&#x2F;&#x2F;devdocs.io&#x2F;" rel="noopener" target="_blank">DevDocs/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.oschina.net/" title="http:&#x2F;&#x2F;tool.oschina.net&#x2F;" rel="noopener" target="_blank">在线工具/索引</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.lu/" title="http:&#x2F;&#x2F;tool.lu&#x2F;" rel="noopener" target="_blank">ToolBox</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://hao.shejidaren.com/" title="http:&#x2F;&#x2F;hao.shejidaren.com&#x2F;" rel="noopener" target="_blank">设计导航</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
