<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.lichao.xin","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"3ZZ8ITB7HE","apiKey":"062eb5a54afbcbf3f20452d58fc40035","indexName":"xinlc","hits":{"per_page":10},"labels":{"input_placeholder":"搜索","hits_empty":"未发现与「${query}」相关的内容","hits_stats":"${hits} 条相关条目，使用了 ${time} 毫秒"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="在微服务架构中，服务与服务之间通过远程调用的方式进行通信，一旦某个被调用的服务发生了故障，其依赖服务也会发生故障，此时就会发生故障的蔓延，最终导致系统瘫痪。Hystrix 实现了断路器模式，当某个服务发生故障时，通过断路器的监控，给调用方返回一个错误响应，而不是长时间的等待，这样就不会使得调用方由于长时间得不到响应而占用线程，从而防止故障的蔓延。Hystrix 具备服务降级、服务熔断、线程隔离、请">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务架构之服务容错：Spring Cloud Hystrix">
<meta property="og:url" content="https://blog.lichao.xin/back-end/java/spring-cloud-hystrix/index.html">
<meta property="og:site_name" content="Richard Xin&#39;s Blog">
<meta property="og:description" content="在微服务架构中，服务与服务之间通过远程调用的方式进行通信，一旦某个被调用的服务发生了故障，其依赖服务也会发生故障，此时就会发生故障的蔓延，最终导致系统瘫痪。Hystrix 实现了断路器模式，当某个服务发生故障时，通过断路器的监控，给调用方返回一个错误响应，而不是长时间的等待，这样就不会使得调用方由于长时间得不到响应而占用线程，从而防止故障的蔓延。Hystrix 具备服务降级、服务熔断、线程隔离、请">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/1.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/2.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/3.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/4.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/5.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/6.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/7.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/8.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/10.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/11.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/12.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/13.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/14.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/15.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/16.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/17.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/18.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/19.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/20.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/22.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/9.png">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/23.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/24.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/25.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/26.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/27.jpg">
<meta property="article:published_time" content="2020-02-19T19:00:00.000Z">
<meta property="article:modified_time" content="2021-06-14T01:33:22.387Z">
<meta property="article:author" content="Richard">
<meta property="article:tag" content="MicroServices">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lichao.xin/images/java/spring-cloud-hystrix/1.jpg">

<link rel="canonical" href="https://blog.lichao.xin/back-end/java/spring-cloud-hystrix/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>微服务架构之服务容错：Spring Cloud Hystrix | Richard Xin's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4530ac9d0bc4e258535c4a9b17029f0c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Richard Xin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Richard Xin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Quick notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">132</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">59</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.lichao.xin/back-end/java/spring-cloud-hystrix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
      <meta itemprop="name" content="Richard">
      <meta itemprop="description" content="惶者生存，偏执者成功">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Richard Xin's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          微服务架构之服务容错：Spring Cloud Hystrix
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-19 19:00:00" itemprop="dateCreated datePublished" datetime="2020-02-19T19:00:00+00:00">2020-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-14 01:33:22" itemprop="dateModified" datetime="2021-06-14T01:33:22+00:00">2021-06-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在微服务架构中，服务与服务之间通过远程调用的方式进行通信，一旦某个被调用的服务发生了故障，其依赖服务也会发生故障，此时就会发生故障的蔓延，最终导致系统瘫痪。Hystrix 实现了断路器模式，当某个服务发生故障时，通过断路器的监控，给调用方返回一个错误响应，而不是长时间的等待，这样就不会使得调用方由于长时间得不到响应而占用线程，从而防止故障的蔓延。Hystrix 具备服务降级、服务熔断、线程隔离、请求缓存、请求合并及服务监控等强大功能。</p>
<a id="more"></a>

<h2 id="为什么需要服务容错保护？"><a href="#为什么需要服务容错保护？" class="headerlink" title="为什么需要服务容错保护？"></a>为什么需要服务容错保护？</h2><p>先来思考一个问题，假定一个单块服务的可用性是99.99%，如果我们有大概30个微服务，每个的可用性都是99.99%，那么总体可用性是多少呢？</p>
<p>答案：它的总体可用性99.7% uptime！相当于每月2小时宕机时间，实际情况往往更糟糕。计算公式是 0.9999^30。</p>
<p>复杂分布式系统通常有很多依赖，如果一个应用不能对来自依赖故障进行隔离，那么应用本身就处在被拖垮的风险中。在一个高流量的网站中，某个单一后端一旦发生延迟，将会在数秒内导致所有应用资源被耗尽，严重情况会造成雪崩效应。很多情况是一个不起眼的小服务造成的。</p>
<p>服务依赖：</p>
<p>在微服务中，从前端发来的一个请求，这个请求我们一般叫它扇出（Fan-Out）。一个请求会依赖很多服务，如下图一个请求依赖的A、H、I、P四个服务（一般在中大型互联网公司一个请求会扇出平均6到8个微服务请求）。</p>
<p><img src="/images/java/spring-cloud-hystrix/1.jpg" alt="1"></p>
<p>单个服务延迟：</p>
<p>平常情况下每个服务都健康是 OK 的，问题就出在单个服务，某个捣蛋鬼比如服务 I 出现了延迟，刚开始延迟问还不大，到后来越来越严重。</p>
<p><img src="/images/java/spring-cloud-hystrix/2.jpg" alt="2"></p>
<p>高峰期致雪崩效应：</p>
<p>当 I 服务延迟越来越严重，这个时候就会出现所谓的高峰期。当流量很大的时候，然后某个服务出现延迟的时候它会堵住，所有的请求都 Hold 住在依赖 I 服务身上，如果说这个服务索性出错了或者挂了之间返回到还好，它的问题是它不挂它就是延迟很慢，延迟5秒甚至10秒更长的时间就会把所有的请求都 Hold 住在这里。严重的时候（高流量的时候）这个系统都不响应，客户体验非常糟糕。</p>
<p><img src="/images/java/spring-cloud-hystrix/3.jpg" alt="3"></p>
<h2 id="容错限流原理"><a href="#容错限流原理" class="headerlink" title="容错限流原理"></a>容错限流原理</h2><h3 id="基本的容错模式"><a href="#基本的容错模式" class="headerlink" title="基本的容错模式"></a>基本的容错模式</h3><p>经过多年的业界实践，其实在容错相关的领域里面已经摸索出了一些常用的模式：</p>
<p><img src="/images/java/spring-cloud-hystrix/4.jpg" alt="4"></p>
<ul>
<li>超时：最简单的，调用依赖的时候设好超时数，比如5秒，2秒，出问题主动超时；</li>
<li>限流：比如十一长假高速要限流，因为车子太多了，只能让这么多车通过；</li>
<li>熔断：当错误数达到阈值时，类似像保险丝一样熔断。分布系统中要有熔断的措施，在流量很大的时候暂时系统熔断拒绝后面的请求，来保护整个微服务后端系统；</li>
<li>隔离：凡是分布式系统的资源都是有限制的，如果你不隔离的话因为一个服务延迟，它会把所有的资源都给耗尽；</li>
<li>降级：比如双十一，外面流量冲进来很多，系统是承载不了的，这个时候要做一些降级，可能这个请求只能满足 VIP 用户，一般普通用户可能暂时要降级，先拒绝掉或者把他们导到一个临时页面去，来保护后台的系统；</li>
</ul>
<h3 id="断路器模式"><a href="#断路器模式" class="headerlink" title="断路器模式"></a>断路器模式</h3><p>断路器模式（Circuit Breaker），这个模式是从一个本书《Release It!》提出来的。就像家里的电路保护器，那你烧大功率的时候，它就会熔断掉保护家里。</p>
<p>断路器的原理其实就是一个状态机，刚开始系统处于绿色（Closed 状态）每次请求过来都是成功，当你后台出了问题它就会 Trip Breaker 触发断路，这个电路就会断开（Open 状态），打开状态的时候所有的请求进来都会被拒绝掉，直接 Falling Fast 直接弹回去，因为这个路不通。</p>
<p>但是断路器是有个弹性的，不是说一直打开了以后请永远进不来了，它会在一段时间以后会尝试进入一种叫办开闭状态（Half-Open）会允许一小部分流量进去试，如果说试了还有问题会继续回到 Open 状态，如果说有少量流量通过了，没问题了系统又好了就会 Reset Breaker 回到关闭状态。</p>
<p><img src="/images/java/spring-cloud-hystrix/5.jpg" alt="5"></p>
<h3 id="舱壁隔离模式"><a href="#舱壁隔离模式" class="headerlink" title="舱壁隔离模式"></a>舱壁隔离模式</h3><p>舱壁隔离模式（Bulkhead）就是隔离的一种模式，跟船一样，每个船舱都是由隔板（钢板）隔开的。当一个两个船舱被损坏它进水了，不会影响其他船舱这个船还是可以行驶的（泰坦尼克号后来沉船了它也是有隔离的但是它的船舱损坏了太多）。对资源进行失败单元隔离，把单元变小，部分单元出问题不会影响这个系统。</p>
<p><img src="/images/java/spring-cloud-hystrix/6.jpg" alt="6"></p>
<h3 id="容错理念"><a href="#容错理念" class="headerlink" title="容错理念"></a>容错理念</h3><ul>
<li>凡是依赖都可能会失败；</li>
<li>凡是资源都有限制：<ul>
<li>CPU/Memory/Threads/Queue</li>
</ul>
</li>
<li>网络并不可靠；</li>
<li>延迟是应用稳定性杀手；</li>
<li>弹性（Resilience）理念：<ul>
<li>在被弯曲，压缩或者拉伸之后，能够恢复原状的能力；</li>
<li>从疾病，抑郁和困境等类似情况中恢复出来的能力；</li>
<li>系统要有弹性，出了问题要能自我保护；</li>
</ul>
</li>
</ul>
<h2 id="Hystrix-简介"><a href="#Hystrix-简介" class="headerlink" title="Hystrix 简介"></a>Hystrix 简介</h2><p>Hystrix 源于 Netflix API 团队在 2011 年启动的弹性工程项目，2013 它在 Netflix 每天处理数百亿的线程隔离以及数千亿的信号量隔离调用 <a href="http://www.infoq.com/cn/news/2013/01/netflix-hystrix-fault-tolerance/" target="_blank" rel="noopener">netflix-hystrix-fault-tolerance</a>。</p>
<p>Hystrix 是基于 Apache License 2.0 协议的开源库，目前托管在 <a href="https://github.com/Netflix/Hystrix/" target="_blank" rel="noopener">github上</a>。</p>
<p>Netflix 云端开源工具 Hystrix 曾助奥巴马<a href="http://it.sohu.com/20121129/n358943361.shtml" target="_blank" rel="noopener">竞选</a>。</p>
<p>这里有个段子，在竞选的时候奥巴马的系统比较稳定，他的竞争对手的系统就不是很稳定…… 当然这只是个段子。</p>
<p><img src="/images/java/spring-cloud-hystrix/7.jpg" alt="7"></p>
<p>Hystrix 主要作者 <a href="https://www.linkedin.com/in/benjchristensen" target="_blank" rel="noopener">Ben Christensen</a>，他也是大名鼎鼎 <a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener">RxJava</a> 响应式 Java 库的作者。Ben 的这两个作品都很牛X，他做事情非常专注，给我一个启示，作为工程师也好架构师也好，在一个公司里面做事情还是需要专注（专注出精品啊），不需要做特别多的东西。</p>
<h2 id="Hystrix-设计原理"><a href="#Hystrix-设计原理" class="headerlink" title="Hystrix 设计原理"></a>Hystrix 设计原理</h2><p>Hystrix 工作流程(自适应反馈机)，下面这个图是老版本：</p>
<p><img src="/images/java/spring-cloud-hystrix/8.jpg" alt="8"></p>
<ol>
<li>依赖的调用用了 Hystrix 以后 会被封装到 Hystrix Command 的类里面。</li>
<li>然后就会执行，执行分两种同步和异步（放到队列中），最新版本还执行响应式执行。</li>
<li>然后判断电路是否打开，如果是打开状态就是短路了 走 8。</li>
<li>如果用了线程隔离，线程也是一个线程池（前面也有可能是队列），线程有可能满队列也有可能满，如果满了走 8。</li>
<li>运行环节，远程调用或者被封装的调用就可以执行了，执行的过程中有可能超时，如果超时了 5a -&gt; 8。</li>
<li>没有超时，看执行情况，失败了走 6b，成功了 6a 会报告 Metrics 7。</li>
<li>就是会把执行的情况做个记录。在这里会进行统计，判断下一次请求是否要关闭或打开电路。</li>
<li>判断是否指定了降级函数。8a 没有指定直接返回，有降级函数 8b 成功执行降级，降级函数也有可能出错，走 8c 降级失败。</li>
</ol>
<h2 id="断路器内核原理"><a href="#断路器内核原理" class="headerlink" title="断路器内核原理"></a>断路器内核原理</h2><p><img src="/images/java/spring-cloud-hystrix/10.jpg" alt="10"></p>
<p>当 Hystrix Command 进来的时候，首先判断允不允许这次请求通过，通过 isOpen 判断电路是不是打开，如果是闭合的就可以通过，如果电路是打开的，它会判断有没有过一个睡眠周期（时间窗口）。如果睡眠周期没过就不允许通过，如果睡眠周期过了，会放一个请求进来试，如果试成功了电路关闭，否则继续打开。主要通过 isOpen 判断，失败数/(成功数+失败数)，看这个百分比是否大于阈值。</p>
<p>断路器内核，内部主要是基于滚动式统计这种方式的，它每一秒钟会生产一个桶，内存当中就是一个数据结构，每个桶里面会记录这些相关的 Metrics 成功、失败、超时的拒绝等。一秒钟产生一个桶，默认是十秒钟窗口期，那么就有十个桶。每过一秒这个桶就会往后推，会产生一个新的桶最老的那个桶机会丢弃。isOpen 就是根据这些数据基于十秒钟的这十个桶进行计算的。</p>
<h2 id="Hystrix-主要概念"><a href="#Hystrix-主要概念" class="headerlink" title="Hystrix 主要概念"></a>Hystrix 主要概念</h2><h3 id="Hystrix-Command"><a href="#Hystrix-Command" class="headerlink" title="Hystrix Command"></a>Hystrix Command</h3><p><img src="/images/java/spring-cloud-hystrix/11.jpg" alt="11"></p>
<p>Hystrix Command 其实是 Hystrix 组件提供的一个基类，它实现了一个命令模式。要封装调用的话就继承 Hystrix Command 实现里面的 Run 方法，把逻辑放到 Run 方法即可，这个逻辑就实现了容错限流的保护。</p>
<h3 id="Fail-Fast"><a href="#Fail-Fast" class="headerlink" title="Fail Fast"></a>Fail Fast</h3><p><img src="/images/java/spring-cloud-hystrix/12.jpg" alt="12"></p>
<p>快速失败，跟 Hystrix 降级相关。所谓的快速失败，直接在 run 方法里抛出异常，这个是最直接的。大部分场景我们并不一点要搞很复杂的 Fallback，我们就直接抛一个异常。</p>
<h3 id="Fail-Silent"><a href="#Fail-Silent" class="headerlink" title="Fail Silent"></a>Fail Silent</h3><p><img src="/images/java/spring-cloud-hystrix/13.jpg" alt="13"></p>
<p>安静失败，其实就是 run 的时候有个降级函数，这个降级函数里面会返回一个 null 或者是空列表之类的。</p>
<h3 id="Static-Fallback"><a href="#Static-Fallback" class="headerlink" title="Static Fallback"></a>Static Fallback</h3><p><img src="/images/java/spring-cloud-hystrix/14.jpg" alt="14"></p>
<p>静态的降级函数，这个函数里面返回一个缺省值。缺省值是 true 或者是一个对象。</p>
<h3 id="Fallback-via-Network"><a href="#Fallback-via-Network" class="headerlink" title="Fallback via Network"></a>Fallback via Network</h3><p><img src="/images/java/spring-cloud-hystrix/15.jpg" alt="15"></p>
<p>通过网络进行降级，在调用一个主服务的时候，在 run 的时候主服务出错了，那降级函数里面我就去调用一个辅助的服务。这个辅助的服务也是要通过网络的，可能是一个缓存或者什么。这个降级函数呢也要封装在一个 Hystrix Command 里面。</p>
<h3 id="Primary-Secondary-with-Fallback"><a href="#Primary-Secondary-with-Fallback" class="headerlink" title="Primary + Secondary with Fallback"></a>Primary + Secondary with Fallback</h3><p><img src="/images/java/spring-cloud-hystrix/16.jpg" alt="16"></p>
<p>主次 Fallback，这个用的比较少。有这样一个场景，可能上线一个新功能，老功能比如叫 Primary，那有一个新功能来了，我担心这个新功能可能会有点问题。这个新功能在 Secondary 开关后面。上线的时候走的是老功能，我要尝试新功能是否 OK，把开关打开切换到到 Secondary。</p>
<h3 id="请求合并"><a href="#请求合并" class="headerlink" title="请求合并"></a>请求合并</h3><p><img src="/images/java/spring-cloud-hystrix/17.jpg" alt="17"></p>
<p>这个功能用的也比较少，有这样一个场景，有非常高频的请求，对后台某些服务压力非常大。比如说 Netflix 网站流量非常大。很多小的请求过来的时候，它会做一个 Batch 合并，它会启动一个时钟，有一个时间窗口比如说 10毫秒，这期间发生的请求都会 Batch 起来。它并不一个个的发向后台服务，而是会放到队列里面，进行 Batch 打包一起发到后台服务。响应回来时在进行拆解返回调用端。这样可以减少对后端的压力，把大量的小请求合成一个 10ms 一个窗口。</p>
<h3 id="请求缓存"><a href="#请求缓存" class="headerlink" title="请求缓存"></a>请求缓存</h3><p><img src="/images/java/spring-cloud-hystrix/18.jpg" alt="18"></p>
<p>这个用的也不是特别多，其实就是缓存，它会把请求以某一个 key 缓存到 ThreadLocal 中，如何后面的请求 key 相同就不请求后端的服务了，直接走缓存直接返回。</p>
<h3 id="线程和信号量隔离"><a href="#线程和信号量隔离" class="headerlink" title="线程和信号量隔离"></a>线程和信号量隔离</h3><p><img src="/images/java/spring-cloud-hystrix/19.jpg" alt="19"></p>
<p>线程隔离：当客户端请求过来的时候，去调用依赖服务，如果依赖两个服务会为每个依赖的服务单独去创建一个线程池进行隔离。每次调用发生在对应的线程里面，线程池可以知道线程数，如果线程池用光了后面的请求就会拒绝。</p>
<p>信号量（Semaphore）隔离：简单理解就是一个计数器，如果说信号量是 10 个信号量，那么计数器就设置成 10，每个请求进来计数器就减 1，如果说 10 个都减完了后面的请求就不能再进来了。当然某个请求结束信号量会还回来，计数器进行加 1。</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>JDK：1.8</li>
<li>Spring Boot：2.2.4.RELEASE</li>
<li>Spring Cloud：Hoxton.SR1</li>
</ul>
<h2 id="创建一个-hystrix-service-模块"><a href="#创建一个-hystrix-service-模块" class="headerlink" title="创建一个 hystrix-service 模块"></a>创建一个 hystrix-service 模块</h2><p>hystrix-service 模块来演示 Hystrix 的常用功能，在 pom.xml 中添加相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 application.yml 进行配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hystrix-service</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8001/eureka/</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">user-service:</span> <span class="string">http://user-service</span></span><br></pre></td></tr></table></figure>

<p>在启动类上添加 @EnableCircuitBreaker 来开启 Hystrix 的断路器功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixServiceApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HystrixServiceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 UserHystrixController 接口用于调用 user-service 服务：</p>
<p>在 UserHystrixController 中添加用于测试服务降级的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/testFallback/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">testFallback</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.getUser(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 UserService 中添加调用方法与服务降级方法，方法上需要添加 @HystrixCommand 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"getDefaultUser"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">getUser</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">"/user/&#123;1&#125;"</span>, CommonResult<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">getDefaultUser</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    User defaultUser = <span class="keyword">new</span> User(-<span class="number">1L</span>, <span class="string">"defaultUser"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(defaultUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动 eureka-server、user-service、hystrix-service 服务；</p>
<p>调用接口进行测试：<a href="http://localhost:8401/user/testFallback/1" target="_blank" rel="noopener">http://localhost:8401/user/testFallback/1</a></p>
<p>关闭 user-service 服务重新测试该接口，发现已经发生了服务降级;</p>
<h2 id="HystrixCommand-详解"><a href="#HystrixCommand-详解" class="headerlink" title="@HystrixCommand 详解"></a>@HystrixCommand 详解</h2><h3 id="HystrixCommand-中的常用参数"><a href="#HystrixCommand-中的常用参数" class="headerlink" title="@HystrixCommand 中的常用参数"></a>@HystrixCommand 中的常用参数</h3><ul>
<li>fallbackMethod：指定服务降级处理方法；</li>
<li>ignoreExceptions：忽略某些异常，不发生服务降级；</li>
<li>commandKey：命令名称，用于区分不同的命令；</li>
<li>groupKey：分组名称，Hystrix 会根据不同的分组来统计命令的告警及仪表盘信息；</li>
<li>threadPoolKey：线程池名称，用于划分线程池；</li>
</ul>
<h3 id="设置命令、分组及线程池名称"><a href="#设置命令、分组及线程池名称" class="headerlink" title="设置命令、分组及线程池名称"></a>设置命令、分组及线程池名称</h3><p>在 UserHystrixController 中添加测试接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/testCommand/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">testCommand</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.getUserCommand(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 UserService 中添加方式实现功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"getDefaultUser"</span>,</span><br><span class="line">    commandKey = <span class="string">"getUserCommand"</span>,</span><br><span class="line">    groupKey = <span class="string">"getUserGroup"</span>,</span><br><span class="line">    threadPoolKey = <span class="string">"getUserThreadPool"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">getUserCommand</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">"/user/&#123;1&#125;"</span>, CommonResult<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-ignoreExceptions-忽略某些异常降级"><a href="#使用-ignoreExceptions-忽略某些异常降级" class="headerlink" title="使用 ignoreExceptions 忽略某些异常降级"></a>使用 ignoreExceptions 忽略某些异常降级</h3><p>在 UserHystrixController 中添加测试接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/testException/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">testException</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.getUserException(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 UserService 中添加实现方法，这里忽略了 NullPointerException，当 id 为 1 时抛出IndexOutOfBoundsException，id 为 2 时抛出 NullPointerException：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"getDefaultUser2"</span>, ignoreExceptions = &#123;NullPointerException<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">CommonResult</span> <span class="title">getUserException</span>(<span class="title">Long</span> <span class="title">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (id == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">"/user/&#123;1&#125;"</span>, CommonResult<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">getDefaultUser2</span><span class="params">(@PathVariable Long id, Throwable e)</span> </span>&#123;</span><br><span class="line">    LOGGER.error(<span class="string">"getDefaultUser2 id:&#123;&#125;,throwable class:&#123;&#125;"</span>, id, e.getClass());</span><br><span class="line">    User defaultUser = <span class="keyword">new</span> User(-<span class="number">2L</span>, <span class="string">"defaultUser2"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(defaultUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用接口进行测试：<a href="http://localhost:8401/user/testException/1" target="_blank" rel="noopener">http://localhost:8401/user/testException/1</a></p>
<h2 id="Hystrix-的请求缓存"><a href="#Hystrix-的请求缓存" class="headerlink" title="Hystrix 的请求缓存"></a>Hystrix 的请求缓存</h2><p>当系统并发量越来越大时，我们需要使用缓存来优化系统，达到减轻并发请求线程数，提供响应速度的效果。</p>
<h3 id="相关注解"><a href="#相关注解" class="headerlink" title="相关注解"></a>相关注解</h3><ul>
<li>@CacheResult：开启缓存，默认所有参数作为缓存的 key，cacheKeyMethod 可以通过返回 String 类型的方法指定key；</li>
<li>@CacheKey：指定缓存的 key，可以指定参数或指定参数中的属性值为缓存 key，cacheKeyMethod 还可以通过返回String 类型的方法指定；</li>
<li>@CacheRemove：移除缓存，需要指定 commandKey。</li>
</ul>
<h3 id="测试使用缓存"><a href="#测试使用缓存" class="headerlink" title="测试使用缓存"></a>测试使用缓存</h3><p>在 UserHystrixController 中添加使用缓存的测试接口，直接调用三次 getUserCache 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/testCache/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">testCache</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    userService.getUserCache(id);</span><br><span class="line">    userService.getUserCache(id);</span><br><span class="line">    userService.getUserCache(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="string">"操作成功"</span>, <span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 UserService 中添加具有缓存功能的 getUserCache 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheResult</span>(cacheKeyMethod = <span class="string">"getCacheKey"</span>)</span><br><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"getDefaultUser"</span>, commandKey = <span class="string">"getUserCache"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">getUserCache</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    LOGGER.info(<span class="string">"getUserCache id:&#123;&#125;"</span>, id);</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(userServiceUrl + <span class="string">"/user/&#123;1&#125;"</span>, CommonResult<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为缓存生成key的方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCacheKey</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.valueOf(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用接口测试 <a href="http://localhost:8401/user/testCache/1" target="_blank" rel="noopener">http://localhost:8401/user/testCache/1</a>, 这个接口中调用了三次 getUserCache 方法，但是只打印了一次日志，说明有两次走的是缓存。</p>
<h3 id="测试移除缓存"><a href="#测试移除缓存" class="headerlink" title="测试移除缓存"></a>测试移除缓存</h3><p>在 UserHystrixController 中添加移除缓存的测试接口，调用一次 removeCache 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/testRemoveCache/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">testRemoveCache</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    userService.getUserCache(id);</span><br><span class="line">    userService.removeCache(id);</span><br><span class="line">    userService.getUserCache(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="string">"操作成功"</span>, <span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 UserService 中添加具有移除缓存功能的 removeCache 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheRemove</span>(commandKey = <span class="string">"getUserCache"</span>, cacheKeyMethod = <span class="string">"getCacheKey"</span>)</span><br><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">removeCache</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    LOGGER.info(<span class="string">"removeCache id:&#123;&#125;"</span>, id);</span><br><span class="line">    <span class="keyword">return</span> restTemplate.postForObject(userServiceUrl + <span class="string">"/user/delete/&#123;1&#125;"</span>, <span class="keyword">null</span>, CommonResult<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用接口测试 <a href="http://localhost:8401/user/testRemoveCache/1，可以发现有两次查询都走的是接口。" target="_blank" rel="noopener">http://localhost:8401/user/testRemoveCache/1，可以发现有两次查询都走的是接口。</a></p>
<h2 id="Hystrix-请求合并"><a href="#Hystrix-请求合并" class="headerlink" title="Hystrix 请求合并"></a>Hystrix 请求合并</h2><p>微服务系统中的服务间通信，需要通过远程调用来实现，随着调用次数越来越多，占用线程资源也会越来越多。Hystrix 中提供了 @HystrixCollapser 用于合并请求，从而达到减少通信消耗及线程数量的效果。</p>
<h3 id="HystrixCollapser-的常用属性"><a href="#HystrixCollapser-的常用属性" class="headerlink" title="@HystrixCollapser 的常用属性"></a>@HystrixCollapser 的常用属性</h3><ul>
<li>batchMethod：用于设置请求合并的方法；</li>
<li>collapserProperties：请求合并属性，用于控制实例属性，有很多；</li>
<li>timerDelayInMilliseconds：collapserProperties 中的属性，用于控制每隔多少时间合并一次请求；</li>
</ul>
<h3 id="功能演示"><a href="#功能演示" class="headerlink" title="功能演示"></a>功能演示</h3><p>在 UserHystrixController 中添加 testCollapser 方法，这里我们先进行两次服务调用，再间隔 200ms 以后进行第三次服务调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/testCollapser"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">testCollapser</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">    Future&lt;User&gt; future1 = userService.getUserFuture(<span class="number">1L</span>);</span><br><span class="line">    Future&lt;User&gt; future2 = userService.getUserFuture(<span class="number">2L</span>);</span><br><span class="line">    future1.get();</span><br><span class="line">    future2.get();</span><br><span class="line">    ThreadUtil.safeSleep(<span class="number">200</span>);</span><br><span class="line">    Future&lt;User&gt; future3 = userService.getUserFuture(<span class="number">3L</span>);</span><br><span class="line">    future3.get();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="string">"操作成功"</span>, <span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 @HystrixCollapser 实现请求合并，所有对 getUserFuture 的的多次调用都会转化为对 getUserByIds 的单次调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCollapser</span>(batchMethod = <span class="string">"getUserByIds"</span>,collapserProperties = &#123;</span><br><span class="line">    <span class="meta">@HystrixProperty</span>(name = <span class="string">"timerDelayInMilliseconds"</span>, value = <span class="string">"100"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;User&gt; <span class="title">getUserFuture</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AsyncResult&lt;User&gt;()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CommonResult commonResult = restTemplate.getForObject(userServiceUrl + <span class="string">"/user/&#123;1&#125;"</span>, CommonResult<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">        Map data = (Map) commonResult.getData();</span><br><span class="line">        User user = BeanUtil.mapToBean(data,User<span class="class">.<span class="keyword">class</span>,<span class="title">true</span>)</span>;</span><br><span class="line">        LOGGER.info(<span class="string">"getUserById username:&#123;&#125;"</span>, user.getUsername());</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getUserByIds</span><span class="params">(List&lt;Long&gt; ids)</span> </span>&#123;</span><br><span class="line">    LOGGER.info(<span class="string">"getUserByIds:&#123;&#125;"</span>, ids);</span><br><span class="line">    CommonResult commonResult = restTemplate.getForObject(userServiceUrl + "/user/getUserByIds?ids=&#123;1&#125;", CommonResult.class, CollUtil.join(ids,","));</span><br><span class="line">    <span class="keyword">return</span> (List&lt;User&gt;) commonResult.getData();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问接口测试 <a href="http://localhost:8401/user/testCollapser，由于我们设置了" target="_blank" rel="noopener">http://localhost:8401/user/testCollapser，由于我们设置了</a> 100 毫秒进行一次请求合并，前两次被合并，最后一次自己单独合并了。</p>
<h2 id="Hystrix-的常用配置"><a href="#Hystrix-的常用配置" class="headerlink" title="Hystrix 的常用配置"></a>Hystrix 的常用配置</h2><h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span> <span class="comment"># 用于控制 HystrixCommand 的行为</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">strategy:</span> <span class="string">THREAD</span> <span class="comment"># 控制 HystrixCommand 的隔离策略，THREAD-&gt;线程池隔离策略(默认)，SEMAPHORE-&gt;信号量隔离策略</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">1000</span> <span class="comment"># 配置 HystrixCommand 执行的超时时间，执行超过该时间会进行服务降级处理</span></span><br><span class="line">            <span class="attr">interruptOnTimeout:</span> <span class="literal">true</span> <span class="comment"># 配置 HystrixCommand 执行超时的时候是否要中断</span></span><br><span class="line">            <span class="attr">interruptOnCancel:</span> <span class="literal">true</span> <span class="comment"># 配置HystrixCommand 执行被取消的时候是否要中断</span></span><br><span class="line">          <span class="attr">timeout:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 配置 HystrixCommand 的执行是否启用超时时间</span></span><br><span class="line">          <span class="attr">semaphore:</span></span><br><span class="line">            <span class="attr">maxConcurrentRequests:</span> <span class="number">10</span> <span class="comment"># 当使用信号量隔离策略时，用来控制并发量的大小，超过该并发量的请求会被拒绝</span></span><br><span class="line">      <span class="attr">fallback:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 用于控制是否启用服务降级</span></span><br><span class="line">      <span class="attr">circuitBreaker:</span> <span class="comment"># 用于控制 HystrixCircuitBreaker 的行为</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 用于控制断路器是否跟踪健康状况以及熔断请求</span></span><br><span class="line">        <span class="attr">requestVolumeThreshold:</span> <span class="number">20</span> <span class="comment"># 超过该请求数的请求会被拒绝</span></span><br><span class="line">        <span class="attr">forceOpen:</span> <span class="literal">false</span> <span class="comment"># 强制打开断路器，拒绝所有请求</span></span><br><span class="line">        <span class="attr">forceClosed:</span> <span class="literal">false</span> <span class="comment"># 强制关闭断路器，接收所有请求</span></span><br><span class="line">      <span class="attr">requestCache:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 用于控制是否开启请求缓存</span></span><br><span class="line">  <span class="attr">collapser:</span> <span class="comment"># 用于控制 HystrixCollapser 的执行行为</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">maxRequestsInBatch:</span> <span class="number">100</span> <span class="comment"># 控制一次合并请求合并的最大请求数</span></span><br><span class="line">      <span class="attr">timerDelayinMilliseconds:</span> <span class="number">10</span> <span class="comment"># 控制多少毫秒内的请求会被合并成一个</span></span><br><span class="line">      <span class="attr">requestCache:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 控制合并请求是否开启缓存</span></span><br><span class="line">  <span class="attr">threadpool:</span> <span class="comment"># 用于控制 HystrixCommand 执行所在线程池的行为</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">10</span> <span class="comment"># 线程池的核心线程数</span></span><br><span class="line">      <span class="attr">maximumSize:</span> <span class="number">10</span> <span class="comment"># 线程池的最大线程数，超过该线程数的请求会被拒绝</span></span><br><span class="line">      <span class="attr">maxQueueSize:</span> <span class="number">-1</span> <span class="comment"># 用于设置线程池的最大队列大小，-1采用 SynchronousQueue，其他正数采用LinkedBlockingQueue</span></span><br><span class="line">      <span class="attr">queueSizeRejectionThreshold:</span> <span class="number">5</span> <span class="comment"># 用于设置线程池队列的拒绝阀值，由于 LinkedBlockingQueue 不能动态改版大小，使用时需要用该参数来控制线程数</span></span><br></pre></td></tr></table></figure>

<h3 id="实例配置"><a href="#实例配置" class="headerlink" title="实例配置"></a>实例配置</h3><p>实例配置只需要将全局配置中的 default 换成与之对应的 key 即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">HystrixComandKey:</span> <span class="comment"># 将 default 换成 HystrixComrnandKey</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">strategy:</span> <span class="string">THREAD</span></span><br><span class="line">  <span class="attr">collapser:</span></span><br><span class="line">    <span class="attr">HystrixCollapserKey:</span> <span class="comment"># 将 default 换成 HystrixCollapserKey</span></span><br><span class="line">      <span class="attr">maxRequestsInBatch:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">threadpool:</span></span><br><span class="line">    <span class="attr">HystrixThreadPoolKey:</span> <span class="comment"># 将 default 换成 HystrixThreadPoolKey</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h4 id="配置文件中相关-key-的说明"><a href="#配置文件中相关-key-的说明" class="headerlink" title="配置文件中相关 key 的说明"></a>配置文件中相关 key 的说明</h4><ul>
<li>HystrixComandKey 对应 @HystrixCommand 中的 commandKey 属性；</li>
<li>HystrixCollapserKey 对应 @HystrixCollapser 注解中的 collapserKey 属性；</li>
<li>HystrixThreadPoolKey 对应 @HystrixCommand 中的 threadPoolKey 属性；</li>
</ul>
<h2 id="Hystrix-Dashboard"><a href="#Hystrix-Dashboard" class="headerlink" title="Hystrix Dashboard"></a>Hystrix Dashboard</h2><p>Hystrix 提供了 Hystrix Dashboard 来实时监控 HystrixCommand 方法的执行情况。 Hystrix Dashboard 可以有效地反映出每个 Hystrix 实例的运行情况，帮助我们快速发现系统中的问题，从而采取对应措施。</p>
<h3 id="Hystrix-单个实例监控"><a href="#Hystrix-单个实例监控" class="headerlink" title="Hystrix 单个实例监控"></a>Hystrix 单个实例监控</h3><p>创建一个 hystrix-dashboard 模块，用来监控 hystrix 实例的执行情况，在 pom.xml 中添加相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 application.yml 进行配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8501</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hystrix-dashboard</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8001/eureka/</span></span><br></pre></td></tr></table></figure>

<p>在启动类上添加 @EnableHystrixDashboard 来启用监控功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixDashboardApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HystrixDashboardApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要启动如下服务：eureka-server、user-service、hystrix-service、hystrix-dashboard。</p>
<p>访问 Hystrix Dashboard：<a href="http://localhost:8501/hystrix" target="_blank" rel="noopener">http://localhost:8501/hystrix</a></p>
<p>填写好信息后点击监控按钮，这里我们需要注意的是，由于我们本地不支持 https，所以我们的地址需要填入的是 http，否则会无法获取监控信息；</p>
<p>还有一点值得注意的是，被监控的 hystrix-service 服务需要开启 Actuator 的 hystrix.stream 端点，配置信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'hystrix.stream'</span> <span class="comment"># 暴露 hystrix 监控端点</span></span><br></pre></td></tr></table></figure>

<p>调用几次 hystrix-service 的接口：<a href="http://localhost:8401/user/testCommand/1" target="_blank" rel="noopener">http://localhost:8401/user/testCommand/1</a></p>
<h3 id="Hystrix-Dashboard-图表解读"><a href="#Hystrix-Dashboard-图表解读" class="headerlink" title="Hystrix Dashboard 图表解读"></a>Hystrix Dashboard 图表解读</h3><p><img src="/images/java/spring-cloud-hystrix/20.jpg" alt="20"></p>
<!-- ![21][21] -->

<h3 id="Hystrix-集群实例监控"><a href="#Hystrix-集群实例监控" class="headerlink" title="Hystrix 集群实例监控"></a>Hystrix 集群实例监控</h3><p>使用 Turbine 来聚合 hystrix-service 服务的监控信息，然后我们的 hystrix-dashboard 服务就可以从 Turbine 获取聚合好的监控信息展示给我们了。</p>
<h3 id="Turbine-原理"><a href="#Turbine-原理" class="headerlink" title="Turbine 原理"></a>Turbine 原理</h3><p><img src="/images/java/spring-cloud-hystrix/22.jpg" alt="22"></p>
<p>Turbine 主要是用来做集群 Hystrix Stream 聚合，有些数据要汇总比如错误数、平均数等。</p>
<h3 id="创建一个-turbine-service-模块"><a href="#创建一个-turbine-service-模块" class="headerlink" title="创建一个 turbine-service 模块"></a>创建一个 turbine-service 模块</h3><p>用来聚合 hystrix-service 的监控信息，在 pom.xml 中添加相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-turbine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 application.yml 进行配置，主要是添加了 Turbine 相关配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8601</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">turbine-service</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8001/eureka/</span></span><br><span class="line"><span class="attr">turbine:</span></span><br><span class="line">  <span class="attr">app-config:</span> <span class="string">hystrix-service</span> <span class="comment"># 指定需要收集信息的服务名称</span></span><br><span class="line">  <span class="attr">cluster-name-expression:</span> <span class="string">new</span> <span class="string">String('default')</span> <span class="comment"># 指定服务所属集群</span></span><br><span class="line">  <span class="attr">combine-host-port:</span> <span class="literal">true</span> <span class="comment"># 以主机名和端口号来区分服务</span></span><br></pre></td></tr></table></figure>

<p>在启动类上添加 @EnableTurbine 来启用 Turbine 相关功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableTurbine</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TurbineServiceApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(TurbineServiceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 application-replica1.yml 配置再启动一个 hystrix-service 服务，启动 turbine-service 服务。</p>
<p>访问Hystrix Dashboard：<a href="http://localhost:8501/hystrix" target="_blank" rel="noopener">http://localhost:8501/hystrix</a></p>
<p>添加集群监控地址，需要注意的是我们需要添加的是 turbine-service 的监控端点地址。</p>
<p>调用几次 hystrix-service 的接口：<a href="http://localhost:8401/user/testCommand/1" target="_blank" rel="noopener">http://localhost:8401/user/testCommand/1</a> 以及 <a href="http://localhost:8402/user/testCommand/1" target="_blank" rel="noopener">http://localhost:8402/user/testCommand/1</a></p>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><ul>
<li>网关集中埋点，覆盖大部分场景；</li>
<li>尽量框架集中埋点，客户端为主；</li>
<li>配置对接 Apollo，根据实际使用调整阀值；</li>
<li>信号量vs线程池场景：<ul>
<li>信号量：网关，缓存；</li>
<li>线程池场景：服务间调用客户端，数据库访问，第三方访问；</li>
</ul>
</li>
<li>线程池大小经验值：<ul>
<li>30 rps x 0.2 sec = 6 + breathing room = 10 threads；</li>
<li>Thread-pool Queue size : 5 ~ 10；</li>
</ul>
</li>
<li>部署：<ul>
<li>Hystrix Dashboard大盘（无线/H5/第三方网关）；</li>
<li>共享Hystrix Dashboard/Turbine服务器；</li>
<li>熔断告警；</li>
</ul>
</li>
</ul>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><h3 id="Hystrix-新版本设计原理"><a href="#Hystrix-新版本设计原理" class="headerlink" title="Hystrix 新版本设计原理"></a>Hystrix 新版本设计原理</h3><p><img src="/images/java/spring-cloud-hystrix/9.png" alt="9"></p>
<p>每一个微服务调用时，都会使用 Hystrix Command 方式（上图的左上角那个），然后使用 command 同步的，或者是响应式的，或者是异步的，判断电路是否熔断（顺着图从左往右看），如果断路则走降级 fallback。</p>
<p>如果这个线闭合着，但是线程资源没了，队列满了，则走限流措施（看图的第5步）。</p>
<p>如果走完了，执行成功了，则走 run 方法，获取 response，但是这个过程如果出错了，则继续走降级 fallback。</p>
<p>同时，看图最上面有一个后缀是 health 的，这是一个计算整个链路是否健康的组件，每一步操作都被它记录着。</p>
<h3 id="引入-Hystrix-架构"><a href="#引入-Hystrix-架构" class="headerlink" title="引入 Hystrix 架构"></a>引入 Hystrix 架构</h3><p>主要在网关上进入：</p>
<p><img src="/images/java/spring-cloud-hystrix/23.jpg" alt="23"></p>
<h3 id="网关和-Hystrix-参考部署"><a href="#网关和-Hystrix-参考部署" class="headerlink" title="网关和 Hystrix 参考部署"></a>网关和 Hystrix 参考部署</h3><p><img src="/images/java/spring-cloud-hystrix/24.jpg" alt="24"></p>
<h3 id="Hystrix-和-Turbine-对接-Eureka-架构"><a href="#Hystrix-和-Turbine-对接-Eureka-架构" class="headerlink" title="Hystrix 和 Turbine 对接 Eureka 架构"></a>Hystrix 和 Turbine 对接 Eureka 架构</h3><p><img src="/images/java/spring-cloud-hystrix/25.jpg" alt="25"></p>
<p>一般 Turbine 只部署一个就够。</p>
<h3 id="线程隔离案例"><a href="#线程隔离案例" class="headerlink" title="线程隔离案例"></a>线程隔离案例</h3><p><img src="/images/java/spring-cloud-hystrix/26.jpg" alt="26"></p>
<blockquote>
<p><a href="https://segmentfault.com/a/1190000005988895" target="_blank" rel="noopener">防雪崩利器：熔断器 Hystrix 的原理与使用</a></p>
</blockquote>
<h3 id="线程-vs-信号量隔离"><a href="#线程-vs-信号量隔离" class="headerlink" title="线程 vs 信号量隔离"></a>线程 vs 信号量隔离</h3><table>
<thead>
<tr>
<th align="left">机制</th>
<th align="left">优点</th>
<th align="left">不足</th>
<th align="left">适用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">信号量隔离</td>
<td align="left">轻量，无额外开销</td>
<td align="left">不支持任务排队和主动超时；不支持异步调用</td>
<td align="left">受信客户；高扇出(网关)； 高频高速调用(cache)</td>
</tr>
<tr>
<td align="left">线程池隔离</td>
<td align="left">支持排队和超时；支持异步调用</td>
<td align="left">线程调用会产生额外的开销</td>
<td align="left">不受信客户；有限扇出</td>
</tr>
</tbody></table>
<h3 id="断路器机制"><a href="#断路器机制" class="headerlink" title="断路器机制"></a>断路器机制</h3><p><img src="/images/java/spring-cloud-hystrix/27.jpg" alt="27"></p>
<h3 id="其它开源容错限流产品"><a href="#其它开源容错限流产品" class="headerlink" title="其它开源容错限流产品"></a>其它开源容错限流产品</h3><ul>
<li>Alibaba Sentinel（Java）<a href="https://github.com/alibaba/Sentinel/" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/</a></li>
<li>Resilience4j（Java）<a href="https://github.com/resilience4j/resilience4j/" target="_blank" rel="noopener">https://github.com/resilience4j/resilience4j/</a></li>
<li>Failsafe（Java）<a href="https://github.com/jhalterman/failsafe/" target="_blank" rel="noopener">https://github.com/jhalterman/failsafe/</a></li>
<li>Hystrix-go（golang）<a href="https://github.com/afex/hystrix-go/" target="_blank" rel="noopener">https://github.com/afex/hystrix-go/</a></li>
<li>Polly（C#）<a href="https://github.com/App-vNext/Polly/" target="_blank" rel="noopener">https://github.com/App-vNext/Polly/</a></li>
</ul>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="缓存使用过程中的问题"><a href="#缓存使用过程中的问题" class="headerlink" title="缓存使用过程中的问题"></a>缓存使用过程中的问题</h3><p>在缓存使用过程中，我们需要在每次使用缓存的请求前后对 HystrixRequestContext 进行初始化和关闭，否则会出现如下异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Request caching is not available. Maybe you need to initialize the HystrixRequestContext?</span><br><span class="line">	at com.netflix.hystrix.HystrixRequestCache.get(HystrixRequestCache.java:<span class="number">104</span>) ~[hystrix-core-<span class="number">1.5</span><span class="number">.18</span>.jar:<span class="number">1.5</span><span class="number">.18</span>]</span><br><span class="line">	at com.netflix.hystrix.AbstractCommand$<span class="number">7</span>.call(AbstractCommand.java:<span class="number">478</span>) ~[hystrix-core-<span class="number">1.5</span><span class="number">.18</span>.jar:<span class="number">1.5</span><span class="number">.18</span>]</span><br><span class="line">	at com.netflix.hystrix.AbstractCommand$<span class="number">7</span>.call(AbstractCommand.java:<span class="number">454</span>) ~[hystrix-core-<span class="number">1.5</span><span class="number">.18</span>.jar:<span class="number">1.5</span><span class="number">.18</span>]</span><br></pre></td></tr></table></figure>

<p>这里我们通过使用过滤器，在每个请求前后初始化和关闭 HystrixRequestContext 来解决该问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@WebFilter</span>(urlPatterns = <span class="string">"/*"</span>,asyncSupported = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixRequestContextFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HystrixRequestContext context = HystrixRequestContext.initializeContext();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            context.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/Netflix/Hystrix/wiki/" target="_blank" rel="noopener">https://github.com/Netflix/Hystrix/wiki/</a></li>
<li><a href="https://cloud.spring.io/spring-cloud-netflix/reference/html/" target="_blank" rel="noopener">https://cloud.spring.io/spring-cloud-netflix/reference/html/</a></li>
<li><a href="https://segmentfault.com/a/1190000005988895" target="_blank" rel="noopener">防雪崩利器：熔断器 Hystrix 的原理与使用</a></li>
<li><a href="https://juejin.im/post/5d822d27e51d45621479ad92/" target="_blank" rel="noopener">https://juejin.im/post/5d822d27e51d45621479ad92/</a></li>
<li>《微服务架构实战》</li>
<li>《Spring Boot &amp; Kubernetes 云原生微服务实践》</li>
<li>《从0开始学微服务》</li>
<li>《微服务设计》</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MicroServices/" rel="tag"># MicroServices</a>
              <a href="/tags/SpringCloud/" rel="tag"># SpringCloud</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/back-end/java/spring-cloud-open-feign/" rel="prev" title="微服务架构之声明式服务调用：Spring Cloud OpenFeign">
      <i class="fa fa-chevron-left"></i> 微服务架构之声明式服务调用：Spring Cloud OpenFeign
    </a></div>
      <div class="post-nav-item">
    <a href="/back-end/java/spring-cloud-zuul/" rel="next" title="微服务架构之API网关：Spring Cloud Zuul">
      微服务架构之API网关：Spring Cloud Zuul <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么需要服务容错保护？"><span class="nav-number">1.</span> <span class="nav-text">为什么需要服务容错保护？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#容错限流原理"><span class="nav-number">2.</span> <span class="nav-text">容错限流原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本的容错模式"><span class="nav-number">2.1.</span> <span class="nav-text">基本的容错模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#断路器模式"><span class="nav-number">2.2.</span> <span class="nav-text">断路器模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#舱壁隔离模式"><span class="nav-number">2.3.</span> <span class="nav-text">舱壁隔离模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#容错理念"><span class="nav-number">2.4.</span> <span class="nav-text">容错理念</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-简介"><span class="nav-number">3.</span> <span class="nav-text">Hystrix 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-设计原理"><span class="nav-number">4.</span> <span class="nav-text">Hystrix 设计原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#断路器内核原理"><span class="nav-number">5.</span> <span class="nav-text">断路器内核原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-主要概念"><span class="nav-number">6.</span> <span class="nav-text">Hystrix 主要概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-Command"><span class="nav-number">6.1.</span> <span class="nav-text">Hystrix Command</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fail-Fast"><span class="nav-number">6.2.</span> <span class="nav-text">Fail Fast</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fail-Silent"><span class="nav-number">6.3.</span> <span class="nav-text">Fail Silent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Static-Fallback"><span class="nav-number">6.4.</span> <span class="nav-text">Static Fallback</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fallback-via-Network"><span class="nav-number">6.5.</span> <span class="nav-text">Fallback via Network</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Primary-Secondary-with-Fallback"><span class="nav-number">6.6.</span> <span class="nav-text">Primary + Secondary with Fallback</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求合并"><span class="nav-number">6.7.</span> <span class="nav-text">请求合并</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求缓存"><span class="nav-number">6.8.</span> <span class="nav-text">请求缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程和信号量隔离"><span class="nav-number">6.9.</span> <span class="nav-text">线程和信号量隔离</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境"><span class="nav-number">7.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建一个-hystrix-service-模块"><span class="nav-number">8.</span> <span class="nav-text">创建一个 hystrix-service 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HystrixCommand-详解"><span class="nav-number">9.</span> <span class="nav-text">@HystrixCommand 详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HystrixCommand-中的常用参数"><span class="nav-number">9.1.</span> <span class="nav-text">@HystrixCommand 中的常用参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置命令、分组及线程池名称"><span class="nav-number">9.2.</span> <span class="nav-text">设置命令、分组及线程池名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-ignoreExceptions-忽略某些异常降级"><span class="nav-number">9.3.</span> <span class="nav-text">使用 ignoreExceptions 忽略某些异常降级</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-的请求缓存"><span class="nav-number">10.</span> <span class="nav-text">Hystrix 的请求缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关注解"><span class="nav-number">10.1.</span> <span class="nav-text">相关注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试使用缓存"><span class="nav-number">10.2.</span> <span class="nav-text">测试使用缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试移除缓存"><span class="nav-number">10.3.</span> <span class="nav-text">测试移除缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-请求合并"><span class="nav-number">11.</span> <span class="nav-text">Hystrix 请求合并</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HystrixCollapser-的常用属性"><span class="nav-number">11.1.</span> <span class="nav-text">@HystrixCollapser 的常用属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#功能演示"><span class="nav-number">11.2.</span> <span class="nav-text">功能演示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-的常用配置"><span class="nav-number">12.</span> <span class="nav-text">Hystrix 的常用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#全局配置"><span class="nav-number">12.1.</span> <span class="nav-text">全局配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实例配置"><span class="nav-number">12.2.</span> <span class="nav-text">实例配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置文件中相关-key-的说明"><span class="nav-number">12.2.1.</span> <span class="nav-text">配置文件中相关 key 的说明</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-Dashboard"><span class="nav-number">13.</span> <span class="nav-text">Hystrix Dashboard</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-单个实例监控"><span class="nav-number">13.1.</span> <span class="nav-text">Hystrix 单个实例监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-Dashboard-图表解读"><span class="nav-number">13.2.</span> <span class="nav-text">Hystrix Dashboard 图表解读</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-集群实例监控"><span class="nav-number">13.3.</span> <span class="nav-text">Hystrix 集群实例监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Turbine-原理"><span class="nav-number">13.4.</span> <span class="nav-text">Turbine 原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建一个-turbine-service-模块"><span class="nav-number">13.5.</span> <span class="nav-text">创建一个 turbine-service 模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最佳实践"><span class="nav-number">14.</span> <span class="nav-text">最佳实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展"><span class="nav-number">15.</span> <span class="nav-text">扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-新版本设计原理"><span class="nav-number">15.1.</span> <span class="nav-text">Hystrix 新版本设计原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引入-Hystrix-架构"><span class="nav-number">15.2.</span> <span class="nav-text">引入 Hystrix 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网关和-Hystrix-参考部署"><span class="nav-number">15.3.</span> <span class="nav-text">网关和 Hystrix 参考部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-和-Turbine-对接-Eureka-架构"><span class="nav-number">15.4.</span> <span class="nav-text">Hystrix 和 Turbine 对接 Eureka 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程隔离案例"><span class="nav-number">15.5.</span> <span class="nav-text">线程隔离案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程-vs-信号量隔离"><span class="nav-number">15.6.</span> <span class="nav-text">线程 vs 信号量隔离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#断路器机制"><span class="nav-number">15.7.</span> <span class="nav-text">断路器机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它开源容错限流产品"><span class="nav-number">15.8.</span> <span class="nav-text">其它开源容错限流产品</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题"><span class="nav-number">16.</span> <span class="nav-text">问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存使用过程中的问题"><span class="nav-number">16.1.</span> <span class="nav-text">缓存使用过程中的问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">17.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Richard"
      src="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
  <p class="site-author-name" itemprop="name">Richard</p>
  <div class="site-description" itemprop="description">惶者生存，偏执者成功</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xinlc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/xinlc" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://learnxinyminutes.com/" title="https:&#x2F;&#x2F;learnxinyminutes.com" rel="noopener" target="_blank">Learn X in Y minutes</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://justjavac.com/" title="http:&#x2F;&#x2F;justjavac.com" rel="noopener" target="_blank">justjavac</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.ruanyifeng.com/blog/" title="http:&#x2F;&#x2F;www.ruanyifeng.com&#x2F;blog&#x2F;" rel="noopener" target="_blank">阮一峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.liaoxuefeng.com/" title="https:&#x2F;&#x2F;www.liaoxuefeng.com" rel="noopener" target="_blank">廖雪峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tech.meituan.com/" title="https:&#x2F;&#x2F;tech.meituan.com" rel="noopener" target="_blank">美团技术</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.v2ex.com/" title="https:&#x2F;&#x2F;www.v2ex.com" rel="noopener" target="_blank">V2EX</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://caniuse.com/" title="https:&#x2F;&#x2F;caniuse.com" rel="noopener" target="_blank">caniuse/工具</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.css88.com/nav/" title="http:&#x2F;&#x2F;www.css88.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">css88/doc</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://overapi.com/" title="http:&#x2F;&#x2F;overapi.com&#x2F;" rel="noopener" target="_blank">OverAPI/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://devdocs.io/" title="http:&#x2F;&#x2F;devdocs.io&#x2F;" rel="noopener" target="_blank">DevDocs/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.oschina.net/" title="http:&#x2F;&#x2F;tool.oschina.net&#x2F;" rel="noopener" target="_blank">在线工具/索引</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.lu/" title="http:&#x2F;&#x2F;tool.lu&#x2F;" rel="noopener" target="_blank">ToolBox</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://hao.shejidaren.com/" title="http:&#x2F;&#x2F;hao.shejidaren.com&#x2F;" rel="noopener" target="_blank">设计导航</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
