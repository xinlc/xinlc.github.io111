<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.lichao.xin","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"3ZZ8ITB7HE","apiKey":"062eb5a54afbcbf3f20452d58fc40035","indexName":"xinlc","hits":{"per_page":10},"labels":{"input_placeholder":"搜索","hits_empty":"未发现与「${query}」相关的内容","hits_stats":"${hits} 条相关条目，使用了 ${time} 毫秒"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Spring Cloud Security 为构建安全的 SpringBoot 应用提供了一系列解决方案，结合 OAuth2 可以实现单点登录、令牌中继、令牌交换等功能。">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务架构之安全认证：Spring Cloud Security OAuth2">
<meta property="og:url" content="https://blog.lichao.xin/back-end/java/spring-cloud-oauth2/index.html">
<meta property="og:site_name" content="Richard Xin&#39;s Blog">
<meta property="og:description" content="Spring Cloud Security 为构建安全的 SpringBoot 应用提供了一系列解决方案，结合 OAuth2 可以实现单点登录、令牌中继、令牌交换等功能。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/1.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/2.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/3.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/4.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/5.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/6.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/7.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/8.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/9.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/10.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/11.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/12.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/13.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/14.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/15.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/16.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/17.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/18.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/19.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/20.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/21.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/22.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/23.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/24.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/25.jpg">
<meta property="article:published_time" content="2020-03-08T19:49:00.000Z">
<meta property="article:modified_time" content="2021-06-14T01:33:22.387Z">
<meta property="article:author" content="Richard">
<meta property="article:tag" content="MicroServices">
<meta property="article:tag" content="SpringCloud">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lichao.xin/images/java/spring-cloud-oauth2/1.jpg">

<link rel="canonical" href="https://blog.lichao.xin/back-end/java/spring-cloud-oauth2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>微服务架构之安全认证：Spring Cloud Security OAuth2 | Richard Xin's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4530ac9d0bc4e258535c4a9b17029f0c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Richard Xin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Richard Xin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Quick notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">132</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">59</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.lichao.xin/back-end/java/spring-cloud-oauth2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
      <meta itemprop="name" content="Richard">
      <meta itemprop="description" content="惶者生存，偏执者成功">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Richard Xin's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          微服务架构之安全认证：Spring Cloud Security OAuth2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-08 19:49:00" itemprop="dateCreated datePublished" datetime="2020-03-08T19:49:00+00:00">2020-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-14 01:33:22" itemprop="dateModified" datetime="2021-06-14T01:33:22+00:00">2021-06-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Spring Cloud Security 为构建安全的 SpringBoot 应用提供了一系列解决方案，结合 OAuth2 可以实现单点登录、令牌中继、令牌交换等功能。</p>
<a id="more"></a>

<h2 id="OAuth2-提出背景"><a href="#OAuth2-提出背景" class="headerlink" title="OAuth2 提出背景"></a>OAuth2 提出背景</h2><p>先来简单介绍一下 OAuth2 协议是基于什么背景提出来的。</p>
<h3 id="开放系统间授权"><a href="#开放系统间授权" class="headerlink" title="开放系统间授权"></a>开放系统间授权</h3><p><img src="/images/java/spring-cloud-oauth2/1.jpg" alt="1"></p>
<p>最初是基于开放系统间授权提出来的，假如有这样一个场景，有个云存储服务（box）存着我们的一些照片，现在有个第三方应用云冲印服务，这个照片是我的，我是相片拥有者我有权对它操作，现在我想通过第三方的云冲印服务打印云存储上的照片，这就涉及到开发系统间授权的问题。</p>
<p>这里有三个概念：</p>
<ul>
<li>资源拥有者：我；</li>
<li>客户应用：第三方应用（云冲印服务）；</li>
<li>受保护的资源：box；</li>
</ul>
<p>那么我能让第三方（云冲印服务）来访问我在云存储服务上的照片呢？</p>
<h3 id="方法一：用户名密码复制"><a href="#方法一：用户名密码复制" class="headerlink" title="方法一：用户名密码复制"></a>方法一：用户名密码复制</h3><p><img src="/images/java/spring-cloud-oauth2/2.jpg" alt="2"></p>
<p>我把自己的用户名和密码传给客户应用，然后它有了用户名密码就可以访问我的受保护的资源。这是最简单粗暴的办法，也是大部分场景下在公司内部的是这么做的，比如说公司内部开发了一个应用程序，公司的用户名密码一般存在 LDAP 中，那你要使用这个应用的时候输入用户名和密码，然后这个应用会去 LDAP 中校验。这是最简单的方式，但是这种方式在开发系统间是行不通的，因为这个第三方应用一般是不受信的，把用户名密码给它了有很大的安全风险。</p>
<h3 id="方法二：万能钥匙"><a href="#方法二：万能钥匙" class="headerlink" title="方法二：万能钥匙"></a>方法二：万能钥匙</h3><p><img src="/images/java/spring-cloud-oauth2/3.jpg" alt="3"></p>
<p>如果客户应用和受保护资源是有一种信任关系的，比如是合作商或是一个公司的两个不同的部门。这种信任一般可以来协商一个通用的万能钥匙（developer key），但是对于不授信的第三方应用来说也是不安全的，会有 <code>developer key</code> 被泄露的问题。</p>
<h3 id="方法三：特殊令牌"><a href="#方法三：特殊令牌" class="headerlink" title="方法三：特殊令牌"></a>方法三：特殊令牌</h3><p><img src="/images/java/spring-cloud-oauth2/4.jpg" alt="4"></p>
<p>我给受保护的资源设置一个特殊的密码或者令牌，仅能访问这个受保护的资源。这个就是很类似 OAuth2 授权了，但是怎么来管理这个令牌，怎么颁发令牌，怎么来吊销这个令牌，这里面就有很多讲究，OAuth2 的设计就是来解决这些问题的。</p>
<h3 id="传统单块应用安全"><a href="#传统单块应用安全" class="headerlink" title="传统单块应用安全"></a>传统单块应用安全</h3><p>除了开放系统间的授权问题，在微服务中还要解决什么问题？先来看一下传统的单块应用安全。</p>
<p><img src="/images/java/spring-cloud-oauth2/5.jpg" alt="5"></p>
<p>在传统的单块应用的安全，一般会有业务 DB 和用户 DB，一个用户登录请求过来以后，会经过一个过滤器去用户 DB 中做鉴权登录，如果通过了会在客户的浏览器中种一个 Cookie 能够记住这个用户，那么相互之间浏览器和应用服务器之间就建立了一个 Session，这是传统的单快应用安全认证的做法。</p>
<h3 id="现代微服务安全"><a href="#现代微服务安全" class="headerlink" title="现代微服务安全"></a>现代微服务安全</h3><p><img src="/images/java/spring-cloud-oauth2/6.jpg" alt="6"></p>
<p>现代互联网系统一般都采用微服务架构，不是单快应用架构。有两个方面的问题，一个是服务拆分的粒度比较细，那么服务和服务之间怎么来认证鉴权；另外一个应用的形态变的多种多样，不再是简单的浏览器应用，还有单页应用、无线 App 应用、服务器端应用等等，应用的形态或设备的类型越来越多。这种情况下不但要解决应用系统内部的服务安全问题，还要对外部多种形态接入的客户端进行安全认证。</p>
<p>这种情况下不就不再适用传统的方式去做安全，而是会有一个独立的服务（AuthServer）把认证和授权都做成一个 Service，核心的技术点不再是原来的用户名密码和 Session，而是基于 Token 的授权。</p>
<h3 id="OAuth2-解决问题域和场景"><a href="#OAuth2-解决问题域和场景" class="headerlink" title="OAuth2 解决问题域和场景"></a>OAuth2 解决问题域和场景</h3><p>在现实生活中我们无时无刻都在使用 OAuth2 授权，比如：大众点评App 通过微信登录；玩王者荣耀时通过微信登录；在用淘宝购物时使用新浪微博登录等等。</p>
<p><img src="/images/java/spring-cloud-oauth2/7.jpg" alt="7"></p>
<p>OAuth2 要解决的问题和场景，大致分为三类：</p>
<ol>
<li>开发系统间的授权<ul>
<li>社交联合登录，现在很多应用都支持微信来登录；</li>
<li>开放API平台，如果公司发展到一定阶段，你要开放平台，那么开放的API也可通过 OAuth2 来解决。</li>
</ul>
</li>
<li>现代微服务安全<ul>
<li>企业内部微服务化后外部需要有很多场景要接入；</li>
<li>单页 H5 应用；</li>
<li>无线 App 应用；</li>
<li>微服务API间调用等。</li>
</ul>
</li>
<li>企业内部应用认证授权（IAM/SSO）<ul>
<li>企业内部也有很多应用要相互授权；</li>
<li>比如单点登录（SSO)。</li>
</ul>
</li>
</ol>
<h2 id="OAuth2-定义和原理"><a href="#OAuth2-定义和原理" class="headerlink" title="OAuth2 定义和原理"></a>OAuth2 定义和原理</h2><p>OAuth 2.0是用于授权的行业标准协议。OAuth 2.0为简化客户端开发提供了特定的授权流，包括Web应用、桌面应用、移动端应用等。</p>
<p><img src="/images/java/spring-cloud-oauth2/8.jpg" alt="8"></p>
<h3 id="OAuth-2-0-的历史"><a href="#OAuth-2-0-的历史" class="headerlink" title="OAuth 2.0 的历史"></a>OAuth 2.0 的历史</h3><p><img src="/images/java/spring-cloud-oauth2/9.jpg" alt="9"></p>
<h3 id="OAuth-2-0-优势"><a href="#OAuth-2-0-优势" class="headerlink" title="OAuth 2.0 优势"></a>OAuth 2.0 优势</h3><p><img src="/images/java/spring-cloud-oauth2/10.jpg" alt="10"></p>
<h3 id="OAuth-2-0-不足"><a href="#OAuth-2-0-不足" class="headerlink" title="OAuth 2.0 不足"></a>OAuth 2.0 不足</h3><p><img src="/images/java/spring-cloud-oauth2/11.jpg" alt="11"></p>
<h3 id="OAuth-2-0-主要角色"><a href="#OAuth-2-0-主要角色" class="headerlink" title="OAuth 2.0 主要角色"></a>OAuth 2.0 主要角色</h3><p><img src="/images/java/spring-cloud-oauth2/12.jpg" alt="12"></p>
<p>OAuth2 相关名词解释：</p>
<ul>
<li>Resource owner（资源拥有者）：拥有该资源的最终用户，他有访问资源的账号密码；</li>
<li>Client（客户端）：访问资源的客户端，会使用访问令牌去获取资源服务器的资源，可以是浏览器、移动设备或者服务器；</li>
<li>Resource server（资源服务器）：拥有受保护资源的服务器，如果请求包含正确的访问令牌，可以访问资源；</li>
<li>Authorization server（认证服务器）：用于认证用户的服务器，如果客户端认证通过，发放访问资源服务器的令牌；</li>
<li>客户凭证（Client Credentials）：客户的clientId 和密码用于认证客户；</li>
<li>令牌（Tokens）：授权服务器在接收到客户请求后，颁发的访问令牌；</li>
<li>作用域（Scopes）：客户请求访问令牌时，由资源拥有者额外指定的细分权限（permission）；</li>
</ul>
<p>OAuth 令牌类型：</p>
<ul>
<li>访问令牌（Access Token）：用于代表一个用户或服务直接去访问受保护的资源；</li>
<li>刷新令牌（Refresh Token）：用于去授权服务器获取一个新的访问令牌；</li>
<li>授权码（Authorization Code Token）：仅用于授权码授权类型，用于交换获取访问令牌和刷新令牌；</li>
<li>Bearer Token：不管谁拿到 Token 都可以访问资源，像现钞；</li>
<li>Proof of Possession(PoP) Token：可以校验 client 是否对 Token 有明确的拥有权；</li>
</ul>
<h3 id="OAuth-2-0-误解"><a href="#OAuth-2-0-误解" class="headerlink" title="OAuth 2.0 误解"></a>OAuth 2.0 误解</h3><p><img src="/images/java/spring-cloud-oauth2/13.jpg" alt="13"></p>
<p>总结：</p>
<ul>
<li>OAuth 本质如何获取 token 如何使用 token；</li>
<li>OAuth 是一种在系统之间的代理授权（delegation authorization）协议；</li>
<li>OAuth 提供一个宽泛的协议框架，具体安全场景需要定制；</li>
<li>OAuth 使用代理协议的方式解决密码共享反模式问题；</li>
</ul>
<h2 id="典型-OAuth-Flow-和选型"><a href="#典型-OAuth-Flow-和选型" class="headerlink" title="典型 OAuth Flow 和选型"></a>典型 OAuth Flow 和选型</h2><h3 id="运行流程"><a href="#运行流程" class="headerlink" title="运行流程"></a>运行流程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+--------+                               +---------------+</span><br><span class="line">|        |--(A)- Authorization Request -&gt;|   Resource    |</span><br><span class="line">|        |                               |     Owner     |</span><br><span class="line">|        |&lt;-(B)-- Authorization Grant ---|               |</span><br><span class="line">|        |                               +---------------+</span><br><span class="line">|        |</span><br><span class="line">|        |                               +---------------+</span><br><span class="line">|        |--(C)-- Authorization Grant --&gt;| Authorization |</span><br><span class="line">| Client |                               |     Server    |</span><br><span class="line">|        |&lt;-(D)----- Access Token -------|               |</span><br><span class="line">|        |                               +---------------+</span><br><span class="line">|        |</span><br><span class="line">|        |                               +---------------+</span><br><span class="line">|        |--(E)----- Access Token ------&gt;|    Resource   |</span><br><span class="line">|        |                               |     Server    |</span><br><span class="line">|        |&lt;-(F)--- Protected Resource ---|               |</span><br><span class="line">+--------+                               +---------------+</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>（A）用户打开客户端以后，客户端要求用户给予授权。</li>
<li>（B）用户同意给予客户端授权。</li>
<li>（C）客户端使用上一步获得的授权，向认证服务器申请令牌。</li>
<li>（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。</li>
<li>（E）客户端使用令牌，向资源服务器申请获取资源。</li>
<li>（F）资源服务器确认令牌无误，同意向客户端开放资源。</li>
</ul>
<h3 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h3><p>授权码模式（authorization code）是功能最完整、流程最严密的授权模式。它的特点就是通过客户端的后台服务器，与”服务提供商”的认证服务器进行互动。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| Resource |</span><br><span class="line">|   Owner  |</span><br><span class="line">|          |</span><br><span class="line">+----------+</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    (B)</span><br><span class="line">+----|-----+          Client Identifier      +---------------+</span><br><span class="line">|         -+----(A)-- &amp; Redirection URI ----&gt;|               |</span><br><span class="line">|  User-   |                                 | Authorization |</span><br><span class="line">|  Agent  -+----(B)-- User authenticates ---&gt;|     Server    |</span><br><span class="line">|          |                                 |               |</span><br><span class="line">|         -+----(C)-- Authorization Code ---&lt;|               |</span><br><span class="line">+-|----|---+                                 +---------------+</span><br><span class="line">  |    |                                         ^      v</span><br><span class="line">(A)  (C)                                         |      |</span><br><span class="line">  |    |                                         |      |</span><br><span class="line">  ^    v                                         |      |</span><br><span class="line">+---------+                                      |      |</span><br><span class="line">|         |&gt;---(D)-- Authorization Code ---------&#39;      |</span><br><span class="line">|  Client |          &amp; Redirection URI                  |</span><br><span class="line">|         |                                             |</span><br><span class="line">|         |&lt;---(E)----- Access Token -------------------&#39;</span><br><span class="line">+---------+       (w&#x2F; Optional Refresh Token)</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>（A）用户访问客户端，后者将前者导向认证服务器。</li>
<li>（B）用户选择是否给予客户端授权。</li>
<li>（C）假设用户给予授权，认证服务器将用户导向客户端事先指定的”重定向URI”（redirection URI），同时附上一个授权码。</li>
<li>（D）客户端收到授权码，附上早先的”重定向URI”，向认证服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。</li>
<li>（E）认证服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）。</li>
</ul>
<h3 id="简化模式"><a href="#简化模式" class="headerlink" title="简化模式"></a>简化模式</h3><p>简化模式（implicit grant type）不通过第三方应用程序的服务器，直接在浏览器中向认证服务器申请令牌，跳过了”授权码”这个步骤，因此得名。所有步骤在浏览器中完成，令牌对访问者是可见的，且客户端不需要认证。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| Resource |</span><br><span class="line">|  Owner   |</span><br><span class="line">|          |</span><br><span class="line">+----------+</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    (B)</span><br><span class="line">+----|-----+          Client Identifier     +---------------+</span><br><span class="line">|         -+----(A)-- &amp; Redirection URI ---&gt;|               |</span><br><span class="line">|  User-   |                                | Authorization |</span><br><span class="line">|  Agent  -|----(B)-- User authenticates --&gt;|     Server    |</span><br><span class="line">|          |                                |               |</span><br><span class="line">|          |&lt;---(C)--- Redirection URI ----&lt;|               |</span><br><span class="line">|          |          with Access Token     +---------------+</span><br><span class="line">|          |            in Fragment</span><br><span class="line">|          |                                +---------------+</span><br><span class="line">|          |----(D)--- Redirection URI ----&gt;|   Web-Hosted  |</span><br><span class="line">|          |          without Fragment      |     Client    |</span><br><span class="line">|          |                                |    Resource   |</span><br><span class="line">|     (F)  |&lt;---(E)------- Script ---------&lt;|               |</span><br><span class="line">|          |                                +---------------+</span><br><span class="line">+-|--------+</span><br><span class="line">  |    |</span><br><span class="line">(A)  (G) Access Token</span><br><span class="line">  |    |</span><br><span class="line">  ^    v</span><br><span class="line">+---------+</span><br><span class="line">|         |</span><br><span class="line">|  Client |</span><br><span class="line">|         |</span><br><span class="line">+---------+</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>（A）客户端将用户导向认证服务器。</li>
<li>（B）用户决定是否给于客户端授权。</li>
<li>（C）假设用户给予授权，认证服务器将用户导向客户端指定的”重定向URI”，并在URI的Hash部分包含了访问令牌。</li>
<li>（D）浏览器向资源服务器发出请求，其中不包括上一步收到的Hash值。</li>
<li>（E）资源服务器返回一个网页，其中包含的代码可以获取Hash值中的令牌。</li>
<li>（F）浏览器执行上一步获得的脚本，提取出令牌。</li>
<li>（G）浏览器将令牌发给客户端。</li>
</ul>
<h3 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h3><p>密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向”服务商提供商”索要授权。</p>
<p>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| Resource |</span><br><span class="line">|  Owner   |</span><br><span class="line">|          |</span><br><span class="line">+----------+</span><br><span class="line">    v</span><br><span class="line">    |    Resource Owner</span><br><span class="line">    (A) Password Credentials</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line">+---------+                                  +---------------+</span><br><span class="line">|         |&gt;--(B)---- Resource Owner -------&gt;|               |</span><br><span class="line">|         |         Password Credentials     | Authorization |</span><br><span class="line">| Client  |                                  |     Server    |</span><br><span class="line">|         |&lt;--(C)---- Access Token ---------&lt;|               |</span><br><span class="line">|         |    (w&#x2F; Optional Refresh Token)   |               |</span><br><span class="line">+---------+                                  +---------------+</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>（A）用户向客户端提供用户名和密码。</li>
<li>（B）客户端将用户名和密码发给认证服务器，向后者请求令牌。</li>
<li>（C）认证服务器确认无误后，向客户端提供访问令牌。</li>
</ul>
<h3 id="客户端模式"><a href="#客户端模式" class="headerlink" title="客户端模式"></a>客户端模式</h3><p>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向”服务提供商”进行认证。严格地说，客户端模式并不属于OAuth框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求”服务提供商”提供服务，其实不存在授权问题。这种模式一般是机器对机器比如 docker client 去镜像仓库拉去镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+---------+                                  +---------------+</span><br><span class="line">|         |                                  |               |</span><br><span class="line">|         |&gt;--(A)- Client Authentication ---&gt;| Authorization |</span><br><span class="line">| Client  |                                  |     Server    |</span><br><span class="line">|         |&lt;--(B)---- Access Token ---------&lt;|               |</span><br><span class="line">|         |                                  |               |</span><br><span class="line">+---------+                                  +---------------+</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>（A）客户端向认证服务器进行身份认证，并要求一个访问令牌。</li>
<li>（B）认证服务器确认无误后，向客户端提供访问令牌。</li>
</ul>
<h3 id="刷新令牌"><a href="#刷新令牌" class="headerlink" title="刷新令牌"></a>刷新令牌</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+--------+                                           +---------------+</span><br><span class="line">|        |--(A)------- Authorization Grant ---------&gt;|               |</span><br><span class="line">|        |                                           |               |</span><br><span class="line">|        |&lt;-(B)----------- Access Token -------------|               |</span><br><span class="line">|        |               &amp; Refresh Token             |               |</span><br><span class="line">|        |                                           |               |</span><br><span class="line">|        |                            +----------+   |               |</span><br><span class="line">|        |--(C)---- Access Token ----&gt;|          |   |               |</span><br><span class="line">|        |                            |          |   |               |</span><br><span class="line">|        |&lt;-(D)- Protected Resource --| Resource |   | Authorization |</span><br><span class="line">| Client |                            |  Server  |   |     Server    |</span><br><span class="line">|        |--(E)---- Access Token ----&gt;|          |   |               |</span><br><span class="line">|        |                            |          |   |               |</span><br><span class="line">|        |&lt;-(F)- Invalid Token Error -|          |   |               |</span><br><span class="line">|        |                            +----------+   |               |</span><br><span class="line">|        |                                           |               |</span><br><span class="line">|        |--(G)----------- Refresh Token -----------&gt;|               |</span><br><span class="line">|        |                                           |               |</span><br><span class="line">|        |&lt;-(H)----------- Access Token -------------|               |</span><br><span class="line">+--------+           &amp; Optional Refresh Token        +---------------+</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>（A）通过一种授权的方式，一般是授权码模式。</li>
<li>（B）通过授权服务器获取 Access Token 和 Refresh Token。</li>
<li>（C）客户端带上 Access Token 去访问资源。</li>
<li>（D）Access Token 在正常的有效期内可以拿到受保护的资源。</li>
<li>（E）过了一段时间 Access Token 失效了，去访问资源。</li>
<li>（F）资源服务验证 Token 过期了就返回验证错误。</li>
<li>（G）客户端发现错误后，可以把刷新令牌发送到授权服务器，请求刷新。</li>
<li>（H）返回新的 Access Token，也可以返回新的刷新令牌。</li>
</ul>
<h3 id="授权流程渠道-channels"><a href="#授权流程渠道-channels" class="headerlink" title="授权流程渠道(channels)"></a>授权流程渠道(channels)</h3><p><img src="/images/java/spring-cloud-oauth2/14.jpg" alt="14"></p>
<p>渠道划分：</p>
<ol>
<li>没有资源服务器参与的称为前端渠道。</li>
<li>没有资源拥有者参与的称为后端渠道。</li>
</ol>
<h3 id="客户应用类型"><a href="#客户应用类型" class="headerlink" title="客户应用类型"></a>客户应用类型</h3><p><img src="/images/java/spring-cloud-oauth2/15.jpg" alt="15"></p>
<p>大致分为两类：</p>
<ol>
<li>公开应用：主要针对单页SAP，原生APP，这种场景就不能把客户的凭证信息存在着上面，比如客户的密码，一般只存公开的标识。</li>
<li>私密应用：服务器端的应用，比较安全是私密的，这里就能存储比较私密的信息。</li>
</ol>
<h3 id="四种OAuth-2-0授权类型-Flows-总结"><a href="#四种OAuth-2-0授权类型-Flows-总结" class="headerlink" title="四种OAuth 2.0授权类型(Flows)总结"></a>四种OAuth 2.0授权类型(Flows)总结</h3><h4 id="授权码-Authorization-Code"><a href="#授权码-Authorization-Code" class="headerlink" title="授权码 Authorization Code"></a>授权码 Authorization Code</h4><ul>
<li>通过前端渠道客户获取授权码；</li>
<li>通过后端渠道，客户使用 authorization；</li>
<li>code去交换access Token和可选的refresh token；</li>
<li>假定资源拥有者和客户在不同的设备上；</li>
<li>最安全的流程，因为令牌不会传递经过user-agent；</li>
</ul>
<h4 id="简化Implicit"><a href="#简化Implicit" class="headerlink" title="简化Implicit"></a>简化Implicit</h4><ul>
<li>适用于公开的浏览器单页应用；</li>
<li>Access Token直接从授权服务器返回（只有前端渠道）；</li>
<li>不支持refresh tokens；</li>
<li>假定资源所有者和公开客户应用在同一个设备上；</li>
<li>最容易受安全攻击；</li>
</ul>
<h4 id="用户名密码Resource-Owner-Credentials"><a href="#用户名密码Resource-Owner-Credentials" class="headerlink" title="用户名密码Resource Owner Credentials"></a>用户名密码Resource Owner Credentials</h4><ul>
<li>使用用户名密码登录的应用，例如桌面App；</li>
<li>使用用户名/密码作为授权方式从授权服务器上获取access token；</li>
<li>一般不支持refresh tokens；</li>
<li>假定资源拥有者和公开客户在相同设备上；</li>
</ul>
<h4 id="客户端凭证Client-Credentials"><a href="#客户端凭证Client-Credentials" class="headerlink" title="客户端凭证Client Credentials"></a>客户端凭证Client Credentials</h4><ul>
<li>适用于服务器间通信场景，机密客户代表它自己或者一个用户；</li>
<li>只有后端渠道，使用客户凭证获取一个access token；</li>
<li>因为客户凭证可以使用对称或者非对称加密，该方式支持共享密码或者证书；</li>
</ul>
<h3 id="授权类型选择流程"><a href="#授权类型选择流程" class="headerlink" title="授权类型选择流程"></a>授权类型选择流程</h3><p><img src="/images/java/spring-cloud-oauth2/16.jpg" alt="16"></p>
<h3 id="授权服务器组成"><a href="#授权服务器组成" class="headerlink" title="授权服务器组成"></a>授权服务器组成</h3><p><img src="/images/java/spring-cloud-oauth2/17.jpg" alt="17"></p>
<p>主要是由四个端点组成：</p>
<ol>
<li>授权端点：客户拿到 Token 之前需要授权。</li>
<li>Token 端点：经过授权以后，可以通过 Token 端点拿到 Token。</li>
<li>校验端点：主要是资源服务器，拿到 Token 后要校验是否合法。</li>
<li>吊销端点：有时候需要显示的去吊销 Token，比如发现这个用户在干坏事情。</li>
</ol>
<h2 id="Spring-Security-OAuth2架构"><a href="#Spring-Security-OAuth2架构" class="headerlink" title="Spring Security OAuth2架构"></a>Spring Security OAuth2架构</h2><ul>
<li><a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/Security/OAuth.html" target="_blank" rel="noopener">http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/Security/OAuth.html</a></li>
</ul>
<p><img src="/images/java/spring-cloud-oauth2/18.jpg" alt="18"></p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>JDK：1.8</li>
<li>Spring Boot：2.2.4.RELEASE</li>
<li>Spring Cloud：Hoxton.SR</li>
</ul>
<h2 id="创建-oauth2-server-模块"><a href="#创建-oauth2-server-模块" class="headerlink" title="创建 oauth2-server 模块"></a>创建 oauth2-server 模块</h2><p>oauth2-server 模块作为认证服务器来使用，在 pom.xml 中添加相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 application.yml 中进行配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9401</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">oauth2-service</span></span><br></pre></td></tr></table></figure>

<p>添加 UserService 实现 UserDetailsService 接口，用于加载用户信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; userList;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String password = passwordEncoder.encode(<span class="string">"123456"</span>);</span><br><span class="line">        userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        userList.add(<span class="keyword">new</span> User(<span class="string">"leo"</span>, password, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"admin"</span>)));</span><br><span class="line">        userList.add(<span class="keyword">new</span> User(<span class="string">"leo2"</span>, password, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"client"</span>)));</span><br><span class="line">        userList.add(<span class="keyword">new</span> User(<span class="string">"leo3"</span>, password, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"client"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        List&lt;User&gt; findUserList = userList.stream().filter(user -&gt; user.getUsername().equals(username)).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(findUserList)) &#123;</span><br><span class="line">            <span class="keyword">return</span> findUserList.get(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"用户名或密码错误"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加认证服务器配置，使用 @EnableAuthorizationServer 注解开启：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证服务器配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用密码模式需要配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> </span>&#123;</span><br><span class="line">        endpoints.authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.inMemory()</span><br><span class="line">                .withClient(<span class="string">"admin"</span>)<span class="comment">//配置client_id</span></span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">"admin123456"</span>))<span class="comment">//配置client_secret</span></span><br><span class="line">                .accessTokenValiditySeconds(<span class="number">3600</span>)<span class="comment">//配置访问token的有效期</span></span><br><span class="line">                .refreshTokenValiditySeconds(<span class="number">864000</span>)<span class="comment">//配置刷新token的有效期</span></span><br><span class="line">                .redirectUris(<span class="string">"http://www.baidu.com"</span>)<span class="comment">//配置redirect_uri，用于授权成功后跳转</span></span><br><span class="line">                .scopes(<span class="string">"all"</span>)<span class="comment">//配置申请的权限范围</span></span><br><span class="line">                .authorizedGrantTypes(<span class="string">"authorization_code"</span>,<span class="string">"password"</span>);<span class="comment">//配置grant_type，表示授权类型</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加资源服务器配置，使用 @EnableResourceServer 注解开启：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源服务器配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .requestMatchers()</span><br><span class="line">                .antMatchers(<span class="string">"/user/**"</span>);<span class="comment">//配置需要保护的资源路径</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加 SpringSecurity 配置，允许认证相关路径的访问及表单登录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpringSecurity配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf()</span><br><span class="line">                .disable()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/oauth/**"</span>, <span class="string">"/login/**"</span>, <span class="string">"/logout/**"</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .permitAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加需要登录的接口用于测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/getCurrentUser"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCurrentUser</span><span class="params">(Authentication authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authentication.getPrincipal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>授权码模式使用：</p>
<ol>
<li>启动oauth2-server服务；</li>
<li>在浏览器访问该地址进行登录授权：<a href="http://localhost:9401/oauth/authorize?response_type=code&amp;client_id=admin&amp;redirect_uri=http://www.baidu.com&amp;scope=all&amp;state=normal" target="_blank" rel="noopener">http://localhost:9401/oauth/authorize?response_type=code&amp;client_id=admin&amp;redirect_uri=http://www.baidu.com&amp;scope=all&amp;state=normal</a></li>
<li>输入账号密码进行登录操作；</li>
<li>登录后进行授权操作；</li>
<li>之后浏览器会带着授权码跳转到我们指定的路径：<a href="https://www.baidu.com/?code=aTbEUP&amp;state=normal" target="_blank" rel="noopener">https://www.baidu.com/?code=aTbEUP&amp;state=normal</a></li>
<li>使用授权码请求该地址获取访问令牌：<a href="http://localhost:9401/oauth/token" target="_blank" rel="noopener">http://localhost:9401/oauth/token</a></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -u admin:admin123456 http://localhost:9401/oauth/token -H</span><br><span class="line"><span class="string">"content-type: application/x-www-form-urlencoded"</span> -d</span><br><span class="line"><span class="string">"code=aTbEUP&amp;grant_type=authorization_code&amp;redirect_uri=http://www.baidu.com&amp;scope=all"</span></span><br></pre></td></tr></table></figure>

<p>案例响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"access_token"</span>: <span class="string">"f991749b-0e68-4908-a8f4-52d39a285ddb"</span>,</span><br><span class="line">  <span class="attr">"token_type"</span>: <span class="string">"bearer"</span>,</span><br><span class="line">  <span class="attr">"expires_in"</span>: <span class="number">43199</span>,</span><br><span class="line">  <span class="attr">"scope"</span>: <span class="string">"all"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>调用 API</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http://localhost:9401/user/getCurrentUser -H <span class="string">"authorization: Bearer f991749b-0e68-4908-a8f4-52d39a285ddb"</span></span><br></pre></td></tr></table></figure>

<p>密码模式使用：</p>
<p>使用密码请求该地址获取访问令牌：<a href="http://localhost:9401/oauth/token" target="_blank" rel="noopener">http://localhost:9401/oauth/token</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -u admin:admin123456 http://localhost:9401/oauth/token -H</span><br><span class="line"><span class="string">"content-type: application/x-www-form-urlencoded"</span> -d</span><br><span class="line"><span class="string">"grant_type=password&amp;username=leo&amp;password=123456&amp;scope=all"</span></span><br></pre></td></tr></table></figure>

<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><h3 id="常见OAuth-2-0安全问题"><a href="#常见OAuth-2-0安全问题" class="headerlink" title="常见OAuth 2.0安全问题"></a>常见OAuth 2.0安全问题</h3><p><img src="/images/java/spring-cloud-oauth2/19.jpg" alt="19"></p>
<h3 id="跨站请求伪造-CSRF（Cross-site-request-forgery）"><a href="#跨站请求伪造-CSRF（Cross-site-request-forgery）" class="headerlink" title="跨站请求伪造 CSRF（Cross-site request forgery）"></a>跨站请求伪造 CSRF（Cross-site request forgery）</h3><p><img src="/images/java/spring-cloud-oauth2/20.jpg" alt="20"></p>
<p>Spring Security 通过添加 State 参数来解决。</p>
<h3 id="OpenId-Connect-简介"><a href="#OpenId-Connect-简介" class="headerlink" title="OpenId Connect 简介"></a>OpenId Connect 简介</h3><p><img src="/images/java/spring-cloud-oauth2/21.jpg" alt="21"></p>
<h3 id="下一代微服务安全架构"><a href="#下一代微服务安全架构" class="headerlink" title="下一代微服务安全架构"></a>下一代微服务安全架构</h3><h4 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h4><p><img src="/images/java/spring-cloud-oauth2/22.jpg" alt="22"></p>
<p>客户应用要访问微服务，要通过网关，网关有个 OAuth 过滤器，如果说你没有经过授权，会先把你导向到授权服务器上去登录获取 Access Token。</p>
<p>拿到 Access Token 后在访问微服务，经过网关，网关去授权服务器进行校验。校验成功后这里会转成JWT的 Token，因为 Access Token 是透明的不含任何信息的，为了缓解后面的微服务不需要再去授权服务器进行校验，这里换成支持自校验的JWT传递到后面的微服务。有些公司经过网关校验后其实到后台都不进行校验了。</p>
<h4 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h4><p><img src="/images/java/spring-cloud-oauth2/23.jpg" alt="23"></p>
<p>全程通过JWT进行无状态自校验，不需要通过授权服务集中校验，JWT中的一些敏感信息进行加密。但是这种方式缺少了集中式校验，不能进行吊销，需要等到JWT自然过期。</p>
<h4 id="方案三"><a href="#方案三" class="headerlink" title="方案三"></a>方案三</h4><p><img src="/images/java/spring-cloud-oauth2/24.jpg" alt="24"></p>
<p>这种方式用的比较多，给用户的还是 Access Token，网关会做 Access Token 跟JWT 的转换，但是中间会加入 Redis 缓存，来缓解授权服务器压力。那其实到后面并不一定要用JWT，可以直接传递用户的信息如用户ID到后面的微服务。</p>
<h3 id="生产级部署"><a href="#生产级部署" class="headerlink" title="生产级部署"></a>生产级部署</h3><p><img src="/images/java/spring-cloud-oauth2/25.jpg" alt="25"></p>
<h3 id="OAuth2-OIDC开源产品"><a href="#OAuth2-OIDC开源产品" class="headerlink" title="OAuth2/OIDC开源产品"></a>OAuth2/OIDC开源产品</h3><ul>
<li>Redhat Keycloak（Java）<a href="http://www.keycloak.org/" target="_blank" rel="noopener">http://www.keycloak.org/</a></li>
<li>Apereo CAS（Java）<a href="https://www.apereo.org/projects/cas/" target="_blank" rel="noopener">https://www.apereo.org/projects/cas/</a></li>
<li>OpenId-Connect-Java-Spring-Server <a href="https://github.com/mitreid-connect/OpenID-Connect-Java-Spring-Server/" target="_blank" rel="noopener">https://github.com/mitreid-connect/OpenID-Connect-Java-Spring-Server/</a></li>
<li>OAuth2全家桶项目 <a href="https://github.com/newnil/oauth2-family-barrel" target="_blank" rel="noopener">https://github.com/newnil/oauth2-family-barrel</a></li>
<li>Apache Oltu+Shiro实现OAuth2服务器 <a href="https://github.com/monkeyk/oauth2-shiro" target="_blank" rel="noopener">https://github.com/monkeyk/oauth2-shiro</a></li>
<li>Using JWT with Spring Security OAuth <a href="https://github.com/Baeldung/spring-security-oauth" target="_blank" rel="noopener">https://github.com/Baeldung/spring-security-oauth</a></li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-security/2.2.1.RELEASE/reference/html/" target="_blank" rel="noopener">https://cloud.spring.io/spring-cloud-static/spring-cloud-security/2.2.1.RELEASE/reference/html/</a></li>
<li><a href="https://juejin.im/post/5dc013bae51d456e817cec30/" target="_blank" rel="noopener">https://juejin.im/post/5dc013bae51d456e817cec30/</a></li>
<li><a href="https://www.manning.com/books/oauth-2-in-action/" target="_blank" rel="noopener">https://www.manning.com/books/oauth-2-in-action/</a></li>
<li><a href="https://tools.ietf.org/html/rfc6749/" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749/</a></li>
<li><a href="https://medium.com/@darutk/the-simplest-guide-to-oauth-2-0-8c71bd9a15bb/" target="_blank" rel="noopener">https://medium.com/@darutk/the-simplest-guide-to-oauth-2-0-8c71bd9a15bb/</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html/" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html/</a></li>
<li>《微服务架构实战》</li>
<li>《Spring Boot &amp; Kubernetes 云原生微服务实践》</li>
<li>《从0开始学微服务》</li>
<li>《微服务设计》</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MicroServices/" rel="tag"># MicroServices</a>
              <a href="/tags/SpringCloud/" rel="tag"># SpringCloud</a>
              <a href="/tags/Security/" rel="tag"># Security</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/back-end/java/spring-cloud-gateway-logging/" rel="prev" title="Spring Cloud Gateway 之 请求响应日志打印过滤器">
      <i class="fa fa-chevron-left"></i> Spring Cloud Gateway 之 请求响应日志打印过滤器
    </a></div>
      <div class="post-nav-item">
    <a href="/back-end/java/spring-cloud-jwt/" rel="next" title="微服务架构之安全认证：JWT 令牌和 SSO">
      微服务架构之安全认证：JWT 令牌和 SSO <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#OAuth2-提出背景"><span class="nav-number">1.</span> <span class="nav-text">OAuth2 提出背景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#开放系统间授权"><span class="nav-number">1.1.</span> <span class="nav-text">开放系统间授权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法一：用户名密码复制"><span class="nav-number">1.2.</span> <span class="nav-text">方法一：用户名密码复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法二：万能钥匙"><span class="nav-number">1.3.</span> <span class="nav-text">方法二：万能钥匙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法三：特殊令牌"><span class="nav-number">1.4.</span> <span class="nav-text">方法三：特殊令牌</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#传统单块应用安全"><span class="nav-number">1.5.</span> <span class="nav-text">传统单块应用安全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#现代微服务安全"><span class="nav-number">1.6.</span> <span class="nav-text">现代微服务安全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth2-解决问题域和场景"><span class="nav-number">1.7.</span> <span class="nav-text">OAuth2 解决问题域和场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OAuth2-定义和原理"><span class="nav-number">2.</span> <span class="nav-text">OAuth2 定义和原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth-2-0-的历史"><span class="nav-number">2.1.</span> <span class="nav-text">OAuth 2.0 的历史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth-2-0-优势"><span class="nav-number">2.2.</span> <span class="nav-text">OAuth 2.0 优势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth-2-0-不足"><span class="nav-number">2.3.</span> <span class="nav-text">OAuth 2.0 不足</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth-2-0-主要角色"><span class="nav-number">2.4.</span> <span class="nav-text">OAuth 2.0 主要角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth-2-0-误解"><span class="nav-number">2.5.</span> <span class="nav-text">OAuth 2.0 误解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#典型-OAuth-Flow-和选型"><span class="nav-number">3.</span> <span class="nav-text">典型 OAuth Flow 和选型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#运行流程"><span class="nav-number">3.1.</span> <span class="nav-text">运行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#授权码模式"><span class="nav-number">3.2.</span> <span class="nav-text">授权码模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简化模式"><span class="nav-number">3.3.</span> <span class="nav-text">简化模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#密码模式"><span class="nav-number">3.4.</span> <span class="nav-text">密码模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端模式"><span class="nav-number">3.5.</span> <span class="nav-text">客户端模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#刷新令牌"><span class="nav-number">3.6.</span> <span class="nav-text">刷新令牌</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#授权流程渠道-channels"><span class="nav-number">3.7.</span> <span class="nav-text">授权流程渠道(channels)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户应用类型"><span class="nav-number">3.8.</span> <span class="nav-text">客户应用类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四种OAuth-2-0授权类型-Flows-总结"><span class="nav-number">3.9.</span> <span class="nav-text">四种OAuth 2.0授权类型(Flows)总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#授权码-Authorization-Code"><span class="nav-number">3.9.1.</span> <span class="nav-text">授权码 Authorization Code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#简化Implicit"><span class="nav-number">3.9.2.</span> <span class="nav-text">简化Implicit</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用户名密码Resource-Owner-Credentials"><span class="nav-number">3.9.3.</span> <span class="nav-text">用户名密码Resource Owner Credentials</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端凭证Client-Credentials"><span class="nav-number">3.9.4.</span> <span class="nav-text">客户端凭证Client Credentials</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#授权类型选择流程"><span class="nav-number">3.10.</span> <span class="nav-text">授权类型选择流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#授权服务器组成"><span class="nav-number">3.11.</span> <span class="nav-text">授权服务器组成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Security-OAuth2架构"><span class="nav-number">4.</span> <span class="nav-text">Spring Security OAuth2架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境"><span class="nav-number">5.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建-oauth2-server-模块"><span class="nav-number">6.</span> <span class="nav-text">创建 oauth2-server 模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展"><span class="nav-number">7.</span> <span class="nav-text">扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常见OAuth-2-0安全问题"><span class="nav-number">7.1.</span> <span class="nav-text">常见OAuth 2.0安全问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨站请求伪造-CSRF（Cross-site-request-forgery）"><span class="nav-number">7.2.</span> <span class="nav-text">跨站请求伪造 CSRF（Cross-site request forgery）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenId-Connect-简介"><span class="nav-number">7.3.</span> <span class="nav-text">OpenId Connect 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下一代微服务安全架构"><span class="nav-number">7.4.</span> <span class="nav-text">下一代微服务安全架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#方案一"><span class="nav-number">7.4.1.</span> <span class="nav-text">方案一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#方案二"><span class="nav-number">7.4.2.</span> <span class="nav-text">方案二</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#方案三"><span class="nav-number">7.4.3.</span> <span class="nav-text">方案三</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生产级部署"><span class="nav-number">7.5.</span> <span class="nav-text">生产级部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth2-OIDC开源产品"><span class="nav-number">7.6.</span> <span class="nav-text">OAuth2&#x2F;OIDC开源产品</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">8.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Richard"
      src="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
  <p class="site-author-name" itemprop="name">Richard</p>
  <div class="site-description" itemprop="description">惶者生存，偏执者成功</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xinlc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/xinlc" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://learnxinyminutes.com/" title="https:&#x2F;&#x2F;learnxinyminutes.com" rel="noopener" target="_blank">Learn X in Y minutes</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://justjavac.com/" title="http:&#x2F;&#x2F;justjavac.com" rel="noopener" target="_blank">justjavac</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.ruanyifeng.com/blog/" title="http:&#x2F;&#x2F;www.ruanyifeng.com&#x2F;blog&#x2F;" rel="noopener" target="_blank">阮一峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.liaoxuefeng.com/" title="https:&#x2F;&#x2F;www.liaoxuefeng.com" rel="noopener" target="_blank">廖雪峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tech.meituan.com/" title="https:&#x2F;&#x2F;tech.meituan.com" rel="noopener" target="_blank">美团技术</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.v2ex.com/" title="https:&#x2F;&#x2F;www.v2ex.com" rel="noopener" target="_blank">V2EX</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://caniuse.com/" title="https:&#x2F;&#x2F;caniuse.com" rel="noopener" target="_blank">caniuse/工具</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.css88.com/nav/" title="http:&#x2F;&#x2F;www.css88.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">css88/doc</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://overapi.com/" title="http:&#x2F;&#x2F;overapi.com&#x2F;" rel="noopener" target="_blank">OverAPI/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://devdocs.io/" title="http:&#x2F;&#x2F;devdocs.io&#x2F;" rel="noopener" target="_blank">DevDocs/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.oschina.net/" title="http:&#x2F;&#x2F;tool.oschina.net&#x2F;" rel="noopener" target="_blank">在线工具/索引</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.lu/" title="http:&#x2F;&#x2F;tool.lu&#x2F;" rel="noopener" target="_blank">ToolBox</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://hao.shejidaren.com/" title="http:&#x2F;&#x2F;hao.shejidaren.com&#x2F;" rel="noopener" target="_blank">设计导航</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
