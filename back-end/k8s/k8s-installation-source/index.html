<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.lichao.xin","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"3ZZ8ITB7HE","apiKey":"062eb5a54afbcbf3f20452d58fc40035","indexName":"xinlc","hits":{"per_page":10},"labels":{"input_placeholder":"搜索","hits_empty":"未发现与「${query}」相关的内容","hits_stats":"${hits} 条相关条目，使用了 ${time} 毫秒"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="目前安装 Kubernetes 的方式多样，主要是：Minikube、二进制部署、kubeadm、Kops、Rancher、Kubespray。">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes 二进制高可用部署">
<meta property="og:url" content="https://blog.lichao.xin/back-end/k8s/k8s-installation-source/index.html">
<meta property="og:site_name" content="Richard Xin&#39;s Blog">
<meta property="og:description" content="目前安装 Kubernetes 的方式多样，主要是：Minikube、二进制部署、kubeadm、Kops、Rancher、Kubespray。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lichao.xin/images/k8s/k8s-installation/5.png">
<meta property="article:published_time" content="2020-05-24T10:30:00.000Z">
<meta property="article:modified_time" content="2021-06-14T01:33:22.391Z">
<meta property="article:author" content="Richard">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lichao.xin/images/k8s/k8s-installation/5.png">

<link rel="canonical" href="https://blog.lichao.xin/back-end/k8s/k8s-installation-source/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Kubernetes 二进制高可用部署 | Richard Xin's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4530ac9d0bc4e258535c4a9b17029f0c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Richard Xin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Richard Xin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Quick notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">132</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">59</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.lichao.xin/back-end/k8s/k8s-installation-source/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
      <meta itemprop="name" content="Richard">
      <meta itemprop="description" content="惶者生存，偏执者成功">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Richard Xin's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes 二进制高可用部署
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-24 10:30:00" itemprop="dateCreated datePublished" datetime="2020-05-24T10:30:00+00:00">2020-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-14 01:33:22" itemprop="dateModified" datetime="2021-06-14T01:33:22+00:00">2021-06-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>目前安装 Kubernetes 的方式多样，主要是：Minikube、二进制部署、kubeadm、Kops、Rancher、Kubespray。</p>
<a id="more"></a>

<h2 id="二进制-方式部署"><a href="#二进制-方式部署" class="headerlink" title="二进制 方式部署"></a>二进制 方式部署</h2><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><h3 id="服务器信息"><a href="#服务器信息" class="headerlink" title="服务器信息"></a>服务器信息</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master1</td>
<td>192.168.0.216</td>
<td>Master1,etcd1,node节点</td>
</tr>
<tr>
<td>k8s-master2</td>
<td>192.168.0.217</td>
<td>Master2,etcd2,node节点</td>
</tr>
<tr>
<td>k8s-master3</td>
<td>192.168.0.218</td>
<td>Master3,etcd3,node节点</td>
</tr>
<tr>
<td>slb</td>
<td>lb.ypvip.com.cn</td>
<td>外网阿里slb域名</td>
</tr>
</tbody></table>
<blockquote>
<p>本环境使用阿里云，API Server 高可用通过阿里云SLB实现，如果环境不在云上，可以通过 Nginx + Keepalived，或者 HaProxy + Keepalived等实现。</p>
</blockquote>
<h3 id="服务版本与K8S集群说明"><a href="#服务版本与K8S集群说明" class="headerlink" title="服务版本与K8S集群说明"></a>服务版本与K8S集群说明</h3><ul>
<li>阿里slb设置TCP监听，监听6443端口(通过四层负载到master apiserver)。</li>
<li>所有阿里云ECS主机使用 CentOS 7.7 版本，并且内核都升到5.x版本。</li>
<li>K8S 集群使用 Iptables 模式（kube-proxy 注释中预留 Ipvs 模式配置）</li>
<li>Calico 使用 IPIP 模式</li>
<li>集群使用默认 svc.cluster.local</li>
<li>10.10.0.1 为集群 kubernetes svc 解析ip</li>
<li>Docker CE version 19.03.6</li>
<li>Kubernetes Version 1.18.2</li>
<li>Etcd Version v3.4.7</li>
<li>Calico Version v3.14.0</li>
<li>Coredns Version 1.6.7</li>
<li>Metrics-Server Version v0.3.6</li>
</ul>
<h3 id="Service-和-Pods-Ip-段划分"><a href="#Service-和-Pods-Ip-段划分" class="headerlink" title="Service 和 Pods Ip 段划分"></a>Service 和 Pods Ip 段划分</h3><table>
<thead>
<tr>
<th>名称</th>
<th>IP网段</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>service-cluster-ip</td>
<td>10.10.0.0/16</td>
<td>可用地址 65534</td>
</tr>
<tr>
<td>pods-ip</td>
<td>10.20.0.0/16</td>
<td>可用地址 65534</td>
</tr>
<tr>
<td>集群dns</td>
<td>10.10.0.2</td>
<td>用于集群service域名解析</td>
</tr>
<tr>
<td>k8s svc</td>
<td>10.10.0.1</td>
<td>集群 kubernetes svc 解析ip</td>
</tr>
</tbody></table>
<h2 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h2><blockquote>
<p>所有集群服务器都需要初始化</p>
</blockquote>
<h3 id="停止所有机器-firewalld-防火墙"><a href="#停止所有机器-firewalld-防火墙" class="headerlink" title="停止所有机器 firewalld 防火墙"></a>停止所有机器 firewalld 防火墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure>

<h3 id="关闭-swap"><a href="#关闭-swap" class="headerlink" title="关闭 swap"></a>关闭 swap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">'s/.*swap.*/#&amp;/'</span> /etc/fstab</span><br></pre></td></tr></table></figure>

<h3 id="关闭-Selinux"><a href="#关闭-Selinux" class="headerlink" title="关闭 Selinux"></a>关闭 Selinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setenforce  0</span><br><span class="line">sed -i <span class="string">"s/^SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/sysconfig/selinux</span><br><span class="line">sed -i <span class="string">"s/^SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span><br><span class="line">sed -i <span class="string">"s/^SELINUX=permissive/SELINUX=disabled/g"</span> /etc/sysconfig/selinux</span><br><span class="line">sed -i <span class="string">"s/^SELINUX=permissive/SELINUX=disabled/g"</span> /etc/selinux/config</span><br></pre></td></tr></table></figure>

<h3 id="设置主机名、升级内核、安装-Docker-ce"><a href="#设置主机名、升级内核、安装-Docker-ce" class="headerlink" title="设置主机名、升级内核、安装 Docker ce"></a>设置主机名、升级内核、安装 Docker ce</h3><p>运行下面 init.sh shell 脚本，脚本完成下面四项任务：</p>
<ul>
<li>设置服务器 hostname</li>
<li>安装 k8s依赖环境</li>
<li>升级系统内核（升级Centos7系统内核，解决Docker-ce版本兼容问题）</li>
<li>安装 docker ce 19.03.6 版本</li>
</ul>
<p>在每台机器上运行 init.sh 脚本，示例如下：</p>
<blockquote>
<p>Ps：init.sh 脚本只用于 Centos，支持 重复运行。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k8s-master1 机器运行，init.sh 后面接的参数是设置 k8s-master1 服务器主机名</span><br><span class="line">chmod +x init.sh &amp;&amp; ./init.sh k8s-master1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行完 init.sh 脚本，请重启服务器</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<p>init.sh：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Check_linux_system</span></span>()&#123;</span><br><span class="line">    linux_version=`cat /etc/redhat-release`</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$&#123;linux_version&#125;</span> =~ <span class="string">"CentOS"</span> ]];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 系统为 <span class="variable">$&#123;linux_version&#125;</span> \033[0m \n"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 系统不是CentOS,该脚本只支持CentOS环境\033[0m \n"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Set_hostname</span></span>()&#123;</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$HostName</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">      grep <span class="variable">$HostName</span> /etc/hostname &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 主机名已设置，退出设置主机名步骤 \033[0m \n"</span> &amp;&amp; <span class="built_in">return</span></span><br><span class="line">      <span class="keyword">case</span> <span class="variable">$HostName</span> <span class="keyword">in</span></span><br><span class="line">      <span class="built_in">help</span>)</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\033[32;32m bash init.sh 主机名 \033[0m \n"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">      ;;</span><br><span class="line">      *)</span><br><span class="line">        hostname <span class="variable">$HostName</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$HostName</span>"</span> &gt; /etc/hostname</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"`ifconfig eth0 | grep inet | awk '&#123;print <span class="variable">$2</span>&#125;'` <span class="variable">$HostName</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line">      ;;</span><br><span class="line">      <span class="keyword">esac</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 输入为空，请参照 bash init.sh 主机名 \033[0m \n"</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Install_depend_environment</span></span>()&#123;</span><br><span class="line">    rpm -qa | grep nfs-utils &amp;&gt; /dev/null &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 已完成依赖环境安装，退出依赖环境安装步骤 \033[0m \n"</span> &amp;&amp; <span class="built_in">return</span></span><br><span class="line">    yum install -y nfs-utils curl yum-utils device-mapper-persistent-data lvm2 net-tools conntrack-tools wget vim  ntpdate libseccomp libtool-ltdl telnet</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 升级Centos7系统内核到5版本，解决Docker-ce版本兼容问题\033[0m \n"</span></span><br><span class="line">    rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org &amp;&amp; \</span><br><span class="line">    rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm &amp;&amp; \</span><br><span class="line">    yum --disablerepo=\* --enablerepo=elrepo-kernel repolist &amp;&amp; \</span><br><span class="line">    yum --disablerepo=\* --enablerepo=elrepo-kernel install -y kernel-ml.x86_64 &amp;&amp; \</span><br><span class="line">    yum remove -y kernel-tools-libs.x86_64 kernel-tools.x86_64 &amp;&amp; \</span><br><span class="line">    yum --disablerepo=\* --enablerepo=elrepo-kernel install -y kernel-ml-tools.x86_64 &amp;&amp; \</span><br><span class="line">    grub2-set-default 0</span><br><span class="line">    modprobe br_netfilter</span><br><span class="line">    cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line">    sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line">    ls /proc/sys/net/bridge</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Install_docker</span></span>()&#123;</span><br><span class="line">    rpm -qa | grep docker &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 已安装docker，退出安装docker步骤 \033[0m \n"</span> &amp;&amp; <span class="built_in">return</span></span><br><span class="line">    yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">    yum makecache fast</span><br><span class="line">    yum -y install docker-ce-19.03.6 docker-ce-cli-19.03.6</span><br><span class="line">    <span class="comment"># 设置 iptables file表中 FORWARD 默认链规则为 ACCEPT</span></span><br><span class="line">    sed  -i <span class="string">'/ExecStart=/i ExecStartPost=\/sbin\/iptables -P FORWARD ACCEPT'</span> /usr/lib/systemd/system/docker.service</span><br><span class="line">    systemctl <span class="built_in">enable</span> docker.service</span><br><span class="line">    systemctl start docker.service</span><br><span class="line">    systemctl stop docker.service</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'&#123;"registry-mirrors": ["https://4xr1qpsp.mirror.aliyuncs.com"], "log-opts": &#123;"max-size":"500m", "max-file":"3"&#125;&#125;'</span> &gt; /etc/docker/daemon.json</span><br><span class="line">    systemctl daemon-reload</span><br><span class="line">    systemctl start docker</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化顺序</span></span><br><span class="line">HostName=<span class="variable">$1</span></span><br><span class="line">Check_linux_system &amp;&amp; \</span><br><span class="line">Set_hostname &amp;&amp; \</span><br><span class="line">Install_depend_environment &amp;&amp; \</span><br><span class="line">Install_docker</span><br></pre></td></tr></table></figure>

<h2 id="Kubernetes-部署"><a href="#Kubernetes-部署" class="headerlink" title="Kubernetes 部署"></a>Kubernetes 部署</h2><h3 id="部署顺序"><a href="#部署顺序" class="headerlink" title="部署顺序"></a>部署顺序</h3><ol>
<li>自签TLS证书</li>
<li>部署Etcd集群</li>
<li>创建 metrics-server 证书</li>
<li>获取K8S二进制包</li>
<li>创建Node节点kubeconfig文件</li>
<li>配置Master组件并运行</li>
<li>配置kubelet证书自动续期</li>
<li>配置Node组件并运行</li>
<li>安装calico网络，使用IPIP模式</li>
<li>集群CoreDNS部署</li>
<li>部署集群监控服务 Metrics Server</li>
<li>部署 Kubernetes Dashboard</li>
</ol>
<h3 id="自签TLS证书"><a href="#自签TLS证书" class="headerlink" title="自签TLS证书"></a>自签TLS证书</h3><blockquote>
<p>在 k8s-master1 安装证书生成工具 cfssl，并生成相关证书</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录用于存放 SSL 证书</span></span><br><span class="line">mkdir /data/ssl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载生成证书命令</span></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移动到 /usr/local/bin 目录下</span></span><br><span class="line">mv cfssl_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssl</span><br><span class="line">mv cfssljson_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入证书目录</span></span><br><span class="line"><span class="built_in">cd</span> /data/ssl/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 certificate.sh 脚本</span></span><br><span class="line">vim  certificate.sh</span><br></pre></td></tr></table></figure>

<blockquote>
<p>PS：证书有效期为 10年</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">         <span class="string">"expiry"</span>: <span class="string">"87600h"</span>,</span><br><span class="line">         <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"Beijing"</span>,</span><br><span class="line">              <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line"></span><br><span class="line"><span class="comment">#-----------------------</span></span><br><span class="line"></span><br><span class="line">cat &gt; server-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"192.168.0.216"</span>,</span><br><span class="line">      <span class="string">"192.168.0.217"</span>,</span><br><span class="line">      <span class="string">"192.168.0.218"</span>,</span><br><span class="line">      <span class="string">"10.10.0.1"</span>,</span><br><span class="line">      <span class="string">"lb.ypvip.com.cn"</span>,</span><br><span class="line">      <span class="string">"kubernetes"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line"></span><br><span class="line"><span class="comment">#-----------------------</span></span><br><span class="line"></span><br><span class="line">cat &gt; admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line"></span><br><span class="line"><span class="comment">#-----------------------</span></span><br><span class="line"></span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure>

<p>根据自己环境修改 certificate.sh 脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"192.168.0.216"</span>,</span><br><span class="line"><span class="string">"192.168.0.217"</span>,</span><br><span class="line"><span class="string">"192.168.0.218"</span>,</span><br><span class="line"><span class="string">"10.10.0.1"</span>,</span><br><span class="line"><span class="string">"lb.ypvip.com.cn"</span>,</span><br></pre></td></tr></table></figure>

<p>修改完脚本，然后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash certificate.sh</span><br></pre></td></tr></table></figure>

<h3 id="部署Etcd集群"><a href="#部署Etcd集群" class="headerlink" title="部署Etcd集群"></a>部署Etcd集群</h3><blockquote>
<p>k8s-master1 机器上操作，把执行文件copy到 k8s-master2 k8s-master3</p>
</blockquote>
<p>二进制包下载地址：<a href="https://github.com/etcd-io/etcd/releases/download/v3.4.7/etcd-v3.4.7-linux-amd64.tar.gz" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases/download/v3.4.7/etcd-v3.4.7-linux-amd64.tar.gz</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建存储etcd数据目录</span></span><br><span class="line">mkdir /data/etcd/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 k8s 集群配置目录</span></span><br><span class="line">mkdir /opt/kubernetes/&#123;bin,cfg,ssl&#125;  -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载二进制etcd包，并把执行文件放到 /opt/kubernetes/bin/ 目录</span></span><br><span class="line"><span class="built_in">cd</span> /data/etcd/</span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.4.7/etcd-v3.4.7-linux-amd64.tar.gz</span><br><span class="line">tar zxvf etcd-v3.4.7-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> etcd-v3.4.7-linux-amd64</span><br><span class="line">cp -a etcd etcdctl /opt/kubernetes/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把 /opt/kubernetes/bin 目录加入到 PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH=$PATH:/opt/kubernetes/bin'</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master2 和 k8s-master3 服务器上操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 k8s 集群配置目录</span></span><br><span class="line">mkdir /data/etcd</span><br><span class="line">mkdir /opt/kubernetes/&#123;bin,cfg,ssl&#125;  -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把 /opt/kubernetes/bin 目录加入到 PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH=$PATH:/opt/kubernetes/bin'</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master1 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入 K8S 集群证书目录</span></span><br><span class="line"><span class="built_in">cd</span> /data/ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把证书 copy 到 k8s-master1 机器 /opt/kubernetes/ssl/ 目录</span></span><br><span class="line">cp ca*pem  server*pem /opt/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把etcd执行文件与证书 copy 到 k8s-master2  k8s-master3 机器 </span></span><br><span class="line">scp -r /opt/kubernetes/*  root@k8s-master2:/opt/kubernetes</span><br><span class="line">scp -r /opt/kubernetes/*  root@k8s-master3:/opt/kubernetes</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写 etcd 配置文件脚本</span></span><br><span class="line">vim etcd.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ETCD_NAME=<span class="variable">$&#123;1:-"etcd01"&#125;</span></span><br><span class="line">ETCD_IP=<span class="variable">$&#123;2:-"127.0.0.1"&#125;</span></span><br><span class="line">ETCD_CLUSTER=<span class="variable">$&#123;3:-"etcd01=https://127.0.0.1:2379"&#125;</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/opt/kubernetes/cfg/etcd.yml</span><br><span class="line">name: <span class="variable">$&#123;ETCD_NAME&#125;</span></span><br><span class="line">data-dir: /var/lib/etcd/default.etcd</span><br><span class="line">listen-peer-urls: https://<span class="variable">$&#123;ETCD_IP&#125;</span>:2380</span><br><span class="line">listen-client-urls: https://<span class="variable">$&#123;ETCD_IP&#125;</span>:2379,https://127.0.0.1:2379</span><br><span class="line"></span><br><span class="line">advertise-client-urls: https://<span class="variable">$&#123;ETCD_IP&#125;</span>:2379</span><br><span class="line">initial-advertise-peer-urls: https://<span class="variable">$&#123;ETCD_IP&#125;</span>:2380</span><br><span class="line">initial-cluster: <span class="variable">$&#123;ETCD_CLUSTER&#125;</span></span><br><span class="line">initial-cluster-token: etcd-cluster</span><br><span class="line">initial-cluster-state: new</span><br><span class="line"></span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: /opt/kubernetes/ssl/server.pem</span><br><span class="line">  key-file: /opt/kubernetes/ssl/server-key.pem</span><br><span class="line">  client-cert-auth: <span class="literal">false</span></span><br><span class="line">  trusted-ca-file: /opt/kubernetes/ssl/ca.pem</span><br><span class="line">  auto-tls: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: /opt/kubernetes/ssl/server.pem</span><br><span class="line">  key-file: /opt/kubernetes/ssl/server-key.pem</span><br><span class="line">  client-cert-auth: <span class="literal">false</span></span><br><span class="line">  trusted-ca-file: /opt/kubernetes/ssl/ca.pem</span><br><span class="line">  auto-tls: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">debug: <span class="literal">false</span></span><br><span class="line">logger: zap</span><br><span class="line"><span class="built_in">log</span>-outputs: [stderr]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/usr/lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">Documentation=https://github.com/etcd-io/etcd</span><br><span class="line">Conflicts=etcd.service</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5s</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">ExecStart=/opt/kubernetes/bin/etcd --config-file=/opt/kubernetes/cfg/etcd.yml</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">systemctl restart etcd</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行 etcd.sh 生成配置脚本</span></span><br><span class="line">chmod +x etcd.sh</span><br><span class="line">./etcd.sh etcd01 192.168.0.216 etcd01=https://192.168.0.216:2380,etcd02=https://192.168.0.217:2380,etcd03=https://192.168.0.218:2380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 etcd 是否启动正常</span></span><br><span class="line">ps -ef | grep etcd</span><br><span class="line">netstat -ntplu | grep etcd</span><br><span class="line"></span><br><span class="line">tcp        0      0 192.168.0.216:2379      0.0.0.0:*               LISTEN      1558/etcd</span><br><span class="line">tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      1558/etcd</span><br><span class="line">tcp        0      0 192.168.0.216:2380      0.0.0.0:*               LISTEN      1558/etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把 etcd.sh 脚本  copy 到 k8s-master2 k8s-master3 机器上</span></span><br><span class="line">scp /data/etcd/etcd.sh  root@k8s-master2:/data/etcd/</span><br><span class="line">scp /data/etcd/etcd.sh  root@k8s-master3:/data/etcd/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master2 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行 etcd.sh 生成配置脚本</span></span><br><span class="line">chmod +x etcd.sh</span><br><span class="line">./etcd.sh etcd02 192.168.0.217 etcd01=https://192.168.0.216:2380,etcd02=https://192.168.0.217:2380,etcd03=https://192.168.0.218:2380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 etcd 是否启动正常</span></span><br><span class="line">ps -ef | grep etcd</span><br><span class="line">netstat -ntplu | grep etcd</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master3 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行 etcd.sh 生成配置脚本</span></span><br><span class="line">chmod +x etcd.sh</span><br><span class="line">./etcd.sh etcd03 192.168.0.218 etcd01=https://192.168.0.216:2380,etcd02=https://192.168.0.217:2380,etcd03=https://192.168.0.218:2380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 etcd 是否启动正常</span></span><br><span class="line">ps -ef | grep etcd</span><br><span class="line">netstat -ntplu | grep etcd</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 随便登陆一台master机器，查看 etcd 集群是否正常</span></span><br><span class="line">ETCDCTL_API=3 etcdctl --write-out=table \</span><br><span class="line">--cacert=/opt/kubernetes/ssl/ca.pem --cert=/opt/kubernetes/ssl/server.pem --key=/opt/kubernetes/ssl/server-key.pem \</span><br><span class="line">--endpoints=https://192.168.0.216:2379,https://192.168.0.217:2379,https://192.168.0.218:2379 endpoint health</span><br><span class="line"></span><br><span class="line">+---------------------------------+--------+-------------+-------+</span><br><span class="line">|            ENDPOINT             | HEALTH |    TOOK     | ERROR |</span><br><span class="line">+---------------------------------+--------+-------------+-------+</span><br><span class="line">| https://192.168.0.216:2379      |   <span class="literal">true</span> | 38.721248ms |       |</span><br><span class="line">| https://192.168.0.217:2379      |   <span class="literal">true</span> | 38.621248ms |       |</span><br><span class="line">| https://192.168.0.218:2379      |   <span class="literal">true</span> | 38.821248ms |       |</span><br><span class="line">+---------------------------------+--------+-------------+-------+</span><br></pre></td></tr></table></figure>

<h3 id="创建-metrics-server-证书"><a href="#创建-metrics-server-证书" class="headerlink" title="创建 metrics-server 证书"></a>创建 metrics-server 证书</h3><p>创建 metrics-server 使用的证书</p>
<blockquote>
<p>登陆到 k8s-master1 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /data/ssl/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意: "CN": "system:metrics-server" 一定是这个，因为后面授权时用到这个名称，否则会报禁止匿名访问</span></span><br><span class="line">cat &gt; metrics-server-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:metrics-server"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"system"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>生成 metrics-server 证书和私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成证书</span></span><br><span class="line">cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem -ca-key=/opt/kubernetes/ssl/ca-key.pem -config=/opt/kubernetes/ssl/ca-config.json -profile=kubernetes metrics-server-csr.json | cfssljson -bare metrics-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># copy 到 /opt/kubernetes/ssl 目录</span></span><br><span class="line">cp metrics-server-key.pem metrics-server.pem /opt/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line"><span class="comment"># copy 到 k8s-master2 k8s-master3 机器上</span></span><br><span class="line">scp metrics-server-key.pem metrics-server.pem root@k8s-master2:/opt/kubernetes/ssl/</span><br><span class="line">scp metrics-server-key.pem metrics-server.pem root@k8s-master3:/opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure>

<h3 id="获取K8S二进制包"><a href="#获取K8S二进制包" class="headerlink" title="获取K8S二进制包"></a>获取K8S二进制包</h3><blockquote>
<p>登陆到 k8s-master1 操作</p>
</blockquote>
<p>v1.18<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.18.md" target="_blank" rel="noopener">下载页面</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建存放 k8s 二进制包目录</span></span><br><span class="line">mkdir /data/k8s-package</span><br><span class="line"><span class="built_in">cd</span> /data/k8s-package</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 v1.18.2 二进制包</span></span><br><span class="line"><span class="comment"># 作者把二进制安装包上传到cdn上 https://cdm.yp14.cn/k8s-package/kubernetes-server-v1.18.2-linux-amd64.tar.gz</span></span><br><span class="line">wget https://dl.k8s.io/v1.18.2/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar xf kubernetes-server-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>master 节点需要用到：</p>
<ul>
<li>kubectl</li>
<li>kube-scheduler</li>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
</ul>
<p>node 节点需要用到：</p>
<ul>
<li>kubelet</li>
<li>kube-proxy</li>
</ul>
<blockquote>
<p>PS：本文master节点也做为一个node节点，所以需要用到 kubelet kube-proxy 执行文件</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入解压出来二进制包bin目录</span></span><br><span class="line"><span class="built_in">cd</span> /data/k8s-package/kubernetes/server/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># cpoy 执行文件到 /opt/kubernetes/bin 目录</span></span><br><span class="line">cp -a kube-apiserver kube-controller-manager kube-scheduler kubectl kubelet kube-proxy /opt/kubernetes/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># copy 执行文件到 k8s-master2 k8s-master3 机器 /opt/kubernetes/bin 目录</span></span><br><span class="line">scp kube-apiserver kube-controller-manager kube-scheduler kubectl kubelet kube-proxy root@k8s-master2:/opt/kubernetes/bin/</span><br><span class="line">scp kube-apiserver kube-controller-manager kube-scheduler kubectl kubelet kube-proxy root@k8s-master3:/opt/kubernetes/bin/</span><br></pre></td></tr></table></figure>

<h3 id="创建Node节点kubeconfig文件"><a href="#创建Node节点kubeconfig文件" class="headerlink" title="创建Node节点kubeconfig文件"></a>创建Node节点kubeconfig文件</h3><blockquote>
<p>登陆到 k8s-master1 操作</p>
</blockquote>
<ul>
<li>创建TLS Bootstrapping Token</li>
<li>创建kubelet kubeconfig</li>
<li>创建kube-proxy kubeconfig</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/ssl/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改第10行 KUBE_APISERVER 地址</span></span><br><span class="line">vim kubeconfig.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 TLS Bootstrapping Token</span></span><br><span class="line"><span class="built_in">export</span> BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d <span class="string">' '</span>)</span><br><span class="line">cat &gt; token.csv &lt;&lt;EOF</span><br><span class="line"><span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span>,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建kubelet bootstrapping kubeconfig</span></span><br><span class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://lb.ypvip.com.cn:6443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建kube-proxy kubeconfig文件</span></span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=./ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kube-proxy \</span><br><span class="line">  --client-certificate=./kube-proxy.pem \</span><br><span class="line">  --client-key=./kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成证书</span></span><br><span class="line">sh kubeconfig.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出下面结果</span></span><br><span class="line">kubeconfig.sh   kube-proxy-csr.json  kube-proxy.kubeconfig</span><br><span class="line">kube-proxy.csr  kube-proxy-key.pem   kube-proxy.pem bootstrap.kubeconfig</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># copy *kubeconfig 文件到 /opt/kubernetes/cfg 目录</span></span><br><span class="line">cp *kubeconfig /opt/kubernetes/cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># copy 到 k8s-master2 k8s-master3 机器上</span></span><br><span class="line">scp *kubeconfig root@k8s-master2:/opt/kubernetes/cfg</span><br><span class="line">scp *kubeconfig root@k8s-master3:/opt/kubernetes/cfg</span><br></pre></td></tr></table></figure>

<h3 id="配置Master组件并运行"><a href="#配置Master组件并运行" class="headerlink" title="配置Master组件并运行"></a>配置Master组件并运行</h3><blockquote>
<p>登陆到 k8s-master1 k8s-master2 k8s-master3 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 /data/k8s-master 目录，用于存放 master 配置执行脚本</span></span><br><span class="line">mkdir /data/k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 kube-apiserver 日志存放目录</span></span><br><span class="line">mkdir -p /var/<span class="built_in">log</span>/kubernetes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 kube-apiserver 审计日志文件</span></span><br><span class="line">touch /var/<span class="built_in">log</span>/kubernetes/k8s-audit.log</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master1</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建生成 kube-apiserver 配置文件脚本</span></span><br><span class="line">vim apiserver.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">MASTER_ADDRESS=<span class="variable">$&#123;1:-"192.168.0.216"&#125;</span></span><br><span class="line">ETCD_SERVERS=<span class="variable">$&#123;2:-"http://127.0.0.1:2379"&#125;</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/opt/kubernetes/cfg/kube-apiserver</span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">"--logtostderr=false \\</span></span><br><span class="line"><span class="string">--v=2 \\</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes \\</span></span><br><span class="line"><span class="string">--etcd-servers=<span class="variable">$&#123;ETCD_SERVERS&#125;</span> \\</span></span><br><span class="line"><span class="string">--bind-address=0.0.0.0 \\</span></span><br><span class="line"><span class="string">--secure-port=6443 \\</span></span><br><span class="line"><span class="string">--advertise-address=<span class="variable">$&#123;MASTER_ADDRESS&#125;</span> \\</span></span><br><span class="line"><span class="string">--allow-privileged=true \\</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.10.0.0/16 \\</span></span><br><span class="line"><span class="string">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction \\</span></span><br><span class="line"><span class="string">--authorization-mode=RBAC,Node \\</span></span><br><span class="line"><span class="string">--kubelet-https=true \\</span></span><br><span class="line"><span class="string">--enable-bootstrap-token-auth=true \\</span></span><br><span class="line"><span class="string">--token-auth-file=/opt/kubernetes/cfg/token.csv \\</span></span><br><span class="line"><span class="string">--service-node-port-range=30000-50000 \\</span></span><br><span class="line"><span class="string">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\</span></span><br><span class="line"><span class="string">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\</span></span><br><span class="line"><span class="string">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\</span></span><br><span class="line"><span class="string">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\</span></span><br><span class="line"><span class="string">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span></span><br><span class="line"><span class="string">--etcd-cafile=/opt/kubernetes/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">--etcd-certfile=/opt/kubernetes/ssl/server.pem \\</span></span><br><span class="line"><span class="string">--etcd-keyfile=/opt/kubernetes/ssl/server-key.pem \\</span></span><br><span class="line"><span class="string">--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">--requestheader-extra-headers-prefix=X-Remote-Extra- \\</span></span><br><span class="line"><span class="string">--requestheader-group-headers=X-Remote-Group \\</span></span><br><span class="line"><span class="string">--requestheader-username-headers=X-Remote-User \\</span></span><br><span class="line"><span class="string">--proxy-client-cert-file=/opt/kubernetes/ssl/metrics-server.pem \\</span></span><br><span class="line"><span class="string">--proxy-client-key-file=/opt/kubernetes/ssl/metrics-server-key.pem \\</span></span><br><span class="line"><span class="string">--runtime-config=api/all=true \\</span></span><br><span class="line"><span class="string">--audit-log-maxage=30 \\</span></span><br><span class="line"><span class="string">--audit-log-maxbackup=3 \\</span></span><br><span class="line"><span class="string">--audit-log-maxsize=100 \\</span></span><br><span class="line"><span class="string">--audit-log-truncate-enabled=true \\</span></span><br><span class="line"><span class="string">--audit-log-path=/var/log/kubernetes/k8s-audit.log"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver \<span class="variable">$KUBE_APISERVER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-apiserver</span><br><span class="line">systemctl restart kube-apiserver</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建生成 kube-controller-manager 配置文件脚本</span></span><br><span class="line"> vim controller-manager.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">MASTER_ADDRESS=<span class="variable">$&#123;1:-"127.0.0.1"&#125;</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/opt/kubernetes/cfg/kube-controller-manager</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=2 \\</span></span><br><span class="line"><span class="string">--master=<span class="variable">$&#123;MASTER_ADDRESS&#125;</span>:8080 \\</span></span><br><span class="line"><span class="string">--leader-elect=true \\</span></span><br><span class="line"><span class="string">--bind-address=0.0.0.0 \\</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.10.0.0/16 \\</span></span><br><span class="line"><span class="string">--cluster-name=kubernetes \\</span></span><br><span class="line"><span class="string">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\</span></span><br><span class="line"><span class="string">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span></span><br><span class="line"><span class="string">--experimental-cluster-signing-duration=87600h0m0s \\</span></span><br><span class="line"><span class="string">--feature-gates=RotateKubeletServerCertificate=true \\</span></span><br><span class="line"><span class="string">--feature-gates=RotateKubeletClientCertificate=true \\</span></span><br><span class="line"><span class="string">--allocate-node-cidrs=true \\</span></span><br><span class="line"><span class="string">--cluster-cidr=10.20.0.0/16 \\</span></span><br><span class="line"><span class="string">--root-ca-file=/opt/kubernetes/ssl/ca.pem"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-controller-manager</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager \<span class="variable">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-controller-manager</span><br><span class="line">systemctl restart kube-controller-manager</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建生成 kube-scheduler 配置文件脚本</span></span><br><span class="line">vim scheduler.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">MASTER_ADDRESS=<span class="variable">$&#123;1:-"127.0.0.1"&#125;</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/opt/kubernetes/cfg/kube-scheduler</span><br><span class="line">KUBE_SCHEDULER_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=2 \\</span></span><br><span class="line"><span class="string">--master=<span class="variable">$&#123;MASTER_ADDRESS&#125;</span>:8080 \\</span></span><br><span class="line"><span class="string">--address=0.0.0.0 \\</span></span><br><span class="line"><span class="string">--leader-elect"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/usr/lib/systemd/system/kube-scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-scheduler</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler \<span class="variable">$KUBE_SCHEDULER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-scheduler</span><br><span class="line">systemctl restart kube-scheduler</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line">chmod +x *.sh</span><br><span class="line"></span><br><span class="line">cp /data/ssl/token.csv /opt/kubernetes/cfg/</span><br><span class="line"></span><br><span class="line"><span class="comment"># copy token.csv 和 master 配置到 k8s-master2 k8s-master3 机器上</span></span><br><span class="line">scp /data/ssl/token.csv root@k8s-master2:/opt/kubernetes/cfg</span><br><span class="line">scp /data/ssl/token.csv root@k8s-master3:/opt/kubernetes/cfg</span><br><span class="line">scp apiserver.sh controller-manager.sh scheduler.sh root@k8s-master2:/data/k8s-master</span><br><span class="line">scp apiserver.sh controller-manager.sh scheduler.sh root@k8s-master3:/data/k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 master配置文件并运行</span></span><br><span class="line">./apiserver.sh 192.168.0.216 https://192.168.0.216:2379,https://192.168.0.217:2379,https://192.168.0.218:2379 </span><br><span class="line">./controller-manager.sh 127.0.0.1</span><br><span class="line">./scheduler.sh 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看master三个服务是否正常运行</span></span><br><span class="line">ps -ef | grep kube</span><br><span class="line">netstat -ntpl | grep kube-</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master2 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 master配置文件并运行</span></span><br><span class="line">./apiserver.sh 192.168.0.217 https://192.168.0.216:2379,https://192.168.0.217:2379,https://192.168.0.218:2379 </span><br><span class="line">./controller-manager.sh 127.0.0.1</span><br><span class="line">./scheduler.sh 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看master三个服务是否正常运行</span></span><br><span class="line">ps -ef | grep kube</span><br><span class="line">netstat -ntpl | grep kube-</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master3 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /data/k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 master配置文件并运行</span></span><br><span class="line">./apiserver.sh 192.168.0.218 https://192.168.0.216:2379,https://192.168.0.217:2379,https://192.168.0.218:2379 </span><br><span class="line">./controller-manager.sh 127.0.0.1</span><br><span class="line">./scheduler.sh 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看master三个服务是否正常运行</span></span><br><span class="line">ps -ef | grep kube</span><br><span class="line">netstat -ntpl | grep kube-</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 随便登陆一台master查看集群健康状态</span></span><br><span class="line">kubectl  get cs</span><br><span class="line"></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>错误处理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询集群状态报下面错误</span></span><br><span class="line">kubectl get cs</span><br><span class="line"></span><br><span class="line">error: no configuration has been provided, try setting KUBERNETES_MASTER environment variable</span><br></pre></td></tr></table></figure>

<p>两种解决方法：</p>
<ol>
<li>可以把kubectl版本降级到1.17版本，生成管理员config文件，并存放到 ~/.kube/config 目录下，再把 kubectl升级到1.18版本，这时就可以正常使用</li>
<li>直接声明下 KUBERNETES_MASTER Apiserver 地址，不推荐这种方法</li>
</ol>
<p>这里介绍生成管理员 config 配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 降级 kubectl 版本到 1.17.5 </span></span><br><span class="line">mv /opt/kubernetes/bin/kubectl /opt/kubernetes/bin/kubectl-1.18.2</span><br><span class="line">wget https://cdm.yp14.cn/k8s-package/k8s-1.17-bin/kubectl -O /opt/kubernetes/bin/kubectl</span><br><span class="line">chmod +x /opt/kubernetes/bin/kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个存放用户文件目录</span></span><br><span class="line">mkdir -p /root/yaml/create-user</span><br><span class="line"><span class="built_in">cd</span> /root/yaml/create-user</span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy 脚本依赖文件</span></span><br><span class="line">cp /data/ssl/ca-config.json /opt/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个生成用户脚本</span></span><br><span class="line">vim create-user-kubeconfig.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 注意修改KUBE_APISERVER为你的API Server的地址</span></span><br><span class="line"></span><br><span class="line">KUBE_APISERVER=<span class="variable">$1</span></span><br><span class="line">USER=<span class="variable">$2</span></span><br><span class="line">USER_SA=system:serviceaccount:default:<span class="variable">$&#123;USER&#125;</span></span><br><span class="line">Authorization=<span class="variable">$3</span></span><br><span class="line">USAGE=<span class="string">"USAGE: create-user.sh &lt;api_server&gt; &lt;username&gt; &lt;clusterrole authorization&gt;\n</span></span><br><span class="line"><span class="string">Example: https://lb.ypvip.com.cn:6443 brand"</span></span><br><span class="line">CSR=`<span class="built_in">pwd</span>`/user-csr.json</span><br><span class="line">SSL_PATH=<span class="string">"/opt/kubernetes/ssl"</span></span><br><span class="line">USER_SSL_PATH=<span class="string">"/root/yaml/create-user"</span></span><br><span class="line">SSL_FILES=(ca-key.pem ca.pem ca-config.json)</span><br><span class="line">CERT_FILES=(<span class="variable">$&#123;USER&#125;</span>.csr <span class="variable">$USER</span>-key.pem <span class="variable">$&#123;USER&#125;</span>.pem)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$KUBE_APISERVER</span> == <span class="string">""</span> ]]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="variable">$USAGE</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$USER</span> == <span class="string">""</span> ]];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="variable">$USAGE</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$Authorization</span> == <span class="string">""</span> ]];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="variable">$USAGE</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户的csr文件</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">createCSR</span></span>()&#123;</span><br><span class="line">cat&gt;<span class="variable">$CSR</span>&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"USER"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># 替换csr文件中的用户名</span></span><br><span class="line">sed -i <span class="string">"s/USER/<span class="variable">$USER_SA</span>/g"</span> <span class="variable">$CSR</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ifExist</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$SSL_PATH</span>/<span class="variable">$1</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$SSL_PATH</span>/<span class="variable">$1</span> not found."</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ifClusterrole</span></span>()&#123;</span><br><span class="line">kubectl get clusterrole <span class="variable">$&#123;Authorization&#125;</span> &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">if</span> (( $? !=0 ));<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;Authorization&#125;</span> clusterrole there is no"</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断clusterrole授权是否存在</span></span><br><span class="line">ifClusterrole</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断证书文件是否存在</span></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> <span class="variable">$&#123;SSL_FILES[@]&#125;</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Check if ssl file <span class="variable">$f</span> exist..."</span></span><br><span class="line">    ifExist <span class="variable">$f</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"OK"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Create CSR file..."</span></span><br><span class="line">createCSR</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$CSR</span> created"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Create user's certificates and keys..."</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$USER_SSL_PATH</span></span><br><span class="line">cfssl gencert -ca=<span class="variable">$&#123;SSL_PATH&#125;</span>/ca.pem -ca-key=<span class="variable">$&#123;SSL_PATH&#125;</span>/ca-key.pem -config=<span class="variable">$&#123;SSL_PATH&#125;</span>/ca-config.json -profile=kubernetes <span class="variable">$CSR</span>| cfssljson -bare <span class="variable">$USER_SA</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 sa</span></span><br><span class="line">kubectl create sa <span class="variable">$&#123;USER&#125;</span> -n default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">--certificate-authority=<span class="variable">$&#123;SSL_PATH&#125;</span>/ca.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">--kubeconfig=<span class="variable">$&#123;USER&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials <span class="variable">$&#123;USER_SA&#125;</span> \</span><br><span class="line">--client-certificate=<span class="variable">$&#123;USER_SSL_PATH&#125;</span>/<span class="variable">$&#123;USER_SA&#125;</span>.pem \</span><br><span class="line">--client-key=<span class="variable">$&#123;USER_SSL_PATH&#125;</span>/<span class="variable">$&#123;USER_SA&#125;</span>-key.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--kubeconfig=<span class="variable">$&#123;USER&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context kubernetes \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=<span class="variable">$&#123;USER_SA&#125;</span> \</span><br><span class="line">--namespace=default \</span><br><span class="line">--kubeconfig=<span class="variable">$&#123;USER&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=<span class="variable">$&#123;USER&#125;</span>.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 namespace</span></span><br><span class="line"><span class="comment"># kubectl create ns $USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定角色</span></span><br><span class="line"><span class="comment"># kubectl create rolebinding $&#123;USER&#125;-admin-binding --clusterrole=admin --user=$USER --namespace=$USER --serviceaccount=$USER:default</span></span><br><span class="line">kubectl create clusterrolebinding <span class="variable">$&#123;USER&#125;</span>-binding --clusterrole=<span class="variable">$&#123;Authorization&#125;</span> --user=<span class="variable">$&#123;USER_SA&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl config get-contexts</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Congratulations!"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Your kubeconfig file is <span class="variable">$&#123;USER&#125;</span>.kubeconfig"</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加执行权限</span></span><br><span class="line">chmod +x create-user-kubeconfig.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本 Help</span></span><br><span class="line">./create-user-kubeconfig.sh --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">USAGE: create-user.sh &lt;api_server&gt; &lt;username&gt; &lt;clusterrole authorization&gt;</span><br><span class="line"> Example: https://lb.ypvip.com.cn:6443 brand</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个 admin 管理员用户，绑定 cluster-admin 权限</span></span><br><span class="line">./create-user-kubeconfig.sh https://lb.ypvip.com.cn:6443 admin cluster-admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 admin 用户 Token</span></span><br><span class="line">kubectl describe secrets -n default `kubectl  get secrets -n default | grep admin-token | awk <span class="string">'&#123;print $1&#125;'</span>` | grep <span class="string">'token:'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把上面查看的 Token 写入到脚本生成 admin.kubeconfig 文件最底部</span></span><br><span class="line">vim admin.kubeconfig</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 .kube 目录</span></span><br><span class="line">mkdir ~/.kube/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝到 .kube 目录下</span></span><br><span class="line">cp admin.kubeconfig ~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把kubectl 从 1.17.5 换成 1.18.2版本，可以正常查看集群状态</span></span><br><span class="line">mv /opt/kubernetes/bin/kubectl-1.18.2 /opt/kubernetes/bin/kubectl</span><br><span class="line">chmod +x /opt/kubernetes/bin/kubectl</span><br><span class="line">kubectl  get cs</span><br><span class="line"></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置kubelet证书自动续期和创建Node授权用户"><a href="#配置kubelet证书自动续期和创建Node授权用户" class="headerlink" title="配置kubelet证书自动续期和创建Node授权用户"></a>配置kubelet证书自动续期和创建Node授权用户</h3><blockquote>
<p>登陆到 k8s-master1 操作</p>
</blockquote>
<p>创建 Node节点 授权用户 kubelet-bootstrap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding  kubelet-bootstrap --clusterrole=system:node-bootstrapper  --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<p>创建自动批准相关 CSR 请求的 ClusterRole</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建证书旋转配置存放目录</span></span><br><span class="line">mkdir ~/yaml/kubelet-certificate-rotating</span><br><span class="line"><span class="built_in">cd</span> ~/yaml/kubelet-certificate-rotating</span><br><span class="line">vim tls-instructs-csr.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">["certificates.k8s.io"]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["certificatesigningrequests/selfnodeserver"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["create"]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署</span></span><br><span class="line">kubectl apply -f tls-instructs-csr.yaml</span><br></pre></td></tr></table></figure>

<p>自动批准 kubelet-bootstrap 用户 TLS bootstrapping 首次申请证书的 CSR 请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding node-client-auto-approve-csr --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<p>自动批准 system:nodes 组用户更新 kubelet 自身与 apiserver 通讯证书的 CSR 请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding node-client-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient --group=system:nodes</span><br></pre></td></tr></table></figure>

<p>自动批准 system:nodes 组用户更新 kubelet 10250 api 端口证书的 CSR 请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding node-server-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeserver --group=system:nodes</span><br></pre></td></tr></table></figure>

<h3 id="配置Node组件并运行"><a href="#配置Node组件并运行" class="headerlink" title="配置Node组件并运行"></a>配置Node组件并运行</h3><p>首先我们先了解下 kubelet 中 kubelet.kubeconfig 配置是如何生成？</p>
<p>kubelet.kubeconfig 配置是通过 TLS Bootstrapping 机制生成，下面是生成的流程图。</p>
<p><img src="/images/k8s/k8s-installation/5.png" alt="5"></p>
<blockquote>
<p>登陆到 k8s-master1 k8s-master2 k8s-master3 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 node 节点生成配置脚本目录</span></span><br><span class="line">mkdir /data/k8s-node</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master1 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建生成 kubelet 配置脚本</span></span><br><span class="line">vim kubelet.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">DNS_SERVER_IP=<span class="variable">$&#123;1:-"10.10.0.2"&#125;</span></span><br><span class="line">HOSTNAME=<span class="variable">$&#123;2:-"`hostname`"&#125;</span></span><br><span class="line">CLUETERDOMAIN=<span class="variable">$&#123;3:-"cluster.local"&#125;</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">KUBELET_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=2 \\</span></span><br><span class="line"><span class="string">--hostname-override=<span class="variable">$&#123;HOSTNAME&#125;</span> \\</span></span><br><span class="line"><span class="string">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span></span><br><span class="line"><span class="string">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span></span><br><span class="line"><span class="string">--config=/opt/kubernetes/cfg/kubelet-config.yml \\</span></span><br><span class="line"><span class="string">--cert-dir=/opt/kubernetes/ssl \\</span></span><br><span class="line"><span class="string">--network-plugin=cni \\</span></span><br><span class="line"><span class="string">--cni-conf-dir=/etc/cni/net.d \\</span></span><br><span class="line"><span class="string">--cni-bin-dir=/opt/cni/bin \\</span></span><br><span class="line"><span class="string">--pod-infra-container-image=yangpeng2468/google_containers-pause-amd64:3.2"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/opt/kubernetes/cfg/kubelet-config.yml</span><br><span class="line">kind: KubeletConfiguration <span class="comment"># 使用对象</span></span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1 <span class="comment"># api版本</span></span><br><span class="line">address: 0.0.0.0 <span class="comment"># 监听地址</span></span><br><span class="line">port: 10250 <span class="comment"># 当前kubelet的端口</span></span><br><span class="line">readOnlyPort: 10255 <span class="comment"># kubelet暴露的端口</span></span><br><span class="line">cgroupDriver: cgroupfs <span class="comment"># 驱动，要于docker info显示的驱动一致</span></span><br><span class="line">clusterDNS:</span><br><span class="line">  - <span class="variable">$&#123;DNS_SERVER_IP&#125;</span></span><br><span class="line">clusterDomain: <span class="variable">$&#123;CLUETERDOMAIN&#125;</span>  <span class="comment"># 集群域</span></span><br><span class="line">failSwapOn: <span class="literal">false</span> <span class="comment"># 关闭swap</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 身份验证</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /opt/kubernetes/ssl/ca.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权</span></span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line"></span><br><span class="line"><span class="comment"># Node 资源保留</span></span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 1G</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 镜像删除策略</span></span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 旋转证书</span></span><br><span class="line">rotateCertificates: <span class="literal">true</span> <span class="comment"># 旋转kubelet client 证书</span></span><br><span class="line">featureGates:</span><br><span class="line">  RotateKubeletServerCertificate: <span class="literal">true</span></span><br><span class="line">  RotateKubeletClientCertificate: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/usr/lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet \<span class="variable">$KUBELET_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建生成 kube-proxy 配置脚本</span></span><br><span class="line">vim proxy.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">HOSTNAME=<span class="variable">$&#123;1:-"`hostname`"&#125;</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">KUBE_PROXY_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=2 \\</span></span><br><span class="line"><span class="string">--config=/opt/kubernetes/cfg/kube-proxy-config.yml"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/opt/kubernetes/cfg/kube-proxy-config.yml</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">address: 0.0.0.0 <span class="comment"># 监听地址</span></span><br><span class="line">metricsBindAddress: 0.0.0.0:10249 <span class="comment"># 监控指标地址,监控获取相关信息 就从这里获取</span></span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig <span class="comment"># 读取配置文件</span></span><br><span class="line">hostnameOverride: <span class="variable">$&#123;HOSTNAME&#125;</span> <span class="comment"># 注册到k8s的节点名称唯一</span></span><br><span class="line">clusterCIDR: 10.20.0.0/16 <span class="comment"># Pod IP范围</span></span><br><span class="line">mode: iptables <span class="comment"># 使用iptables模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 ipvs 模式</span></span><br><span class="line"><span class="comment">#mode: ipvs # ipvs 模式</span></span><br><span class="line"><span class="comment">#ipvs:</span></span><br><span class="line"><span class="comment">#  scheduler: "rr"</span></span><br><span class="line"><span class="comment">#iptables:</span></span><br><span class="line"><span class="comment">#  masqueradeAll: true</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt;/usr/lib/systemd/system/kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy \<span class="variable">$KUBE_PROXY_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-proxy</span><br><span class="line">systemctl restart kube-proxy</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成 node 配置文件</span></span><br><span class="line">./kubelet.sh 10.10.0.2 k8s-master1 cluster.local</span><br><span class="line">./proxy.sh k8s-master1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务是否启动</span></span><br><span class="line">netstat -ntpl | egrep <span class="string">"kubelet|kube-proxy"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy kubelet.sh proxy.sh 脚本到 k8s-master2 k8s-master3 机器上</span></span><br><span class="line">scp kubelet.sh  proxy.sh  root@k8s-master2:/data/k8s-node</span><br><span class="line">scp kubelet.sh  proxy.sh  root@k8s-master3:/data/k8s-node</span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master2 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/k8s-node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 node 配置文件</span></span><br><span class="line">./kubelet.sh 10.10.0.2 k8s-master2 cluster.local</span><br><span class="line">./proxy.sh k8s-master2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务是否启动</span></span><br><span class="line">netstat -ntpl | egrep <span class="string">"kubelet|kube-proxy"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>登陆到 k8s-master3 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/k8s-node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 node 配置文件</span></span><br><span class="line">./kubelet.sh 10.10.0.2 k8s-master3 cluster.local</span><br><span class="line">./proxy.sh k8s-master3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务是否启动</span></span><br><span class="line">netstat -ntpl | egrep <span class="string">"kubelet|kube-proxy"</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 随便登陆一台master机器查看node节点是否添加成功</span></span><br><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">NAME       STATUS   ROLES    AGE    VERSION</span><br><span class="line">k8s-master1   NoReady    &lt;none&gt;   4d4h   v1.18.2</span><br><span class="line">k8s-master2   NoReady    &lt;none&gt;   4d4h   v1.18.2</span><br><span class="line">k8s-master3   NoReady    &lt;none&gt;   4d4h   v1.18.2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面 Node 节点处理 NoReady 状态，是因为目前还没有安装网络组件，下文安装网络组件。</p>
</blockquote>
<p>解决无法查询pods日志问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/yaml/apiserver-to-kubelet-rbac.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubelet-api-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:kubelet-api-admin</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用</span></span><br><span class="line">kubectl apply -f ~/yaml/apiserver-to-kubelet-rbac.yml</span><br></pre></td></tr></table></figure>

<h3 id="安装calico网络，使用IPIP模式"><a href="#安装calico网络，使用IPIP模式" class="headerlink" title="安装calico网络，使用IPIP模式"></a>安装calico网络，使用IPIP模式</h3><blockquote>
<p>登陆到 k8s-master1 操作</p>
</blockquote>
<p>下载 Calico Version v3.14.0 Yaml 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 存放etcd yaml文件</span></span><br><span class="line">mkdir -p ~/yaml/calico</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~/yaml/calico</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：下面是基于自建etcd做为存储的配置文件</span></span><br><span class="line">curl https://docs.projectcalico.org/manifests/calico-etcd.yaml -O</span><br></pre></td></tr></table></figure>

<p>calico-etcd.yaml 需要修改如下配置：</p>
<p>Secret 配置修改</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">calico-etcd-secrets</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">etcd-key:</span> <span class="string">(cat</span> <span class="string">/opt/kubernetes/ssl/server-key.pem</span> <span class="string">|</span> <span class="string">base64</span> <span class="string">-w</span> <span class="number">0</span><span class="string">)</span> <span class="comment"># 将输出结果填写在这里</span></span><br><span class="line">  <span class="attr">etcd-cert:</span> <span class="string">(cat</span> <span class="string">/opt/kubernetes/ssl/server.pem</span> <span class="string">|</span> <span class="string">base64</span> <span class="string">-w</span> <span class="number">0</span><span class="string">)</span> <span class="comment"># 将输出结果填写在这里</span></span><br><span class="line">  <span class="attr">etcd-ca:</span> <span class="string">(cat</span> <span class="string">/opt/kubernetes/ssl/ca.pem</span> <span class="string">|</span> <span class="string">base64</span> <span class="string">-w</span> <span class="number">0</span><span class="string">)</span> <span class="comment"># 将输出结果填写在这里</span></span><br></pre></td></tr></table></figure>

<p>ConfigMap 配置修改</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">calico-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">etcd_endpoints:</span> <span class="string">"https://192.168.0.216:2379,https://192.168.0.217:2379,https://192.168.0.218:2379"</span></span><br><span class="line">  <span class="attr">etcd_ca:</span> <span class="string">"/calico-secrets/etcd-ca"</span></span><br><span class="line">  <span class="attr">etcd_cert:</span> <span class="string">"/calico-secrets/etcd-cert"</span></span><br><span class="line">  <span class="attr">etcd_key:</span> <span class="string">"/calico-secrets/etcd-key"</span></span><br></pre></td></tr></table></figure>

<p>关于ConfigMap部分主要参数如下：</p>
<ul>
<li>etcd_endpoints：Calico使用etcd来保存网络拓扑和状态，该参数指定etcd的地址，可以使用K8S Master所用的etcd，也可以另外搭建。</li>
<li>calico_backend：Calico的后端，默认为bird。</li>
<li>cni_network_config：符合CNI规范的网络配置，其中type=calico表示，Kubelet 从 CNI_PATH (默认为/opt/cni/bin)目录找calico的可执行文件，用于容器IP地址的分配。</li>
<li>etcd 如果配置TLS安全认证，则还需要指定相应的ca、cert、key等文件</li>
</ul>
<p>修改 Pods 使用的 IP 网段，默认使用 192.168.0.0/16 网段</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV4POOL_CIDR</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"10.20.0.0/16"</span></span><br></pre></td></tr></table></figure>

<p>配置网卡自动发现规则</p>
<p>在 DaemonSet calico-node env 中添加网卡发现规则</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义ipv4自动发现网卡规则</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IP_AUTODETECTION_METHOD</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"interface=eth.*"</span></span><br><span class="line"><span class="comment"># 定义ipv6自动发现网卡规则</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IP6_AUTODETECTION_METHOD</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"interface=eth.*"</span></span><br></pre></td></tr></table></figure>

<p>Calico 模式设置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable IPIP</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV4POOL_IPIP</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"Always"</span></span><br></pre></td></tr></table></figure>

<p>Calico 有两种网络模式：BGP 和 IPIP</p>
<ul>
<li>使用 IPIP 模式时，设置 CALICO_IPV4POOL_IPIP=”always”，IPIP 是一种将各Node的路由之间做一个tunnel，再把两个网络连接起来的模式，启用IPIP模式时，Calico将在各Node上创建一个名为 tunl0 的虚拟网络接口。</li>
<li>使用 BGP 模式时，设置 CALICO_IPV4POOL_IPIP=”off”</li>
</ul>
<p>错误解决方法</p>
<p>错误：[ERROR][8] startup/startup.go 146: failed to query kubeadm’s config map error=Get <a href="https://10.10.0.1:443/api/v1/namespaces/kube-system/configmaps/kubeadm-config?timeout=2s" target="_blank" rel="noopener">https://10.10.0.1:443/api/v1/namespaces/kube-system/configmaps/kubeadm-config?timeout=2s</a>: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</p>
<p>原因：Node工作节点连接不到 apiserver 地址，检查一下calico配置文件，要把apiserver的IP和端口配置上，如果不配置的话，calico默认将设置默认的calico网段和443端口。字段名：KUBERNETES_SERVICE_HOST、KUBERNETES_SERVICE_PORT、KUBERNETES_SERVICE_PORT_HTTPS。</p>
<p>解决方法：</p>
<p>在 DaemonSet calico-node env 中添加环境变量</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBERNETES_SERVICE_HOST</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"lb.ypvip.com.cn"</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBERNETES_SERVICE_PORT</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"6443"</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBERNETES_SERVICE_PORT_HTTPS</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"6443"</span></span><br></pre></td></tr></table></figure>

<p>修改完 calico-etcd.yaml 后，执行部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署</span></span><br><span class="line">kubectl apply -f calico-etcd.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 calico pods</span></span><br><span class="line">kubectl  get pods -n kube-system  | grep calico</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 node 是否正常，现在 node 服务正常了</span></span><br><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">NAME       STATUS   ROLES    AGE    VERSION</span><br><span class="line">k8s-master1   Ready    &lt;none&gt;   4d4h   v1.18.2</span><br><span class="line">k8s-master2   Ready    &lt;none&gt;   4d4h   v1.18.2</span><br><span class="line">k8s-master3   Ready    &lt;none&gt;   4d4h   v1.18.2</span><br></pre></td></tr></table></figure>

<h3 id="集群CoreDNS部署"><a href="#集群CoreDNS部署" class="headerlink" title="集群CoreDNS部署"></a>集群CoreDNS部署</h3><blockquote>
<p>登陆到 k8s-master1 操作</p>
</blockquote>
<p>deploy.sh 是一个便捷的脚本，用于生成coredns yaml 配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖 jq 命令</span></span><br><span class="line">yum install jq -y</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ~/yaml</span><br><span class="line">mkdir coredns</span><br><span class="line"><span class="built_in">cd</span> coredns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 CoreDNS 项目</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/coredns/deployment.git</span><br><span class="line"><span class="built_in">cd</span> coredns/deployment/kubernetes</span><br></pre></td></tr></table></figure>

<p>默认情况下 CLUSTER_DNS_IP 是自动获取kube-dns的集群ip的，但是由于没有部署kube-dns所以只能手动指定一个集群ip。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">111 <span class="keyword">if</span> [[ -z <span class="variable">$CLUSTER_DNS_IP</span> ]]; <span class="keyword">then</span></span><br><span class="line">112   <span class="comment"># Default IP to kube-dns IP</span></span><br><span class="line">113   <span class="comment"># CLUSTER_DNS_IP=$(kubectl get service --namespace kube-system kube-dns -o jsonpath="&#123;.spec.clusterIP&#125;")</span></span><br><span class="line">114   CLUSTER_DNS_IP=10.10.0.2</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看执行效果，并未开始部署</span></span><br><span class="line">./deploy.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行部署</span></span><br><span class="line">./deploy.sh | kubectl apply -f -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Coredns</span></span><br><span class="line">kubectl get svc,pods -n kube-system| grep coredns</span><br></pre></td></tr></table></figure>

<p>测试 Coredns 解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个 busybox Pod</span></span><br><span class="line">vim busybox.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.28.4</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"3600"</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署</span></span><br><span class="line">kubectl apply -f busybox.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试解析，下面是解析正常</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -i busybox -n default nslookup kubernetes</span><br><span class="line"></span><br><span class="line">Server:    10.10.0.2</span><br><span class="line">Address 1: 10.10.0.2 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.10.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h3 id="部署集群监控服务-Metrics-Server"><a href="#部署集群监控服务-Metrics-Server" class="headerlink" title="部署集群监控服务 Metrics Server"></a>部署集群监控服务 Metrics Server</h3><blockquote>
<p>登陆到 k8s-master1 操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取 v0.3.6 版本</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/kubernetes-sigs/metrics-server.git -b v0.3.6</span><br><span class="line"><span class="built_in">cd</span> metrics-server/deploy/1.8+</span><br></pre></td></tr></table></figure>

<p>只修改 metrics-server-deployment.yaml 配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面是修改前后比较差异</span></span><br><span class="line">git diff metrics-server-deployment.yaml</span><br><span class="line"></span><br><span class="line">diff --git a/deploy/1.8+/metrics-server-deployment.yaml b/deploy/1.8+/metrics-server-deployment.yaml</span><br><span class="line">index 2393e75..2139e4a 100644</span><br><span class="line">--- a/deploy/1.8+/metrics-server-deployment.yaml</span><br><span class="line">+++ b/deploy/1.8+/metrics-server-deployment.yaml</span><br><span class="line">@@ -29,8 +29,19 @@ spec:</span><br><span class="line">         emptyDir: &#123;&#125;</span><br><span class="line">       containers:</span><br><span class="line">       - name: metrics-server</span><br><span class="line">-        image: k8s.gcr.io/metrics-server-amd64:v0.3.6</span><br><span class="line">-        imagePullPolicy: Always</span><br><span class="line">+        image: yangpeng2468/metrics-server-amd64:v0.3.6</span><br><span class="line">+        imagePullPolicy: IfNotPresent</span><br><span class="line">+        resources:</span><br><span class="line">+          limits:</span><br><span class="line">+            cpu: 400m</span><br><span class="line">+            memory: 1024Mi</span><br><span class="line">+          requests:</span><br><span class="line">+            cpu: 50m</span><br><span class="line">+            memory: 50Mi</span><br><span class="line">+        <span class="built_in">command</span>:</span><br><span class="line">+        - /metrics-server</span><br><span class="line">+        - --kubelet-insecure-tls</span><br><span class="line">+        - --kubelet-preferred-address-types=InternalIP</span><br><span class="line">         volumeMounts:</span><br><span class="line">         - name: tmp-dir</span><br><span class="line">           mountPath: /tmp</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署</span></span><br><span class="line">kubectl apply -f .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">kubectl top node</span><br><span class="line"></span><br><span class="line">NAME       CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">k8s-master1   72m          7%     1002Mi          53%</span><br><span class="line">k8s-master2   121m         3%     1852Mi          12%</span><br><span class="line">k8s-master3   300m         3%     1852Mi          20%</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存单位 Mi=1024*1024字节  M=1000*1000字节</span></span><br><span class="line"><span class="comment"># CPU单位 1核=1000m 即 250m=1/4核</span></span><br></pre></td></tr></table></figure>

<h2 id="部署-Kubernetes-Dashboard"><a href="#部署-Kubernetes-Dashboard" class="headerlink" title="部署 Kubernetes Dashboard"></a>部署 Kubernetes Dashboard</h2><p><strong>自定义证书：</strong></p>
<p>下面是生成 k8s dashboard 域名证书方法，任何一种都可以。</p>
<ul>
<li>通过 <a href="https://freessl.cn" target="_blank" rel="noopener">https://freessl.cn</a> 网站，在线生成免费1年的证书。</li>
<li>通过 Let’s Encrypt 生成 90天 免费证书</li>
<li>通过 Cert-Manager 服务来生成和管理证书</li>
</ul>
<blockquote>
<p>注意：自定义证书 kubernetes-dashboard-certs secret 必须存储在与Kubernetes仪表板相同的 Namespaces。</p>
</blockquote>
<p><strong>创建 kubernetes-dashboard-certs secret：</strong></p>
<p>按上面方法，生成证书，证书生成存放到 $HOME/certs 目录中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 证书</span></span><br><span class="line">ls <span class="variable">$HOME</span>/certs</span><br><span class="line"></span><br><span class="line">k8s-dashboard.yp14.cn.crt  k8s-dashboard.yp14.cn.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 kubernetes-dashboard-certs secret</span></span><br><span class="line">kubectl create secret generic kubernetes-dashboard-certs --from-file=<span class="variable">$HOME</span>/certs -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<p>下载 dashboard yaml 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>

<p>修改 dashboard yaml 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim recommended.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把创建 kubernetes-dashboard-certs Secret 注释掉，前面已通过命令创建。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#apiVersion: v1</span></span><br><span class="line"><span class="comment">#kind: Secret</span></span><br><span class="line"><span class="comment">#metadata:</span></span><br><span class="line"><span class="comment">#  labels:</span></span><br><span class="line"><span class="comment">#    k8s-app: kubernetes-dashboard</span></span><br><span class="line"><span class="comment">#  name: kubernetes-dashboard-certs</span></span><br><span class="line"><span class="comment">#  namespace: kubernetes-dashboard</span></span><br><span class="line"><span class="comment">#type: Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加ssl证书路径，关闭自动更新证书，添加多长时间登出。</span></span><br><span class="line"><span class="comment"># 注意：--tls-key-file --tls-cert-file 引用名称，要与上面创建 kubernetes-dashboard-certs Secret 引用的证书文件名称一样。</span></span><br><span class="line"></span><br><span class="line">          args:</span><br><span class="line">            <span class="comment">#- --auto-generate-certificates</span></span><br><span class="line">            - --namespace=kubernetes-dashboard</span><br><span class="line">            - --tls-key-file=k8s-dashboard.yp14.cn.key</span><br><span class="line">            - --tls-cert-file=k8s-dashboard.yp14.cn.crt</span><br><span class="line">            - --token-ttl=3600</span><br></pre></td></tr></table></figure>

<p>部署 dashboard</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  apply -f recommended.yaml</span><br></pre></td></tr></table></figure>

<p>查看 dashboard</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl  get pods -n kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-6b4884c9d5-lx8dw   1/1     Running   0          14h</span><br><span class="line">kubernetes-dashboard-b75f6b5d6-r22nq         1/1     Running   0          14h</span><br></pre></td></tr></table></figure>

<p><strong>创建登陆用户：</strong></p>
<p>创建 admin-user 管理员 yaml 配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim create-admin.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>

<p>创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f create-admin.yaml</span><br></pre></td></tr></table></figure>

<p>查看登陆 token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure>

<p><strong>配置 Ingress Nginx 提供访问入口：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$HOME</span>/certs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 k8s-dashboard.yp14.cn 域名 Ingress nginx https 证书</span></span><br><span class="line">kubectl create secret tls k8s-dashboard --key k8s-dashboard.yp14.cn.key --cert k8s-dashboard.yp14.cn.crt -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-dashboard-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line">    <span class="comment"># 开启use-regex，启用path的正则匹配</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line">    <span class="comment"># 默认为 true，启用 TLS 时，http请求会 308 重定向到https</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="comment"># 默认为 http，开启后端服务使用 proxy_pass https://协议</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">"HTTPS"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">k8s-dashboard.yp14.cn</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">k8s-dashboard</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s-dashboard.yp14.cn</span></span><br></pre></td></tr></table></figure>

<p>创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f k8s-dashboard-ingress.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>访问入口域名：<a href="https://k8s-dashboard.yp14.cn，把上文查看的登陆" target="_blank" rel="noopener">https://k8s-dashboard.yp14.cn，把上文查看的登陆</a> token 填入。</p>
</blockquote>
<h2 id="一键添加-Node节点"><a href="#一键添加-Node节点" class="headerlink" title="一键添加 Node节点"></a>一键添加 Node节点</h2><p><strong>注意事项：</strong></p>
<ul>
<li>脚本中 SSL证书 下载链接 https://…/k8s-v1.18.2-ssl.tar.gz 需要自己提供，因为每个集群 SSL证书 不一样。</li>
<li>k8s-v1.18.2-ssl.tar.gz 包文件目录结构如下：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">k8s-v1.18.2-ssl</span><br><span class="line">├── bootstrap.kubeconfig</span><br><span class="line">├── ca-key.pem</span><br><span class="line">├── ca.pem</span><br><span class="line">├── kube-proxy.kubeconfig</span><br><span class="line">├── server-key.pem</span><br><span class="line">└── server.pem</span><br><span class="line"></span><br><span class="line">0 directories, 6 files</span><br></pre></td></tr></table></figure>

<ul>
<li>k8s-v1.18.2.tar.gz 包文件目录结构如下：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">k8s-v1.18.2</span><br><span class="line">├── kubernetes-configure</span><br><span class="line">│   └── k8s-node</span><br><span class="line">│       ├── kubelet.sh</span><br><span class="line">│       └── proxy.sh</span><br><span class="line">└── kubernetes-package</span><br><span class="line">    ├── kubelet</span><br><span class="line">    └── kube-proxy</span><br><span class="line"></span><br><span class="line">3 directories, 4 files</span><br></pre></td></tr></table></figure>

<h3 id="添加-Node-节点"><a href="#添加-Node-节点" class="headerlink" title="添加 Node 节点"></a>添加 Node 节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建Node节点初始化脚本</span></span><br><span class="line">vim Init_Node.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Check_linux_system</span></span>()&#123;</span><br><span class="line">    linux_version=`cat /etc/redhat-release`</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$&#123;linux_version&#125;</span> =~ <span class="string">"CentOS"</span> ]];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 系统为 <span class="variable">$&#123;linux_version&#125;</span> \033[0m \n"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 系统不是CentOS,该脚本只支持CentOS环境\033[0m \n"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Set_hostname</span></span>()&#123;</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$HostName</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">      grep <span class="variable">$HostName</span> /etc/hostname &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 主机名已设置，退出设置主机名步骤 \033[0m \n"</span> &amp;&amp; <span class="built_in">return</span></span><br><span class="line">      <span class="keyword">case</span> <span class="variable">$HostName</span> <span class="keyword">in</span></span><br><span class="line">      <span class="built_in">help</span>)</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\033[32;32m bash init.sh 主机名 \033[0m \n"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">      ;;</span><br><span class="line">      *)</span><br><span class="line">        hostname <span class="variable">$HostName</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$HostName</span>"</span> &gt; /etc/hostname</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"`ifconfig eth0 | grep -w inet | awk '&#123;print <span class="variable">$2</span>&#125;'` <span class="variable">$HostName</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line">      ;;</span><br><span class="line">      <span class="keyword">esac</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 输入为空，请参照 bash init.sh 主机名 \033[0m \n"</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Install_depend_environment</span></span>()&#123;</span><br><span class="line">    rpm -qa | grep nfs-utils &amp;&gt; /dev/null &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 已完成依赖环境安装，退出依赖环境安装步骤 \033[0m \n"</span> &amp;&amp; <span class="built_in">return</span></span><br><span class="line">    yum install -y nfs-utils curl yum-utils device-mapper-persistent-data lvm2 net-tools conntrack-tools wget vim  ntpdate libseccomp libtool-ltdl telnet</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 升级Centos7系统内核到5版本，解决Docker-ce版本兼容问题\033[0m \n"</span></span><br><span class="line">    rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org &amp;&amp; \</span><br><span class="line">    rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm &amp;&amp; \</span><br><span class="line">    yum --disablerepo=\* --enablerepo=elrepo-kernel repolist &amp;&amp; \</span><br><span class="line">    yum --disablerepo=\* --enablerepo=elrepo-kernel install -y kernel-ml.x86_64 &amp;&amp; \</span><br><span class="line">    yum remove -y kernel-tools-libs.x86_64 kernel-tools.x86_64 &amp;&amp; \</span><br><span class="line">    yum --disablerepo=\* --enablerepo=elrepo-kernel install -y kernel-ml-tools.x86_64 &amp;&amp; \</span><br><span class="line">    grub2-set-default 0</span><br><span class="line">    modprobe br_netfilter</span><br><span class="line">    cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line">    sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line">    ls /proc/sys/net/bridge</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Install_docker</span></span>()&#123;</span><br><span class="line">    rpm -qa | grep docker &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"\033[32;32m 已安装docker，退出安装docker步骤 \033[0m \n"</span> &amp;&amp; <span class="built_in">return</span></span><br><span class="line">    yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">    yum makecache fast</span><br><span class="line">    yum -y install docker-ce-19.03.6 docker-ce-cli-19.03.6</span><br><span class="line">    <span class="comment"># 设置 iptables file表中 FORWARD 默认链规则为 ACCEPT</span></span><br><span class="line">    sed  -i <span class="string">'/ExecStart=/i ExecStartPost=\/sbin\/iptables -P FORWARD ACCEPT'</span> /usr/lib/systemd/system/docker.service</span><br><span class="line">    systemctl <span class="built_in">enable</span> docker.service</span><br><span class="line">    systemctl start docker.service</span><br><span class="line">    systemctl stop docker.service</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'&#123;"registry-mirrors": ["https://4xr1qpsp.mirror.aliyuncs.com"], "log-opts": &#123;"max-size":"500m", "max-file":"3"&#125;&#125;'</span> &gt; /etc/docker/daemon.json</span><br><span class="line">    systemctl daemon-reload</span><br><span class="line">    systemctl start docker</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Install_k8s_node</span></span>()&#123;</span><br><span class="line">    ps aux | grep kube | grep -v grep &amp;&gt; /dev/null &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"\033[32;32m k8s node服务已启动，退出初始化node服务步骤 \033[0m \n"</span> &amp;&amp; <span class="built_in">return</span></span><br><span class="line">    mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl&#125; /data/k8s-node</span><br><span class="line">    <span class="built_in">cd</span> /data/k8s-node</span><br><span class="line">    <span class="comment"># 添加更换为自己集群SSL证书下载地址</span></span><br><span class="line">    wget https://.../k8s-v1.18.2-ssl.tar.gz</span><br><span class="line">    tar zxvf k8s-v1.18.2-ssl.tar.gz</span><br><span class="line">    <span class="built_in">cd</span> k8s-v1.18.2-ssl/</span><br><span class="line">    cp ca*pem server*pem /opt/kubernetes/ssl/</span><br><span class="line">    cp *kubeconfig /opt/kubernetes/cfg/</span><br><span class="line">    <span class="built_in">cd</span> /data/k8s-node</span><br><span class="line">    wget https://cdm.yp14.cn/k8s-script/k8s-v1.18.2.tar.gz</span><br><span class="line">    tar zxvf k8s-v1.18.2.tar.gz</span><br><span class="line">    <span class="built_in">cd</span> k8s-v1.18.2/kubernetes-package/</span><br><span class="line">    cp -a kubelet kube-proxy /opt/kubernetes/bin/</span><br><span class="line">    chmod +x /opt/kubernetes/bin/kubelet /opt/kubernetes/bin/kube-proxy</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'export PATH=$PATH:/opt/kubernetes/bin'</span> &gt;&gt; ~/.bashrc</span><br><span class="line">    <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">    <span class="comment"># 删除 tar 包</span></span><br><span class="line">    rm -f /data/k8s-node/k8s-v1.18.2-ssl.tar.gz /data/k8s-node/k8s-v1.18.2.tar.gz</span><br><span class="line">    <span class="built_in">cd</span> /data/k8s-node/k8s-v1.18.2/kubernetes-configure/k8s-node</span><br><span class="line">    <span class="comment"># kubelet.sh 后面接的参数分别为：集群dns地址、Node节点主机名、集群域名后辍</span></span><br><span class="line">    bash kubelet.sh 10.10.0.2 <span class="variable">$HostName</span> cluster.local</span><br><span class="line">    <span class="comment"># proxy.sh 后面接的参数分别为：Node节点主机名</span></span><br><span class="line">    bash proxy.sh <span class="variable">$HostName</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化顺序</span></span><br><span class="line">HostName=<span class="variable">$1</span></span><br><span class="line">Check_linux_system &amp;&amp; \</span><br><span class="line">Set_hostname &amp;&amp; \</span><br><span class="line">Install_depend_environment &amp;&amp; \</span><br><span class="line">Install_docker &amp;&amp; \</span><br><span class="line">Install_k8s_node</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给脚本添加执行权限</span></span><br><span class="line">chmod +x Init_Node.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行添加Node节点脚本，需要传入 主机名 参数</span></span><br><span class="line">./Init_Node.sh k8s-node1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 成功添加好Node节点，需要把Node节点重启，使用新的内核</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://mp.weixin.qq.com/s/jnVn6_cyRUILBQ0cBhBNyQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/jnVn6_cyRUILBQ0cBhBNyQ</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/back-end/k8s/k8s-installation-kubeadm/" rel="prev" title="Kubeadm 部署 Kubernetes">
      <i class="fa fa-chevron-left"></i> Kubeadm 部署 Kubernetes
    </a></div>
      <div class="post-nav-item">
    <a href="/back-end/k8s/k8s-installation-kubespray/" rel="next" title="Kubespray 部署 Kubernetes">
      Kubespray 部署 Kubernetes <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#二进制-方式部署"><span class="nav-number">1.</span> <span class="nav-text">二进制 方式部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境"><span class="nav-number">2.</span> <span class="nav-text">环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器信息"><span class="nav-number">2.1.</span> <span class="nav-text">服务器信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务版本与K8S集群说明"><span class="nav-number">2.2.</span> <span class="nav-text">服务版本与K8S集群说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-和-Pods-Ip-段划分"><span class="nav-number">2.3.</span> <span class="nav-text">Service 和 Pods Ip 段划分</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境初始化"><span class="nav-number">3.</span> <span class="nav-text">环境初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#停止所有机器-firewalld-防火墙"><span class="nav-number">3.1.</span> <span class="nav-text">停止所有机器 firewalld 防火墙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭-swap"><span class="nav-number">3.2.</span> <span class="nav-text">关闭 swap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭-Selinux"><span class="nav-number">3.3.</span> <span class="nav-text">关闭 Selinux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置主机名、升级内核、安装-Docker-ce"><span class="nav-number">3.4.</span> <span class="nav-text">设置主机名、升级内核、安装 Docker ce</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-部署"><span class="nav-number">4.</span> <span class="nav-text">Kubernetes 部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署顺序"><span class="nav-number">4.1.</span> <span class="nav-text">部署顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自签TLS证书"><span class="nav-number">4.2.</span> <span class="nav-text">自签TLS证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署Etcd集群"><span class="nav-number">4.3.</span> <span class="nav-text">部署Etcd集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-metrics-server-证书"><span class="nav-number">4.4.</span> <span class="nav-text">创建 metrics-server 证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取K8S二进制包"><span class="nav-number">4.5.</span> <span class="nav-text">获取K8S二进制包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Node节点kubeconfig文件"><span class="nav-number">4.6.</span> <span class="nav-text">创建Node节点kubeconfig文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Master组件并运行"><span class="nav-number">4.7.</span> <span class="nav-text">配置Master组件并运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置kubelet证书自动续期和创建Node授权用户"><span class="nav-number">4.8.</span> <span class="nav-text">配置kubelet证书自动续期和创建Node授权用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Node组件并运行"><span class="nav-number">4.9.</span> <span class="nav-text">配置Node组件并运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装calico网络，使用IPIP模式"><span class="nav-number">4.10.</span> <span class="nav-text">安装calico网络，使用IPIP模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群CoreDNS部署"><span class="nav-number">4.11.</span> <span class="nav-text">集群CoreDNS部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署集群监控服务-Metrics-Server"><span class="nav-number">4.12.</span> <span class="nav-text">部署集群监控服务 Metrics Server</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-Kubernetes-Dashboard"><span class="nav-number">5.</span> <span class="nav-text">部署 Kubernetes Dashboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一键添加-Node节点"><span class="nav-number">6.</span> <span class="nav-text">一键添加 Node节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加-Node-节点"><span class="nav-number">6.1.</span> <span class="nav-text">添加 Node 节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Richard"
      src="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
  <p class="site-author-name" itemprop="name">Richard</p>
  <div class="site-description" itemprop="description">惶者生存，偏执者成功</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xinlc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/xinlc" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://learnxinyminutes.com/" title="https:&#x2F;&#x2F;learnxinyminutes.com" rel="noopener" target="_blank">Learn X in Y minutes</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://justjavac.com/" title="http:&#x2F;&#x2F;justjavac.com" rel="noopener" target="_blank">justjavac</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.ruanyifeng.com/blog/" title="http:&#x2F;&#x2F;www.ruanyifeng.com&#x2F;blog&#x2F;" rel="noopener" target="_blank">阮一峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.liaoxuefeng.com/" title="https:&#x2F;&#x2F;www.liaoxuefeng.com" rel="noopener" target="_blank">廖雪峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tech.meituan.com/" title="https:&#x2F;&#x2F;tech.meituan.com" rel="noopener" target="_blank">美团技术</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.v2ex.com/" title="https:&#x2F;&#x2F;www.v2ex.com" rel="noopener" target="_blank">V2EX</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://caniuse.com/" title="https:&#x2F;&#x2F;caniuse.com" rel="noopener" target="_blank">caniuse/工具</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.css88.com/nav/" title="http:&#x2F;&#x2F;www.css88.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">css88/doc</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://overapi.com/" title="http:&#x2F;&#x2F;overapi.com&#x2F;" rel="noopener" target="_blank">OverAPI/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://devdocs.io/" title="http:&#x2F;&#x2F;devdocs.io&#x2F;" rel="noopener" target="_blank">DevDocs/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.oschina.net/" title="http:&#x2F;&#x2F;tool.oschina.net&#x2F;" rel="noopener" target="_blank">在线工具/索引</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.lu/" title="http:&#x2F;&#x2F;tool.lu&#x2F;" rel="noopener" target="_blank">ToolBox</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://hao.shejidaren.com/" title="http:&#x2F;&#x2F;hao.shejidaren.com&#x2F;" rel="noopener" target="_blank">设计导航</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
