<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.lichao.xin","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"3ZZ8ITB7HE","apiKey":"062eb5a54afbcbf3f20452d58fc40035","indexName":"xinlc","hits":{"per_page":10},"labels":{"input_placeholder":"搜索","hits_empty":"未发现与「${query}」相关的内容","hits_stats":"${hits} 条相关条目，使用了 ${time} 毫秒"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="目前安装 Kubernetes 的方式多样，主要是：Minikube、二进制部署、kubeadm、Kops、Rancher、Kubespray。">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubeadm 部署 Kubernetes">
<meta property="og:url" content="https://blog.lichao.xin/back-end/k8s/k8s-installation-kubeadm/index.html">
<meta property="og:site_name" content="Richard Xin&#39;s Blog">
<meta property="og:description" content="目前安装 Kubernetes 的方式多样，主要是：Minikube、二进制部署、kubeadm、Kops、Rancher、Kubespray。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lichao.xin/images/k8s/k8s-installation/3.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/k8s/k8s-installation/4.jpg">
<meta property="article:published_time" content="2020-05-23T10:00:00.000Z">
<meta property="article:modified_time" content="2021-06-14T01:33:22.391Z">
<meta property="article:author" content="Richard">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lichao.xin/images/k8s/k8s-installation/3.jpg">

<link rel="canonical" href="https://blog.lichao.xin/back-end/k8s/k8s-installation-kubeadm/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Kubeadm 部署 Kubernetes | Richard Xin's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4530ac9d0bc4e258535c4a9b17029f0c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Richard Xin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Richard Xin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Quick notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">132</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">59</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.lichao.xin/back-end/k8s/k8s-installation-kubeadm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
      <meta itemprop="name" content="Richard">
      <meta itemprop="description" content="惶者生存，偏执者成功">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Richard Xin's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubeadm 部署 Kubernetes
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-23 10:00:00" itemprop="dateCreated datePublished" datetime="2020-05-23T10:00:00+00:00">2020-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-14 01:33:22" itemprop="dateModified" datetime="2021-06-14T01:33:22+00:00">2021-06-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>目前安装 Kubernetes 的方式多样，主要是：Minikube、二进制部署、kubeadm、Kops、Rancher、Kubespray。</p>
<a id="more"></a>

<h2 id="kubeadm-方式部署"><a href="#kubeadm-方式部署" class="headerlink" title="kubeadm 方式部署"></a>kubeadm 方式部署</h2><p>Minikube 部署 Kubernetes 的核心就是 Kubeadm。Kubeadm 是一个工具，它提供了 <code>kubeadm init</code> 以及 <code>kubeadm join</code> 这两个命令作为快速创建 kubernetes 集群的最佳实践。</p>
<h2 id="kubeadm-部署单Master节点"><a href="#kubeadm-部署单Master节点" class="headerlink" title="kubeadm 部署单Master节点"></a>kubeadm 部署单Master节点</h2><h3 id="机器准备"><a href="#机器准备" class="headerlink" title="机器准备"></a>机器准备</h3><blockquote>
<p>在所有节点上操作</p>
</blockquote>
<ul>
<li>关闭selinux,firewall</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setenforce  0</span><br><span class="line">sed -i <span class="string">'s/SELINUX=enforcing/SELINUX=permissive/'</span> /etc/selinux/config</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭swap，(1.8版本后的要求，目的应该是不想让swap干扰pod可使用的内存limit)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure>

<ul>
<li>修改下面内核参数，否则请求数据经过iptables的路由可能有问题</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>

<h3 id="检查所需端口"><a href="#检查所需端口" class="headerlink" title="检查所需端口"></a>检查所需端口</h3><blockquote>
<p>Master 节点/Control-plane node(s)</p>
</blockquote>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>入站</td>
<td>6443*</td>
<td>Kubernetes API 服务器</td>
<td>所有组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>2379-2380</td>
<td>etcd server client API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>kubelet 自身、控制平面组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10251</td>
<td>kube-scheduler</td>
<td>kube-scheduler 自身</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10252</td>
<td>kube-controller-manager</td>
<td>kube-controller-manager 自身</td>
</tr>
</tbody></table>
<blockquote>
<p>Node节点/Worker node(s)</p>
</blockquote>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>kubelet 自身、控制平面组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>30000-32767</td>
<td>NodePort 服务**</td>
<td>所有组件</td>
</tr>
</tbody></table>
<p>** NodePort 服务 的默认端口范围。</p>
<p>使用 * 标记的任意端口号都可以被覆盖，所以您需要保证所定制的端口是开放的。</p>
<h3 id="检查网络"><a href="#检查网络" class="headerlink" title="检查网络"></a>检查网络</h3><blockquote>
<p>在所有节点执行命令</p>
</blockquote>
<p>安装后的拓扑图如下：<a href="https://kuboard.cn" target="_blank" rel="noopener">参考</a></p>
<p><img src="/images/k8s/k8s-installation/3.jpg" alt="3"></p>
<ul>
<li><code>ip route show</code> 命令中，可以知道机器的默认网卡，通常是 <code>eth0</code>，如 <strong><em>default via 172.21.0.23 dev <font color="blue" weight="500">eth0</font></em></strong></li>
<li><code>ip address</code> 命令中，可显示默认网卡的 IP 地址，Kubernetes 将使用此 IP 地址与集群内的其他节点通信，如 <code>172.17.216.80</code></li>
<li>所有节点上 Kubernetes 所使用的 IP 地址必须可以互通（无需 NAT 映射、无安全组或防火墙隔离）</li>
</ul>
<p><strong>修改hostname：</strong></p>
<p>如果在安装使用k8s中出现以下错误, 则需要修改hostname：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name: Invalid value: <span class="string">"k8s_master"</span>: a DNS-1123 subdomain must consist of lower <span class="keyword">case</span> alphanumeric characters, <span class="string">'-'</span> or <span class="string">'.'</span>, and must start and end with an alphanumeric character (e.g. <span class="string">'example.com'</span>, regex used <span class="keyword">for</span></span><br><span class="line"> validation is <span class="string">'[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*'</span>)</span><br></pre></td></tr></table></figure>

<p>出现hostname不合法的情况, 执行以下命令修改hostname</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 hostname</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname your-new-host-name</span><br><span class="line"><span class="comment"># 查看修改结果</span></span><br><span class="line">hostnamectl status</span><br><span class="line"><span class="comment"># 设置 hostname 解析</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"127.0.0.1   <span class="variable">$(hostname)</span>"</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<h3 id="一键安装脚本"><a href="#一键安装脚本" class="headerlink" title="一键安装脚本"></a>一键安装脚本</h3><blockquote>
<p>在 master 节点和 worker 节点都要执行</p>
</blockquote>
<p>使用 root 身份在所有节点执行下面的脚本，以安装软件：</p>
<ul>
<li>docker</li>
<li>nfs-utils</li>
<li>kubectl / kubeadm / kubelet</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 master 节点和 worker 节点都要执行</span></span><br><span class="line"><span class="comment"># 最后一个参数 1.18.3 用于指定 kubenetes 版本，支持所有 1.18.x 版本的安装</span></span><br><span class="line"><span class="comment"># 腾讯云 docker hub 镜像</span></span><br><span class="line"><span class="comment"># export REGISTRY_MIRROR="https://mirror.ccs.tencentyun.com"</span></span><br><span class="line"><span class="comment"># DaoCloud 镜像</span></span><br><span class="line"><span class="comment"># export REGISTRY_MIRROR="http://f1361db2.m.daocloud.io"</span></span><br><span class="line"><span class="comment"># 阿里云 docker hub 镜像</span></span><br><span class="line"><span class="built_in">export</span> REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class="line"></span><br><span class="line">bash install_kubelet.sh 1.18.3</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install_kubelet.sh</span></span><br><span class="line"><span class="comment"># CentOS 版本: 7.7</span></span><br><span class="line"><span class="comment"># K8s: 1.18.3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 docker</span></span><br><span class="line"><span class="comment"># 参考文档如下</span></span><br><span class="line"><span class="comment"># https://docs.docker.com/install/linux/docker-ce/centos/ </span></span><br><span class="line"><span class="comment"># https://docs.docker.com/install/linux/linux-postinstall/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载旧版本</span></span><br><span class="line">yum remove -y docker \</span><br><span class="line">docker-client \</span><br><span class="line">docker-client-latest \</span><br><span class="line">docker-ce-cli \</span><br><span class="line">docker-common \</span><br><span class="line">docker-latest \</span><br><span class="line">docker-latest-logrotate \</span><br><span class="line">docker-logrotate \</span><br><span class="line">docker-selinux \</span><br><span class="line">docker-engine-selinux \</span><br><span class="line">docker-engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 yum repository</span></span><br><span class="line">yum install -y yum-utils \</span><br><span class="line">device-mapper-persistent-data \</span><br><span class="line">lvm2</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装并启动 docker</span></span><br><span class="line">yum install -y docker-ce-19.03.8 docker-ce-cli-19.03.8 containerd.io</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 nfs-utils</span></span><br><span class="line"><span class="comment"># 必须先安装 nfs-utils 才能挂载 nfs 网络存储</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line">yum install -y wget</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 SeLinux</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 swap</span></span><br><span class="line">swapoff -a</span><br><span class="line">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class="line">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># 如果有配置，则修改</span></span><br><span class="line">sed -i <span class="string">"s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g"</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">"s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g"</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">"s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g"</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">"s#^net.ipv6.conf.all.disable_ipv6.*#net.ipv6.conf.all.disable_ipv6=1#g"</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">"s#^net.ipv6.conf.default.disable_ipv6.*#net.ipv6.conf.default.disable_ipv6=1#g"</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">"s#^net.ipv6.conf.lo.disable_ipv6.*#net.ipv6.conf.lo.disable_ipv6=1#g"</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">"s#^net.ipv6.conf.all.forwarding.*#net.ipv6.conf.all.forwarding=1#g"</span>  /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 可能没有，追加</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.ipv4.ip_forward = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.bridge.bridge-nf-call-ip6tables = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.bridge.bridge-nf-call-iptables = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.ipv6.conf.all.disable_ipv6 = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.ipv6.conf.default.disable_ipv6 = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.ipv6.conf.lo.disable_ipv6 = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.ipv6.conf.all.forwarding = 1"</span>  &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 执行命令以应用</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置K8S的yum源</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载旧版本</span></span><br><span class="line">yum remove -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装kubelet、kubeadm、kubectl</span></span><br><span class="line"><span class="comment"># 将 $&#123;1&#125; 替换为 kubernetes 版本号，例如 1.17.2</span></span><br><span class="line">yum install -y kubelet-<span class="variable">$&#123;1&#125;</span> kubeadm-<span class="variable">$&#123;1&#125;</span> kubectl-<span class="variable">$&#123;1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改docker Cgroup Driver为systemd</span></span><br><span class="line"><span class="comment"># # 将/usr/lib/systemd/system/docker.service文件中的这一行 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span></span><br><span class="line"><span class="comment"># # 修改为 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd</span></span><br><span class="line"><span class="comment"># 如果不修改，在添加 worker 节点时可能会碰到如下错误</span></span><br><span class="line"><span class="comment"># [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd".</span></span><br><span class="line"><span class="comment"># Please follow the guide at https://kubernetes.io/docs/setup/cri/</span></span><br><span class="line">sed -i <span class="string">"s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g"</span> /usr/lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 docker 镜像，提高 docker 镜像下载速度和稳定性</span></span><br><span class="line"><span class="comment"># 如果您访问 https://hub.docker.io 速度非常稳定，亦可以跳过这个步骤</span></span><br><span class="line">curl -sSL https://xinlichao.cn/resource/back-end/k8s/k8s-installation-kubeadm/set_mirror.sh | sh -s <span class="variable">$&#123;REGISTRY_MIRROR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 docker，并启动 kubelet</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line"></span><br><span class="line">docker version</span><br></pre></td></tr></table></figure>

<h3 id="初始化-master-节点"><a href="#初始化-master-节点" class="headerlink" title="初始化 master 节点"></a>初始化 master 节点</h3><blockquote>
<p>只在 master 节点执行</p>
</blockquote>
<p><strong>注意事项：</strong></p>
<ul>
<li>以 root 身份在 master-k8s 机器上执行</li>
<li>关于初始化时用到的环境变量<ul>
<li>APISERVER_NAME 不能是 master 的 hostname</li>
<li>APISERVER_NAME 必须全为小写字母、数字、小数点，不能包含减号</li>
<li>POD_SUBNET 所使用的网段不能与 master节点/worker节点 所在的网段重叠。该字段的取值为一个 CIDR 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET=10.100.0.1/16 命令，不做修改</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行以下命令只在 master-k8s 节点机器执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 master 节点实际 IP（请使用内网 IP）</span></span><br><span class="line"><span class="comment"># export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=x.x.x.x</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为 您想要的 dnsName</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="comment"># Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span></span><br><span class="line"><span class="built_in">export</span> POD_SUBNET=10.100.0.1/16</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">bash init_master.sh 1.18.3</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># init_master.sh</span></span><br><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本出错时终止执行</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;#POD_SUBNET&#125;</span> -eq 0 ] || [ <span class="variable">$&#123;#APISERVER_NAME&#125;</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31;1m请确保您已经设置了环境变量 POD_SUBNET 和 APISERVER_NAME \033[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> 当前POD_SUBNET=<span class="variable">$POD_SUBNET</span></span><br><span class="line">  <span class="built_in">echo</span> 当前APISERVER_NAME=<span class="variable">$APISERVER_NAME</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看完整配置选项 https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2</span></span><br><span class="line">rm -f ./kubeadm-config.yaml</span><br><span class="line">cat &lt;&lt;EOF &gt; ./kubeadm-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v<span class="variable">$&#123;1&#125;</span></span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">controlPlaneEndpoint: <span class="string">"<span class="variable">$&#123;APISERVER_NAME&#125;</span>:6443"</span></span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: <span class="string">"10.96.0.0/16"</span></span><br><span class="line">  podSubnet: <span class="string">"<span class="variable">$&#123;POD_SUBNET&#125;</span>"</span></span><br><span class="line">  dnsDomain: <span class="string">"cluster.local"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubeadm init</span></span><br><span class="line"><span class="comment"># 根据您服务器网速的情况，您需要等候 3 - 10 分钟</span></span><br><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 kubectl</span></span><br><span class="line">rm -rf /root/.kube/</span><br><span class="line">mkdir /root/.kube/</span><br><span class="line">cp -i /etc/kubernetes/admin.conf /root/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 calico 网络插件</span></span><br><span class="line"><span class="comment"># 参考文档 https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"安装calico-3.13.1"</span></span><br><span class="line">rm -f calico-3.13.1.yaml</span><br><span class="line">wget https://xinlichao.cn/resource/back-end/k8s/k8s-installation-kubeadm/calico-3.13.1.yaml-t -O calico-3.13.1.yaml</span><br><span class="line">kubectl apply -f calico-3.13.1.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>检查 master 初始化结果</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span></span><br><span class="line">watch kubectl get pod -n kube-system -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 master 节点初始化结果</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>

<h3 id="初始化-worker-节点"><a href="#初始化-worker-节点" class="headerlink" title="初始化 worker 节点"></a>初始化 worker 节点</h3><ul>
<li>获得 join命令参数</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line">kubeadm token create --<span class="built_in">print</span>-join-command</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubeadm token create 命令的输出</span></span><br><span class="line"><span class="comment"># 该 token 的有效时间为 2 个小时，2小时内，您可以使用此 token 初始化任意数量的 worker 节点。</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure>

<ul>
<li>执行加入集群命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 worker 节点执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 master 节点的内网 IP</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=x.x.x.x</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换为 master 节点上 kubeadm token create 命令的输出</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure>

<ul>
<li>检查初始化结果</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>

<h2 id="安装helm（kubeSphere准备工作）"><a href="#安装helm（kubeSphere准备工作）" class="headerlink" title="安装helm（kubeSphere准备工作）"></a>安装helm（kubeSphere准备工作）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3</span><br><span class="line">chmod 700 get_helm.sh</span><br><span class="line">./get_helm.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行helm version 可以看到client已经安装好了，但是server端还没有安装。</span></span><br><span class="line">helm version</span><br></pre></td></tr></table></figure>

<p>创建rbac-config.yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f rbac-config.yaml</span><br></pre></td></tr></table></figure>

<p>以上步骤配置成功后，安装tiller （和helm client的版本要一样）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下命令二选一</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># google源</span></span><br><span class="line">helm init --service-account tiller --upgrade -i gcr.io/kubernetes-helm/tiller:v2.16.0</span><br><span class="line"><span class="comment"># 阿里源</span></span><br><span class="line">helm init --service-account tiller --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.16.0 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数--stable-repo-url用于拉取charts所在源的位置，如果不设置则默认访问官方charts</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看tiller是否安装成功</span></span><br><span class="line">kubectl get pod -n kube-system -l app=helm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次执行 helm version可以看到client和service都安装好了</span></span><br><span class="line">helm version</span><br></pre></td></tr></table></figure>

<h2 id="部署-KubeSphere"><a href="#部署-KubeSphere" class="headerlink" title="部署 KubeSphere"></a>部署 KubeSphere</h2><p>版本要求：</p>
<ul>
<li>Kubernetes &gt;=1.13.0 &amp;&amp; &lt;=1.16.0</li>
<li>GitVersion &gt;v1.13.0</li>
<li>Helm &gt;= 2.10.0</li>
</ul>
<p>机器要求：</p>
<ul>
<li>集群work节点可用总内存至少10G以上，建议20G</li>
</ul>
<h3 id="在-Master-节点安装-kubeSphere"><a href="#在-Master-节点安装-kubeSphere" class="headerlink" title="在 Master 节点安装 kubeSphere"></a>在 Master 节点安装 kubeSphere</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在Kubernetes 集群中创建名为 kubesphere-system 和 kubesphere-monitoring-system 的 namespace。</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF | kubectl create -f -</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">    name: kubesphere-system</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">    name: kubesphere-monitoring-system</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="创建-Kubernetes-集群-CA-证书的-Secret"><a href="#创建-Kubernetes-集群-CA-证书的-Secret" class="headerlink" title="创建 Kubernetes 集群 CA 证书的 Secret"></a>创建 Kubernetes 集群 CA 证书的 Secret</h3><blockquote>
<p>注：按照当前集群 ca.crt 和 ca.key 证书路径创建（Kubeadm 创建集群的证书路径一般为 /etc/kubernetes/pki）</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubesphere-system create secret generic kubesphere-ca  \</span><br><span class="line">--from-file=ca.crt=/etc/kubernetes/pki/ca.crt  \</span><br><span class="line">--from-file=ca.key=/etc/kubernetes/pki/ca.key</span><br></pre></td></tr></table></figure>

<h3 id="创建集群-etcd-的证书-Secret"><a href="#创建集群-etcd-的证书-Secret" class="headerlink" title="创建集群 etcd 的证书 Secret"></a>创建集群 etcd 的证书 Secret</h3><ul>
<li>若 etcd 已经配置过证书，则参考如下创建（以下命令适用于 Kubeadm 创建的 Kubernetes 集群环境）：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs  \</span><br><span class="line">--from-file=etcd-client-ca.crt=/etc/kubernetes/pki/etcd/ca.crt  \</span><br><span class="line">--from-file=etcd-client.crt=/etc/kubernetes/pki/etcd/healthcheck-client.crt  \</span><br><span class="line">--from-file=etcd-client.key=/etc/kubernetes/pki/etcd/healthcheck-client.key</span><br></pre></td></tr></table></figure>

<ul>
<li>若 etcd 没有配置证书，则创建空 Secret：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs</span><br></pre></td></tr></table></figure>

<ul>
<li>克隆 kubesphere-installer 仓库至本地</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install git</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/kubesphere/ks-installer.git</span><br></pre></td></tr></table></figure>

<ul>
<li>进入 ks-installer，然后在 Kubernetes 集群部署 KubeSphere</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据参数说明列表，编辑 kubesphere-installer.yaml 中 ks-config.yaml 为当前集群参数信息（若 etcd 无证书，设置 etcd_tls_enable: False）</span></span><br><span class="line"><span class="comment"># 修改kube_apiserver_host和etcd_endpoint_ips为机器的内网IP</span></span><br><span class="line">vim kubesphere-installer.yaml</span><br><span class="line"></span><br><span class="line">kubectl apply -f kubesphere-installer.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>查看部署日志信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l job-name=kubesphere-installer -o jsonpath=<span class="string">'&#123;.items[0].metadata.name&#125;'</span>) -f</span><br></pre></td></tr></table></figure>

<ul>
<li>安装成功 安装成功执行以下命令查看状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n kubesphere-system</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 IP:30880 访问 KubeSphere UI 界面，默认的集群管理员账号为 admin/P@88w0rd</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看指定 namespace 下 pod 所属的 node 节点</span></span><br><span class="line">kubectl get pods -n istio-system -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看dev下的pod</span></span><br><span class="line">kubectl get pods -n dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod xxx的yaml文件</span></span><br><span class="line">kubectl get pods -n dev xxx -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取namespace 为dev 的pod详情</span></span><br><span class="line">kubectl get pods -n dev -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">kubectl apply -f xxx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示node的labeal</span></span><br><span class="line">kubectl get nodes --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 namespace为dev下的pod详情</span></span><br><span class="line">kubectl describe pods -n dev [podName]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看node节点详情</span></span><br><span class="line">kubectl describe nodes [nodeName] -o wide</span><br></pre></td></tr></table></figure>

<blockquote>
<p>碰到 status为ContainerCreating ，可以到对应pod所在的node节点上执行journalctl -f查看镜像或容器实时状态</p>
</blockquote>
<h2 id="kubeadm-部署高可用"><a href="#kubeadm-部署高可用" class="headerlink" title="kubeadm 部署高可用"></a>kubeadm 部署高可用</h2><p>高可用集群安装具备如下特点：</p>
<ul>
<li>CentOS 7.7</li>
<li>Kubernetes 1.16.2<ul>
<li>calico 3.9</li>
<li>nginx-ingress 1.5.5</li>
</ul>
</li>
<li>Docker 18.09.7</li>
<li>三个 master 组成主节点集群，通过内网 loader balancer 实现负载均衡；至少需要三个 master 节点才可组成高可用集群，否则会出现 脑裂 现象</li>
<li>多个 worker 组成工作节点集群，通过外网 loader balancer 实现负载均衡</li>
</ul>
<p>安装后的拓扑图如下：</p>
<p><img src="/images/k8s/k8s-installation/4.jpg" alt="4"></p>
<h3 id="检查-centos-hostname"><a href="#检查-centos-hostname" class="headerlink" title="检查 centos / hostname"></a>检查 centos / hostname</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 master 节点和 worker 节点都要执行</span></span><br><span class="line">cat /etc/redhat-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此处 hostname 的输出将会是该机器在 Kubernetes 集群中的节点名字</span></span><br><span class="line"><span class="comment"># 不能使用 localhost 作为节点的名字</span></span><br><span class="line">hostname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请使用 lscpu 命令，核对 CPU 信息</span></span><br><span class="line"><span class="comment"># Architecture: x86_64    本安装文档不支持 arm 架构</span></span><br><span class="line"><span class="comment"># CPU(s):       2         CPU 内核数量不能低于 2</span></span><br><span class="line">lscpu</span><br></pre></td></tr></table></figure>

<ul>
<li>修改 hostname</li>
</ul>
<p>如果需要修改 hostname，可执行如下指令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 hostname</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname your-new-host-name</span><br><span class="line"><span class="comment"># 查看修改结果</span></span><br><span class="line">hostnamectl status</span><br><span class="line"><span class="comment"># 设置 hostname 解析</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"127.0.0.1   <span class="variable">$(hostname)</span>"</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<ul>
<li>检查网络</li>
</ul>
<blockquote>
<p>在所有节点执行命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@demo-master-a-1 ~]$ ip route show</span><br><span class="line">default via 172.21.0.1 dev eth0</span><br><span class="line">169.254.0.0&#x2F;16 dev eth0 scope link metric 1002</span><br><span class="line">172.21.0.0&#x2F;20 dev eth0 proto kernel scope link src 172.21.0.12</span><br><span class="line"></span><br><span class="line">[root@demo-master-a-1 ~]$ ip address</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link&#x2F;loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1&#x2F;8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link&#x2F;ether 00:16:3e:12:a4:1b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.216.80&#x2F;20 brd 172.17.223.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 305741654sec preferred_lft 305741654sec</span><br></pre></td></tr></table></figure>

<ul>
<li>kubelet使用的IP地址：<ul>
<li><code>ip route show</code> 命令中，可以知道机器的默认网卡，通常是 <code>eth0</code>，如 <strong><em>default via 172.21.0.1 dev <font color="blue" weight="500">eth0</font></em></strong></li>
<li><code>ip address</code> 命令中，可显示默认网卡的 IP 地址，Kubernetes 将使用此 IP 地址与集群内的其他节点通信，如 <code>172.17.216.80</code></li>
<li>所有节点上 Kubernetes 所使用的 IP 地址必须可以互通（无需 NAT 映射、无安全组或防火墙隔离）</li>
</ul>
</li>
</ul>
<h3 id="安装-docker-kubelet"><a href="#安装-docker-kubelet" class="headerlink" title="安装 docker / kubelet"></a>安装 docker / kubelet</h3><p><strong>注意事项：</strong></p>
<ul>
<li>任意节点 centos 版本为 7.6 或 7.7</li>
<li>任意节点 CPU 内核数量大于等于 2，且内存大于等于 4G</li>
<li>任意节点 hostname 不是 localhost，且不包含下划线、小数点、大写字母</li>
<li>任意节点都有固定的内网 IP 地址</li>
<li>任意节点都只有一个网卡，如果有特殊目的，我可以在完成 K8S 安装后再增加新的网卡</li>
<li>任意节点上 Kubelet使用的 IP 地址 可互通（无需 NAT 映射即可相互访问），且没有防火墙、安全组隔离</li>
<li>任意节点不会直接使用 docker run 或 docker-compose 运行容器</li>
</ul>
<p>使用 root 身份在所有节点执行如下代码，以安装软件：</p>
<ul>
<li>docker</li>
<li>nfs-utils</li>
<li>kubectl / kubeadm / kubelet</li>
</ul>
<p>install_kubelet.sh：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 master 节点和 worker 节点都要执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 docker</span></span><br><span class="line"><span class="comment"># 参考文档如下</span></span><br><span class="line"><span class="comment"># https://docs.docker.com/install/linux/docker-ce/centos/ </span></span><br><span class="line"><span class="comment"># https://docs.docker.com/install/linux/linux-postinstall/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载旧版本</span></span><br><span class="line">yum remove -y docker \</span><br><span class="line">docker-client \</span><br><span class="line">docker-client-latest \</span><br><span class="line">docker-common \</span><br><span class="line">docker-latest \</span><br><span class="line">docker-latest-logrotate \</span><br><span class="line">docker-logrotate \</span><br><span class="line">docker-selinux \</span><br><span class="line">docker-engine-selinux \</span><br><span class="line">docker-engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 yum repository</span></span><br><span class="line">yum install -y yum-utils \</span><br><span class="line">device-mapper-persistent-data \</span><br><span class="line">lvm2</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装并启动 docker</span></span><br><span class="line">yum install -y docker-ce-18.09.7 docker-ce-cli-18.09.7 containerd.io</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 nfs-utils</span></span><br><span class="line"><span class="comment"># 必须先安装 nfs-utils 才能挂载 nfs 网络存储</span></span><br><span class="line">yum install -y nfs-utils</span><br><span class="line">yum install -y wget</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 SeLinux</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 swap</span></span><br><span class="line">swapoff -a</span><br><span class="line">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class="line">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># 如果有配置，则修改</span></span><br><span class="line">sed -i <span class="string">"s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g"</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">"s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g"</span>  /etc/sysctl.conf</span><br><span class="line">sed -i <span class="string">"s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g"</span>  /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 可能没有，追加</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.ipv4.ip_forward = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.bridge.bridge-nf-call-ip6tables = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"net.bridge.bridge-nf-call-iptables = 1"</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 执行命令以应用</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置K8S的yum源</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载旧版本</span></span><br><span class="line">yum remove -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装kubelet、kubeadm、kubectl</span></span><br><span class="line">yum install -y kubelet-1.16.2 kubeadm-1.16.2 kubectl-1.16.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改docker Cgroup Driver为systemd</span></span><br><span class="line"><span class="comment"># # 将/usr/lib/systemd/system/docker.service文件中的这一行 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span></span><br><span class="line"><span class="comment"># # 修改为 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd</span></span><br><span class="line"><span class="comment"># 如果不修改，在添加 worker 节点时可能会碰到如下错误</span></span><br><span class="line"><span class="comment"># [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd".</span></span><br><span class="line"><span class="comment"># Please follow the guide at https://kubernetes.io/docs/setup/cri/</span></span><br><span class="line">sed -i <span class="string">"s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g"</span> /usr/lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 docker 镜像，提高 docker 镜像下载速度和稳定性</span></span><br><span class="line"><span class="comment"># 如果您访问 https://hub.docker.io 速度非常稳定，亦可以跳过这个步骤</span></span><br><span class="line">curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 docker，并启动 kubelet</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line"></span><br><span class="line">docker version</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果此时执行 service status kubelet 命令，将得到 kubelet 启动失败的错误提示，请忽略此错误，因为必须完成后续步骤中 kubeadm init 的操作，kubelet 才能正常启动</p>
</blockquote>
<h3 id="初始化API-Server"><a href="#初始化API-Server" class="headerlink" title="初始化API Server"></a>初始化API Server</h3><p>创建 ApiServer 的 Load Balancer（私网）</p>
<ul>
<li>监听端口：6443 / TCP</li>
<li>后端资源组：包含 demo-master-a-1, demo-master-a-2, demo-master-a-3</li>
<li>后端端口：6443</li>
<li>开启 按源地址保持会话</li>
<li>假设完成创建以后，Load Balancer的 ip 地址为 x.x.x.x</li>
</ul>
<blockquote>
<p>根据每个人实际的情况不同，实现 LoadBalancer 的方式不一样，本文不详细阐述如何搭建 LoadBalancer，请读者自行解决，可以考虑的选择有：</p>
<ul>
<li>nginx</li>
<li>haproxy</li>
<li>keepalived</li>
<li>云供应商提供的负载均衡产品</li>
</ul>
</blockquote>
<h3 id="初始化第一个Master节点"><a href="#初始化第一个Master节点" class="headerlink" title="初始化第一个Master节点"></a>初始化第一个Master节点</h3><p><strong>注意事项：</strong></p>
<ul>
<li>以 root 身份在 demo-master-a-1 机器上执行</li>
<li>初始化 master 节点时，如果因为中间某些步骤的配置出错，想要重新初始化 master 节点，请先执行 <code>kubeadm reset</code> 操作</li>
<li>关于初始化时用到的环境变量<ul>
<li>APISERVER_NAME 不能是 master 的 hostname</li>
<li>APISERVER_NAME 必须全为小写字母、数字、小数点，不能包含减号</li>
<li>POD_SUBNET 所使用的网段不能与 master节点/worker节点 所在的网段重叠。该字段的取值为一个 CIDR 值，如果您对 CIDR 这个概念还不熟悉，请不要修改这个字段的取值 10.100.0.1/16</li>
</ul>
</li>
</ul>
<pre style="display:none;">
  <!--
    Aliyun 建议：
    Pod CIDR 172.20.0.0/16
    Service CIDR 172.21.0.0/20
    建议选择范围：
    Pod CIDR 10.0.0.0/8，172.16-31.0.0/12-16，192.168.0.0/16 
    Service CIDR 10.0.0.0/16-24，172.16-31.0.0/16-24，192.168.0.0/16-24 
    注意：不能与 VPC 及 VPC 内已有 Kubernetes 集群使用的网段重复
   -->
</pre>

<ul>
<li>执行以下脚本完成初始化集群</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在第一个 master 节点执行</span></span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为 您想要的 dnsName</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="comment"># Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span></span><br><span class="line"><span class="built_in">export</span> POD_SUBNET=10.100.0.1/16</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"127.0.0.1    <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行下面初始化脚本</span></span><br><span class="line">bash init_master.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本出错时终止执行</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;#POD_SUBNET&#125;</span> -eq 0 ] || [ <span class="variable">$&#123;#APISERVER_NAME&#125;</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\033[31;1m请确保您已经设置了环境变量 POD_SUBNET 和 APISERVER_NAME \033[0m"</span></span><br><span class="line">  <span class="built_in">echo</span> 当前POD_SUBNET=<span class="variable">$POD_SUBNET</span></span><br><span class="line">  <span class="built_in">echo</span> 当前APISERVER_NAME=<span class="variable">$APISERVER_NAME</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看完整配置选项 https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2</span></span><br><span class="line">rm -f ./kubeadm-config.yaml</span><br><span class="line">cat &lt;&lt;EOF &gt; ./kubeadm-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.16.2</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">controlPlaneEndpoint: <span class="string">"<span class="variable">$&#123;APISERVER_NAME&#125;</span>:6443"</span></span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: <span class="string">"10.96.0.0/16"</span></span><br><span class="line">  podSubnet: <span class="string">"<span class="variable">$&#123;POD_SUBNET&#125;</span>"</span></span><br><span class="line">  dnsDomain: <span class="string">"cluster.local"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubeadm init</span></span><br><span class="line"><span class="comment"># 根据您服务器网速的情况，您需要等候 3 - 10 分钟</span></span><br><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 kubectl</span></span><br><span class="line">rm -rf /root/.kube/</span><br><span class="line">mkdir /root/.kube/</span><br><span class="line">cp -i /etc/kubernetes/admin.conf /root/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 calico 网络插件</span></span><br><span class="line"><span class="comment"># 参考文档 https://docs.projectcalico.org/v3.9/getting-started/kubernetes/</span></span><br><span class="line">rm -f calico-3.9.2.yaml</span><br><span class="line">wget https://xinlichao.cn/resource/back-end/k8s/k8s-installation-kubeadm/calico-3.9.2.yaml-t -O calico-3.9.2.yaml</span><br><span class="line">sed -i <span class="string">"s#192\.168\.0\.0/16#<span class="variable">$&#123;POD_SUBNET&#125;</span>#"</span> calico-3.9.2.yaml</span><br><span class="line">kubectl apply -f calico-3.9.2.yaml</span><br></pre></td></tr></table></figure>

<p><strong>执行结果中：</strong></p>
<ul>
<li>第15、16、17行，用于初始化第二、三个 master 节点</li>
<li>第25、26行，用于初始化 worker 节点</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of the control-plane node running the following <span class="built_in">command</span> on each as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join apiserver.k8s:6443 --token 4z3r2v.2p43g28ons3b475v \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:959569cbaaf0cf3fad744f8bd8b798ea9e11eb1e568c15825355879cf4cdc5d6 \</span><br><span class="line">    --control-plane --certificate-key 41a741533a038a936759aff43b5680f0e8c41375614a873ea49fde8944614dd6</span><br><span class="line"></span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted <span class="keyword">in</span> two hours; If necessary, you can use </span><br><span class="line"><span class="string">"kubeadm init phase upload-certs --upload-certs"</span> to reload certs afterward.</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join apiserver.k8s:6443 --token 4z3r2v.2p43g28ons3b475v \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:959569cbaaf0cf3fad744f8bd8b798ea9e11eb1e568c15825355879cf4cdc5d6</span><br></pre></td></tr></table></figure>

<ul>
<li>检查 Master 初始化结果</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在第一个 master 节点执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span></span><br><span class="line">watch kubectl get pod -n kube-system -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 master 节点初始化结果</span></span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请等到所有容器组（大约9个）全部处于 Running 状态，才进行下一步</p>
</blockquote>
<h3 id="初始化第二、三个Master节点"><a href="#初始化第二、三个Master节点" class="headerlink" title="初始化第二、三个Master节点"></a>初始化第二、三个Master节点</h3><p><strong><em>获得 master 节点的 join 命令：</em></strong></p>
<p>可以和第一个Master节点一起初始化第二、三个Master节点，也可以从单Master节点调整过来，只需要</p>
<ul>
<li>增加Master的 LoadBalancer</li>
<li>将所有节点的 /etc/hosts 文件中 apiserver.demo 解析为 LoadBalancer 的地址</li>
<li>添加第二、三个Master节点</li>
<li>初始化 master 节点的 token 有效时间为 2 小时</li>
</ul>
<p><strong><em>在 demo-master-a-2 和 demo-master-a-3 机器上执行：</em></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在第二、三个 master 节点 demo-master-a-2 和 demo-master-a-3 执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 ApiServer LoadBalancer 的 IP 地址。如果还没有配置负载可以设置 demo-master-a-1 的ip（临时解决，生产建议用内网私有 LoadBalancer）</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_IP=x.x.x.x</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为 前面已经使用的 dnsName</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;APISERVER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="comment"># 使用前面步骤中获得的第二、三个 master 节点的 join 命令</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token ejwx62.vqwog6il5p83uk7y \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303 \</span><br><span class="line">--control-plane --certificate-key 70eb87e62f052d2d5de759969d5b42f372d0ad798f98df38f7fe73efdf63a13c</span><br></pre></td></tr></table></figure>

<p><strong><em>第一个Master节点初始化2个小时后再初始化：</em></strong></p>
<p>获得 certificate key</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 第一个 master 节点 demo-master-a-1 上执行</span></span><br><span class="line">kubeadm init phase upload-certs --upload-certs</span><br></pre></td></tr></table></figure>

<p>获得 join 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 第一个 master 节点 demo-master-a-1 上执行</span></span><br><span class="line">kubeadm token create --<span class="built_in">print</span>-join-command</span><br></pre></td></tr></table></figure>

<p>则，第二、三个 master 节点的 join 命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join apiserver.demo:6443 --token ejwx62.vqwog6il5p83uk7y \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303 \ <span class="comment">#1</span></span><br><span class="line">--control-plane --certificate-key 70eb87e62f052d2d5de759969d5b42f372d0ad798f98df38f7fe73efdf63a13c <span class="comment">#2</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>命令行中，#1部分(第1、2行)来自于前面获得的 join 命令，#2部分(第3行)来自于前面获得的 certificate key</p>
</blockquote>
<p>如果一直停留在 pre-flight 状态，请在第二、三个节点上执行命令检查：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl -ik https://apiserver.demo:6443/version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Cache-Control: no-cache, private</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Date: Wed, 30 Oct 2019 08:13:39 GMT</span><br><span class="line">Content-Length: 263</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"major"</span>: <span class="string">"1"</span>,</span><br><span class="line">  <span class="string">"minor"</span>: <span class="string">"16"</span>,</span><br><span class="line">  <span class="string">"gitVersion"</span>: <span class="string">"v1.16.2"</span>,</span><br><span class="line">  <span class="string">"gitCommit"</span>: <span class="string">"2bd9643cee5b3b3a5ecbd3af49d09018f0773c77"</span>,</span><br><span class="line">  <span class="string">"gitTreeState"</span>: <span class="string">"clean"</span>,</span><br><span class="line">  <span class="string">"buildDate"</span>: <span class="string">"2019-09-18T14:27:17Z"</span>,</span><br><span class="line">  <span class="string">"goVersion"</span>: <span class="string">"go1.12.9"</span>,</span><br><span class="line">  <span class="string">"compiler"</span>: <span class="string">"gc"</span>,</span><br><span class="line">  <span class="string">"platform"</span>: <span class="string">"linux/amd64"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 否则，请您检查一下您的 Loadbalancer 是否设置正确</span></span><br></pre></td></tr></table></figure>

<p>检查 master 初始化结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在第一个 master 节点 demo-master-a-1 执行</span></span><br><span class="line"><span class="comment"># 查看 master 节点初始化结果</span></span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<h3 id="初始化-worker节点"><a href="#初始化-worker节点" class="headerlink" title="初始化 worker节点"></a>初始化 worker节点</h3><blockquote>
<p>针对所有的 worker 节点执行</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 worker 节点执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 ApiServer LoadBalancer 的 IP 地址</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=x.x.x.x</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>"</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换为前面 kubeadm token create --print-join-command 的输出结果</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure>

<p><strong><em>第一个Master节点初始化2个小时后再初始化：</em></strong></p>
<p>在第一个 master 节点 demo-master-a-1 节点执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在第一个 master 节点 demo-master-a-1 上执行</span></span><br><span class="line">kubeadm token create --<span class="built_in">print</span>-join-command</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可获取kubeadm join 命令及参数，如下所示</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该 token 的有效时间为 2 个小时，2小时内，您可以使用此 token 初始化任意数量的 worker 节点。</p>
</blockquote>
<h3 id="移除-worker-节点"><a href="#移除-worker-节点" class="headerlink" title="移除 worker 节点"></a>移除 worker 节点</h3><blockquote>
<p>在准备移除的 worker 节点上执行</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在第一个 master 节点 demo-master-a-1 上执行</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete node demo-worker-x-x</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>将 demo-worker-x-x 替换为要移除的 worker 节点的名字</li>
<li>worker 节点的名字可以通过在第一个 master 节点 demo-master-a-1 上执行 <code>kubectl get nodes</code> 命令获得</li>
</ul>
</blockquote>
<h3 id="安装-Ingress-Controller"><a href="#安装-Ingress-Controller" class="headerlink" title="安装 Ingress Controller"></a>安装 Ingress Controller</h3><p>kubernetes支持多种Ingress Controllers (traefik / Kong / Istio / Nginx 等)，推荐使用 <a href="https://github.com/nginxinc/kubernetes-ingress" target="_blank" rel="noopener">https://github.com/nginxinc/kubernetes-ingress</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在第一个 master 节点 demo-master-a-1 上执行</span></span><br><span class="line">kubectl apply -f nginx-ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">kubectl delete -f nginx-ingress.yaml</span><br></pre></td></tr></table></figure>

<p>nginx-ingress.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果打算用于生产环境，请参考 https://github.com/nginxinc/kubernetes-ingress/blob/v1.5.5/docs/installation.md 并根据您自己的情况做进一步定制</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-ingress</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-server-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-ingress</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2akNDQWFZQ0NRREFPRjl0THNhWFhEQU5CZ2txaGtpRzl3MEJBUXNGQURBaE1SOHdIUVlEVlFRRERCWk8KUjBsT1dFbHVaM0psYzNORGIyNTBjbTlzYkdWeU1CNFhEVEU0TURreE1qRTRNRE16TlZvWERUSXpNRGt4TVRFNApNRE16TlZvd0lURWZNQjBHQTFVRUF3d1dUa2RKVGxoSmJtZHlaWE56UTI5dWRISnZiR3hsY2pDQ0FTSXdEUVlKCktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUwvN2hIUEtFWGRMdjNyaUM3QlBrMTNpWkt5eTlyQ08KR2xZUXYyK2EzUDF0azIrS3YwVGF5aGRCbDRrcnNUcTZzZm8vWUk1Y2Vhbkw4WGM3U1pyQkVRYm9EN2REbWs1Qgo4eDZLS2xHWU5IWlg0Rm5UZ0VPaStlM2ptTFFxRlBSY1kzVnNPazFFeUZBL0JnWlJVbkNHZUtGeERSN0tQdGhyCmtqSXVuektURXUyaDU4Tlp0S21ScUJHdDEwcTNRYzhZT3ExM2FnbmovUWRjc0ZYYTJnMjB1K1lYZDdoZ3krZksKWk4vVUkxQUQ0YzZyM1lma1ZWUmVHd1lxQVp1WXN2V0RKbW1GNWRwdEMzN011cDBPRUxVTExSakZJOTZXNXIwSAo1TmdPc25NWFJNV1hYVlpiNWRxT3R0SmRtS3FhZ25TZ1JQQVpQN2MwQjFQU2FqYzZjNGZRVXpNQ0F3RUFBVEFOCkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQWpLb2tRdGRPcEsrTzhibWVPc3lySmdJSXJycVFVY2ZOUitjb0hZVUoKdGhrYnhITFMzR3VBTWI5dm15VExPY2xxeC9aYzJPblEwMEJCLzlTb0swcitFZ1U2UlVrRWtWcitTTFA3NTdUWgozZWI4dmdPdEduMS9ienM3bzNBaS9kclkrcUI5Q2k1S3lPc3FHTG1US2xFaUtOYkcyR1ZyTWxjS0ZYQU80YTY3Cklnc1hzYktNbTQwV1U3cG9mcGltU1ZmaXFSdkV5YmN3N0NYODF6cFErUyt1eHRYK2VBZ3V0NHh3VlI5d2IyVXYKelhuZk9HbWhWNThDd1dIQnNKa0kxNXhaa2VUWXdSN0diaEFMSkZUUkk3dkhvQXprTWIzbjAxQjQyWjNrN3RXNQpJUDFmTlpIOFUvOWxiUHNoT21FRFZkdjF5ZytVRVJxbStGSis2R0oxeFJGcGZnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdi91RWM4b1JkMHUvZXVJTHNFK1RYZUprckxMMnNJNGFWaEMvYjVyYy9XMlRiNHEvClJOcktGMEdYaVN1eE9ycXgrajlnamx4NXFjdnhkenRKbXNFUkJ1Z1B0ME9hVGtIekhvb3FVWmcwZGxmZ1dkT0EKUTZMNTdlT1l0Q29VOUZ4amRXdzZUVVRJVUQ4R0JsRlNjSVo0b1hFTkhzbysyR3VTTWk2Zk1wTVM3YUhudzFtMApxWkdvRWEzWFNyZEJ6eGc2clhkcUNlUDlCMXl3VmRyYURiUzc1aGQzdUdETDU4cGszOVFqVUFQaHpxdmRoK1JWClZGNGJCaW9CbTVpeTlZTW1hWVhsMm0wTGZzeTZuUTRRdFFzdEdNVWozcGJtdlFmazJBNnljeGRFeFpkZFZsdmwKMm82MjBsMllxcHFDZEtCRThCay90elFIVTlKcU56cHpoOUJUTXdJREFRQUJBb0lCQVFDZklHbXowOHhRVmorNwpLZnZJUXQwQ0YzR2MxNld6eDhVNml4MHg4Mm15d1kxUUNlL3BzWE9LZlRxT1h1SENyUlp5TnUvZ2IvUUQ4bUFOCmxOMjRZTWl0TWRJODg5TEZoTkp3QU5OODJDeTczckM5bzVvUDlkazAvYzRIbjAzSkVYNzZ5QjgzQm9rR1FvYksKMjhMNk0rdHUzUmFqNjd6Vmc2d2szaEhrU0pXSzBwV1YrSjdrUkRWYmhDYUZhNk5nMUZNRWxhTlozVDhhUUtyQgpDUDNDeEFTdjYxWTk5TEI4KzNXWVFIK3NYaTVGM01pYVNBZ1BkQUk3WEh1dXFET1lvMU5PL0JoSGt1aVg2QnRtCnorNTZud2pZMy8yUytSRmNBc3JMTnIwMDJZZi9oY0IraVlDNzVWYmcydVd6WTY3TWdOTGQ5VW9RU3BDRkYrVm4KM0cyUnhybnhBb0dCQU40U3M0ZVlPU2huMVpQQjdhTUZsY0k2RHR2S2ErTGZTTXFyY2pOZjJlSEpZNnhubmxKdgpGenpGL2RiVWVTbWxSekR0WkdlcXZXaHFISy9iTjIyeWJhOU1WMDlRQ0JFTk5jNmtWajJTVHpUWkJVbEx4QzYrCk93Z0wyZHhKendWelU0VC84ajdHalRUN05BZVpFS2FvRHFyRG5BYWkyaW5oZU1JVWZHRXFGKzJyQW9HQkFOMVAKK0tZL0lsS3RWRzRKSklQNzBjUis3RmpyeXJpY05iWCtQVzUvOXFHaWxnY2grZ3l4b25BWlBpd2NpeDN3QVpGdwpaZC96ZFB2aTBkWEppc1BSZjRMazg5b2pCUmpiRmRmc2l5UmJYbyt3TFU4NUhRU2NGMnN5aUFPaTVBRHdVU0FkCm45YWFweUNweEFkREtERHdObit3ZFhtaTZ0OHRpSFRkK3RoVDhkaVpBb0dCQUt6Wis1bG9OOTBtYlF4VVh5YUwKMjFSUm9tMGJjcndsTmVCaWNFSmlzaEhYa2xpSVVxZ3hSZklNM2hhUVRUcklKZENFaHFsV01aV0xPb2I2NTNyZgo3aFlMSXM1ZUtka3o0aFRVdnpldm9TMHVXcm9CV2xOVHlGanIrSWhKZnZUc0hpOGdsU3FkbXgySkJhZUFVWUNXCndNdlQ4NmNLclNyNkQrZG8wS05FZzFsL0FvR0FlMkFVdHVFbFNqLzBmRzgrV3hHc1RFV1JqclRNUzRSUjhRWXQKeXdjdFA4aDZxTGxKUTRCWGxQU05rMXZLTmtOUkxIb2pZT2pCQTViYjhibXNVU1BlV09NNENoaFJ4QnlHbmR2eAphYkJDRkFwY0IvbEg4d1R0alVZYlN5T294ZGt5OEp0ek90ajJhS0FiZHd6NlArWDZDODhjZmxYVFo5MWpYL3RMCjF3TmRKS2tDZ1lCbyt0UzB5TzJ2SWFmK2UwSkN5TGhzVDQ5cTN3Zis2QWVqWGx2WDJ1VnRYejN5QTZnbXo5aCsKcDNlK2JMRUxwb3B0WFhNdUFRR0xhUkcrYlNNcjR5dERYbE5ZSndUeThXczNKY3dlSTdqZVp2b0ZpbmNvVlVIMwphdmxoTUVCRGYxSjltSDB5cDBwWUNaS2ROdHNvZEZtQktzVEtQMjJhTmtsVVhCS3gyZzR6cFE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-ingress</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">server-names-hash-bucket-size:</span> <span class="string">"1024"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"extensions"</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">k8s.nginx.org</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">virtualservers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">virtualserverroutes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-ingress</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">"9113"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-ingress</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nginx-ingress</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx/nginx-ingress:1.5.5</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">9113</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-nginx-configmaps=$(POD_NAMESPACE)/nginx-config</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-default-server-tls-secret=$(POD_NAMESPACE)/default-server-secret</span></span><br><span class="line">         <span class="comment">#- -v=3 # Enables extensive logging. Useful for troubleshooting.</span></span><br><span class="line">         <span class="comment">#- -report-ingress-status</span></span><br><span class="line">         <span class="comment">#- -external-service=nginx-ingress</span></span><br><span class="line">         <span class="comment">#- -enable-leader-election</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-enable-prometheus-metrics</span></span><br><span class="line">         <span class="comment">#- -enable-custom-resources</span></span><br></pre></td></tr></table></figure>

<h3 id="在-IaaS-层完成如下配置（公网Load-Balancer）"><a href="#在-IaaS-层完成如下配置（公网Load-Balancer）" class="headerlink" title="在 IaaS 层完成如下配置（公网Load Balancer）"></a>在 IaaS 层完成如下配置（公网Load Balancer）</h3><p>创建负载均衡 Load Balancer：</p>
<ul>
<li>监听器 1：80 / TCP， SOURCE_ADDRESS 会话保持</li>
<li>服务器资源池 1： demo-worker-x-x 的所有节点的 80端口</li>
<li>监听器 2：443 / TCP， SOURCE_ADDRESS 会话保持</li>
<li>服务器资源池 2： demo-worker-x-x 的所有节点的443端口</li>
</ul>
<p>假设刚创建的负载均衡 Load Balancer 的 IP 地址为： z.z.z.z</p>
<p><strong>配置域名解析：</strong></p>
<p>将域名 *.demo.yourdomain.com 解析到地址负载均衡服务器 的 IP 地址 z.z.z.z</p>
<blockquote>
<p>在浏览器访问 a.demo.yourdomain.com，将得到 404 NotFound 错误页面</p>
</blockquote>
<h2 id="安装-Kubectl"><a href="#安装-Kubectl" class="headerlink" title="安装 Kubectl"></a>安装 Kubectl</h2><p>日常工作中，您可能需要在自己的笔记本电脑上执行 kubectl 命令以管理远程 Linux 服务器上的 Kubernetes 集群。</p>
<h3 id="在客户端电脑安装-kubectl"><a href="#在客户端电脑安装-kubectl" class="headerlink" title="在客户端电脑安装 kubectl"></a>在客户端电脑安装 kubectl</h3><p>Kubernetes 官网文档参照 安装 <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener">kubectl</a> 安装时，经常会失败，因为国内访问 google 的镜像仓库存在问题。</p>
<h4 id="Mac-安装-kubectl"><a href="#Mac-安装-kubectl" class="headerlink" title="Mac 安装 kubectl"></a>Mac 安装 kubectl</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载最新的可执行文件</span></span><br><span class="line">curl -LO <span class="string">"https://storage.googleapis.com/kubernetes-release/release/<span class="variable">$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)</span>/bin/darwin/amd64/kubectl"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加可执行权限</span></span><br><span class="line">chmod +x ./kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制到 PATH 路径</span></span><br><span class="line">sudo mv ./kubectl /usr/<span class="built_in">local</span>/bin/kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查已安装版本</span></span><br><span class="line">kubectl version</span><br></pre></td></tr></table></figure>

<h4 id="Windows-安装-kubectl"><a href="#Windows-安装-kubectl" class="headerlink" title="Windows 安装 kubectl"></a>Windows 安装 kubectl</h4><ul>
<li>从下面的链接下载 kubectl 可执行文件</li>
</ul>
<p><a href="https://storage.googleapis.com/kubernetes-release/release/v1.16.2/bin/windows/amd64/kubectl.exe" target="_blank" rel="noopener">https://storage.googleapis.com/kubernetes-release/release/v1.16.2/bin/windows/amd64/kubectl.exe</a></p>
<blockquote>
<ul>
<li>请将其中的 v1.16.2 替换为最新的版本号</li>
<li>通过此链接可获取最新的版本号 <a href="https://storage.googleapis.com/kubernetes-release/release/stable.txt" target="_blank" rel="noopener">https://storage.googleapis.com/kubernetes-release/release/stable.txt</a></li>
</ul>
</blockquote>
<ul>
<li><p>将下载的可执行文件添加到 PATH 环境变量</p>
</li>
<li><p>执行命令查看已安装的 kubectl 版本号</p>
</li>
</ul>
<h4 id="Linux-安装-kubectl"><a href="#Linux-安装-kubectl" class="headerlink" title="Linux 安装 kubectl"></a>Linux 安装 kubectl</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置K8S的yum源</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum install -y kubectl</span><br></pre></td></tr></table></figure>

<h3 id="获取-kubectl-config-文件"><a href="#获取-kubectl-config-文件" class="headerlink" title="获取 kubectl config 文件"></a>获取 kubectl config 文件</h3><blockquote>
<p>请在 demo-master-a-1 节点上执行如下命令</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>

<p><strong>Linux 和 Mac：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将前面获得的 /etc/kubernetes/admin.conf 文件的内容粘贴进该文件并保存</span></span><br><span class="line">vim ~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 hosts, 将 x.x.x.x 替换成 demo-master-a-1 的实际 IP 地址</span></span><br><span class="line"><span class="comment"># 将 apiserver.demo 替换成前面获得 /etc/kubernetes/admin.conf 文件中 clusters/cluster/server 中 URL 里 host 对应的部分</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"x.x.x.x    apiserver.demo"</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证。 更多参考：https://kubernetes.io/docs/reference/kubectl/overview/</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个config（集群），合并配置</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">KUBECONFIG=config1:config2 kubectl config view --flatten &gt; <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看配置</span></span><br><span class="line">kubectl config view</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群</span></span><br><span class="line">kubectl config get-contexts</span><br><span class="line">kubectl config current-context</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换集群</span></span><br><span class="line">kubectl config use-context docker-for-desktop</span><br><span class="line">kubectl config use-context kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>

<p><strong>Windows：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用记事本（或其他文本编辑器）创建文件 ~/.kube/config，其中 ~ 代表当前的用户目录</span></span><br><span class="line"><span class="comment"># 将前面获得的 /etc/kubernetes/admin.conf 文件的内容粘贴进该文件并保存</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用记事本打开 C:\windows\System32\drivers\etc\hosts 文件（需要管理员权限），在该文件末尾添加一行记录：</span></span><br><span class="line">x.x.x.x    apiserver.demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 x.x.x.x 替换成 demo-master-a-1 的实际 IP 地址</span></span><br><span class="line"><span class="comment"># 将 apiserver.demo 替换成前面获得 /etc/kubernetes/admin.conf 文件中 clusters/cluster/server 中 URL 里 host 对应的部分</span></span><br></pre></td></tr></table></figure>

<h2 id="配置-Kubectl"><a href="#配置-Kubectl" class="headerlink" title="配置 Kubectl"></a>配置 Kubectl</h2><p><code>kubectl</code> 命令行工具从配置文件kubeconfig中查找用于调用 API Server 接口的信息：</p>
<ul>
<li>集群 cluster</li>
<li>用户 user</li>
<li>名称空间 namespace</li>
<li>认证机制 authentication mechanism</li>
</ul>
<blockquote>
<p>kubeconfig 并不是一个文件的名字，而是 kubectl 配置文件的统称</p>
</blockquote>
<p>默认情况下，<code>kubectl</code> 读取 <code>$HOME/.kube/config</code> 作为配置文件。您可以通过两种方式为 <code>kubectl</code> 指定配置文件：</p>
<ul>
<li>环境变量 <code>KUBECONFIG</code></li>
<li>命令行参数 <code>--kubeconfig</code></li>
</ul>
<p>可以在一个或多个kubeconfig文件中配置多个集群的访问信息，并使用 <code>kubectl config use-context</code> 命令切换要访问哪个集群。本文描述了如何配置 kubectl 以访问多个集群。</p>
<blockquote>
<p>kubectl的版本号必须大于等于集群的版本号，执行命令 <code>kubectl version</code> 可查看 kubectl 版本</p>
</blockquote>
<h3 id="KUBECONFIG环境变量"><a href="#KUBECONFIG环境变量" class="headerlink" title="KUBECONFIG环境变量"></a>KUBECONFIG环境变量</h3><p>可以在 <code>KUBECONFIG</code> 环境变量中配置多个 kubeconfig 文件：</p>
<ul>
<li>在 Linux 和 MAC 中，使用英文冒号 <code>:</code> 分隔</li>
<li>在 Windows 中，使用英文分号 <code>;</code> 分隔</li>
</ul>
<p>当 <code>KUBECONFIG</code> 指定了多个 kubeconfig 文件时，kubectl会自动合并所有文件中的配置内容。您可以将每个集群的访问信息存储到一个文件中，并将该文件加入到 <code>KUBECONFIG</code> 环境变量中。</p>
<p><code>KUBECONFIG</code> 环境变量并不是必须配置的，如果该环境变量不存在， kubectl 将使用默认位置的 kubeconfig 文件，即 <code>$HOME/.kube/config</code>。</p>
<h3 id="kubeconfig文件的合并"><a href="#kubeconfig文件的合并" class="headerlink" title="kubeconfig文件的合并"></a>kubeconfig文件的合并</h3><p>前面提到，kubectl会自动合并 <code>KUBECONFIG</code> 指定的多个文件，执行以下指令，可以查看最终生效的结果：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config view</span><br></pre></td></tr></table></figure>

<p>合并时的规则如下：</p>
<ul>
<li>如果执行 kubectl 指令时，指定了 <code>--kubeconfig</code> 参数，则只使用该参数指定的 kubeconfig 文件，不会进行合并</li>
<li>否则，在指定了环境变量 <code>KUBECONFIG</code> 的情况下，该环境变量中的所有文件将被合并使用：<ul>
<li>对于不能正常解析的文件，提示错误信息</li>
<li>当执行 <code>kubectl config use-context</code> 指令后，在第一个文件中保存 <code>current-context</code> 字段</li>
<li>合并过程忽略冲突。例如：如果多个文件中都定义了 <code>red-user</code>，将只使用列表中第一个定义了 <code>red-user</code> 的内容，所有后面定义的 <code>red-user</code> 都将被忽略</li>
</ul>
</li>
<li>如果既没指定 <code>--kubeconfig</code> 参数，又没指定 <code>KUBECONFIG</code> 环境变量，则使用默认的配置文件 <code>$HOME/.kube/config</code>，此时也无需合并</li>
</ul>
<h3 id="切换当前访问的集群"><a href="#切换当前访问的集群" class="headerlink" title="切换当前访问的集群"></a>切换当前访问的集群</h3><p>当您通过 <code>KUBECONFIG</code> 环境变量指定了多个集群的访问配置文件时，执行 <code>kubectl config view</code> 指令，输出结果如下所示：</p>
<ul>
<li>其中 <code>contexts</code> 字段包含了多个访问集群的 <code>上下文</code>，每个上下文指定了一个 <code>name</code>，并指定了该 <code>上下文</code> 要访问的集群名称<code>cluster</code>，集群中的名称空间<code>namespace</code>，使用哪个用户去访问<code>user</code>。</li>
<li><code>current-context</code> 字段指定了当前生效的 <code>上下文</code></li>
</ul>
<figure class="highlight yaml"><figcaption><span>&#123;6,11,21,22&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">contexts:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">development</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">developer</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-frontend</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">development</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ramp</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">developer</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-ramp-up</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">development</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">storage</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">developer</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-storage</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">scratch</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">experimenter</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">exp-scratch</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">dev-frontend</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>执行 <code>kubectl config get-contexts</code> 命令，可以查看可用的 <code>上下文</code> 列表，其中第一列带 <code>*</code> 的为当前使用的 <code>上下文</code>。</p>
<p>执行 <code>kubectl config use-context dev-storage</code> 命令，可以切换到另外一个 <code>上下文</code></p>
<h2 id="安装-Kubernetes-Dashboard"><a href="#安装-Kubernetes-Dashboard" class="headerlink" title="安装 Kubernetes Dashboard"></a>安装 Kubernetes Dashboard</h2><p>Kubernetes Dashboard 是 Kubernetes 的官方 Web UI。使用 Kubernetes Dashboard，您可以：</p>
<ul>
<li>向 Kubernetes 集群部署容器化应用</li>
<li>诊断容器化应用的问题</li>
<li>管理集群的资源</li>
<li>查看集群上所运行的应用程序</li>
<li>创建、修改Kubernetes 上的资源（例如 Deployment、Job、DaemonSet等）</li>
<li>展示集群上发生的错误</li>
</ul>
<p>例如：您可以伸缩一个 Deployment、执行滚动更新、重启一个 Pod 或部署一个新的应用程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>

<h3 id="访问-Dashboard"><a href="#访问-Dashboard" class="headerlink" title="访问 Dashboard"></a>访问 Dashboard</h3><p>Kubernetes Dashboard 当前，只支持使用 Bearer Token登录。 由于 Kubernetes Dashboard 默认部署时，只配置了最低权限的 RBAC。因此，我们要创建一个名为 <code>admin-user</code> 的 ServiceAccount，再创建一个 ClusterRolebinding，将其绑定到 Kubernetes 集群中默认初始化的 <code>cluster-admin</code> 这个 ClusterRole。</p>
<blockquote>
<p>更多关于权限管理的信息，请参考 <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noopener">Using RBAC Authorization</a></p>
</blockquote>
<ul>
<li>创建 Service Account 和 ClusterRoleBinding</li>
</ul>
<p>使用 kubeadm 安装集群时，默认创建了 ClusterRole cluster-admin。此时我们可以直接为刚才的 ServiceAccount 创建 ClusterRoleBinding。</p>
<p>执行如下命令可创建 ServiceAccount 和 ClusterRoleBinding</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f k8s-dashboard-auth.yaml</span><br></pre></td></tr></table></figure>

<p><strong>k8s-dashboard-auth.yaml：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取 Bearer Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>执行 kubectl proxy 命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果在服务器运行，修改监听地址，并接收所有请求，让外网访问。</span></span><br><span class="line"><span class="comment"># kubectl proxy --address=0.0.0.0 --port=8001 --accept-hosts='^*$'</span></span><br></pre></td></tr></table></figure>

<p>您必须能够在自己的笔记本（工作电脑）上运行 kubectl 并访问您的集群。</p>
<p>访问路径：<a href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/" target="_blank" rel="noopener">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</a></p>
<blockquote>
<p>如需要使用 nodePort 或 Ingress 的方式访问 Kubernetes Dashboard 请配置正确的 https 证书，或者使用 Firefox 浏览器，并忽略 HTTPS 校验错误。</p>
</blockquote>
<p>将上一个步骤中获得的 Token 输入到登录界面中，点击 Sign in 按钮，完成登录</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="重启Kubernetes集群"><a href="#重启Kubernetes集群" class="headerlink" title="重启Kubernetes集群"></a>重启Kubernetes集群</h3><p>Kubernetes集群的设计目标是setup-and-run-forever，然而许多学习者使用自己笔记本上的虚拟机安装K8S集群用于学习，这就必然会出现反复重启集群所在虚拟机的情况。</p>
<p><strong>Worker节点不能启动：</strong></p>
<p>Master 节点的 IP 地址变化，导致 worker 节点不能启动。请重装集群，并确保所有节点都有固定内网 IP 地址。</p>
<p><strong>许多Pod一直Crash或不能正常访问：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>

<p>重启后会发现许多 Pod 不在 Running 状态，此时，请使用如下命令删除这些状态不正常的 Pod。通常，您的 Pod 如果是使用 Deployment、StatefulSet 等控制器创建的，kubernetes 将创建新的 Pod 作为替代，重新启动的 Pod 通常能够正常工作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod &lt;pod-name&gt; -n &lt;pod-namespece&gt;</span><br></pre></td></tr></table></figure>

<h3 id="为什么Kubernetes-Service不能ping"><a href="#为什么Kubernetes-Service不能ping" class="headerlink" title="为什么Kubernetes Service不能ping"></a>为什么Kubernetes Service不能ping</h3><h4 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h4><p><strong>Kubernetes Service 不能 ping</strong></p>
<p>例如可以执行 <code>nslookup</code> 命令，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@gateway-example-6f6f45cd6-px8bn eip]<span class="comment"># nslookup gateway-example</span></span><br><span class="line">Server:         10.96.0.10</span><br><span class="line">Address:        10.96.0.10<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:   gateway-example.example.svc.cluster.local</span><br><span class="line">Address: 10.105.141.232</span><br></pre></td></tr></table></figure>

<p>但是执行 <code>ping</code> 命令则会失败：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@gateway-example-6f6f45cd6-px8bn eip]<span class="comment"># ping gateway-example</span></span><br><span class="line">PING gateway-example.example.svc.cluster.local (10.105.141.232) 56(84) bytes of data.</span><br><span class="line">From 172.17.76.171 (172.17.76.171) icmp_seq=1 Time to live exceeded</span><br><span class="line">From 172.17.76.171 (172.17.76.171) icmp_seq=2 Time to live exceeded</span><br><span class="line">From 172.17.76.171 (172.17.76.171) icmp_seq=3 Time to live exceeded</span><br><span class="line">From 172.17.76.171 (172.17.76.171) icmp_seq=4 Time to live exceeded</span><br><span class="line">^C</span><br><span class="line">--- gateway-example.example.svc.cluster.local ping statistics ---</span><br><span class="line">4 packets transmitted, 0 received, +4 errors, 100% packet loss, time 3003ms</span><br></pre></td></tr></table></figure>

<p>执行 <code>curl</code> 命令会成功：(如果后端 Pod 正常)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gateway-example-6f6f45cd6-px8bn eip]<span class="comment"># curl gateway-example:9201</span></span><br><span class="line">&#123;<span class="string">"timestamp"</span>:<span class="string">"2019-11-29T15:29:39.515+0000"</span>,<span class="string">"path"</span>:<span class="string">"/"</span>,<span class="string">"status"</span>:404,<span class="string">"error"</span>:<span class="string">"Not Found"</span>,<span class="string">"message"</span>:null&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>telnet</code> 命令也可以成功：(如果后端 Pod 正常)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@gateway-example-6f6f45cd6-px8bn eip]<span class="comment"># telnet gateway-example 9201</span></span><br><span class="line">Trying 10.105.141.232...</span><br><span class="line">Connected to gateway-example.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br></pre></td></tr></table></figure>

<h4 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h4><p>在 Kubernetes 的网络中，Service 就是 ping 不通的。因为 Kubernetes 只是为 Service 生成了一个虚拟 IP 地址，实现的方式有：</p>
<ul>
<li><a href="/back-end/k8s/k8s-services-networking/#user-space-代理模式">User space 代理模式</a></li>
<li><a href="/back-end/k8s/k8s-services-networking/#iptables-代理模式">Iptables 代理模式</a></li>
<li><a href="/back-end/k8s/k8s-services-networking/#ipvs-代理模式">IPVS 代理模式</a></li>
</ul>
<p>不管是哪种代理模式，Kubernetes Service 的 IP 背后都没有任何实体可以响应「ICMP」，全称为 Internet 控制报文协议（Internet Control Message Protocol）。参考 <a href="https://www.jianshu.com/p/dc9de5038874" target="_blank" rel="noopener">每天都在用的Ping命令，它到底是什么？</a></p>
<p>通过 Service 访问 Pod 时的数据传递方式，可参考 <a href="/back-end/k8s/k8s-services-networking/#数据包的传递：service-to-pod">数据包的传递：Service-to-Pod</a></p>
<h3 id="为什么我不能获取到镜像，ImagePullBackoff"><a href="#为什么我不能获取到镜像，ImagePullBackoff" class="headerlink" title="为什么我不能获取到镜像，ImagePullBackoff"></a>为什么我不能获取到镜像，ImagePullBackoff</h3><blockquote>
<p>应用长时间处于 Pending 状态时，也可以按照这个办法查看镜像的下载进度。</p>
</blockquote>
<p>安装 Kubernetes 过程中，或者向 Kubernetes 部署应用的过程中，有可能会碰到 ImagePullBackoff 的问题。例如执行命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>

<p>结果如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NAME                                          READY   STATUS              RESTARTS   AGE</span><br><span class="line">coredns-94d74667-6dj45                        1&#x2F;1     ImagePullBackOff    0          12m</span><br><span class="line">coredns-94d74667-xv6wd                        1&#x2F;1     Pending             0          12m</span><br><span class="line">etcd-master                                   1&#x2F;1     Running             0          13m</span><br><span class="line">kube-apiserver-master                         1&#x2F;1     Running             0          13m</span><br><span class="line">kube-controller-manager-master                1&#x2F;1     Running             0          12m</span><br><span class="line">kube-flannel-ds-amd64-4wjcl                   1&#x2F;1     Running             0          12m</span><br><span class="line">kube-flannel-ds-amd64-9k28h                   1&#x2F;1     Running             0          12m</span><br><span class="line">kube-flannel-ds-amd64-pwkv5                   1&#x2F;1     Running             0          12m</span><br><span class="line">kube-proxy-qd6w7                              1&#x2F;1     Running             0          12m</span><br><span class="line">kube-scheduler-master                         1&#x2F;1     Running             0          12m</span><br></pre></td></tr></table></figure>

<p>碰到这个问题时，可按如下步骤解决：</p>
<ul>
<li><p>确定问题 Pod 所在节点，以 <code>kube-system</code> 名称空间下的 Pod <code>coredns-94d74667-6dj45</code> 为例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods coredns-94d74667-6dj45 -n kube-system -o wide</span><br></pre></td></tr></table></figure>

<p>输出结果如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-94d74667-6dj45   1&#x2F;1     Running   2          39d   10.244.0.40   master   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>从这个就结果中，我们得知，该 Pod 被调度到了 <code>master</code> 节点</p>
</li>
<li><p>确定 Pod 所使用的容器镜像：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods coredns-94d74667-6dj45 -n kube-system -o yaml | grep image:</span><br></pre></td></tr></table></figure>
<p>输出结果如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">image: registry.aliyuncs.com&#x2F;google_containers&#x2F;coredns:1.3.1</span><br><span class="line">image: registry.aliyuncs.com&#x2F;google_containers&#x2F;coredns:1.3.1</span><br></pre></td></tr></table></figure>
<p>从这个结果中，我们得知，该 Pod 使用到了容器镜像 <code>registry.aliyuncs.com/google_containers/coredns:1.3.1</code></p>
</li>
<li><p>在 Pod 所在节点执行 docker pull 指令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.aliyuncs.com/google_containers/coredns:1.3.1</span><br></pre></td></tr></table></figure>

<p>如果镜像标签没有问题，docker 指令将显示该镜像的下载过程，耐心等待即可。如果不能抓取 docker 镜像，请参考 Docker 命令的输出提示，做对应的处理。</p>
</li>
</ul>
<h3 id="修改NodePort的范围"><a href="#修改NodePort的范围" class="headerlink" title="修改NodePort的范围"></a>修改NodePort的范围</h3><p>在 Kubernetes 集群中，NodePort 默认范围是 30000-32767，某些情况下，因为您所在公司的网络策略限制，您可能需要修改 NodePort 的端口范围，本文描述了具体的操作方法。</p>
<h4 id="修改kube-apiserver-yaml"><a href="#修改kube-apiserver-yaml" class="headerlink" title="修改kube-apiserver.yaml"></a>修改kube-apiserver.yaml</h4><p>使用 kubeadm 安装 K8S 集群的情况下，您的 Master 节点上会有一个文件 <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>，修改此文件，向其中添加 <code>--service-node-port-range=20000-22767</code> （请使用您自己需要的端口范围），如下所示：</p>
<figure class="highlight yaml"><figcaption><span>&#123;38&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--advertise-address=172.17.216.80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--allow-privileged=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authorization-mode=Node,RBAC</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--enable-admission-plugins=NodeRestriction</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--enable-bootstrap-token-auth=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-servers=https://127.0.0.1:2379</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--insecure-port=0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-allowed-names=front-proxy-client</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-extra-headers-prefix=X-Remote-Extra-</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-group-headers=X-Remote-Group</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-username-headers=X-Remote-User</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--secure-port=6443</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-account-key-file=/etc/kubernetes/pki/sa.pub</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-cluster-ip-range=10.96.0.0/12</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-node-port-range=20000-22767</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.16.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">172.17</span><span class="number">.216</span><span class="number">.80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>

<h4 id="重启apiserver"><a href="#重启apiserver" class="headerlink" title="重启apiserver"></a>重启apiserver</h4><p>执行以下命令，重启 apiserver</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获得 apiserver 的 pod 名字</span></span><br><span class="line"><span class="built_in">export</span> apiserver_pods=$(kubectl get pods --selector=component=kube-apiserver -n kube-system --output=jsonpath=&#123;.items..metadata.name&#125;)</span><br><span class="line"><span class="comment"># 删除 apiserver 的 pod</span></span><br><span class="line">kubectl delete pod <span class="variable">$apiserver_pods</span> -n kube-system</span><br></pre></td></tr></table></figure>

<h4 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h4><p>执行以下命令，验证修改是否生效：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod <span class="variable">$apiserver_pods</span> -n kube-system</span><br></pre></td></tr></table></figure>
<p>输出结果如下所示：（此时，我们可以看到，apiserver 已经使用新的命令行参数启动）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Command:</span><br><span class="line">      kube-apiserver</span><br><span class="line">      --advertise-address&#x3D;172.17.216.80</span><br><span class="line">      --allow-privileged&#x3D;true</span><br><span class="line">      --authorization-mode&#x3D;Node,RBAC</span><br><span class="line">      --client-ca-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.crt</span><br><span class="line">      --enable-admission-plugins&#x3D;NodeRestriction</span><br><span class="line">      --enable-bootstrap-token-auth&#x3D;true</span><br><span class="line">      --etcd-cafile&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt</span><br><span class="line">      --etcd-certfile&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver-etcd-client.crt</span><br><span class="line">      --etcd-keyfile&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver-etcd-client.key</span><br><span class="line">      --etcd-servers&#x3D;https:&#x2F;&#x2F;127.0.0.1:2379</span><br><span class="line">      --insecure-port&#x3D;0</span><br><span class="line">      --kubelet-client-certificate&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver-kubelet-client.crt</span><br><span class="line">      --kubelet-client-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver-kubelet-client.key</span><br><span class="line">      --kubelet-preferred-address-types&#x3D;InternalIP,ExternalIP,Hostname</span><br><span class="line">      --proxy-client-cert-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-client.crt</span><br><span class="line">      --proxy-client-key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-client.key</span><br><span class="line">      --requestheader-allowed-names&#x3D;front-proxy-client</span><br><span class="line">      --requestheader-client-ca-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca.crt</span><br><span class="line">      --requestheader-extra-headers-prefix&#x3D;X-Remote-Extra-</span><br><span class="line">      --requestheader-group-headers&#x3D;X-Remote-Group</span><br><span class="line">      --requestheader-username-headers&#x3D;X-Remote-User</span><br><span class="line">      --secure-port&#x3D;6443</span><br><span class="line">      --service-account-key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;sa.pub</span><br><span class="line">      --service-cluster-ip-range&#x3D;10.96.0.0&#x2F;12</span><br><span class="line">      --service-node-port-range&#x3D;20000-22767</span><br><span class="line">      --tls-cert-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver.crt</span><br><span class="line">      --tls-private-key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;apiserver.key</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Mon, 11 Nov 2019 21:31:39 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        250m</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>::: tip 注意</p>
<ul>
<li>对于已经创建的NodePort类型的Service，您需要删除重新创建</li>
<li>如果您的集群有多个 Master 节点，您需要逐个修改每个节点上的  <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> 文件，并重启 apiserver<br>:::</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-linux/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-linux/</a></li>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></li>
<li><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</a></li>
<li><a href="https://kubernetes.io/zh/docs/reference/kubectl/overview/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/reference/kubectl/overview/</a></li>
<li><a href="https://kuboard.cn/" target="_blank" rel="noopener">https://kuboard.cn/</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/back-end/k8s/k8s-installation-minikube/" rel="prev" title="Minikube 部署 Kubernetes">
      <i class="fa fa-chevron-left"></i> Minikube 部署 Kubernetes
    </a></div>
      <div class="post-nav-item">
    <a href="/back-end/k8s/k8s-installation-source/" rel="next" title="Kubernetes 二进制高可用部署">
      Kubernetes 二进制高可用部署 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#kubeadm-方式部署"><span class="nav-number">1.</span> <span class="nav-text">kubeadm 方式部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubeadm-部署单Master节点"><span class="nav-number">2.</span> <span class="nav-text">kubeadm 部署单Master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#机器准备"><span class="nav-number">2.1.</span> <span class="nav-text">机器准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查所需端口"><span class="nav-number">2.2.</span> <span class="nav-text">检查所需端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查网络"><span class="nav-number">2.3.</span> <span class="nav-text">检查网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一键安装脚本"><span class="nav-number">2.4.</span> <span class="nav-text">一键安装脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化-master-节点"><span class="nav-number">2.5.</span> <span class="nav-text">初始化 master 节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化-worker-节点"><span class="nav-number">2.6.</span> <span class="nav-text">初始化 worker 节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装helm（kubeSphere准备工作）"><span class="nav-number">3.</span> <span class="nav-text">安装helm（kubeSphere准备工作）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-KubeSphere"><span class="nav-number">4.</span> <span class="nav-text">部署 KubeSphere</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在-Master-节点安装-kubeSphere"><span class="nav-number">4.1.</span> <span class="nav-text">在 Master 节点安装 kubeSphere</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-Kubernetes-集群-CA-证书的-Secret"><span class="nav-number">4.2.</span> <span class="nav-text">创建 Kubernetes 集群 CA 证书的 Secret</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建集群-etcd-的证书-Secret"><span class="nav-number">4.3.</span> <span class="nav-text">创建集群 etcd 的证书 Secret</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubeadm-部署高可用"><span class="nav-number">5.</span> <span class="nav-text">kubeadm 部署高可用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#检查-centos-hostname"><span class="nav-number">5.1.</span> <span class="nav-text">检查 centos &#x2F; hostname</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-docker-kubelet"><span class="nav-number">5.2.</span> <span class="nav-text">安装 docker &#x2F; kubelet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化API-Server"><span class="nav-number">5.3.</span> <span class="nav-text">初始化API Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化第一个Master节点"><span class="nav-number">5.4.</span> <span class="nav-text">初始化第一个Master节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化第二、三个Master节点"><span class="nav-number">5.5.</span> <span class="nav-text">初始化第二、三个Master节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化-worker节点"><span class="nav-number">5.6.</span> <span class="nav-text">初始化 worker节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#移除-worker-节点"><span class="nav-number">5.7.</span> <span class="nav-text">移除 worker 节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-Ingress-Controller"><span class="nav-number">5.8.</span> <span class="nav-text">安装 Ingress Controller</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在-IaaS-层完成如下配置（公网Load-Balancer）"><span class="nav-number">5.9.</span> <span class="nav-text">在 IaaS 层完成如下配置（公网Load Balancer）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-Kubectl"><span class="nav-number">6.</span> <span class="nav-text">安装 Kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在客户端电脑安装-kubectl"><span class="nav-number">6.1.</span> <span class="nav-text">在客户端电脑安装 kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Mac-安装-kubectl"><span class="nav-number">6.1.1.</span> <span class="nav-text">Mac 安装 kubectl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Windows-安装-kubectl"><span class="nav-number">6.1.2.</span> <span class="nav-text">Windows 安装 kubectl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux-安装-kubectl"><span class="nav-number">6.1.3.</span> <span class="nav-text">Linux 安装 kubectl</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取-kubectl-config-文件"><span class="nav-number">6.2.</span> <span class="nav-text">获取 kubectl config 文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-Kubectl"><span class="nav-number">7.</span> <span class="nav-text">配置 Kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#KUBECONFIG环境变量"><span class="nav-number">7.1.</span> <span class="nav-text">KUBECONFIG环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeconfig文件的合并"><span class="nav-number">7.2.</span> <span class="nav-text">kubeconfig文件的合并</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#切换当前访问的集群"><span class="nav-number">7.3.</span> <span class="nav-text">切换当前访问的集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-Kubernetes-Dashboard"><span class="nav-number">8.</span> <span class="nav-text">安装 Kubernetes Dashboard</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#访问-Dashboard"><span class="nav-number">8.1.</span> <span class="nav-text">访问 Dashboard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题"><span class="nav-number">9.</span> <span class="nav-text">问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重启Kubernetes集群"><span class="nav-number">9.1.</span> <span class="nav-text">重启Kubernetes集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么Kubernetes-Service不能ping"><span class="nav-number">9.2.</span> <span class="nav-text">为什么Kubernetes Service不能ping</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#现象"><span class="nav-number">9.2.1.</span> <span class="nav-text">现象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解释"><span class="nav-number">9.2.2.</span> <span class="nav-text">解释</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么我不能获取到镜像，ImagePullBackoff"><span class="nav-number">9.3.</span> <span class="nav-text">为什么我不能获取到镜像，ImagePullBackoff</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改NodePort的范围"><span class="nav-number">9.4.</span> <span class="nav-text">修改NodePort的范围</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改kube-apiserver-yaml"><span class="nav-number">9.4.1.</span> <span class="nav-text">修改kube-apiserver.yaml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重启apiserver"><span class="nav-number">9.4.2.</span> <span class="nav-text">重启apiserver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证结果"><span class="nav-number">9.4.3.</span> <span class="nav-text">验证结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">10.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Richard"
      src="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
  <p class="site-author-name" itemprop="name">Richard</p>
  <div class="site-description" itemprop="description">惶者生存，偏执者成功</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xinlc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/xinlc" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://learnxinyminutes.com/" title="https:&#x2F;&#x2F;learnxinyminutes.com" rel="noopener" target="_blank">Learn X in Y minutes</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://justjavac.com/" title="http:&#x2F;&#x2F;justjavac.com" rel="noopener" target="_blank">justjavac</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.ruanyifeng.com/blog/" title="http:&#x2F;&#x2F;www.ruanyifeng.com&#x2F;blog&#x2F;" rel="noopener" target="_blank">阮一峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.liaoxuefeng.com/" title="https:&#x2F;&#x2F;www.liaoxuefeng.com" rel="noopener" target="_blank">廖雪峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tech.meituan.com/" title="https:&#x2F;&#x2F;tech.meituan.com" rel="noopener" target="_blank">美团技术</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.v2ex.com/" title="https:&#x2F;&#x2F;www.v2ex.com" rel="noopener" target="_blank">V2EX</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://caniuse.com/" title="https:&#x2F;&#x2F;caniuse.com" rel="noopener" target="_blank">caniuse/工具</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.css88.com/nav/" title="http:&#x2F;&#x2F;www.css88.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">css88/doc</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://overapi.com/" title="http:&#x2F;&#x2F;overapi.com&#x2F;" rel="noopener" target="_blank">OverAPI/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://devdocs.io/" title="http:&#x2F;&#x2F;devdocs.io&#x2F;" rel="noopener" target="_blank">DevDocs/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.oschina.net/" title="http:&#x2F;&#x2F;tool.oschina.net&#x2F;" rel="noopener" target="_blank">在线工具/索引</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.lu/" title="http:&#x2F;&#x2F;tool.lu&#x2F;" rel="noopener" target="_blank">ToolBox</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://hao.shejidaren.com/" title="http:&#x2F;&#x2F;hao.shejidaren.com&#x2F;" rel="noopener" target="_blank">设计导航</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
