<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.lichao.xin","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"3ZZ8ITB7HE","apiKey":"062eb5a54afbcbf3f20452d58fc40035","indexName":"xinlc","hits":{"per_page":10},"labels":{"input_placeholder":"搜索","hits_empty":"未发现与「${query}」相关的内容","hits_stats":"${hits} 条相关条目，使用了 ${time} 毫秒"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="深入了解 ES 高级搜索、相关性评分、搜索建议、自动补全等。">
<meta property="og:type" content="article">
<meta property="og:title" content="重学 Elastic Stack 之 Elasticsearch 深入了解(一)">
<meta property="og:url" content="https://blog.lichao.xin/back-end/big-data/es-05/index.html">
<meta property="og:site_name" content="Richard Xin&#39;s Blog">
<meta property="og:description" content="深入了解 ES 高级搜索、相关性评分、搜索建议、自动补全等。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/1.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/2.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/3.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/4.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/5.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/6.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/7.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/8.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/9.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/10.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/11.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/12.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/13.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/14.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/15.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/16.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/17.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-05/18.jpg">
<meta property="article:published_time" content="2021-02-06T15:00:00.000Z">
<meta property="article:modified_time" content="2021-06-14T01:33:22.379Z">
<meta property="article:author" content="Richard">
<meta property="article:tag" content="Elastic Stack">
<meta property="article:tag" content="ES">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lichao.xin/images/big-data/es-05/1.jpg">

<link rel="canonical" href="https://blog.lichao.xin/back-end/big-data/es-05/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>重学 Elastic Stack 之 Elasticsearch 深入了解(一) | Richard Xin's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4530ac9d0bc4e258535c4a9b17029f0c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Richard Xin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Richard Xin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Quick notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">132</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">59</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.lichao.xin/back-end/big-data/es-05/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
      <meta itemprop="name" content="Richard">
      <meta itemprop="description" content="惶者生存，偏执者成功">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Richard Xin's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          重学 Elastic Stack 之 Elasticsearch 深入了解(一)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-06 15:00:00" itemprop="dateCreated datePublished" datetime="2021-02-06T15:00:00+00:00">2021-02-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-14 01:33:22" itemprop="dateModified" datetime="2021-06-14T01:33:22+00:00">2021-06-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BigData/" itemprop="url" rel="index"><span itemprop="name">BigData</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>深入了解 ES 高级搜索、相关性评分、搜索建议、自动补全等。</p>
<a id="more"></a>

<h2 id="基于词项和基于全文的搜索"><a href="#基于词项和基于全文的搜索" class="headerlink" title="基于词项和基于全文的搜索"></a>基于词项和基于全文的搜索</h2><h3 id="基于-Term-的查询"><a href="#基于-Term-的查询" class="headerlink" title="基于 Term 的查询"></a>基于 Term 的查询</h3><ul>
<li>Term 的 重要性<ul>
<li><strong>Term 是表达语意的最小单位</strong>。搜索和利用统计语言模型进行自然语言处理都需要处理 Term</li>
</ul>
</li>
<li>特点<ul>
<li>Term Level Query：Term Query / Range Query / Exists Query / Prefix Query / Wildcard Query</li>
<li>在 ES 中，Term 查询，对输入<strong>不做分词</strong>。会将输入作为一个整体，在倒排索引中查找准确的词项，并且使用相关度算分公式为每个包含该词项的文档进行<strong>相关度算分</strong> - 例如 “Apple Store”</li>
<li>可以通过 Constant Score 将查询转换换成一个 Filtering，<strong>避免算分，并利用缓存</strong>，提交性能</li>
</ul>
</li>
</ul>
<p><strong>Demo</strong> </p>
<ul>
<li>插入数据</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELETE products</span><br><span class="line">PUT products</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"number_of_shards"</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"productID"</span> : <span class="string">"XHDK-A-1293-#fJ3"</span>,<span class="attr">"desc"</span>:<span class="string">"iPhone"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"productID"</span> : <span class="string">"KDKE-B-9947-#kL5"</span>,<span class="attr">"desc"</span>:<span class="string">"iPad"</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span>: &#123; <span class="attr">"_id"</span>: <span class="number">3</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">"productID"</span> : <span class="string">"JODL-X-1937-#pV7"</span>,<span class="attr">"desc"</span>:<span class="string">"MBP"</span> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>查询</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多字段 Mapping 和 Term 查询</span></span><br><span class="line">GET /products/_mapping</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"desc"</span>: &#123;</span><br><span class="line">        <span class="comment">//"value": "iPhone"</span></span><br><span class="line">        <span class="attr">"value"</span>:<span class="string">"iphone"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"desc.keyword"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"iPhone"</span> <span class="comment">//查不到数据，term查询</span></span><br><span class="line">        <span class="comment">//"value":"iphone" // 查到数据 term查询会做分词</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"productID"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"XHDK-A-1293-#fJ3"</span>  <span class="comment">// 无结果</span></span><br><span class="line">        <span class="comment">// "value": "xhdk" //有一条数据</span></span><br><span class="line">        <span class="comment">// "value": "xhdk-a-1293-#fj3"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果对值进行查询</span></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//"explain": true,</span></span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"productID.keyword"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"XHDK-A-1293-#fJ3"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="复合查询-Constant-Score-转为-Filter"><a href="#复合查询-Constant-Score-转为-Filter" class="headerlink" title="复合查询 - Constant Score 转为 Filter"></a>复合查询 - Constant Score 转为 Filter</h3><ul>
<li>将 Query 转成 Filter，忽略 TF-IDF 计算，避免相关性算分的开销</li>
<li>Filter 可以有效利用缓存</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"productID.keyword"</span>: <span class="string">"XHDK-A-1293-#fJ3"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基于全文本的查询"><a href="#基于全文本的查询" class="headerlink" title="基于全文本的查询"></a>基于全文本的查询</h3><ul>
<li>基于全文本的查找<ul>
<li>Match Query / Match Phrase Query / Query String Query</li>
</ul>
</li>
<li>特点<ul>
<li>索引和搜索时会进行分词，查询字符串先传递到一个合适的分词器，然后生成一个供查询的词项列表</li>
<li>查询时候，先<strong>会对输入的查询进行分词</strong>。然后每个词项逐个进行底层的查询，最终将结果进行合并。并未每个文档生成一个算分。 例如查 “Martix reloaded”, 会查到包括 Matrix 或者 reload 的所有结果。</li>
</ul>
</li>
</ul>
<h4 id="Match-Query-Result"><a href="#Match-Query-Result" class="headerlink" title="Match Query Result"></a>Match Query Result</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>:&#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>:&#123;</span><br><span class="line">        <span class="attr">"query"</span>: <span class="string">"Matrix reloaded"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>:&#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>:&#123;</span><br><span class="line">        <span class="attr">"query"</span>: <span class="string">"Matrix reloaded"</span>,</span><br><span class="line">        <span class="attr">"operator"</span>: <span class="string">"AND"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Minimun-should-match"><a href="#Minimun-should-match" class="headerlink" title="Minimun_should_match"></a>Minimun_should_match</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>:<span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>:&#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>:&#123;</span><br><span class="line">        <span class="attr">"query"</span>: <span class="string">"Matrix reloaded"</span>,</span><br><span class="line">        <span class="attr">"minimum_should_match"</span>: <span class="number">2</span> </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Match-Phrase-Query"><a href="#Match-Phrase-Query" class="headerlink" title="Match Phrase Query"></a>Match Phrase Query</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>:<span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>:&#123;</span><br><span class="line">    <span class="attr">"match_phrase"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>:&#123;</span><br><span class="line">        <span class="attr">"query"</span>: <span class="string">"Matrix reloaded"</span>,</span><br><span class="line">        <span class="attr">"slop"</span>: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Match-Query-查询过程"><a href="#Match-Query-查询过程" class="headerlink" title="Match Query 查询过程"></a>Match Query 查询过程</h3><ul>
<li>基于全文本的查找<ul>
<li>Match Query / Match Phrase Query / Query String Query</li>
</ul>
</li>
<li>基于全文本的查询的特点<ul>
<li>索引和搜索时都会进行分词，查询字符串先传递到一个合适的分词器，然后生成一个供查询的词项列表</li>
<li>查询会对每个词项逐个进行底层的查询，再将结果进行合并，并未每个文档生成一个算分</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-05/1.jpg" alt="1"></p>
<p><strong>小结</strong></p>
<ul>
<li>基于词项的查找 vs 基于全文的查找</li>
<li>通过字段 Mapping 控制字段的分词<ul>
<li>“Text” vs “Keyword”</li>
</ul>
</li>
<li>通过参数控制查询的 Precision &amp; Recall</li>
<li>复合查询<ul>
<li>即使是对 Keyword 进行 Term 查询，同样会进行算分</li>
<li>可以将查询转为 Filtering，取消相关性算分的环节，以提高性能</li>
</ul>
</li>
</ul>
<h2 id="结构化搜索"><a href="#结构化搜索" class="headerlink" title="结构化搜索"></a>结构化搜索</h2><ul>
<li>结构化搜索（Structured search） 是指对结构化数据的搜索<ul>
<li>日期，布尔类型和数字都是结构化</li>
</ul>
</li>
<li>文本也可以是结构化的<ul>
<li>如彩色笔可以有离散的颜色集合：红（red）、绿（green）、蓝（blue）</li>
<li>一个博客可能被标记了标签，例如，分布式（distributed）和搜索（search）</li>
<li>电商网站上的商品都有 UPCs（通用产品码 Universal Product Codes）或其他的唯一标识，它们都遵从严格规定的、结构化的格式</li>
</ul>
</li>
</ul>
<h3 id="ES-中的机构化搜索"><a href="#ES-中的机构化搜索" class="headerlink" title="ES 中的机构化搜索"></a>ES 中的机构化搜索</h3><ul>
<li>布尔、时间，日期和数字这类结构化数据：有精确的格式，我们可以对这些格式进行逻辑操作。包括比较数字或时间的范围，或判断两个值的大小</li>
<li>结构化的文本可以做到精确匹配或者部分匹配<ul>
<li>Term 查询 / Prefix 前缀查询</li>
</ul>
</li>
<li>结构化结构只有 “是” 或 “否” 两个值<ul>
<li>根据场景需要，可以决定结构化搜索是否需要打分</li>
</ul>
</li>
</ul>
<p><strong>Demo</strong> </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">DELETE products</span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"price"</span>:<span class="number">10</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"date"</span>:<span class="string">"2018-01-01"</span>,<span class="attr">"productID"</span>:<span class="string">"XHDK-A-1293-#fJ3"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"price"</span>:<span class="number">20</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"date"</span>:<span class="string">"2019-01-01"</span>,<span class="attr">"productID"</span>:<span class="string">"KDKE-B-9947-#kL5"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">3</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"price"</span>:<span class="number">30</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"productID"</span>:<span class="string">"JODL-X-1937-#pV7"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">4</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"price"</span>:<span class="number">30</span>,<span class="attr">"avaliable"</span>:<span class="literal">false</span>,<span class="attr">"productID"</span>:<span class="string">"QQPX-R-3956-#aD8"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看mapping</span></span><br><span class="line">GET products/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"products"</span> : &#123;</span><br><span class="line">    <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"properties"</span> : &#123;</span><br><span class="line">        <span class="attr">"avaliable"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"boolean"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"date"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"date"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"price"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"productID"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对布尔值 match 查询，有算分</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"avaliable"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对布尔值，通过 constant score 转成 filtering，没有算分</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"avaliable"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"boost"</span>: <span class="number">1.2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>数字类型 Term</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"price"</span>: <span class="number">30</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"boost"</span>: <span class="number">1.2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>数字类型 terms</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"terms"</span>: &#123;</span><br><span class="line">          <span class="attr">"price"</span>: [</span><br><span class="line">              <span class="string">"20"</span>,</span><br><span class="line">              <span class="string">"30"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>数字 Range 查询<ul>
<li>gt 大于</li>
<li>lt 小于</li>
<li>gte 大于等于</li>
<li>lte 小于等于</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"range"</span>: &#123;</span><br><span class="line">          <span class="attr">"price"</span>: &#123;</span><br><span class="line">             <span class="attr">"gte"</span>: <span class="number">20</span>,</span><br><span class="line">             <span class="attr">"lte"</span>:<span class="number">30</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>日期 range<ul>
<li>Date Match Expressions</li>
<li><code>2020-01-01 00:00:00 || +1M</code></li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-05/2.jpg" alt="2"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line">  <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">    <span class="attr">"filter"</span>: &#123;</span><br><span class="line">      <span class="attr">"range"</span>: &#123;</span><br><span class="line">        <span class="attr">"date"</span>: &#123;</span><br><span class="line">           <span class="attr">"gte"</span>: <span class="string">"now-1y"</span>  <span class="comment">//当前时间减1年</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>exists 查询 - 非空查询</li>
</ul>
<p>类似于SQL：<code>IS NOT NULL</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span> : &#123;</span><br><span class="line">        <span class="attr">"constant_score"</span> : &#123;</span><br><span class="line">            <span class="attr">"filter"</span> : &#123;</span><br><span class="line">                <span class="attr">"exists"</span>: &#123;</span><br><span class="line">                    <span class="attr">"field"</span>:<span class="string">"date"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似于SQL：<code>IS NULL</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">		<span class="attr">"bool"</span>: &#123;</span><br><span class="line">			<span class="attr">"must_not"</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="attr">"exists"</span>: &#123;</span><br><span class="line">						<span class="attr">"field"</span>: <span class="string">"date"</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			]</span><br><span class="line">		&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>字符类型 terms</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"terms"</span>: &#123;</span><br><span class="line">          <span class="attr">"productID.keyword"</span>: [</span><br><span class="line">            <span class="string">"QQPX-R-3956-#aD8"</span>,</span><br><span class="line">            <span class="string">"JODL-X-1937-#pV7"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>处理多值字段</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /movies/_bulk</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title"</span>:<span class="string">"Father of the Bridge Part II"</span>,<span class="attr">"year"</span>:<span class="number">1995</span>,<span class="attr">"genre"</span>:<span class="string">"Comedy"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title"</span>:<span class="string">"Dave"</span>,<span class="attr">"year"</span>:<span class="number">1993</span>,<span class="attr">"genre"</span>:[<span class="string">"Comedy"</span>,<span class="string">"Romance"</span>]&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>处理多值字段，term 查询是包含，而不是等于</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回2条数据</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"constant_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"genre.keyword"</span>: <span class="string">"Comedy"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Match 跟 term 对比</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"date"</span>: <span class="string">"2019-01-01"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"date"</span>: <span class="string">"2019-01-01"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>小结</strong></p>
<ul>
<li>机构化数据 &amp; 结构化搜索<ul>
<li>如果不需要算分，可以通过 Constant Score ，将查询转为 Filterng</li>
</ul>
</li>
<li>范围查询 和 Date Match</li>
<li>使用 Exist 查询处理非空 NULL 值</li>
<li>精确值 &amp; 多值字段的精确值查找<ul>
<li>Term 查询是包含，不是完全相等。针对多值字段查询要尤其注意</li>
</ul>
</li>
</ul>
<p><strong>什么时候用 term 跟 match</strong></p>
<blockquote>
<p>结构化数据的精确匹配，就使用 term 查询。日期属于结构化数据。match 主要用于文本的 full-text 查询</p>
</blockquote>
<h2 id="搜索的相关性算分"><a href="#搜索的相关性算分" class="headerlink" title="搜索的相关性算分"></a>搜索的相关性算分</h2><p>ES 对查询关键字和索引文档的相关度进行打分，得分高的就排在前边。</p>
<ul>
<li>相关性 - Relevance<ul>
<li>搜索的相关性算分，描述了一个文档和查询语句匹配的程度。ES 会对每个匹配查询条件的结构进行算分_score</li>
<li>打分的本质是排序 , 需要把最符合用户需求的文档排在前面。ES 5 之前，默认的相关性打分采用 TF-IDF，现在采用 BM25</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">词（Term）</th>
<th align="center">文档（Doc ID)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">区块链</td>
<td align="center">1，2，3</td>
</tr>
<tr>
<td align="center">的</td>
<td align="center">2，3，4，5，6，7，8</td>
</tr>
<tr>
<td align="center">应用</td>
<td align="center">2，3，8，9，10</td>
</tr>
</tbody></table>
<h3 id="词频-TF"><a href="#词频-TF" class="headerlink" title="词频 TF"></a>词频 TF</h3><ul>
<li>Term Frequency∶ 检索词在一篇文档中出现的频率<ul>
<li>检索词出现的次数除以文档的总字数</li>
</ul>
</li>
<li>度量一条查询和结果文档相关性的简单方法：简单将搜索中每一个 词的 TF 进行相加<ul>
<li>$ TF(区块链) + TF(的) + TF(应用) $</li>
</ul>
</li>
<li>Stop Word<ul>
<li>“的”在文档中出现了很多次，但是对贡献相关度几乎没有用处，不应该考虑他们的 TF</li>
</ul>
</li>
</ul>
<h3 id="逆文档频率-IDF"><a href="#逆文档频率-IDF" class="headerlink" title="逆文档频率 IDF"></a>逆文档频率 IDF</h3><ul>
<li><p>DF：检索词在所有文档中出现的频率</p>
<ul>
<li>“区块链” 在相对比较少的文档中出现</li>
<li>“应用” 在相对比较多的文档中出现</li>
<li>“Stop Word” 在大量的文档中出现</li>
</ul>
</li>
<li><p>Inverse Document Frequency：$ 简单说 = log（全部文档数 / 检索词出现过的文档总数）$</p>
</li>
<li><p>TF-IDF 本质上就是将 TF 求和变成了加权求和</p>
</li>
<li><p>$ TF(区块链) * IDF(区块链) + TF(的) * IDF(的) + TF(应用) *  IDF(应用) $</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">出现的文档数</th>
<th align="center">总文档数</th>
<th align="center">IDF</th>
</tr>
</thead>
<tbody><tr>
<td align="center">区块链</td>
<td align="center">200万</td>
<td align="center">10亿</td>
<td align="center">log(500) = 8.96</td>
</tr>
<tr>
<td align="center">的</td>
<td align="center">10亿</td>
<td align="center">10亿</td>
<td align="center">log(1) = 0</td>
</tr>
<tr>
<td align="center">应用</td>
<td align="center">5亿</td>
<td align="center">10亿</td>
<td align="center">log(2) = 1</td>
</tr>
</tbody></table>
<blockquote>
<p>这里 log 底数是 2</p>
</blockquote>
<h3 id="TF-IDF-的概念"><a href="#TF-IDF-的概念" class="headerlink" title="TF-IDF 的概念"></a>TF-IDF 的概念</h3><ul>
<li>TF-IDF 被公认为是信息检索领域最重要的发明</li>
<li>除了在信息检索，在文献分类和其他相关领域有着非常广泛的应用</li>
<li>IDF 的概念，最早是剑桥大学的”斯巴克.琼斯”提出<ul>
<li>1972年 一 “关键词特殊性的统计解释和它在文献检索中的应用”</li>
<li>但是没有从理论上解释 IDF应该是用 log（全部文档数 / 检索词出现过的文档总数），而不是其他函数。他也没有做进一步的研究</li>
</ul>
</li>
<li>1970，1980年代萨尔顿和罗宾逊，进行了进一步的证明和研究，并用香农信息论做了证明<ul>
<li><a href="http://www.staff.city.ac.uk/~sbrp622/papers/foundations_bm25_review.pdf" target="_blank" rel="noopener">http://www.staff.city.ac.uk/~sbrp622/papers/foundations_bm25_review.pdf</a></li>
</ul>
</li>
<li>现代搜索引擎，对 TF-IDF 进行了大量细微的优化</li>
</ul>
<h3 id="Lucene-中的-TF-IDF-评分公式"><a href="#Lucene-中的-TF-IDF-评分公式" class="headerlink" title="Lucene 中的 TF-IDF 评分公式"></a>Lucene 中的 TF-IDF 评分公式</h3><p><img src="/images/big-data/es-05/3.jpg" alt="3"></p>
<ul>
<li><strong>score(q,d)</strong> 是指查询输入Q和当前文档D的相关性得分；</li>
<li><strong>coord(q,d)</strong> 是协调因子，表示输入的Token被文档匹配到的比例；</li>
<li><strong>queryNorm(q)</strong> 是查询输入归一化因子，其作用是使最终的得分不至于太大，从而具有一定的可比性；</li>
<li><strong>tf(t,d)</strong> 表示输入的一个Token在文档中出现的频率，频率越高，得分越高；</li>
<li>*<em>idf(t) *</em> 表示输入的一个Token的频率级别，它具体的计算与当前文档无关，而是与索引中出现的频率相关，出现频率越低，说明这个词是个稀缺词，得分会越高；</li>
<li><strong>boost(t)</strong> 是查询时指定的权重；</li>
<li><strong>norm(t,d)</strong> 是指当前文档的Term数量的一个权重，文档越短，相关性越高。</li>
</ul>
<h3 id="BM25"><a href="#BM25" class="headerlink" title="BM25"></a>BM25</h3><p><img src="/images/big-data/es-05/4.jpg" alt="4"></p>
<ul>
<li>从 ES 5开始，默认算法改为 BM25；</li>
<li>和经典的 TF-ID F相比，当 TF无限增加时，BM 25 算分会趋于一个数值。</li>
</ul>
<h3 id="定制-Similarity"><a href="#定制-Similarity" class="headerlink" title="定制 Similarity"></a>定制 Similarity</h3><p><img src="/images/big-data/es-05/5.jpg" alt="5"></p>
<h3 id="通过-Explain-API-查看-TF-IDF"><a href="#通过-Explain-API-查看-TF-IDF" class="headerlink" title="通过 Explain API 查看 TF-IDF"></a>通过 Explain API 查看 TF-IDF</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT testscore/_bulk</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"content"</span>:<span class="string">"we use Elasticsearch to power the search"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"content"</span>:<span class="string">"we like elasticsearch"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">3</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"content"</span>:<span class="string">"The scoring of documents is caculated by the scoring formula"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">4</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"content"</span>:<span class="string">"you know, for search"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询</span></span><br><span class="line">POST /testscore/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">     <span class="comment">// "content":"you"</span></span><br><span class="line">      <span class="attr">"content"</span>: <span class="string">"elasticsearch"</span></span><br><span class="line">      <span class="comment">//"content":"the"</span></span><br><span class="line">      <span class="comment">//"content": "the elasticsearch"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Boosting-Relevance"><a href="#Boosting-Relevance" class="headerlink" title="Boosting Relevance"></a>Boosting Relevance</h3><ul>
<li>Boosting 是控制相关度的一种手段<ul>
<li>索引，字段或查询子条件</li>
</ul>
</li>
<li>参数 boost 的含义<ul>
<li>当 boost &gt; 1 时，打分的相关度相对性提高</li>
<li>当 0 &lt; boost &lt; 1 时，打分的权重相对性降低</li>
<li>当 boost &lt; 0 时，贡献度负分</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST testscore/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"boosting"</span> : &#123;</span><br><span class="line">      <span class="attr">"positive"</span> : &#123;</span><br><span class="line">        <span class="attr">"term"</span> : &#123;</span><br><span class="line">          <span class="attr">"content"</span> : <span class="string">"elasticsearch"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"negative"</span> : &#123;</span><br><span class="line">        <span class="attr">"term"</span> : &#123;</span><br><span class="line">          <span class="attr">"content"</span> : <span class="string">"like"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"negative_boost"</span> : <span class="number">0.2</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Query-amp-Filtering-与-多字符串多字段查询"><a href="#Query-amp-Filtering-与-多字符串多字段查询" class="headerlink" title="Query &amp; Filtering 与 多字符串多字段查询"></a>Query &amp; Filtering 与 多字符串多字段查询</h2><p><img src="/images/big-data/es-05/6.jpg" alt="6"></p>
<ul>
<li>高级搜索的功能：支持多项文本输入，针对多个字段进行搜索</li>
<li>搜索引擎一般也提供基于时间，价格等条件的过滤</li>
<li>在 ES 中，有 Query 和 Filter 两种 Context<ul>
<li>Query Context：相关性算分</li>
<li>Filter Context：不需要算分（Yes or No）, 可以利用 Cache 获得更好的性能</li>
</ul>
</li>
</ul>
<h3 id="条件组合"><a href="#条件组合" class="headerlink" title="条件组合"></a>条件组合</h3><ul>
<li>假设要搜索一本电影，包含了以下条件<ul>
<li>评论中包含了 Guitar ，用户打分高于 3 分，同时上映时间在 1993 到 2000 年之间</li>
</ul>
</li>
<li>这个搜索包含了 3 段逻辑，针对不同的字段<ul>
<li>评论字段中要包含 Guitar 、用户评论大于 3、上映时间日期在给定范围内</li>
</ul>
</li>
<li>同时包含这三个逻辑，并且有比较好的性能<ul>
<li>复合查询： bool Query</li>
</ul>
</li>
</ul>
<h3 id="bool-查询"><a href="#bool-查询" class="headerlink" title="bool 查询"></a>bool 查询</h3><ul>
<li>一个 bool 查询，是一个或者多个查询子句的组合<ul>
<li>总共包含 4 种子句，其中 2 种会影响算分，2 种不影响算分</li>
</ul>
</li>
<li>相关性并不只是全文本搜索的专利。也适合 yes | no 的子句，匹配的子句越多，相关性评分越高。如果多条查询子句被合并为一条复合查询语句，比如 bool 查询，则每个查询子句计算得出的评分会被合并到总的相关性评分中。</li>
</ul>
<p><img src="/images/big-data/es-05/7.jpg" alt="7"></p>
<h3 id="bool-查询语句"><a href="#bool-查询语句" class="headerlink" title="bool 查询语句"></a>bool 查询语句</h3><ul>
<li>子查询可以任意顺序出现</li>
<li>可以嵌套多个查询</li>
<li>如果你的 bool 查询中，没有 must 条件，should 中必须满足一条查询</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//插入数据</span></span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"price"</span>:<span class="number">10</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"date"</span>:<span class="string">"2018-01-01"</span>,<span class="attr">"productID"</span>:<span class="string">"XHDK-A-1293-#fJ3"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"price"</span>:<span class="number">20</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"date"</span>:<span class="string">"2019-01-01"</span>,<span class="attr">"productID"</span>:<span class="string">"KDKE-B-9947-#kL5"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">3</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"price"</span>:<span class="number">30</span>,<span class="attr">"avaliable"</span>:<span class="literal">true</span>,<span class="attr">"productID"</span>:<span class="string">"JODL-X-1937-#pV7"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">4</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"price"</span>:<span class="number">30</span>,<span class="attr">"avaliable"</span>:<span class="literal">false</span>,<span class="attr">"productID"</span>:<span class="string">"QQPX-R-3956-#aD8"</span>&#125;</span><br><span class="line"><span class="comment">//查询</span></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"price"</span>: <span class="string">"30"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span>: &#123;</span><br><span class="line">          <span class="attr">"avaliable"</span>: <span class="string">"true"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"must_not"</span>: &#123;</span><br><span class="line">        <span class="attr">"range"</span>: &#123;</span><br><span class="line">          <span class="attr">"price"</span>: &#123;</span><br><span class="line">            <span class="attr">"lte"</span>: <span class="number">10</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"productID.keyword"</span>: <span class="string">"JODL-X-1937-#pV7"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"term"</span>: &#123;</span><br><span class="line">            <span class="attr">"productID.keyword"</span>: <span class="string">"XHDK-A-1293-#fJ3"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"minimum_should_match"</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：ES中 同时使用 should 和 must 导致只有 must 生效</strong></p>
<blockquote>
<p>should 并不是 or 的关系</p>
</blockquote>
<p><strong>解决1：</strong></p>
<p>使用多个must嵌套查询 将should组成的bool查询包含在其中一个must查询中</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"bool"</span>: &#123;</span><br><span class="line">            <span class="attr">"should"</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">"match_phrase"</span>: &#123;</span><br><span class="line">                  <span class="attr">"title"</span>: <span class="string">"疫情期间"</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">"match_phrase"</span>: &#123;</span><br><span class="line">                  <span class="attr">"content"</span>: <span class="string">"疫情期间"</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"1"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"must_not"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"enabled"</span>: <span class="number">0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"highlight"</span>: &#123;</span><br><span class="line">    <span class="attr">"pre_tags"</span>: [</span><br><span class="line">      <span class="string">"&lt;font color='red'&gt;"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"post_tags"</span>: [</span><br><span class="line">      <span class="string">"&lt;/font&gt;"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"fields"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">"content"</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解决2：</strong></p>
<ul>
<li>minimum_should_match 设置为 1</li>
</ul>
<h3 id="如何解决结构化查询-“包含而不是相等”-的问题"><a href="#如何解决结构化查询-“包含而不是相等”-的问题" class="headerlink" title="如何解决结构化查询 - “包含而不是相等” 的问题"></a>如何解决结构化查询 - “包含而不是相等” 的问题</h3><p><img src="/images/big-data/es-05/8.jpg" alt="8"></p>
<p><strong>增加 count 字段，使用 bool 查询</strong></p>
<ul>
<li>从业务角度，按需改进 ES 数据模型</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">POST /newmovies/_bulk</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title"</span>:<span class="string">"Father of the Bridge Part II"</span>,<span class="attr">"year"</span>:<span class="number">1995</span>,<span class="attr">"genre"</span>:<span class="string">"Comedy"</span>,<span class="attr">"genre_count"</span>:<span class="number">1</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title"</span>:<span class="string">"Dave"</span>,<span class="attr">"year"</span>:<span class="number">1993</span>,<span class="attr">"genre"</span>:[<span class="string">"Comedy"</span>,<span class="string">"Romance"</span>],<span class="attr">"genre_count"</span>:<span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query Context - 影响算分</span></span><br><span class="line"><span class="comment">// must 有算分</span></span><br><span class="line">POST /newmovies/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line">  <span class="attr">"bool"</span>: &#123;</span><br><span class="line">    <span class="attr">"must"</span>: [</span><br><span class="line">      &#123;<span class="attr">"term"</span>: &#123;<span class="attr">"genre.keyword"</span>: &#123;<span class="attr">"value"</span>: <span class="string">"Comedy"</span>&#125;&#125;&#125;,</span><br><span class="line">      &#123;<span class="attr">"term"</span>: &#123;<span class="attr">"genre_count"</span>: &#123;<span class="attr">"value"</span>: <span class="number">1</span>&#125;&#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Filter Context - 不影响算分</span></span><br><span class="line"><span class="comment">// Filter。不参与算分，结果的score是0</span></span><br><span class="line">POST /newmovies/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line">  <span class="attr">"bool"</span>: &#123;</span><br><span class="line">    <span class="attr">"filter"</span>: [</span><br><span class="line">      &#123;<span class="attr">"term"</span>: &#123;<span class="attr">"genre.keyword"</span>: &#123;<span class="attr">"value"</span>: <span class="string">"Comedy"</span>&#125;&#125;&#125;,</span><br><span class="line">      &#123;<span class="attr">"term"</span>: &#123;<span class="attr">"genre_count"</span>: &#123;<span class="attr">"value"</span>: <span class="number">1</span>&#125;&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bool-嵌套"><a href="#bool-嵌套" class="headerlink" title="bool 嵌套"></a>bool 嵌套</h3><p><img src="/images/big-data/es-05/9.jpg" alt="9"></p>
<h3 id="查询语句的结构，会对相关度算分产生影响"><a href="#查询语句的结构，会对相关度算分产生影响" class="headerlink" title="查询语句的结构，会对相关度算分产生影响"></a>查询语句的结构，会对相关度算分产生影响</h3><ul>
<li>同一层级下的竞争字段，具有相同的权重</li>
<li>通过嵌套 bool 查询，可以改变对算分的影响</li>
</ul>
<p><img src="/images/big-data/es-05/10.jpg" alt="10"></p>
<h3 id="控制字段的-Boosting"><a href="#控制字段的-Boosting" class="headerlink" title="控制字段的 Boosting"></a>控制字段的 Boosting</h3><p><img src="/images/big-data/es-05/11.jpg" alt="11"></p>
<h3 id="Not-Quite-Not"><a href="#Not-Quite-Not" class="headerlink" title="Not Quite Not"></a>Not Quite Not</h3><p><img src="/images/big-data/es-05/12.jpg" alt="12"></p>
<h3 id="Boosting-Query"><a href="#Boosting-Query" class="headerlink" title="Boosting Query"></a>Boosting Query</h3><p><img src="/images/big-data/es-05/13.jpg" alt="13"></p>
<p><strong>小结</strong></p>
<ul>
<li>Query Context vs Filter Context</li>
<li>Bool Query - 更多的条件组合</li>
<li>查询结构与相关性算分</li>
<li>如何控制查询的精确度<ul>
<li>Boosting &amp; Boosting Query</li>
</ul>
</li>
</ul>
<h2 id="单字符串多字段查询：Dis-Max-Query"><a href="#单字符串多字段查询：Dis-Max-Query" class="headerlink" title="单字符串多字段查询：Dis Max Query"></a>单字符串多字段查询：Dis Max Query</h2><h3 id="单字符串查询"><a href="#单字符串查询" class="headerlink" title="单字符串查询"></a>单字符串查询</h3><ul>
<li>Google 只提供一个输入框，查询相关的多个字段</li>
<li>支持按照价格，时间等进行过虑</li>
</ul>
<p><strong>单字符串查询的实例</strong></p>
<ul>
<li>博客标题<ul>
<li>文档1中出现”Brown”</li>
</ul>
</li>
<li>博客内容<ul>
<li>文档1中出现了”Brown”</li>
<li>“Brown fox”在文档 2中全部出现，并且保持和查询一致的顺序（目测相关性最高）</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">PUT /blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Quick brown rabbits"</span>,</span><br><span class="line">  <span class="attr">"body"</span>: <span class="string">"Brown rabbits are commonly seen."</span></span><br><span class="line">&#125;</span><br><span class="line">PUT /blogs/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Keeping pets healthy"</span>,</span><br><span class="line">  <span class="attr">"body"</span>: <span class="string">"My quick brown fox eats rabbits on a regular basis."</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//查询语句</span></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Brown fox"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"body"</span>: <span class="string">"Brown fox"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="算分过程"><a href="#算分过程" class="headerlink" title="算分过程"></a>算分过程</h4><ul>
<li>查询 should 语句中的两个查询</li>
<li>加和两个查询的评分</li>
<li>乘以匹配语句的总数</li>
<li>除以所有语句的总数</li>
</ul>
<h4 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">"hits" : &#123;</span><br><span class="line">    "total" : &#123;</span><br><span class="line">      "value" : 2,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    &#125;,</span><br><span class="line">    "max_score" : 0.90425634,</span><br><span class="line">    "hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"blogs"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">0.90425634</span>, <span class="comment">// 因为2个字段都有brown</span></span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"title"</span> : <span class="string">"Quick brown rabbits"</span>,</span><br><span class="line">          <span class="attr">"body"</span> : <span class="string">"Brown rabbits are commonly seen."</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"blogs"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">0.77041256</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"title"</span> : <span class="string">"Keeping pets healthy"</span>,</span><br><span class="line">          <span class="attr">"body"</span> : <span class="string">"My quick brown fox eats rabbits on a regular basis."</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/big-data/es-05/14.jpg" alt="14"> <img src="/images/big-data/es-05/15.jpg" alt="15"></p>
<h3 id="Disjunction-Max-Query-查询"><a href="#Disjunction-Max-Query-查询" class="headerlink" title="Disjunction Max Query 查询"></a>Disjunction Max Query 查询</h3><ul>
<li>上列中，title 和 body 相互竞争<ul>
<li>不应该将分数简单叠加，而是应该找个单个最佳匹配的字段的评分</li>
</ul>
</li>
<li>Disjunction Max Query<ul>
<li>将任何与任一查询匹配的文档作为结果返回。采用字段上最匹配的评分返回</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-05/16.jpg" alt="16"></p>
<h3 id="最佳字段查询调优"><a href="#最佳字段查询调优" class="headerlink" title="最佳字段查询调优"></a>最佳字段查询调优</h3><ul>
<li>有一些情况下，同时匹配 title 和 body 字段的文档比只与一个字段匹配的文档的相关度更高</li>
<li>但 disjunction max query 查询指挥简单的使用单个最佳匹配语句的评分_scoce 作为整体评分，怎么办？</li>
</ul>
<h3 id="通过-Tie-Breaker-参数调整"><a href="#通过-Tie-Breaker-参数调整" class="headerlink" title="通过 Tie Breaker 参数调整"></a>通过 Tie Breaker 参数调整</h3><ul>
<li>获得最佳匹配语句的评分 _score</li>
<li>将其他匹配语句的评分 与 tie_breaker 相乘</li>
<li>对以上评分求和并规范化<ul>
<li>Tie Breanker 是一个介于 0-1 之间的浮点数。0 代表使用最佳匹配；1 代表所有语句同等重要。</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line">  <span class="attr">"dis_max"</span>: &#123;</span><br><span class="line">      <span class="attr">"queries"</span>: [</span><br><span class="line">          &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"title"</span>: <span class="string">"Quick pets"</span> &#125;&#125;,</span><br><span class="line">          &#123; <span class="attr">"match"</span>: &#123; <span class="attr">"body"</span>:  <span class="string">"Quick pets"</span> &#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"tie_breaker"</span>: <span class="number">0.2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="单字符串多字段查询-Multi-Match"><a href="#单字符串多字段查询-Multi-Match" class="headerlink" title="单字符串多字段查询: Multi Match"></a>单字符串多字段查询: Multi Match</h2><ul>
<li>最佳字段（Best Fields）<ul>
<li>当字段之间相互竞争，又相互关联。例如 title 和 body 这样的字段，评分来自最匹配字段</li>
</ul>
</li>
<li>多数字段（Most Fields）<ul>
<li>处理英文内容时：一种常见的手段是，在主字段（English Analyzer），抽取词干，加入同义词，以匹配更多的文档。相同的文本，加入子字段（Standard Analyzer），以提供更加精确的匹配。其他字段作为匹配文档提高性相关度的信号。匹配字段越多越好</li>
</ul>
</li>
<li>混合字段（Cross Field）<ul>
<li>对于某些实体，例如人名，地址，图书信息。需要在多个字段中确定信息，单个字段只能作为整体的一部分。希望在任何这些列出的字段中尽可能找出多的词</li>
</ul>
</li>
</ul>
<h3 id="Multi-Match-Query"><a href="#Multi-Match-Query" class="headerlink" title="Multi Match Query"></a>Multi Match Query</h3><ul>
<li>Best Fields 是默认类型，可不指定</li>
<li>Minimum should match 等参数可以传递到生成的 query 中</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"best_fields"</span>,</span><br><span class="line">      <span class="attr">"query"</span>: <span class="string">"Quick pets"</span>,</span><br><span class="line">      <span class="attr">"fields"</span>: [<span class="string">"title"</span>,<span class="string">"body"</span>],</span><br><span class="line">      <span class="attr">"tie_breaker"</span>: <span class="number">0.2</span>,</span><br><span class="line">      <span class="attr">"minimum_should_match"</span>: <span class="string">"20%"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>查询案例</strong></p>
<ul>
<li>英文分词器，导致精确度降低，时态信息丢失</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">PUT /titles</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>:&#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"analyzer"</span>: <span class="string">"english"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST titles/_bulk</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title"</span>:<span class="string">"My dog barks"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title"</span>:<span class="string">"I see a lot of barking dogs on the road "</span>&#125;</span><br><span class="line"></span><br><span class="line">GET titles/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>: <span class="string">"barking dogs"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结果 因为是english 分词 ，且短 则 id 排第一个</span></span><br><span class="line">"hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"titles"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">0.24399278</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"title"</span> : <span class="string">"My dog barks"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"titles"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">0.1854345</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"title"</span> : <span class="string">"I see a lot of barking dogs on the road "</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<p><strong>重新设置 mapping</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">DELETE titles</span><br><span class="line">PUT /titles</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"title"</span>:&#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"analyzer"</span>: <span class="string">"english"</span>,</span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">          <span class="attr">"std"</span>:&#123;</span><br><span class="line">            <span class="attr">"type"</span>:<span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"analyzer"</span>:<span class="string">"standard"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">POST titles/_bulk</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title"</span>:<span class="string">"My dog barks"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;<span class="attr">"_id"</span>:<span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title"</span>:<span class="string">"I see a lot of barking dogs on the road "</span>&#125;</span><br><span class="line"><span class="comment">//multi_match 查询</span></span><br><span class="line">GET titles/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: <span class="string">"barking dogs"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"most_fields"</span>, <span class="comment">//默认是best_fields</span></span><br><span class="line">      <span class="attr">"fields"</span>: [<span class="string">"title"</span>,<span class="string">"title.std"</span>]<span class="comment">//累计叠加</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//返回</span></span><br><span class="line">"hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"titles"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">1.4569323</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"title"</span> : <span class="string">"I see a lot of barking dogs on the road "</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"titles"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">0.42221838</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"title"</span> : <span class="string">"My dog barks"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<h3 id="使用多字段匹配解决"><a href="#使用多字段匹配解决" class="headerlink" title="使用多字段匹配解决"></a>使用多字段匹配解决</h3><ul>
<li>用广度匹配字段 title 包括尽可能多的文档 - 以提高召回率 ，同时又使用字段 title.std 作为信息将相关度更高的文档结至于文档顶部</li>
<li>每个字段对于最终评分的贡献可以通过自定义值 boost 来控制。比如，使 title 字段更为重要，这样同时也降低了其他信号字段的作用</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET titles/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: <span class="string">"barking dogs"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"most_fields"</span>, </span><br><span class="line">      <span class="attr">"fields"</span>: [<span class="string">"title^10"</span>,<span class="string">"title.std"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="跨字段搜索"><a href="#跨字段搜索" class="headerlink" title="跨字段搜索"></a>跨字段搜索</h3><ul>
<li>most_fields 无法使用 opeartor<ul>
<li>可以用 copy_to 解决，但是需要额外的储存空间</li>
</ul>
</li>
<li>cross_fields 可以支持 operator<ul>
<li>与 copy_to 相比，其中一个优势就是可以在搜索时为某个字段提升权重</li>
</ul>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT address/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"street"</span>:<span class="string">"5 Poland Street"</span>,</span><br><span class="line">  <span class="attr">"city"</span> : <span class="string">"Lodon"</span>,</span><br><span class="line">  <span class="attr">"country"</span>:<span class="string">"United Kingdom"</span>,</span><br><span class="line">  <span class="attr">"postcode"</span> : <span class="string">"W1V 3DG"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST address/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>:&#123;</span><br><span class="line">    <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: <span class="string">"Poland Street W1V"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"cross_fields"</span>,  <span class="comment">//most_fields查询为空</span></span><br><span class="line">      <span class="attr">"operator"</span>: <span class="string">"and"</span>, </span><br><span class="line">      <span class="attr">"fields"</span>: [<span class="string">"street"</span>,<span class="string">"city"</span>,<span class="string">"country"</span>,<span class="string">"postcode"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">"hits" : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"address"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">0.8630463</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"street"</span> : <span class="string">"5 Poland Street"</span>,</span><br><span class="line">          <span class="attr">"city"</span> : <span class="string">"Lodon"</span>,</span><br><span class="line">          <span class="attr">"country"</span> : <span class="string">"United Kingdom"</span>,</span><br><span class="line">          <span class="attr">"postcode"</span> : <span class="string">"W1V 3DG"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<h2 id="多语言及中文分词与检索"><a href="#多语言及中文分词与检索" class="headerlink" title="多语言及中文分词与检索"></a>多语言及中文分词与检索</h2><h3 id="自然语言与查询-Recall"><a href="#自然语言与查询-Recall" class="headerlink" title="自然语言与查询 Recall"></a>自然语言与查询 Recall</h3><ul>
<li>当处理人类自然语言时，有些情况，尽管搜索和原文不完全匹配，但是希望搜到一些内容<ul>
<li>Quick brown fox 和 fast brown fox / Jumping fox 和 Jumped foxes</li>
</ul>
</li>
<li>一些可采取的优化<ul>
<li>归一化词元：清除变音符号，如 rÔle 的的时候 也会匹配 role</li>
<li>抽取词根：清除单复数和时态的差异</li>
<li>包含同义词</li>
<li>拼写错误：拼写错误，或者同音异形词</li>
</ul>
</li>
</ul>
<h3 id="混合多语言的挑战"><a href="#混合多语言的挑战" class="headerlink" title="混合多语言的挑战"></a>混合多语言的挑战</h3><ul>
<li>一些具体的多语言场景<ul>
<li>不同的索引使用不同的语言 / 同一索引中，不同的字段使用不同的语言 / 一个文档的一个字段内混合不同的语言</li>
</ul>
</li>
<li>混合语言存在的一些挑战<ul>
<li>词干提取：以色列文档，包含了希伯来语，阿拉伯语，俄语和英文</li>
<li>不争取的文档频率 - 英文为主的文章中，德文算分高（稀有）</li>
<li>需要判断用户搜索时使用的语言，语言识别（Compact Language Detecor）<ul>
<li>例如，根据语言查询不同的索引</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="分词的挑战"><a href="#分词的挑战" class="headerlink" title="分词的挑战"></a>分词的挑战</h3><ul>
<li>英文分词：You’re 分成一个还是多个？Half-baked</li>
<li>中文分词<ul>
<li>分词的标椎：哈工大标椎中，姓和名分开。HanLP 是在一起的。具体情况需制定不同的标椎</li>
<li>歧义（组合型歧义，交际型歧义，真歧义）<ul>
<li>中华人民共和国 / 美国会通过对台收武器法案 / 上海仁和服装厂</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="中文分词方法的演变-字典法"><a href="#中文分词方法的演变-字典法" class="headerlink" title="中文分词方法的演变 - 字典法"></a>中文分词方法的演变 - 字典法</h3><ul>
<li>查字典 - 最容易想到的分词方法（北京航空大学的梁南元教授提出）<ul>
<li>一个句子从左到到右扫描一遍。遇到有点词就标识出来。找到复合词，就找最长的</li>
<li>不认识的字符串就分割成单字词</li>
</ul>
</li>
<li>最小词数的分词理论 - 哈工大王晓龙博士吧查字典的方法理论化<ul>
<li>一句话应该分词数量最少的词串</li>
<li>遇到二义性的分割，无能为力（例如：“发展中国家”/“上海大学城书店”）</li>
<li>用各种文化规则来解决二义性，都并不成功</li>
</ul>
</li>
</ul>
<h3 id="中文分词方法的演变-基于统计法的机器学习算法"><a href="#中文分词方法的演变-基于统计法的机器学习算法" class="headerlink" title="中文分词方法的演变 - 基于统计法的机器学习算法"></a>中文分词方法的演变 - 基于统计法的机器学习算法</h3><ul>
<li>统计语言模型 - 1990 年前后 ，清华大学电子工程系郭进博士<ul>
<li>解决了二义性问题，将中文分词的错误率降低了一个数据级。概率问题，动态规划 + 利用维特比算法快速找到最佳分词</li>
</ul>
</li>
<li>基于统计的机器学习算法<ul>
<li>这类目前常用的算法是 HMM、CRF、SVM、深度学习算法等算法。比如 Hanlp 分词工具是基于 CRF 算法为例，基本思路是对汉字进行标注训练，不仅考虑了词语出现的频率，还考虑上下文，具有较好的学习能力，因此其对歧义词和未登录词的识别都具有良好的下效果</li>
<li>随着深度学习的兴起，也出现了基于神经网路的分词器，有人尝试使用双向 LSTM + CRF 实现分词器，其本质上是序列标注，据报道其分词器字符准确率可高达 97.5%</li>
</ul>
</li>
</ul>
<h3 id="中文分词器现状"><a href="#中文分词器现状" class="headerlink" title="中文分词器现状"></a>中文分词器现状</h3><ul>
<li>中文分词器以统计语言模型为基础，经过几十年的发展，今天基本已经可以看做是一个已经解决的问题</li>
<li>不同分词器的好坏，主要的差别在于数据的使用和工程使用的精度</li>
<li>常见的分词器都是使用机器学期算法和词典相结合，一方面能够提高分词准确率，另一方面能够改善领域适应性</li>
</ul>
<h3 id="一些分词工具"><a href="#一些分词工具" class="headerlink" title="一些分词工具"></a>一些分词工具</h3><ul>
<li>Elasticsearch IK分词插件 <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></li>
<li>Elasticsearch HanLP 分词插件 <a href="https://github.com/KennFalcon/elasticsearch-analysis-hanlp" target="_blank" rel="noopener">https://github.com/KennFalcon/elasticsearch-analysis-hanlp</a></li>
<li>中科院计算所NLPIR <a href="http://ictclas.nlpir.org/nlpir/" target="_blank" rel="noopener">http://ictclas.nlpir.org/nlpir/</a></li>
<li>ansj分词器 <a href="https://github.com/NLPchina/ansj_seg" target="_blank" rel="noopener">https://github.com/NLPchina/ansj_seg</a></li>
<li>哈工大的LTP <a href="https://github.com/HIT-SCIR/ltp" target="_blank" rel="noopener">https://github.com/HIT-SCIR/ltp</a></li>
<li>清华大学THULAC <a href="https://github.com/thunlp/THULAC" target="_blank" rel="noopener">https://github.com/thunlp/THULAC</a></li>
<li>斯坦福分词器 <a href="https://nlp.stanford.edu/software/segmenter.shtml" target="_blank" rel="noopener">https://nlp.stanford.edu/software/segmenter.shtml</a></li>
<li>Hanlp分词器 <a href="https://github.com/hankcs/HanLP" target="_blank" rel="noopener">https://github.com/hankcs/HanLP</a></li>
<li>结巴分词 <a href="https://github.com/yanyiwu/cppjieba" target="_blank" rel="noopener">https://github.com/yanyiwu/cppjieba</a></li>
<li>KCWS分词器(字嵌入+Bi-LSTM+CRF) <a href="https://github.com/koth/kcws" target="_blank" rel="noopener">https://github.com/koth/kcws</a></li>
<li>ZPar <a href="https://github.com/frcchang/zpar/releases" target="_blank" rel="noopener">https://github.com/frcchang/zpar/releases</a></li>
<li>IKAnalyzer <a href="https://github.com/wks/ik-analyzer" target="_blank" rel="noopener">https://github.com/wks/ik-analyzer</a></li>
</ul>
<h3 id="中文分词-DEMO"><a href="#中文分词-DEMO" class="headerlink" title="中文分词 DEMO"></a>中文分词 DEMO</h3><ul>
<li>使用不同分词器测试效果</li>
<li>索引时，尽量切分的短，查询的时候，尽量用长的词</li>
<li>拼音分词器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装插件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># IK Analysis - 支持字典热更新</span></span><br><span class="line">bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拼音</span></span><br><span class="line">bin/elasticsearch install https://github.com/medcl/elasticsearch-analysis-pinyin/releases/download/v7.1.0/elasticsearch-analysis-pinyin-7.1.0.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># HanLP - 支持加载远程字典</span></span><br><span class="line">bin/elasticsearch install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ik_max_word</span></span><br><span class="line"><span class="comment">// ik_smart</span></span><br><span class="line"><span class="comment">// hanlp: hanlp默认分词</span></span><br><span class="line"><span class="comment">// hanlp_standard: 标准分词</span></span><br><span class="line"><span class="comment">// hanlp_index: 索引分词</span></span><br><span class="line"><span class="comment">// hanlp_nlp: NLP分词</span></span><br><span class="line"><span class="comment">// hanlp_n_short: N-最短路分词</span></span><br><span class="line"><span class="comment">// hanlp_dijkstra: 最短路分词</span></span><br><span class="line"><span class="comment">// hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）</span></span><br><span class="line"><span class="comment">// hanlp_speed: 极速词典分词</span></span><br><span class="line"></span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"analyzer"</span>: <span class="string">"hanlp_standard"</span>,</span><br><span class="line">  <span class="attr">"text"</span>: [<span class="string">"剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜"</span>]</span><br><span class="line">&#125;     </span><br><span class="line"></span><br><span class="line"><span class="comment">// Pinyin</span></span><br><span class="line">PUT /artists/</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"settings"</span> : &#123;</span><br><span class="line">        <span class="attr">"analysis"</span> : &#123;</span><br><span class="line">            <span class="attr">"analyzer"</span> : &#123;</span><br><span class="line">                <span class="attr">"user_name_analyzer"</span> : &#123;</span><br><span class="line">                    <span class="attr">"tokenizer"</span> : <span class="string">"whitespace"</span>,</span><br><span class="line">                    <span class="attr">"filter"</span> : <span class="string">"pinyin_first_letter_and_full_pinyin_filter"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"filter"</span> : &#123;</span><br><span class="line">                <span class="attr">"pinyin_first_letter_and_full_pinyin_filter"</span> : &#123;</span><br><span class="line">                    <span class="attr">"type"</span> : <span class="string">"pinyin"</span>,</span><br><span class="line">                    <span class="attr">"keep_first_letter"</span> : <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">"keep_full_pinyin"</span> : <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">"keep_none_chinese"</span> : <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">"keep_original"</span> : <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">"limit_first_letter_length"</span> : <span class="number">16</span>,</span><br><span class="line">                    <span class="attr">"lowercase"</span> : <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">"trim_whitespace"</span> : <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">"keep_none_chinese_in_first_letter"</span> : <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /artists/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"text"</span>: [<span class="string">"刘德华 张学友 郭富城 黎明 四大天王"</span>],</span><br><span class="line">  <span class="attr">"analyzer"</span>: <span class="string">"user_name_analyzer"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">curl -XPOST http://localhost:9200/index/_mapping -H 'Content-Type:application/json' -d &#123;</span><br><span class="line">  "properties": &#123;</span><br><span class="line">    "content": &#123;</span><br><span class="line">      "type": "text",</span><br><span class="line">      "analyzer": "ik_max_word",</span><br><span class="line">      "search_analyzer" : "ik_smart"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试相关性一理解原理-＋-多分析-＋-多调整测试"><a href="#测试相关性一理解原理-＋-多分析-＋-多调整测试" class="headerlink" title="测试相关性一理解原理 ＋ 多分析 ＋ 多调整测试"></a>测试相关性一理解原理 ＋ 多分析 ＋ 多调整测试</h2><ul>
<li>技术分为道和术两种<ul>
<li>道 一 原理和原则</li>
<li>术 一 具体的做法，具体的解法</li>
</ul>
</li>
<li>关于搜索，为了有一个好的搜索结果。除了真正理解背后的原理，更需要多加实践与分析<ul>
<li>单纯追求”术”，会一直很辛苦。只有掌握了本质和精髓之”道”，做事才能游刃有余</li>
<li>要做好搜索，除了理解原理，也需要坚持去分析一些不好的搜索结果。只有通过一定时间的积累，<br>才能真正有所感觉</li>
<li>总希望一个模型，一个算法，就能毕其功于一役，是不现实的</li>
</ul>
</li>
</ul>
<h3 id="监控并且理解用户行为"><a href="#监控并且理解用户行为" class="headerlink" title="监控并且理解用户行为"></a>监控并且理解用户行为</h3><ul>
<li>不要过度调试相关度</li>
<li>而要监控搜索结果，监控用户点击最顶端结果的频次</li>
<li>将搜索结果提高到极高水平，唯一途径就是<ul>
<li>需要具有度量用户行为的强大能力</li>
<li>可以在后台实现统计数据，比如，用户的查询和结果，有多少被点击了</li>
<li>哪些搜索，没有返回结果</li>
</ul>
</li>
</ul>
<h2 id="使用-Search-Template-和-Index-Alias"><a href="#使用-Search-Template-和-Index-Alias" class="headerlink" title="使用 Search Template 和 Index Alias"></a>使用 Search Template 和 Index Alias</h2><h3 id="Search-Template-解耦程序-amp-搜索-DSL"><a href="#Search-Template-解耦程序-amp-搜索-DSL" class="headerlink" title="Search Template - 解耦程序 &amp; 搜索 DSL"></a>Search Template - 解耦程序 &amp; 搜索 DSL</h3><ul>
<li>Elasticsearch 的查询语句<ul>
<li>对相关性算分 / 查询性能都至关重要</li>
</ul>
</li>
<li>在开发初期，虽然可以明确查询参数，但是往往还不能最终定义查询的 DSL 的具体结构<ul>
<li>通过 Search Template 定义一个 Contract</li>
</ul>
</li>
<li>各司其职，解耦<ul>
<li>开发人员 / 搜索工程师 / 性能工程师</li>
</ul>
</li>
</ul>
<h3 id="使用-Search-Template-进行查询"><a href="#使用-Search-Template-进行查询" class="headerlink" title="使用 Search Template 进行查询"></a>使用 Search Template 进行查询</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">DELETE _scripts/tmdb</span><br><span class="line"><span class="comment">// 定义模板</span></span><br><span class="line">POST _scripts/tmdb</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"script"</span>: &#123;</span><br><span class="line">    <span class="attr">"lang"</span>: <span class="string">"mustache"</span>,</span><br><span class="line">    <span class="attr">"source"</span>: &#123;</span><br><span class="line">      <span class="attr">"_source"</span>: [</span><br><span class="line">        <span class="string">"title"</span>,<span class="string">"overview"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>: <span class="string">"&#123;&#123;q&#125;&#125;"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [<span class="string">"title"</span>,<span class="string">"overview"</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _scripts/tmdb</span><br><span class="line"></span><br><span class="line">POST tmdb/_search/template</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"id"</span>:<span class="string">"tmdb"</span>,</span><br><span class="line">    <span class="attr">"params"</span>: &#123;</span><br><span class="line">        <span class="attr">"q"</span>: <span class="string">"basketball with cartoon aliens"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Index-Alias-实现零停机运维"><a href="#使用-Index-Alias-实现零停机运维" class="headerlink" title="使用 Index Alias 实现零停机运维"></a>使用 Index Alias 实现零停机运维</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">PUT movies-2019/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>:<span class="string">"the matrix"</span>,</span><br><span class="line">  <span class="attr">"rating"</span>:<span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT movies-2019/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>:<span class="string">"Speed"</span>,</span><br><span class="line">  <span class="attr">"rating"</span>:<span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"actions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"add"</span>: &#123;</span><br><span class="line">        <span class="attr">"index"</span>: <span class="string">"movies-2019"</span>,</span><br><span class="line">        <span class="attr">"alias"</span>: <span class="string">"movies-latest"</span> <span class="comment">// 为索引创建个别名</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过别名读写数据</span></span><br><span class="line">POST movies-latest/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Alias-创建不同查询的视图"><a href="#使用-Alias-创建不同查询的视图" class="headerlink" title="使用 Alias 创建不同查询的视图"></a>使用 Alias 创建不同查询的视图</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"actions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"add"</span>: &#123;</span><br><span class="line">        <span class="attr">"index"</span>: <span class="string">"movies-2019"</span>,</span><br><span class="line">        <span class="attr">"alias"</span>: <span class="string">"movies-lastest-highrate"</span>,</span><br><span class="line">        <span class="attr">"filter"</span>: &#123;</span><br><span class="line">          <span class="attr">"range"</span>: &#123;</span><br><span class="line">            <span class="attr">"rating"</span>: &#123;</span><br><span class="line">              <span class="attr">"gte"</span>: <span class="number">4</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST movies-lastest-highrate/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="综合排序-Function-Score-Query-优化算分"><a href="#综合排序-Function-Score-Query-优化算分" class="headerlink" title="综合排序 Function Score Query 优化算分"></a>综合排序 Function Score Query 优化算分</h2><h3 id="算分与排序"><a href="#算分与排序" class="headerlink" title="算分与排序"></a>算分与排序</h3><ul>
<li>ES 默认会以文档的相关度算分进行排序</li>
<li>可以通过制定一个或者多个字段进行排序</li>
<li>使用相关性算分（score）排序，不能满足某些特定条件<ul>
<li>无法针对相关度，对排序实现更多的控制</li>
</ul>
</li>
</ul>
<h3 id="Function-Score-Query"><a href="#Function-Score-Query" class="headerlink" title="Function Score Query"></a>Function Score Query</h3><ul>
<li>Function Score Query<ul>
<li>可以在查询结束后，对每一个匹配的文档进行一系列的重新算分，根据新生成的分数进行排序</li>
</ul>
</li>
<li>提供了几种默认的计算分值的函数<ul>
<li>Weight：为每一个文档设置一个简单而不被规范化的权重</li>
<li>Field Value Factor：使用该数值来修改_score，例如将 “热度” 和 “点赞数” 作为算分的参考因素</li>
<li>Random Score：为每一个用户使用一个不同的，随机算分结果</li>
<li>衰减函数∶ 以某个字段的值为标准，距离某个值越近，得分越高</li>
<li>Script Score∶ 自定义脚本完全控制所需逻辑</li>
</ul>
</li>
</ul>
<h3 id="按受欢迎度提升权重"><a href="#按受欢迎度提升权重" class="headerlink" title="按受欢迎度提升权重"></a>按受欢迎度提升权重</h3><ul>
<li>希望能够将点赞多的 blog，放在搜索列表相对靠前的位置。同事搜索的评分，还是要作为排序的主要依据</li>
<li>新的算分 = 老的算分 * 投票数<ul>
<li>投票数为 0</li>
<li>投票数很大时</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">DELETE blogs</span><br><span class="line">PUT /blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:   <span class="string">"About popularity"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"In this post we will talk about..."</span>,</span><br><span class="line">  <span class="attr">"votes"</span>:   <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /blogs/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:   <span class="string">"About popularity"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"In this post we will talk about..."</span>,</span><br><span class="line">  <span class="attr">"votes"</span>:   <span class="number">100</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /blogs/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:   <span class="string">"About popularity"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"In this post we will talk about..."</span>,</span><br><span class="line">  <span class="attr">"votes"</span>:   <span class="number">1000000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>:    <span class="string">"popularity"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"content"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"votes"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Modifier-平滑曲线"><a href="#使用-Modifier-平滑曲线" class="headerlink" title="使用 Modifier 平滑曲线"></a>使用 Modifier 平滑曲线</h3><ul>
<li>新的算分 = 老的算分 * log（1 + 投票数）</li>
</ul>
<p><img src="/images/big-data/es-05/17.jpg" alt="17"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>:    <span class="string">"popularity"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"content"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"votes"</span>,</span><br><span class="line">        <span class="attr">"modifier"</span>: <span class="string">"log1p"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="引入-Factor"><a href="#引入-Factor" class="headerlink" title="引入 Factor"></a>引入 Factor</h3><ul>
<li>新的算分 = 老的算分 * log（1 + factor * 投票数）</li>
</ul>
<p><img src="/images/big-data/es-05/18.jpg" alt="18"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>:    <span class="string">"popularity"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"content"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"votes"</span>,</span><br><span class="line">        <span class="attr">"modifier"</span>: <span class="string">"log1p"</span> ,</span><br><span class="line">        <span class="attr">"factor"</span>: <span class="number">0.1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Boost-Mode-和-Max-Boost"><a href="#Boost-Mode-和-Max-Boost" class="headerlink" title="Boost Mode 和 Max Boost"></a>Boost Mode 和 Max Boost</h3><ul>
<li>Boost Mode<ul>
<li>Multiply：算分和函数值的乘积</li>
<li>Sum：算分和函数值的和</li>
<li>Min/Max：算分与函数去 最小 / 最大值</li>
<li>Replace：使用函数取代算分</li>
</ul>
</li>
<li>Max Boost 可以将算分控制在一个最大值</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span>: &#123;</span><br><span class="line">          <span class="attr">"query"</span>:    <span class="string">"popularity"</span>,</span><br><span class="line">          <span class="attr">"fields"</span>: [ <span class="string">"title"</span>, <span class="string">"content"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"votes"</span>,</span><br><span class="line">        <span class="attr">"modifier"</span>: <span class="string">"log1p"</span> ,</span><br><span class="line">        <span class="attr">"factor"</span>: <span class="number">0.1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"boost_mode"</span>: <span class="string">"sum"</span>,</span><br><span class="line">      <span class="attr">"max_boost"</span>: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一致性随机函数"><a href="#一致性随机函数" class="headerlink" title="一致性随机函数"></a>一致性随机函数</h3><ul>
<li>使用场景：网址的广告需要提高展示率</li>
<li>具体需求：让每个用户看到不同的随机排名，但是也希望同一个用户访问时，结果的相对顺序，保持一致（Consistently Random）</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">      <span class="attr">"random_score"</span>: &#123;</span><br><span class="line">        <span class="attr">"seed"</span>: <span class="number">911119</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Term-amp-Phrase-Suggester"><a href="#Term-amp-Phrase-Suggester" class="headerlink" title="Term &amp; Phrase Suggester"></a>Term &amp; Phrase Suggester</h2><h3 id="什么是搜索建议"><a href="#什么是搜索建议" class="headerlink" title="什么是搜索建议"></a>什么是搜索建议</h3><ul>
<li>现代的搜索引擎，一般都会提供 Suggest as you type 的功能</li>
<li>帮助用户在输入搜索的过程中，进行自动补全或者纠错。通过协助用户输入更加精准的关键词，提高后续搜索阶段文档匹配的程度</li>
<li>在 google 上搜索，一开始会自动补全。当输入到一定长度，如因为单词拼写错误无法补全，就会开始提示相似的词或者句子</li>
</ul>
<h3 id="Elasticsearch-Suggester-API"><a href="#Elasticsearch-Suggester-API" class="headerlink" title="Elasticsearch Suggester API"></a>Elasticsearch Suggester API</h3><ul>
<li>搜索引擎中类似的功能，在 ES 中通过 Sugester API 实现的</li>
<li>原理：将输入的文档分解为 Token，然后在索引的字段里查找相似的 Term 并返回</li>
<li>根据不同的使用场景，ES 设计了 4 种类别的 Suggesters<ul>
<li>Term &amp; Phrase Suggester</li>
<li>Complete &amp; Context Suggester</li>
</ul>
</li>
</ul>
<h3 id="Term-Suggester"><a href="#Term-Suggester" class="headerlink" title="Term Suggester"></a>Term Suggester</h3><ul>
<li>Suggester 就是一种特殊类型的搜索。“text” 里是调用时候提供的文本，通常来自用户界面上用户输入的内容</li>
<li>用户输入的 “lucen” 是一个错误的拼写</li>
<li>会到 指定的字段 “body” 上搜索，当无法搜索到结果时（missing），返回建议的词</li>
</ul>
<h3 id="Term-Suggester-Missing-Mode"><a href="#Term-Suggester-Missing-Mode" class="headerlink" title="Term Suggester - Missing Mode"></a>Term Suggester - Missing Mode</h3><ul>
<li>搜索 “lucen rock”：<ul>
<li>每个建议都包含了一个算分，相似性是通过 Levenshtein Edit Distance 的算法实现的。核心思想就是一个词改动多少字段就可以和另外一个词一致。提供了很多可选参数来控制相似性的模糊程度。</li>
</ul>
</li>
<li>几种 Suggestion Mode<ul>
<li>Missing - 如索引中已存在，就不提供建议</li>
<li>Popular - 推荐出现频率更加高的词</li>
<li>Always - 无论是否存在，都提供建议</li>
</ul>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//插入数据</span></span><br><span class="line">POST article/_bulk</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"body"</span>:<span class="string">"lucene is very cool"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"body"</span>:<span class="string">"Elasticsearch builds on top of lucene"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"body"</span>:<span class="string">"Elasticsearch rocks"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"body"</span>:<span class="string">"elastic is the company behind ELK stack"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"body"</span>:<span class="string">"Elk stack rocks"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"body"</span>:<span class="string">"elasticsearch is rock solid"</span>&#125;</span><br><span class="line"><span class="comment">//suggest</span></span><br><span class="line">POST article/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"body"</span>: <span class="string">"lucen rock"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"term-suggestion"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"lucen rock"</span>,</span><br><span class="line">      <span class="attr">"term"</span>: &#123;</span><br><span class="line">        <span class="attr">"suggest_mode"</span>: <span class="string">"missing"</span>, <span class="comment">// popular  always</span></span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"body"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//返回结果</span></span><br><span class="line">"suggest" : &#123;</span><br><span class="line">    "term-suggestion" : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"text"</span> : <span class="string">"lucen"</span>,</span><br><span class="line">        <span class="attr">"offset"</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"length"</span> : <span class="number">5</span>,</span><br><span class="line">        <span class="attr">"options"</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"text"</span> : <span class="string">"lucene"</span>,<span class="comment">//推荐了</span></span><br><span class="line">            <span class="attr">"score"</span> : <span class="number">0.8</span>,</span><br><span class="line">            <span class="attr">"freq"</span> : <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"text"</span> : <span class="string">"rock"</span>,<span class="comment">//没有推荐</span></span><br><span class="line">        <span class="attr">"offset"</span> : <span class="number">6</span>,</span><br><span class="line">        <span class="attr">"length"</span> : <span class="number">4</span>,</span><br><span class="line">        <span class="attr">"options"</span> : [ ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>默认使用 standard 分词器<ul>
<li>大写转小写</li>
<li>rocks 和 rock 是两个词</li>
</ul>
</li>
</ul>
<h3 id="Term-Suggester-Popuar-Mode"><a href="#Term-Suggester-Popuar-Mode" class="headerlink" title="Term Suggester - Popuar Mode"></a>Term Suggester - Popuar Mode</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">POST article/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"term-suggestion"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"lucen rock"</span>,</span><br><span class="line">      <span class="attr">"term"</span>: &#123;</span><br><span class="line">        <span class="attr">"suggest_mode"</span>: <span class="string">"popular"</span>,</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"body"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//返回</span></span><br><span class="line">"suggest" : &#123;</span><br><span class="line">    "term-suggestion" : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"text"</span> : <span class="string">"lucen"</span>,</span><br><span class="line">        <span class="attr">"offset"</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"length"</span> : <span class="number">5</span>,</span><br><span class="line">        <span class="attr">"options"</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"text"</span> : <span class="string">"lucene"</span>,</span><br><span class="line">            <span class="attr">"score"</span> : <span class="number">0.8</span>,</span><br><span class="line">            <span class="attr">"freq"</span> : <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"text"</span> : <span class="string">"rock"</span>,</span><br><span class="line">        <span class="attr">"offset"</span> : <span class="number">6</span>,</span><br><span class="line">        <span class="attr">"length"</span> : <span class="number">4</span>,</span><br><span class="line">        <span class="attr">"options"</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"text"</span> : <span class="string">"rocks"</span>,</span><br><span class="line">            <span class="attr">"score"</span> : <span class="number">0.75</span>,</span><br><span class="line">            <span class="attr">"freq"</span> : <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Sorting-by-Frequency-amp-PrefixLength"><a href="#Sorting-by-Frequency-amp-PrefixLength" class="headerlink" title="Sorting by Frequency &amp; PrefixLength"></a>Sorting by Frequency &amp; PrefixLength</h3><ul>
<li>默认按照 score 排序，也可以按照 “frequency”</li>
<li>默认首字母不一致就不会匹配推荐，但是如果将 prefix_length 设置为 0，就会为 hock 建议 rock</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /articles/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"term-suggestion"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"lucen hocks"</span>,</span><br><span class="line">      <span class="attr">"term"</span>: &#123;</span><br><span class="line">        <span class="attr">"suggest_mode"</span>: <span class="string">"always"</span>,</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"body"</span>,</span><br><span class="line">        <span class="attr">"prefix_length"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"sort"</span>: <span class="string">"frequency"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Phrase-Suggester"><a href="#Phrase-Suggester" class="headerlink" title="Phrase Suggester"></a>Phrase Suggester</h3><ul>
<li>Phrase Suggesetr 上增加了一些额外的逻辑<br>一些参数<ul>
<li>Suggeset Mode ： missing,popular ,always</li>
<li>Max Errors: 最多可以拼错的 Terms 数</li>
<li>Condfidence ： 限制返回结果数，默认为 1</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST /articles/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"my-suggestion"</span>: &#123;</span><br><span class="line">      <span class="attr">"text"</span>: <span class="string">"lucne and elasticsear rock hello world "</span>,</span><br><span class="line">      <span class="attr">"phrase"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"body"</span>,</span><br><span class="line">        <span class="attr">"max_errors"</span>:<span class="number">2</span>,</span><br><span class="line">        <span class="attr">"confidence"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"direct_generator"</span>:[&#123;</span><br><span class="line">          <span class="attr">"field"</span>:<span class="string">"body"</span>,</span><br><span class="line">          <span class="attr">"suggest_mode"</span>:<span class="string">"always"</span></span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="attr">"highlight"</span>: &#123;</span><br><span class="line">          <span class="attr">"pre_tag"</span>: <span class="string">"&lt;em&gt;"</span>,</span><br><span class="line">          <span class="attr">"post_tag"</span>: <span class="string">"&lt;/em&gt;"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自动补全与基于上下文的提示"><a href="#自动补全与基于上下文的提示" class="headerlink" title="自动补全与基于上下文的提示"></a>自动补全与基于上下文的提示</h2><h3 id="The-Completion-Suggester"><a href="#The-Completion-Suggester" class="headerlink" title="The Completion Suggester"></a>The Completion Suggester</h3><ul>
<li>Completion Suggester 提供了 “自动完成”（Auto Complete）的功能。用户每输入一个字符，就需要即时发送一个查询请求到后端查询匹配项</li>
<li>对性能要求比较苛刻。ES 采用了不同的数据结构，并非通过倒排索引来完成。而是将 Analyze 的数据编码成 FST 和索引一起存放。FST 会被 ES 整个加载进内存，速度很快</li>
<li>FST 只能用于前缀查找</li>
</ul>
<h3 id="使用-Completion-Suggester-一些步骤"><a href="#使用-Completion-Suggester-一些步骤" class="headerlink" title="使用 Completion Suggester 一些步骤"></a>使用 Completion Suggester 一些步骤</h3><ul>
<li>定义 Mapping，使用 “completion” type</li>
<li>索引数据</li>
<li>运行 “suggest” 查询，得到搜索建议</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义mapping</span></span><br><span class="line">PUT articles</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"title_completion"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"completion"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//写入数据</span></span><br><span class="line">POST articles/_bulk</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title_completion"</span>:<span class="string">"lucene is very cool"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title_completion"</span>:<span class="string">"Elasticsearch builds on top of lucene"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title_completion"</span>:<span class="string">"Elasticsearch rocks"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title_completion"</span>:<span class="string">"elastic is the company behind ELK stack"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line">&#123;<span class="attr">"title_completion"</span>:<span class="string">"Elk stack rocks"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"index"</span>:&#123;&#125;&#125;</span><br><span class="line"><span class="comment">//查询</span></span><br><span class="line">POST articles/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"article-suggest"</span>: &#123;</span><br><span class="line">      <span class="attr">"prefix"</span>: <span class="string">"e"</span>, <span class="comment">//查询字段 </span></span><br><span class="line">      <span class="attr">"completion"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"title_completion"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="什么是-Context-Suggester"><a href="#什么是-Context-Suggester" class="headerlink" title="什么是 Context Suggester"></a>什么是 Context Suggester</h3><ul>
<li>Completion Suggester 的扩展</li>
<li>可以在搜索中加入耕读偶读上下文信息，例如，输入 “star”<ul>
<li>咖啡相关：starbucks</li>
<li>电影相关：star wars</li>
</ul>
</li>
</ul>
<h3 id="实现-Context-Suggester"><a href="#实现-Context-Suggester" class="headerlink" title="实现 Context Suggester"></a>实现 Context Suggester</h3><ul>
<li>可以定义两种类型的 Context<ul>
<li>Category - 任意的字符串</li>
<li>Geo - 地理信息位置</li>
</ul>
</li>
<li>实现 Context Suggester<ul>
<li>定制一个 Mapping</li>
<li>索引数据，并且为每个文档加入 Conetxt 信息</li>
<li>结合 Context 进行 Suggestion 查询</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">DELETE comments</span><br><span class="line">PUT comments</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加 contexts type 和 name</span></span><br><span class="line">PUT comments/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>:&#123;</span><br><span class="line">    <span class="attr">"comment_autocomplete"</span>:&#123;</span><br><span class="line">      <span class="attr">"type"</span>:<span class="string">"completion"</span>,</span><br><span class="line">      <span class="attr">"contexts"</span>:[&#123;</span><br><span class="line">       <span class="attr">"type"</span>:<span class="string">"category"</span>,</span><br><span class="line">       <span class="attr">"name"</span>:<span class="string">"comment_category"</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 索引数据 设置不同的 category</span></span><br><span class="line">POST comments/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"comment"</span>: <span class="string">"I love the star war movies"</span>,</span><br><span class="line">  <span class="attr">"comment_autocomplete"</span>: &#123;</span><br><span class="line">    <span class="attr">"input"</span>: [<span class="string">"star wars"</span>],</span><br><span class="line">    <span class="attr">"contexts"</span>: &#123;</span><br><span class="line">      <span class="attr">"comment_category"</span>: <span class="string">"movies"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">POST comments/_doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"comment"</span>:<span class="string">"Where can I find a Starbucks"</span>,</span><br><span class="line">  <span class="attr">"comment_autocomplete"</span>:&#123;</span><br><span class="line">    <span class="attr">"input"</span>:[<span class="string">"starbucks"</span>],</span><br><span class="line">    <span class="attr">"contexts"</span>:&#123;</span><br><span class="line">      <span class="attr">"comment_category"</span>:<span class="string">"coffee"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">POST comments/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"suggest"</span>: &#123;</span><br><span class="line">    <span class="attr">"MY_SUGGESTION"</span>: &#123;</span><br><span class="line">      <span class="attr">"prefix"</span>: <span class="string">"sta"</span>,</span><br><span class="line">      <span class="attr">"completion"</span>:&#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"comment_autocomplete"</span>,</span><br><span class="line">        <span class="attr">"contexts"</span>:&#123;</span><br><span class="line">         <span class="attr">"comment_category"</span>:<span class="string">"movies"</span> </span><br><span class="line">        <span class="comment">//  "comment_category":"coffee"  </span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="精确度和召回率"><a href="#精确度和召回率" class="headerlink" title="精确度和召回率"></a>精确度和召回率</h3><ul>
<li>精准度<ul>
<li>Completion &gt; Phrase &gt; Term</li>
</ul>
</li>
<li>召回率<ul>
<li>Term &gt; Phrase &gt; Completion</li>
</ul>
</li>
<li>性能<ul>
<li>Completion &gt; Phrase &gt; Term</li>
</ul>
</li>
</ul>
<h2 id="跨集群搜索"><a href="#跨集群搜索" class="headerlink" title="跨集群搜索"></a>跨集群搜索</h2><h3 id="水平扩展的痛点"><a href="#水平扩展的痛点" class="headerlink" title="水平扩展的痛点"></a>水平扩展的痛点</h3><ul>
<li>单集群 - 当水平扩展时，节点数不能无限增加<ul>
<li>当集群的 meta 信息（节点，索引，集群状态）过多，会导致更新压力变大，单个 Active Master 会成为性能瓶颈，导致整个集群无法正常工作</li>
</ul>
</li>
<li>早起版本，通过 Tribe Node 可以实现多集群访问的需求，但是还存在一定的问题<ul>
<li>Tribe Node 会以 Client Node 的方式加入集群。集群中 Master 节点的任务变更需要 Tribe Node 的回应才能继续</li>
<li>Tribe Node 不保存 Cluster State 信息，一旦重启，初始化很慢</li>
<li>当多个集群存在索引重名的情况下，只能设置一种 Perfer 规则</li>
</ul>
</li>
</ul>
<h3 id="跨集群搜索-Cross-Cluster-Search"><a href="#跨集群搜索-Cross-Cluster-Search" class="headerlink" title="跨集群搜索 - Cross Cluster Search"></a>跨集群搜索 - Cross Cluster Search</h3><ul>
<li>早期 Tribe Node 的方案存在一定的问题，现已被 Deprecated</li>
<li>ES 5.3 引入跨集群搜索的功能（Cross Cluster Search），推荐使用<ul>
<li>允许任何节点扮演 federated 节点，以轻量的方式，将搜索请求进行代理</li>
<li>不需要以 Client Node 的形式加入其它集群</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动3个集群</span></span><br><span class="line">bin/elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300</span><br><span class="line">bin/elasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301</span><br><span class="line">bin/elasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在每个集群上设置动态的设置</span></span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"persistent"</span>: &#123;</span><br><span class="line">    <span class="attr">"cluster"</span>: &#123;</span><br><span class="line">      <span class="attr">"remote"</span>: &#123;</span><br><span class="line">        <span class="attr">"cluster0"</span>: &#123;</span><br><span class="line">          <span class="attr">"seeds"</span>: [</span><br><span class="line">            <span class="string">"127.0.0.1:9300"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"transport.ping_schedule"</span>: <span class="string">"30s"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cluster1"</span>: &#123;</span><br><span class="line">          <span class="attr">"seeds"</span>: [</span><br><span class="line">            <span class="string">"127.0.0.1:9301"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"transport.compress"</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">"skip_unavailable"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cluster2"</span>: &#123;</span><br><span class="line">          <span class="attr">"seeds"</span>: [</span><br><span class="line">            <span class="string">"127.0.0.1:9302"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cURL</span></span><br><span class="line">curl -XPUT <span class="string">"http://localhost:9200/_cluster/settings"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;"persistent":&#123;"cluster":&#123;"remote":&#123;"cluster0":&#123;"seeds":["127.0.0.1:9300"],"transport.ping_schedule":"30s"&#125;,"cluster1":&#123;"seeds":["127.0.0.1:9301"],"transport.compress":true,"skip_unavailable":true&#125;,"cluster2":&#123;"seeds":["127.0.0.1:9302"]&#125;&#125;&#125;&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">"http://localhost:9201/_cluster/settings"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;"persistent":&#123;"cluster":&#123;"remote":&#123;"cluster0":&#123;"seeds":["127.0.0.1:9300"],"transport.ping_schedule":"30s"&#125;,"cluster1":&#123;"seeds":["127.0.0.1:9301"],"transport.compress":true,"skip_unavailable":true&#125;,"cluster2":&#123;"seeds":["127.0.0.1:9302"]&#125;&#125;&#125;&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">"http://localhost:9202/_cluster/settings"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;"persistent":&#123;"cluster":&#123;"remote":&#123;"cluster0":&#123;"seeds":["127.0.0.1:9300"],"transport.ping_schedule":"30s"&#125;,"cluster1":&#123;"seeds":["127.0.0.1:9301"],"transport.compress":true,"skip_unavailable":true&#125;,"cluster2":&#123;"seeds":["127.0.0.1:9302"]&#125;&#125;&#125;&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建测试数据</span></span><br><span class="line">curl -XPOST <span class="string">"http://localhost:9200/users/_doc"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;"name":"user1","age":10&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPOST <span class="string">"http://localhost:9201/users/_doc"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;"name":"user2","age":20&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPOST <span class="string">"http://localhost:9202/users/_doc"</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;"name":"user3","age":30&#125;'</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询</span></span><br><span class="line">GET /users,cluster1:users,cluster2:users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"range"</span>: &#123;</span><br><span class="line">      <span class="attr">"age"</span>: &#123;</span><br><span class="line">        <span class="attr">"gte"</span>: <span class="number">20</span>,</span><br><span class="line">        <span class="attr">"lte"</span>: <span class="number">40</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/term-level-queries.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/term-level-queries.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/full-text-queries.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/full-text-queries.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-exists-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-exists-query.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-boosting-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-boosting-query.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-dis-max-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-dis-max-query.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-request-highlighting.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-request-highlighting.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.12/highlighting.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.12/highlighting.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/50444885" target="_blank" rel="noopener">分词算法综述</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-function-score-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-function-score-query.html</a></li>
<li>《Elasticsearch核心技术与实战》</li>
<li><a href="https://kelonsoftware.com/cross-cluster-search-kibana/" target="_blank" rel="noopener">在Kibana中使用Cross data search</a></li>
<li><a href="https://blog.csdn.net/laoyang360/article/details/104809787" target="_blank" rel="noopener">实战 | Elasticsearch自定义评分的N种方法</a></li>
</ul>
<style>
  img {
    zoom: 50%;
  }
</style>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Elastic-Stack/" rel="tag"># Elastic Stack</a>
              <a href="/tags/ES/" rel="tag"># ES</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/back-end/big-data/es-04/" rel="prev" title="重学 Elastic Stack 之 Elasticsearch NLP">
      <i class="fa fa-chevron-left"></i> 重学 Elastic Stack 之 Elasticsearch NLP
    </a></div>
      <div class="post-nav-item">
    <a href="/back-end/big-data/es-06/" rel="next" title="重学 Elastic Stack 之 Elasticsearch 深入了解(二)">
      重学 Elastic Stack 之 Elasticsearch 深入了解(二) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基于词项和基于全文的搜索"><span class="nav-number">1.</span> <span class="nav-text">基于词项和基于全文的搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基于-Term-的查询"><span class="nav-number">1.1.</span> <span class="nav-text">基于 Term 的查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复合查询-Constant-Score-转为-Filter"><span class="nav-number">1.2.</span> <span class="nav-text">复合查询 - Constant Score 转为 Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于全文本的查询"><span class="nav-number">1.3.</span> <span class="nav-text">基于全文本的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Match-Query-Result"><span class="nav-number">1.3.1.</span> <span class="nav-text">Match Query Result</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Operator"><span class="nav-number">1.3.2.</span> <span class="nav-text">Operator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Minimun-should-match"><span class="nav-number">1.3.3.</span> <span class="nav-text">Minimun_should_match</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Match-Phrase-Query"><span class="nav-number">1.3.4.</span> <span class="nav-text">Match Phrase Query</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Match-Query-查询过程"><span class="nav-number">1.4.</span> <span class="nav-text">Match Query 查询过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结构化搜索"><span class="nav-number">2.</span> <span class="nav-text">结构化搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ES-中的机构化搜索"><span class="nav-number">2.1.</span> <span class="nav-text">ES 中的机构化搜索</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#搜索的相关性算分"><span class="nav-number">3.</span> <span class="nav-text">搜索的相关性算分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#词频-TF"><span class="nav-number">3.1.</span> <span class="nav-text">词频 TF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#逆文档频率-IDF"><span class="nav-number">3.2.</span> <span class="nav-text">逆文档频率 IDF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TF-IDF-的概念"><span class="nav-number">3.3.</span> <span class="nav-text">TF-IDF 的概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lucene-中的-TF-IDF-评分公式"><span class="nav-number">3.4.</span> <span class="nav-text">Lucene 中的 TF-IDF 评分公式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BM25"><span class="nav-number">3.5.</span> <span class="nav-text">BM25</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定制-Similarity"><span class="nav-number">3.6.</span> <span class="nav-text">定制 Similarity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过-Explain-API-查看-TF-IDF"><span class="nav-number">3.7.</span> <span class="nav-text">通过 Explain API 查看 TF-IDF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Boosting-Relevance"><span class="nav-number">3.8.</span> <span class="nav-text">Boosting Relevance</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Query-amp-Filtering-与-多字符串多字段查询"><span class="nav-number">4.</span> <span class="nav-text">Query &amp; Filtering 与 多字符串多字段查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#条件组合"><span class="nav-number">4.1.</span> <span class="nav-text">条件组合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bool-查询"><span class="nav-number">4.2.</span> <span class="nav-text">bool 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bool-查询语句"><span class="nav-number">4.3.</span> <span class="nav-text">bool 查询语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何解决结构化查询-“包含而不是相等”-的问题"><span class="nav-number">4.4.</span> <span class="nav-text">如何解决结构化查询 - “包含而不是相等” 的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bool-嵌套"><span class="nav-number">4.5.</span> <span class="nav-text">bool 嵌套</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询语句的结构，会对相关度算分产生影响"><span class="nav-number">4.6.</span> <span class="nav-text">查询语句的结构，会对相关度算分产生影响</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制字段的-Boosting"><span class="nav-number">4.7.</span> <span class="nav-text">控制字段的 Boosting</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Not-Quite-Not"><span class="nav-number">4.8.</span> <span class="nav-text">Not Quite Not</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Boosting-Query"><span class="nav-number">4.9.</span> <span class="nav-text">Boosting Query</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#单字符串多字段查询：Dis-Max-Query"><span class="nav-number">5.</span> <span class="nav-text">单字符串多字段查询：Dis Max Query</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#单字符串查询"><span class="nav-number">5.1.</span> <span class="nav-text">单字符串查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#算分过程"><span class="nav-number">5.1.1.</span> <span class="nav-text">算分过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结果分析"><span class="nav-number">5.1.2.</span> <span class="nav-text">结果分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Disjunction-Max-Query-查询"><span class="nav-number">5.2.</span> <span class="nav-text">Disjunction Max Query 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最佳字段查询调优"><span class="nav-number">5.3.</span> <span class="nav-text">最佳字段查询调优</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过-Tie-Breaker-参数调整"><span class="nav-number">5.4.</span> <span class="nav-text">通过 Tie Breaker 参数调整</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#单字符串多字段查询-Multi-Match"><span class="nav-number">6.</span> <span class="nav-text">单字符串多字段查询: Multi Match</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi-Match-Query"><span class="nav-number">6.1.</span> <span class="nav-text">Multi Match Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用多字段匹配解决"><span class="nav-number">6.2.</span> <span class="nav-text">使用多字段匹配解决</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨字段搜索"><span class="nav-number">6.3.</span> <span class="nav-text">跨字段搜索</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多语言及中文分词与检索"><span class="nav-number">7.</span> <span class="nav-text">多语言及中文分词与检索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自然语言与查询-Recall"><span class="nav-number">7.1.</span> <span class="nav-text">自然语言与查询 Recall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#混合多语言的挑战"><span class="nav-number">7.2.</span> <span class="nav-text">混合多语言的挑战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分词的挑战"><span class="nav-number">7.3.</span> <span class="nav-text">分词的挑战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中文分词方法的演变-字典法"><span class="nav-number">7.4.</span> <span class="nav-text">中文分词方法的演变 - 字典法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中文分词方法的演变-基于统计法的机器学习算法"><span class="nav-number">7.5.</span> <span class="nav-text">中文分词方法的演变 - 基于统计法的机器学习算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中文分词器现状"><span class="nav-number">7.6.</span> <span class="nav-text">中文分词器现状</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些分词工具"><span class="nav-number">7.7.</span> <span class="nav-text">一些分词工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中文分词-DEMO"><span class="nav-number">7.8.</span> <span class="nav-text">中文分词 DEMO</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试相关性一理解原理-＋-多分析-＋-多调整测试"><span class="nav-number">8.</span> <span class="nav-text">测试相关性一理解原理 ＋ 多分析 ＋ 多调整测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#监控并且理解用户行为"><span class="nav-number">8.1.</span> <span class="nav-text">监控并且理解用户行为</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-Search-Template-和-Index-Alias"><span class="nav-number">9.</span> <span class="nav-text">使用 Search Template 和 Index Alias</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Search-Template-解耦程序-amp-搜索-DSL"><span class="nav-number">9.1.</span> <span class="nav-text">Search Template - 解耦程序 &amp; 搜索 DSL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Search-Template-进行查询"><span class="nav-number">9.2.</span> <span class="nav-text">使用 Search Template 进行查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Index-Alias-实现零停机运维"><span class="nav-number">9.3.</span> <span class="nav-text">使用 Index Alias 实现零停机运维</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Alias-创建不同查询的视图"><span class="nav-number">9.4.</span> <span class="nav-text">使用 Alias 创建不同查询的视图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#综合排序-Function-Score-Query-优化算分"><span class="nav-number">10.</span> <span class="nav-text">综合排序 Function Score Query 优化算分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#算分与排序"><span class="nav-number">10.1.</span> <span class="nav-text">算分与排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Function-Score-Query"><span class="nav-number">10.2.</span> <span class="nav-text">Function Score Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#按受欢迎度提升权重"><span class="nav-number">10.3.</span> <span class="nav-text">按受欢迎度提升权重</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Modifier-平滑曲线"><span class="nav-number">10.4.</span> <span class="nav-text">使用 Modifier 平滑曲线</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引入-Factor"><span class="nav-number">10.5.</span> <span class="nav-text">引入 Factor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Boost-Mode-和-Max-Boost"><span class="nav-number">10.6.</span> <span class="nav-text">Boost Mode 和 Max Boost</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一致性随机函数"><span class="nav-number">10.7.</span> <span class="nav-text">一致性随机函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Term-amp-Phrase-Suggester"><span class="nav-number">11.</span> <span class="nav-text">Term &amp; Phrase Suggester</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是搜索建议"><span class="nav-number">11.1.</span> <span class="nav-text">什么是搜索建议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Elasticsearch-Suggester-API"><span class="nav-number">11.2.</span> <span class="nav-text">Elasticsearch Suggester API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Term-Suggester"><span class="nav-number">11.3.</span> <span class="nav-text">Term Suggester</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Term-Suggester-Missing-Mode"><span class="nav-number">11.4.</span> <span class="nav-text">Term Suggester - Missing Mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Term-Suggester-Popuar-Mode"><span class="nav-number">11.5.</span> <span class="nav-text">Term Suggester - Popuar Mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sorting-by-Frequency-amp-PrefixLength"><span class="nav-number">11.6.</span> <span class="nav-text">Sorting by Frequency &amp; PrefixLength</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Phrase-Suggester"><span class="nav-number">11.7.</span> <span class="nav-text">Phrase Suggester</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自动补全与基于上下文的提示"><span class="nav-number">12.</span> <span class="nav-text">自动补全与基于上下文的提示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Completion-Suggester"><span class="nav-number">12.1.</span> <span class="nav-text">The Completion Suggester</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Completion-Suggester-一些步骤"><span class="nav-number">12.2.</span> <span class="nav-text">使用 Completion Suggester 一些步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是-Context-Suggester"><span class="nav-number">12.3.</span> <span class="nav-text">什么是 Context Suggester</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现-Context-Suggester"><span class="nav-number">12.4.</span> <span class="nav-text">实现 Context Suggester</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#精确度和召回率"><span class="nav-number">12.5.</span> <span class="nav-text">精确度和召回率</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#跨集群搜索"><span class="nav-number">13.</span> <span class="nav-text">跨集群搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#水平扩展的痛点"><span class="nav-number">13.1.</span> <span class="nav-text">水平扩展的痛点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨集群搜索-Cross-Cluster-Search"><span class="nav-number">13.2.</span> <span class="nav-text">跨集群搜索 - Cross Cluster Search</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">14.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Richard"
      src="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
  <p class="site-author-name" itemprop="name">Richard</p>
  <div class="site-description" itemprop="description">惶者生存，偏执者成功</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xinlc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/xinlc" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://learnxinyminutes.com/" title="https:&#x2F;&#x2F;learnxinyminutes.com" rel="noopener" target="_blank">Learn X in Y minutes</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://justjavac.com/" title="http:&#x2F;&#x2F;justjavac.com" rel="noopener" target="_blank">justjavac</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.ruanyifeng.com/blog/" title="http:&#x2F;&#x2F;www.ruanyifeng.com&#x2F;blog&#x2F;" rel="noopener" target="_blank">阮一峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.liaoxuefeng.com/" title="https:&#x2F;&#x2F;www.liaoxuefeng.com" rel="noopener" target="_blank">廖雪峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tech.meituan.com/" title="https:&#x2F;&#x2F;tech.meituan.com" rel="noopener" target="_blank">美团技术</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.v2ex.com/" title="https:&#x2F;&#x2F;www.v2ex.com" rel="noopener" target="_blank">V2EX</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://caniuse.com/" title="https:&#x2F;&#x2F;caniuse.com" rel="noopener" target="_blank">caniuse/工具</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.css88.com/nav/" title="http:&#x2F;&#x2F;www.css88.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">css88/doc</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://overapi.com/" title="http:&#x2F;&#x2F;overapi.com&#x2F;" rel="noopener" target="_blank">OverAPI/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://devdocs.io/" title="http:&#x2F;&#x2F;devdocs.io&#x2F;" rel="noopener" target="_blank">DevDocs/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.oschina.net/" title="http:&#x2F;&#x2F;tool.oschina.net&#x2F;" rel="noopener" target="_blank">在线工具/索引</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.lu/" title="http:&#x2F;&#x2F;tool.lu&#x2F;" rel="noopener" target="_blank">ToolBox</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://hao.shejidaren.com/" title="http:&#x2F;&#x2F;hao.shejidaren.com&#x2F;" rel="noopener" target="_blank">设计导航</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
