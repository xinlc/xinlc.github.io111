<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.lichao.xin","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"3ZZ8ITB7HE","apiKey":"062eb5a54afbcbf3f20452d58fc40035","indexName":"xinlc","hits":{"per_page":10},"labels":{"input_placeholder":"搜索","hits_empty":"未发现与「${query}」相关的内容","hits_stats":"${hits} 条相关条目，使用了 ${time} 毫秒"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="深入了解 ES 集群、分页、聚合分析、父子文档、数据建模等。">
<meta property="og:type" content="article">
<meta property="og:title" content="重学 Elastic Stack 之 Elasticsearch 深入了解(二)">
<meta property="og:url" content="https://blog.lichao.xin/back-end/big-data/es-06/index.html">
<meta property="og:site_name" content="Richard Xin&#39;s Blog">
<meta property="og:description" content="深入了解 ES 集群、分页、聚合分析、父子文档、数据建模等。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/1.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/2.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/3.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/4.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/5.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/6.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/7.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/8.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/9.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/10.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/11.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/12.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/13.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/14.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/15.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/16.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/17.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/18.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/19.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/20.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/21.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/22.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/23.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/24.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/25.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/26.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/28.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/29.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/30.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/31.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/32.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/33.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/34.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/35.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/36.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/37.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/38.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/39.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/40.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/41.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/42.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/63.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/43.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/44.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/45.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/46.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/47.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/48.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/49.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/50.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/51.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/52.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/53.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/54.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/55.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/56.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/57.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/58.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/59.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/60.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/61.jpg">
<meta property="og:image" content="https://blog.lichao.xin/images/big-data/es-06/62.jpg">
<meta property="article:published_time" content="2021-02-08T22:10:00.000Z">
<meta property="article:modified_time" content="2021-06-14T01:33:22.379Z">
<meta property="article:author" content="Richard">
<meta property="article:tag" content="Elastic Stack">
<meta property="article:tag" content="ES">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lichao.xin/images/big-data/es-06/1.jpg">

<link rel="canonical" href="https://blog.lichao.xin/back-end/big-data/es-06/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>重学 Elastic Stack 之 Elasticsearch 深入了解(二) | Richard Xin's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4530ac9d0bc4e258535c4a9b17029f0c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Richard Xin's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Richard Xin's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Quick notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">132</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">59</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.lichao.xin/back-end/big-data/es-06/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
      <meta itemprop="name" content="Richard">
      <meta itemprop="description" content="惶者生存，偏执者成功">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Richard Xin's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          重学 Elastic Stack 之 Elasticsearch 深入了解(二)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-08 22:10:00" itemprop="dateCreated datePublished" datetime="2021-02-08T22:10:00+00:00">2021-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-14 01:33:22" itemprop="dateModified" datetime="2021-06-14T01:33:22+00:00">2021-06-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BigData/" itemprop="url" rel="index"><span itemprop="name">BigData</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>深入了解 ES 集群、分页、聚合分析、父子文档、数据建模等。</p>
<a id="more"></a>

<h2 id="集群分布式模型与选主与脑裂问题"><a href="#集群分布式模型与选主与脑裂问题" class="headerlink" title="集群分布式模型与选主与脑裂问题"></a>集群分布式模型与选主与脑裂问题</h2><h3 id="分布式特性"><a href="#分布式特性" class="headerlink" title="分布式特性"></a>分布式特性</h3><ul>
<li>ES 的分布式架构带来的好处<ul>
<li>储存的水平扩容，支持 PB 级数据</li>
<li>提高系统的可用性，部分节点停止服务，整个集群的服务不受影响</li>
</ul>
</li>
<li>ES 的分布式架构<ul>
<li>不同的集群通过不同的名字来区分，默认名字 “elasticsearch”</li>
<li>通过配置文件的修改，或者在命令行中 <code>-E cluster.name=xxx</code> 设定</li>
</ul>
</li>
</ul>
<h3 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h3><ul>
<li>节点是一个 ES 的实例<ul>
<li>其本质就是一个 JAVA 进程</li>
<li>一台机器可以运行多个 ES 进程，但是生产环境一般建议一台机器就运行一个 ES 实例</li>
</ul>
</li>
<li>每一个节点都有名字，通过配置文件配置，或者启动时候 <code>-E node.name=xxx</code> 指定</li>
<li>每一个节点在启动之后，都会分配一个 UID，保存在 data 目录下</li>
</ul>
<h3 id="Coordinating-Node"><a href="#Coordinating-Node" class="headerlink" title="Coordinating Node"></a>Coordinating Node</h3><ul>
<li>处理请求的节点，叫 Coordinating Node<ul>
<li>路由请求到正确的节点，例如创建索引的请求，需要路由到 Master 节点</li>
</ul>
</li>
<li>所有节点默认都是 Coordinating Node</li>
<li>通过将其他类型设置成 False ，使其成为 Dedicated Coordinating Node</li>
</ul>
<h3 id="Data-Node"><a href="#Data-Node" class="headerlink" title="Data Node"></a>Data Node</h3><ul>
<li>可以保存数据的节点，叫做 Data Node<ul>
<li>节点启动后，默认就是数据节点。可以设置 <code>node.data:false</code> 禁止</li>
</ul>
</li>
<li>Data Node 的职责<ul>
<li>保存分片数据。在数据扩展上起到了至关重要的作用（由 Master Node 决定把分片分发到数据节点上）</li>
</ul>
</li>
<li>通过增加数据节点<ul>
<li>可以解决数据<strong>水平扩展</strong>和解决<strong>数据单点</strong>的问题</li>
</ul>
</li>
</ul>
<h3 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h3><ul>
<li>Master Node 的职责<ul>
<li>处理创建，删除索引等请求 / 决定分片被分配到哪个节点 / 负责索引的创建与删除</li>
<li>维护并且更新 Cluster State</li>
</ul>
</li>
<li>Master Node 的最佳实践<ul>
<li>Master 节点非常重要，在部署上需要考虑解决单点的问题</li>
<li>为一个集群设置多个 Master 节点 / 每个节点值承担 Master 的单一角色</li>
</ul>
</li>
</ul>
<h3 id="Master-Eligible-Nodes-amp-选主流程"><a href="#Master-Eligible-Nodes-amp-选主流程" class="headerlink" title="Master Eligible Nodes &amp; 选主流程"></a>Master Eligible Nodes &amp; 选主流程</h3><ul>
<li>一个集群，支持配置多个 Master Eligble 节点。这些节点可以在必要时（如 Master 节点出现故障，网络故障时）参与选主流程，成为 Master 节点</li>
<li>每个节点启动后，默认就是一个 Master eligible 节点<ul>
<li>可以设置 <code>node.master:false</code></li>
</ul>
</li>
<li>当集群内的第一个 Master eligible 节点启动的时候，它会将自己选举成 Master 节点</li>
</ul>
<h3 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h3><ul>
<li>集群状态信息（Cluster State），维护了一个集群中，必要的信息<ul>
<li>所有的节点信息</li>
<li>所有的索引和其相关的 Mapping 与 Setting 信息</li>
<li>分片的路由信息</li>
</ul>
</li>
<li>在每个节点都保存了集群的状态信息</li>
<li>但是，只有 Master 节点才能修改集群的状态信息，并负责同步给其他节点<ul>
<li>因为，任意节点都能修改信息会导致 Cluster State 信息不一致</li>
</ul>
</li>
</ul>
<h3 id="Master-Eligbile-Nodes-amp-选主的过程"><a href="#Master-Eligbile-Nodes-amp-选主的过程" class="headerlink" title="Master Eligbile Nodes &amp; 选主的过程"></a>Master Eligbile Nodes &amp; 选主的过程</h3><ul>
<li>互相 ping 对方。<strong>Node Id</strong> 低的会被成为被选举的节点</li>
<li>其他节点会加入集群，但是不承担 Master 节点的角色。一旦发现被选中的主节点丢失，就会选举出新的 Master 节点</li>
</ul>
<p><img src="/images/big-data/es-06/1.jpg" alt="1"></p>
<h3 id="脑裂问题"><a href="#脑裂问题" class="headerlink" title="脑裂问题"></a>脑裂问题</h3><ul>
<li>Split-Brain ，分布式系统的经典网络问题，当出现网络问题，一个节点和其他节点无法连接<ul>
<li>Node 2 和 Node 3 会被重新选举 Master</li>
<li>Node 1 自己还是作为 Master，组成一个集群，同时更新 Cluster State</li>
<li>导致 2 个 master，维护不同的 cluster state。当网络恢复是，无法选择正确恢复</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/2.jpg" alt="2"></p>
<h3 id="如何避免脑裂问题"><a href="#如何避免脑裂问题" class="headerlink" title="如何避免脑裂问题"></a>如何避免脑裂问题</h3><ul>
<li>限定一个选举条件，这是 quorum（仲裁），只有在 Master eligble 节点数大于 quorum 时，才能进行选举<ul>
<li>Quorum = (master 节点总数 / 2) + 1</li>
<li>当 3 个 master eligible 时，设置 <strong>discovery.zen.minimum_master_nodes</strong> 为 2 ，即可避免脑裂</li>
</ul>
</li>
<li>从 7.0 开始，无需这个配置<ul>
<li>移除 minimum_master_nodes 参数，让 ES 自己选择可以形成冲裁的节点</li>
<li>典型的主节点选举现在只需要很短的时间可以完成。集群的伸缩变得更加安全，更容易，并且可能造成丢失数据的系统配置选项更少了</li>
<li>节点更清楚的记录它们的状态，有助于诊断为什么它们不能加入集群或为什么无法选举除主节点</li>
</ul>
</li>
</ul>
<h3 id="为什么高可用是奇数节点？"><a href="#为什么高可用是奇数节点？" class="headerlink" title="为什么高可用是奇数节点？"></a>为什么高可用是奇数节点？</h3><p>为了避免脑裂，同时也为了避免浪费资源（机器），Raft 算法为：</p>
<p>N 为 master 节点总数，可容忍 <strong>(N-1)/2</strong> 失败数，quorum 需要 <strong>(N/2)+1</strong></p>
<h3 id="分布式共识算法"><a href="#分布式共识算法" class="headerlink" title="分布式共识算法"></a>分布式共识算法</h3><p>一致性往往指分布式系统中多个副本对外呈现的数据的状态。共识则描述了分布式系统中多个节点之间，彼此对某个状态达成一致结果的过程。因此，一致性描述的是结果状态，共识则是一种手段。达成某种共识并不意味着就保障了一致性。</p>
<p>对于分布式系统来讲，各个节点通常都是相同的确定性状态机模型（又称为状态机复制问题，state-machine replication），从相同初始状态开始接收相同顺序的指令，则可以保证相同的结果状态。因此，系统中多个节点最关键的是对多个事件的顺序进行共识，即排序。</p>
<p><strong>问题与挑战</strong></p>
<p>一般地，把出现故障（crash或fail-stop，即不响应）但不会伪造信息的情况称为“非拜占庭错误”（non-byzantine fault）或“故障错误”（Crash Fault）；伪造信息恶意响应的情况称为“拜占庭错误”（Byzantine Fault），对应节点为拜占庭节点。</p>
<p><strong>常见算法</strong></p>
<p>根据解决的是非拜占庭的普通错误情况还是拜占庭错误情况，共识算法可以分为Crash Fault Tolerance（CFT）类算法和Byzantine Fault Tolerance（BFT）类算法。</p>
<p>对于非拜占庭错误：已经存在一些经典的解决算法，包括Paxos、Raft及其变种等。这类容错算法往往性能比较好，处理较快，容忍不超过一半的故障节点。</p>
<p>对于拜占庭错误：一般包括PBFT（Practical Byzantine Fault Tolerance）为代表的确定性系列算法、PoW为代表的概率算法等。对于确定性算法，一旦达成对某个结果的共识就不可逆转，即共识是最终结果；而对于概率类算法，共识结果则是临时的，随着时间推移或某种强化，共识结果被推翻的概率越来越小，成为事实上的最终结果。拜占庭类容错算法往往性能较差，容忍不超过1/3的故障节点。</p>
<p>此外，XFT（Cross Fault Tolerance）等改进算法可以提供类似CFT的处理响应速度，并能在大多数节点正常工作时提供BFT保障。</p>
<p>crash fault tolerance 的系统，节点数需要满足 n=2f+1 （ f 为会崩溃的节点数），所以最小的系统需要 3 个节点。</p>
<p>拜占庭容错系统的节点数是 n=3f+1 （ f 为拜占庭节点数量）。所以拜占庭容错系统需要至少 4 个节点才能容忍 1 个拜占庭节点。</p>
<p>相关的理论可以看 Paxos，Raft，pbft 等著名论文。主要思想是：保证正常运作的节点数量过系统的半数（过半机制）。</p>
<ul>
<li><a href="https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/" target="_blank" rel="noopener">FLP 不可能定理</a></li>
<li><a href="https://www.usenix.org/system/files/conference/atc14/atc14-paper-ongaro.pdf" target="_blank" rel="noopener">Raft 共识算法论文</a></li>
</ul>
<h3 id="配置节点类型"><a href="#配置节点类型" class="headerlink" title="配置节点类型"></a>配置节点类型</h3><ul>
<li>一个节点默认下是一个 Master eligible ，data and ingest node</li>
</ul>
<table>
<thead>
<tr>
<th align="left">节点类型</th>
<th align="left">配置参数</th>
<th align="left">默认值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">maste eligible</td>
<td align="left">node.master</td>
<td align="left">true</td>
</tr>
<tr>
<td align="left">data</td>
<td align="left">node.data</td>
<td align="left">true</td>
</tr>
<tr>
<td align="left">ingest</td>
<td align="left">node.ingest</td>
<td align="left">ture</td>
</tr>
<tr>
<td align="left">coordinating only</td>
<td align="left">⽆</td>
<td align="left">设置上⾯三个参数全部为 false</td>
</tr>
<tr>
<td align="left">machine learning</td>
<td align="left">node.ml</td>
<td align="left">true (需要 enable x-pack)</td>
</tr>
</tbody></table>
<blockquote>
<p>配置版本基于 7.1，相关配置可能已发生改动详情看 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html" target="_blank" rel="noopener">官网</a></p>
</blockquote>
<h2 id="分片与集群的故障转移"><a href="#分片与集群的故障转移" class="headerlink" title="分片与集群的故障转移"></a>分片与集群的故障转移</h2><h3 id="Primary-Shard-提升系统存储容量"><a href="#Primary-Shard-提升系统存储容量" class="headerlink" title="Primary Shard - 提升系统存储容量"></a>Primary Shard - 提升系统存储容量</h3><ul>
<li>分片是 ES 分布式储存的基石<ul>
<li>主分片 / 副本分片</li>
</ul>
</li>
<li>通过主分片，将数据分布在所有节点上<ul>
<li>Primary Shard , 可以将一份索引的数据，分散在多个 Data Node 上，实现储存的水平扩展</li>
<li>主分片（Primary Shard）数在索引创建时候指定，后续默认不能修改，如要修改，需重建索引</li>
</ul>
</li>
</ul>
<h3 id="Replica-Shard-提高数据可用性"><a href="#Replica-Shard-提高数据可用性" class="headerlink" title="Replica Shard - 提高数据可用性"></a>Replica Shard - 提高数据可用性</h3><ul>
<li>数据可用性<ul>
<li>通过引入副本分片（Replica Shard）提高数据的可用性。一旦主分片丢失，副本分片可以在 Promote 成主分片。副本分片数可以动态调整的。每个节点上都有完备的数据。如果不设置副本分片，一旦出现节点硬件故障，就有可能造成数据丢失。</li>
</ul>
</li>
<li>提高系统的读取性能<ul>
<li>副本分片由主分片（Primary Shard）同步。通过支持增加 Replica 个数，一定程度可以提高读取的吞吐量</li>
</ul>
</li>
</ul>
<h3 id="分片数的设置"><a href="#分片数的设置" class="headerlink" title="分片数的设置"></a>分片数的设置</h3><ul>
<li>如何规划一个索引的主分片数和副本分片数<ul>
<li>主分片数过小：例如创建一个 1 个 Primary Shard 的 index<ul>
<li>如果该索引增长很快，集群无法通过增加节点实现对这个索引的数据扩展</li>
</ul>
</li>
<li>主分片数设置过大：导致单个 Shard 容量很小，引发一个节点上有过多分片，影响性能</li>
<li>副本分片设置过多，会降低集群整体的写入性能</li>
</ul>
</li>
</ul>
<h3 id="单节点集群"><a href="#单节点集群" class="headerlink" title="单节点集群"></a>单节点集群</h3><ul>
<li>副本无法分片，集群状态为黄色</li>
</ul>
<p><img src="/images/big-data/es-06/3.jpg" alt="3"></p>
<blockquote>
<p>使用 cerebro 观察集群状态 <a href="https://github.com/lmenezes/cerebro" target="_blank" rel="noopener">https://github.com/lmenezes/cerebro</a></p>
</blockquote>
<h3 id="增加一个数据节点"><a href="#增加一个数据节点" class="headerlink" title="增加一个数据节点"></a>增加一个数据节点</h3><ul>
<li>集群状态转为绿色</li>
<li>集群具备故障转移能力</li>
<li>尝试着将 Replica 设置成 2 和 3，查看集群的状况</li>
</ul>
<p><img src="/images/big-data/es-06/4.jpg" alt="4"></p>
<h3 id="在增加一个节点"><a href="#在增加一个节点" class="headerlink" title="在增加一个节点"></a>在增加一个节点</h3><ul>
<li>集群具备故障转移能力</li>
<li>Master 节点会决定分片分配到哪个节点</li>
<li>通过增加节点数，提高集群的计算能力</li>
</ul>
<p><img src="/images/big-data/es-06/5.jpg" alt="5"></p>
<h3 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h3><ul>
<li>3 个节点共同组成。包含 1 个索引，索引设置了 3 个 Primary Shard 和 1 个 Replica</li>
<li>节点 1 是 Master 节点，节点意外出现故障。集群重新选举 Master 节点</li>
<li>Node3 上的 R0 提升成 P0 ，集群变黄</li>
<li>R0 和 R1 分配，集群变绿</li>
</ul>
<p><img src="/images/big-data/es-06/6.jpg" alt="6"></p>
<h3 id="集群健康状态"><a href="#集群健康状态" class="headerlink" title="集群健康状态"></a>集群健康状态</h3><ul>
<li>Green : 健康状态，所有的主分片和副本分片都可用</li>
<li>Yellow: 亚健康，所有的主分片可用，部分副本分片不可用</li>
<li>Red：不健康状态，部分主分片不可用</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cluster/health</span><br></pre></td></tr></table></figure>

<p><strong>Demo</strong></p>
<ul>
<li>启动一个节点，3 个 Primary shard，1 个 Replica，集群黄色，因为无法分片 Replica</li>
<li>启动 3 个节点，1 个索引上包含 3 个 Primary Shard，一个 Replica</li>
<li>关闭 Node 1（Master）</li>
<li>查看 Master Node 重新选举</li>
<li>集群变黄，然后重新分配</li>
</ul>
<p><strong>小结</strong></p>
<ul>
<li>主分片，副本分片的作用<ul>
<li>主分片的分片数，设置后不能修改，除非重新索引数据</li>
<li>副本分片可以随时修改</li>
</ul>
</li>
<li>集群的故障转移<ul>
<li>需要集群具备故障转移的能力，必须将索引的副本分片数设置为1，否则，一点有节点就是，就会造成数据丢失</li>
</ul>
</li>
</ul>
<h2 id="文档分布式存储"><a href="#文档分布式存储" class="headerlink" title="文档分布式存储"></a>文档分布式存储</h2><h3 id="文档储存在分片上"><a href="#文档储存在分片上" class="headerlink" title="文档储存在分片上"></a>文档储存在分片上</h3><ul>
<li>文档会存储在具体的某个主分片和副本分片上：例如文档 1，会储存在 P0 和 R0 分片上</li>
<li>文档到分片的映射算法<ul>
<li>确保文档能均匀分布在所用分片上，充分利用硬件资源，避免部分机器空闲，部门机器繁忙</li>
<li>潜在的算法<ul>
<li>随机 / Round Robin. 当查询文档 1，分片数很多，需要多次查询才能查档文档 1</li>
<li>维护文档到分片的映射关系，当文档数据量大的时候，维护成本高</li>
<li>实时计算，通过文档 1，自动算出，需要去哪个分片上获取文档</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="文档到分片的路由算法"><a href="#文档到分片的路由算法" class="headerlink" title="文档到分片的路由算法"></a>文档到分片的路由算法</h3><ul>
<li>shard = hash(_routing) % number_of_primary_shards<ul>
<li>Hash 算法确保文档均匀分散到分片中</li>
<li>默认的_routing 值是文档 id</li>
<li>可以自行制定 routing 数值，例如用相同国家的商品，都分配到制定的 shard</li>
<li>设置 Index Setting 后，<strong>Primary 数，不能随意修改的根本原因</strong></li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT posts/_doc/100?routing=bigdata</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Mastering Elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"body"</span>: <span class="string">"Let's Rock"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h3><ul>
<li>顺序：index -&gt; hash -&gt; route -&gt; delete -&gt; index -&gt; success -&gt; response</li>
</ul>
<p><img src="/images/big-data/es-06/7.jpg" alt="7"></p>
<h3 id="删除一个文档"><a href="#删除一个文档" class="headerlink" title="删除一个文档"></a>删除一个文档</h3><ul>
<li>顺序 ：detele -&gt; hash&amp;route -&gt; delete -&gt; delete replica -&gt; success -&gt; deleted -&gt; response</li>
</ul>
<p><img src="/images/big-data/es-06/8.jpg" alt="8"></p>
<p><strong>小结</strong></p>
<ul>
<li>可以设置 Index Settings ，控制数据的分片</li>
<li>Primary Shard 的值不能修改，修改需要重新 Index。默认值是 5，从版本 7 开始，默认值为 1</li>
<li>索引写入数据后，Replica 值可以修改。增加副本，可提高大并发下的读取性能</li>
<li>通过控制集群的节点数，设置 Primary Shard 数，实现水平扩展</li>
</ul>
<h2 id="分片及其生命周期"><a href="#分片及其生命周期" class="headerlink" title="分片及其生命周期"></a>分片及其生命周期</h2><h3 id="分片的内部原理"><a href="#分片的内部原理" class="headerlink" title="分片的内部原理"></a>分片的内部原理</h3><ul>
<li>什么是 ES 的分片<ul>
<li>ES 中最小的工作单元 / 是一个 Lucence 的 Index</li>
</ul>
</li>
<li>一些问题：<ul>
<li>为什么 ES 的搜索时近实时的（1 秒后被搜到）</li>
<li>ES 如何保证在断电时数据也不会丢失</li>
<li>为什么删除文档，并不会立刻释放空间</li>
</ul>
</li>
</ul>
<h3 id="倒排索引的不可变性"><a href="#倒排索引的不可变性" class="headerlink" title="倒排索引的不可变性"></a>倒排索引的不可变性</h3><ul>
<li>倒排索引采用 Immutable Design, 一旦生成，不可更改</li>
<li>不可变性，带来了的好处如下：<ul>
<li>无需考虑并发写文件的问题，避免了锁机制带来的性能问题</li>
<li>一旦读入内核的文件系统缓存，便留在那里，只要文件系统存有足够的空间，大部分请求就会直接请求内存，不会命中磁盘，提高了很大的性能</li>
<li>缓存容易生成和维护 / 数据可以被压缩</li>
</ul>
</li>
<li>不可变更性，带来了的挑战：如果需要让一个新的文档可以被搜索，需要重建整个索引</li>
</ul>
<h3 id="Lucence-index"><a href="#Lucence-index" class="headerlink" title="Lucence index"></a>Lucence index</h3><ul>
<li>在 Lucene 中，单个倒排索引文件被称为 Segment。Segment 是自包含的，不可变更的。多个 Segments 汇总在一起，称为 Lucene 的 Index，其对应的就是 ES 中的 Shard</li>
<li>当有新文档写入时，会生成新的 Segment, 查询时会同时查询所有的 Segments，并且对结果汇总。Luncene 中有个文件，用来记录所有的 Segments 的信息，叫做 Commit Point</li>
<li>删除的文档信息，保存在”.del” 文件中</li>
</ul>
<p><img src="/images/big-data/es-06/9.jpg" alt="9"></p>
<h3 id="Refresh"><a href="#Refresh" class="headerlink" title="Refresh"></a>Refresh</h3><ul>
<li>将 Index buffer 写入 Segment 的过程叫做 Refresh。Refresh 不执行 fsync 操作</li>
<li>Refresh 频率：默认 1 秒发生一次，可通过 index.refresh_interval 配置。Refresh 后，数据就可以被搜索到了。这也就是为什么 ES 被称为近实时搜索</li>
<li>如果系统有大量的数据写入，那就会产生很多的 Segment</li>
<li>Index Buffer 被占满时，会触发 Refresh, 默认值是 JVM 的 10%</li>
</ul>
<p><img src="/images/big-data/es-06/10.jpg" alt="10"></p>
<h3 id="Transaction-Log"><a href="#Transaction-Log" class="headerlink" title="Transaction Log"></a>Transaction Log</h3><ul>
<li>Segment 写入磁盘的过程相对耗时，借助文件系统缓存，Refresh 时，先将 Segment 写入缓存以开放查询</li>
<li>蔚来保证数据不会丢失。所有在 Index 文档时，同时写 Transaction Log，高版本开始，Transaction Log 默认落盘。每个分片都有一个 Transaction Log</li>
<li>当 ES Refresh 时，Index Buffer 被清空，Transaction Log 不会清空</li>
</ul>
<p><img src="/images/big-data/es-06/11.jpg" alt="11"></p>
<h3 id="Flush"><a href="#Flush" class="headerlink" title="Flush"></a>Flush</h3><ul>
<li>ES Flush &amp; Lucene Commit<ul>
<li>调用 Refresh ，Index Buffer 清空并且 Refresh</li>
<li>调用 fsync, 将缓存中的 Segments 写入磁盘</li>
<li>清空（删除）Transaction Log</li>
<li>默认 30 分钟调用一次</li>
<li>Transaction Log 满（默认 512M）</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/12.jpg" alt="12"></p>
<h3 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h3><ul>
<li>Segment 很多，需要定期被合并<ul>
<li>减少 Segments / 删除已经删除的文档</li>
</ul>
</li>
<li>ES 和 Lucene 会自动进行 Merge 操作<ul>
<li>POST my_index/_forcemerge</li>
</ul>
</li>
</ul>
<h2 id="剖析分布式查询及相关性算法"><a href="#剖析分布式查询及相关性算法" class="headerlink" title="剖析分布式查询及相关性算法"></a>剖析分布式查询及相关性算法</h2><h3 id="分布式搜索的运行机制"><a href="#分布式搜索的运行机制" class="headerlink" title="分布式搜索的运行机制"></a>分布式搜索的运行机制</h3><ul>
<li>ES 的搜索，会分两阶段进行<ul>
<li>第一阶段 - Query</li>
<li>第二阶段 - Fetch</li>
</ul>
</li>
<li>Query-then-Fetch</li>
</ul>
<h3 id="Query-阶段"><a href="#Query-阶段" class="headerlink" title="Query 阶段"></a>Query 阶段</h3><ul>
<li>用户发出搜索请求到 ES 节点。节点收到请求后，会以 Coordinating 节点的身份，在 6 个主副分片中随机选择 3 个分片，发送查询请求</li>
<li>被选中的分片执行查询，进行排序。然后，每个分片都会返回 From + Size 个排序后的文档 Id 和排序值给 Coordinating 节点</li>
</ul>
<p><img src="/images/big-data/es-06/13.jpg" alt="13"></p>
<h3 id="Fetch-阶段"><a href="#Fetch-阶段" class="headerlink" title="Fetch 阶段"></a>Fetch 阶段</h3><ul>
<li>Coordinating Node 会将 Query 阶段，从每个分片获取的排序后的文档 Id 列表，重新进行排序。选取 From 到 From + Size 个文档的 Id</li>
<li>以 multi get 请求的方式，到相应的分片获取详细的文档数据</li>
</ul>
<h3 id="Query-Then-Fetch-潜在的问题"><a href="#Query-Then-Fetch-潜在的问题" class="headerlink" title="Query Then Fetch 潜在的问题"></a>Query Then Fetch 潜在的问题</h3><ul>
<li>性能问题<ul>
<li>每个分片上需要查的文档个数 = from + size</li>
<li>最终协调节点需要处理：number_of_shard * (from + size)</li>
<li>深度分页 (可以使用 Search After)</li>
</ul>
</li>
<li>相关性算分<ul>
<li>每个分片都基于自己的分片上的数据进行相关度计算。这会导致打分偏离的情况，特别是数据量很少时。相关性算分在分片之间是相互独立。当文档总数很少的情况下，如果主分片大于 1，主分片越多，相关性算分会越不准。</li>
</ul>
</li>
</ul>
<h3 id="解决算分不准的方法"><a href="#解决算分不准的方法" class="headerlink" title="解决算分不准的方法"></a>解决算分不准的方法</h3><ul>
<li>数据量不大的时候，可以将主分片数设置为 1<ul>
<li>当数据量足够大时候，只要保证文档均匀分散在各个分片上，结果一般就不会出现偏差</li>
</ul>
</li>
<li>使用 DFS Query Then Fetch<ul>
<li>搜索的 URL 中指定参数 “_search?search_type=dfs_query_then_fetch”</li>
<li>到每个分片把各分片的词频和文档频率进行搜集，然后完整的进行一次相关性算分，消耗更加多的 CPU 和内存，执行性能低下，一般不建议使用</li>
</ul>
</li>
</ul>
<h3 id="相关性算分问题-Demo"><a href="#相关性算分问题-Demo" class="headerlink" title="相关性算分问题 Demo"></a>相关性算分问题 Demo</h3><ul>
<li>写入 3 条记录 “Good” / “Good moring” / “good morning everyone”</li>
<li>使用 1 个主分片测试，Good 应该排在第一，Good DF 数值应该是 3</li>
<li>和 20 个主分片测试</li>
<li>当多个主分片时，3 个文档的算分都一样。可以通过 Explain API 进行分析</li>
<li>在 3 个主分片上执行 DFS Query Then Fetch ，结果和一个分片上一致</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">DELETE message</span><br><span class="line">PUT message</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"number_of_shards"</span>: <span class="number">20</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET message</span><br><span class="line">POST message/_doc?routing=1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"good"</span></span><br><span class="line">&#125;</span><br><span class="line">POST message/_doc?routing=2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"good morning"</span></span><br><span class="line">&#125;</span><br><span class="line">POST message/_doc?routing=3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"good morning everyone"</span></span><br><span class="line">&#125;</span><br><span class="line">POST message/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST message/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"explain"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"content"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"good"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST message/_search?search_type=dfs_query_then_fetch</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"content"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"good"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="排序及-Doc-Values-amp-Field-Data"><a href="#排序及-Doc-Values-amp-Field-Data" class="headerlink" title="排序及 Doc Values &amp; Field Data"></a>排序及 Doc Values &amp; Field Data</h2><h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><ul>
<li>ES 默认采用相关性算分对结果进行降序排序</li>
<li>可以通过设置 sorting 参数，自行设定排序</li>
<li>如果不指定 _score, 算分为 null</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sort"</span>: [</span><br><span class="line">    &#123;<span class="attr">"order_date"</span>: &#123;<span class="attr">"order"</span>: <span class="string">"desc"</span>&#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多字段进行排序"><a href="#多字段进行排序" class="headerlink" title="多字段进行排序"></a>多字段进行排序</h3><ul>
<li>组合多个条件</li>
<li>优先考虑写在前面的排序</li>
<li>支持对相关性算分进行排序</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sort"</span>: [</span><br><span class="line">    &#123;<span class="attr">"order_date"</span>: &#123;<span class="attr">"order"</span>: <span class="string">"desc"</span>&#125;&#125;,</span><br><span class="line">    &#123;<span class="attr">"_doc"</span>:&#123;<span class="attr">"order"</span>: <span class="string">"asc"</span>&#125;&#125;,</span><br><span class="line">    &#123;<span class="attr">"_score"</span>:&#123; <span class="attr">"order"</span>: <span class="string">"desc"</span>&#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="对-Text-类型排序"><a href="#对-Text-类型排序" class="headerlink" title="对 Text 类型排序"></a>对 Text 类型排序</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对 text 字段进行排序。默认会报错，需打开fielddata</span></span><br><span class="line">POST /kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sort"</span>: [</span><br><span class="line">    &#123;<span class="attr">"customer_full_name"</span>: &#123;<span class="attr">"order"</span>: <span class="string">"desc"</span>&#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开 text的 fielddata</span></span><br><span class="line">PUT kibana_sample_data_ecommerce/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"customer_full_name"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"fielddata"</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="排序的过程"><a href="#排序的过程" class="headerlink" title="排序的过程"></a>排序的过程</h3><ul>
<li>排序是针对字段原始内容进行的。倒排索引无法发挥作用</li>
<li>需要用到正排索引。通过文档 ID 和字段快速得到字段原始内容</li>
<li>ES 有 2 种实现方式<ul>
<li>Fielddata</li>
<li>Doc Values (列式存储，对 Text 类型无效）</li>
</ul>
</li>
</ul>
<h3 id="Doc-Values-vs-Field-Data"><a href="#Doc-Values-vs-Field-Data" class="headerlink" title="Doc Values vs. Field Data"></a>Doc Values vs. Field Data</h3><table>
<thead>
<tr>
<th align="left"></th>
<th align="left">Doc Values</th>
<th align="left">Field data</th>
</tr>
</thead>
<tbody><tr>
<td align="left">何时创建</td>
<td align="left">索引时，和倒排索引一起创建</td>
<td align="left">搜索时候动态创建</td>
</tr>
<tr>
<td align="left">创建位置</td>
<td align="left">磁盘文件</td>
<td align="left">JVM Heap</td>
</tr>
<tr>
<td align="left">优点</td>
<td align="left">避免大量内存占用</td>
<td align="left">索引速度快，不占用额外的磁盘空间</td>
</tr>
<tr>
<td align="left">缺点</td>
<td align="left">降低索引速度，占用额外磁盘空间</td>
<td align="left">文档过多时，动态创建开销大，占用过多 JVM Heap</td>
</tr>
<tr>
<td align="left">缺省值</td>
<td align="left">ES 2.x 之后</td>
<td align="left">ES1.x 及之前</td>
</tr>
</tbody></table>
<h3 id="打开-Fielddata"><a href="#打开-Fielddata" class="headerlink" title="打开 Fielddata"></a>打开 Fielddata</h3><ul>
<li>默认关闭，可以通过 Mapping 设置打开。修改设置后，即时生效，无需缩减索引</li>
<li>其他字段类型不支持，支持对 Text 进行设定</li>
<li>打开后，可以对 Text 字段进行排序，但是是对分词后的 term 排序，所以，结果往往无法满足预期，不建议使用</li>
<li>部分情况下打开，满足一些聚合分析的特定需求</li>
</ul>
<h3 id="关闭-Doc-Values"><a href="#关闭-Doc-Values" class="headerlink" title="关闭 Doc Values"></a>关闭 Doc Values</h3><ul>
<li>默认启动，可以通过 Mapping 设置关闭<ul>
<li>增加索引的速度 / 减少磁盘空间</li>
</ul>
</li>
<li>如果重新打开，需要重建索引</li>
<li>什么时候需要关闭<ul>
<li>明确不需要做排序及聚合分析</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭 keyword的 doc values</span></span><br><span class="line">PUT test_keyword</span><br><span class="line">PUT test_keyword/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"user_name"</span>:&#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">      <span class="attr">"doc_values"</span>:<span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取-Doc-Values-amp-Fielddata-中储存的内容"><a href="#获取-Doc-Values-amp-Fielddata-中储存的内容" class="headerlink" title="获取 Doc Values &amp; Fielddata 中储存的内容"></a>获取 Doc Values &amp; Fielddata 中储存的内容</h3><ul>
<li>Text 类型的不支持 Doc Values</li>
<li>Text 类型打开 Fielddata 后，可以查看分词后的数据</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">DELETE temp_users</span><br><span class="line">PUT temp_users</span><br><span class="line">PUT temp_users/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>:&#123;<span class="attr">"type"</span>: <span class="string">"text"</span>,<span class="attr">"fielddata"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    <span class="attr">"desc"</span>:&#123;<span class="attr">"type"</span>: <span class="string">"text"</span>,<span class="attr">"fielddata"</span>: <span class="literal">true</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST temp_users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"Jack"</span>,<span class="attr">"desc"</span>:<span class="string">"Jack is a good boy!"</span>,<span class="attr">"age"</span>:<span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开fielddata 后，查看 docvalue_fields数据</span></span><br><span class="line">POST  temp_users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"docvalue_fields"</span>: [</span><br><span class="line">    <span class="string">"name"</span>,<span class="string">"desc"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看整型字段的docvalues</span></span><br><span class="line">POST  temp_users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"docvalue_fields"</span>: [</span><br><span class="line">    <span class="string">"age"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Fielddata Demo</strong></p>
<ul>
<li>对Text字段设置fielddata ，支持随时修改</li>
<li>Doc Values 可以在Mapping 中关闭，但是需要重新索引</li>
<li>Text 不支持Doc Values</li>
<li>使用docvalue_fields 查看存储的信息</li>
</ul>
<h2 id="分页与遍历-From-Size-Search-After-amp-Scorll-API"><a href="#分页与遍历-From-Size-Search-After-amp-Scorll-API" class="headerlink" title="分页与遍历 - From, Size, Search After &amp; Scorll API"></a>分页与遍历 - From, Size, Search After &amp; Scorll API</h2><h3 id="From-Size"><a href="#From-Size" class="headerlink" title="From / Size"></a>From / Size</h3><ul>
<li>默认情况下，查询按照相关度算分排序，返回前 10 条记录</li>
<li>容易理解的分页方案<ul>
<li>From: 开始位置</li>
<li>Size: 期望获取文档的总数</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"from"</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分布式系统中深度分页的问题"><a href="#分布式系统中深度分页的问题" class="headerlink" title="分布式系统中深度分页的问题"></a>分布式系统中深度分页的问题</h3><ul>
<li>ES 天生就是分布式，查询信息，但是数据分别保存在多个分片，多台机器，ES 天生就需要满足排序的需要（按照相关性算分）</li>
<li>当一个查询：From = 990 ，Size =10<ul>
<li>会在每个分片上先获取 1000 个文档。然后，通过 Coordinating Node 聚合所有结果。最后在通过排序选取前 1000 个文档</li>
<li>页数越深，占用内容越多。为了避免深度分页带来的内存开销。ES 有个设定，默认限定到 10000 个文档<ul>
<li>index.max_result_window</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/14.jpg" alt="14"></p>
<h3 id="Search-After-避免深度分页的问题"><a href="#Search-After-避免深度分页的问题" class="headerlink" title="Search After 避免深度分页的问题"></a>Search After 避免深度分页的问题</h3><ul>
<li>避免深度分页的性能问题，可以实时获取下一页文档信息<ul>
<li>不支持指定页数（From）</li>
<li>不能往下翻</li>
</ul>
</li>
<li>第一步搜索需要指定 sort，并且保证值是唯一的（可以通过加入_id 保证唯一性）</li>
<li>然后使用上一次，最后一个文档的 sort 值进行查询</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">DELETE users</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"user1"</span>,<span class="attr">"age"</span>:<span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"user2"</span>,<span class="attr">"age"</span>:<span class="number">11</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"user2"</span>,<span class="attr">"age"</span>:<span class="number">12</span>&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"user2"</span>,<span class="attr">"age"</span>:<span class="number">13</span>&#125;</span><br><span class="line"></span><br><span class="line">POST users/_count</span><br><span class="line"></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"sort"</span>: [</span><br><span class="line">        &#123;<span class="attr">"age"</span>: <span class="string">"desc"</span>&#125; ,</span><br><span class="line">        &#123;<span class="attr">"_id"</span>: <span class="string">"asc"</span>&#125;    </span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"search_after"</span>:</span><br><span class="line">        [</span><br><span class="line">          <span class="number">10</span>,</span><br><span class="line">          <span class="string">"ZQ0vYGsBrR8X3IP75QqX"</span>],</span><br><span class="line">    <span class="attr">"sort"</span>: [</span><br><span class="line">        &#123;<span class="attr">"age"</span>: <span class="string">"desc"</span>&#125; ,</span><br><span class="line">        &#123;<span class="attr">"_id"</span>: <span class="string">"asc"</span>&#125;    </span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Search-After-是如何解决深度分页的问题"><a href="#Search-After-是如何解决深度分页的问题" class="headerlink" title="Search After 是如何解决深度分页的问题"></a>Search After 是如何解决深度分页的问题</h3><ul>
<li>假设 Size 是 10</li>
<li>当查询 990 - 1000</li>
<li>通过唯一排序值定位，将每次要处理的文档都控制在 10</li>
</ul>
<p><img src="/images/big-data/es-06/15.jpg" alt="15"></p>
<h3 id="Scoll-API"><a href="#Scoll-API" class="headerlink" title="Scoll API"></a>Scoll API</h3><ul>
<li>创建一个快照，有新的数据写入以后，无法被查找</li>
<li>每次查询后，输入上一次的 Sroll ID</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">DELETE users</span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"user1"</span>,<span class="attr">"age"</span>:<span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"user2"</span>,<span class="attr">"age"</span>:<span class="number">20</span>&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"user3"</span>,<span class="attr">"age"</span>:<span class="number">30</span>&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"user4"</span>,<span class="attr">"age"</span>:<span class="number">40</span>&#125;</span><br><span class="line"></span><br><span class="line">POST /users/_search?scroll=5m</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match_all"</span> : &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;<span class="attr">"name"</span>:<span class="string">"user5"</span>,<span class="attr">"age"</span>:<span class="number">50</span>&#125;</span><br><span class="line">POST /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"scroll"</span> : <span class="string">"1m"</span>,</span><br><span class="line">    <span class="attr">"scroll_id"</span> : <span class="string">"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ=="</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不同的搜索类型和使用场景"><a href="#不同的搜索类型和使用场景" class="headerlink" title="不同的搜索类型和使用场景"></a>不同的搜索类型和使用场景</h3><ul>
<li>Regular<ul>
<li>需要实时获取顶部的部分文档。例如查询最新的订单</li>
</ul>
</li>
<li>Scorll<ul>
<li>需要全部文档，例如导出全部数据</li>
</ul>
</li>
<li>Pagination<ul>
<li>From 和 Size</li>
</ul>
</li>
<li>如何需要深度分页，则选用 Search After</li>
</ul>
<h2 id="处理并发读写操作"><a href="#处理并发读写操作" class="headerlink" title="处理并发读写操作"></a>处理并发读写操作</h2><h3 id="并发控制的必要性"><a href="#并发控制的必要性" class="headerlink" title="并发控制的必要性"></a>并发控制的必要性</h3><ul>
<li>两个 Web 程序同时更新某个文档，如果缺乏有效的并发，会导致更改的数据丢失</li>
<li>悲观并发控制<ul>
<li>假定有变更冲突的可能，会对资源加锁，防止冲突。例如数据库行锁</li>
</ul>
</li>
<li>乐观并发控制<ul>
<li>假设突然是不会发生的，不会阻塞正在尝试的操作。如果数据在读写中被修改，更新将会失败。应用程序决定如何解决冲突，例如重试更新，使用新的数据，或者将错误报告给用户</li>
</ul>
</li>
<li>ES 采用的乐观并发控制</li>
</ul>
<p><img src="/images/big-data/es-06/16.jpg" alt="16"></p>
<h3 id="ES-的乐观并发控制"><a href="#ES-的乐观并发控制" class="headerlink" title="ES 的乐观并发控制"></a>ES 的乐观并发控制</h3><ul>
<li>ES 中的文档是不可变更的。如果你更新一个文档，会将会文档标记为删除，同时增加一个全新当文档，同时文档的 version 字段加 1</li>
<li>内部版本控制<ul>
<li>If_seq_no + If_primary_term</li>
</ul>
</li>
<li>使用外部版本（使用其他数据库作为主要数据存储）<ul>
<li>version + version_type = external</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/17.jpg" alt="17"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DELETE products</span><br><span class="line">PUT products</span><br><span class="line">PUT products/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"iphone"</span>,</span><br><span class="line">  <span class="attr">"count"</span>:<span class="number">100</span></span><br><span class="line">&#125;</span><br><span class="line">GET products/_doc/1</span><br><span class="line"><span class="comment">//只能执行一次</span></span><br><span class="line">PUT products/_doc/1?if_seq_no=0&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"iphone"</span>,</span><br><span class="line">  <span class="attr">"count"</span>:<span class="number">110</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//数据库版本号为主</span></span><br><span class="line">PUT products/_doc/1?version=23&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"iphone"</span>,</span><br><span class="line">  <span class="attr">"count"</span>:<span class="number">130</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Bucket-amp-Metric-聚合分析及嵌套聚合"><a href="#Bucket-amp-Metric-聚合分析及嵌套聚合" class="headerlink" title="Bucket &amp; Metric 聚合分析及嵌套聚合"></a>Bucket &amp; Metric 聚合分析及嵌套聚合</h2><h3 id="Bucket-amp-Metric-Aggregation"><a href="#Bucket-amp-Metric-Aggregation" class="headerlink" title="Bucket &amp; Metric Aggregation"></a>Bucket &amp; Metric Aggregation</h3><ul>
<li>Metric 一些系列的统计方法</li>
<li>Bucket 一组满足条件的文档</li>
</ul>
<p><img src="/images/big-data/es-06/18.jpg" alt="18"></p>
<h3 id="Aggregation-的语法"><a href="#Aggregation-的语法" class="headerlink" title="Aggregation 的语法"></a>Aggregation 的语法</h3><p>Aggregation 属于 Search 的一部分。一般情况下，建议将其 Size 指定为 0</p>
<p><img src="/images/big-data/es-06/19.jpg" alt="19"></p>
<p><strong>例子: 工资统计信息</strong></p>
<p><img src="/images/big-data/es-06/20.jpg" alt="20"></p>
<h3 id="Mertric-Aggregation"><a href="#Mertric-Aggregation" class="headerlink" title="Mertric Aggregation"></a>Mertric Aggregation</h3><ul>
<li>单值分析：只输出一个分析结果<ul>
<li>min，max，avg，sum</li>
<li>Cardinality（类似 distinct Count）</li>
</ul>
</li>
<li>多值分析：输出多个分析结果<ul>
<li>stats, extended stats</li>
<li>percentile, percentile rank</li>
<li>top hits （排在前面的示例）</li>
</ul>
</li>
</ul>
<h3 id="Metric-聚合的具体-Demo"><a href="#Metric-聚合的具体-Demo" class="headerlink" title="Metric 聚合的具体 Demo"></a>Metric 聚合的具体 Demo</h3><ul>
<li>查看最低工资</li>
<li>查看最高工资</li>
<li>一个聚合输出多个值</li>
<li>一次查询包含多个聚合<ul>
<li>同时查看最低, 最高和平均工资</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">DELETE /employees</span><br><span class="line">PUT /employees/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"properties"</span> : &#123;</span><br><span class="line">        <span class="attr">"age"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"gender"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"job"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="attr">"ignore_above"</span> : <span class="number">50</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"name"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"salary"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"integer"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /employees/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"1"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Emma"</span>,<span class="attr">"age"</span>:<span class="number">32</span>,<span class="attr">"job"</span>:<span class="string">"Product Manager"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>:<span class="number">35000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"2"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Underwood"</span>,<span class="attr">"age"</span>:<span class="number">41</span>,<span class="attr">"job"</span>:<span class="string">"Dev Manager"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">50000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"3"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Tran"</span>,<span class="attr">"age"</span>:<span class="number">25</span>,<span class="attr">"job"</span>:<span class="string">"Web Designer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>:<span class="number">18000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"4"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Rivera"</span>,<span class="attr">"age"</span>:<span class="number">26</span>,<span class="attr">"job"</span>:<span class="string">"Web Designer"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>: <span class="number">22000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"5"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Rose"</span>,<span class="attr">"age"</span>:<span class="number">25</span>,<span class="attr">"job"</span>:<span class="string">"QA"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>:<span class="number">18000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"6"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Lucy"</span>,<span class="attr">"age"</span>:<span class="number">31</span>,<span class="attr">"job"</span>:<span class="string">"QA"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>: <span class="number">25000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"7"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Byrd"</span>,<span class="attr">"age"</span>:<span class="number">27</span>,<span class="attr">"job"</span>:<span class="string">"QA"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>:<span class="number">20000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"8"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Foster"</span>,<span class="attr">"age"</span>:<span class="number">27</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">20000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"9"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Gregory"</span>,<span class="attr">"age"</span>:<span class="number">32</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>:<span class="number">22000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"10"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Bryant"</span>,<span class="attr">"age"</span>:<span class="number">20</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">9000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"11"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Jenny"</span>,<span class="attr">"age"</span>:<span class="number">36</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>:<span class="number">38000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"12"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Mcdonald"</span>,<span class="attr">"age"</span>:<span class="number">31</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">32000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"13"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Jonthna"</span>,<span class="attr">"age"</span>:<span class="number">30</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>:<span class="number">30000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"14"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Marshall"</span>,<span class="attr">"age"</span>:<span class="number">32</span>,<span class="attr">"job"</span>:<span class="string">"Javascript Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">25000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"15"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"King"</span>,<span class="attr">"age"</span>:<span class="number">33</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>:<span class="number">28000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"16"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Mccarthy"</span>,<span class="attr">"age"</span>:<span class="number">21</span>,<span class="attr">"job"</span>:<span class="string">"Javascript Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">16000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"17"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Goodwin"</span>,<span class="attr">"age"</span>:<span class="number">25</span>,<span class="attr">"job"</span>:<span class="string">"Javascript Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">16000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"18"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Catherine"</span>,<span class="attr">"age"</span>:<span class="number">29</span>,<span class="attr">"job"</span>:<span class="string">"Javascript Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>: <span class="number">20000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"19"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Boone"</span>,<span class="attr">"age"</span>:<span class="number">30</span>,<span class="attr">"job"</span>:<span class="string">"DBA"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">30000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"20"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Kathy"</span>,<span class="attr">"age"</span>:<span class="number">29</span>,<span class="attr">"job"</span>:<span class="string">"DBA"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>: <span class="number">20000</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Metric 聚合，找到最低的工资</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"min_salary"</span>: &#123;</span><br><span class="line">      <span class="attr">"min"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Metric 聚合，找到最高的工资</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"max_salary"</span>: &#123;</span><br><span class="line">      <span class="attr">"max"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个 Metric 聚合，找到最低最高和平均工资</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"max_salary"</span>: &#123;</span><br><span class="line">      <span class="attr">"max"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"min_salary"</span>: &#123;</span><br><span class="line">      <span class="attr">"min"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">      <span class="attr">"avg"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个聚合，输出多值</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"stats_salary"</span>: &#123;</span><br><span class="line">      <span class="attr">"stats"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Bucket"><a href="#Bucket" class="headerlink" title="Bucket"></a>Bucket</h3><ul>
<li>按照一定的规则，将文档分配到不同的桶中，从而达到分类的目的。ES 提供的一些常见的 Bucket Aggregation<ul>
<li>Terms</li>
<li>数字类型</li>
<li>Range / Date Range</li>
<li>Histogram / Data Histogram</li>
</ul>
</li>
<li>支持嵌套：也就在桶里在做分桶</li>
</ul>
<p><img src="/images/big-data/es-06/21.jpg" alt="21"></p>
<h3 id="Terms-Aggregation"><a href="#Terms-Aggregation" class="headerlink" title="Terms Aggregation"></a>Terms Aggregation</h3><ul>
<li>字段需要打开 fielddata，才能进行 Terms Aggregation<ul>
<li>Keyword 默认支持 doc_values</li>
<li>Text 需要在 Mapping 中 enable ，会按照分词后的结果进行分</li>
</ul>
</li>
<li>Demo<ul>
<li>对 job 和 job.keyword 进行聚合</li>
<li>对性别进行 Terms 聚合</li>
<li>指定 bucket size</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对keword 进行聚合</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"job.keyword"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对 Text 字段进行 terms 聚合查询，失败</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"job"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对 Text 字段打开 fielddata，支持terms aggregation</span></span><br><span class="line">PUT employees/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span> : &#123;</span><br><span class="line">    <span class="attr">"job"</span>:&#123;</span><br><span class="line">       <span class="attr">"type"</span>:     <span class="string">"text"</span>,</span><br><span class="line">       <span class="attr">"fielddata"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"cardinate"</span>: &#123;</span><br><span class="line">      <span class="attr">"cardinality"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"job"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对 性别的 keyword 进行聚合</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"gender"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"gender"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Cardinality"><a href="#Cardinality" class="headerlink" title="Cardinality"></a>Cardinality</h3><p>类似 SQL 中的 Distinct</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"cardinate"</span>: &#123;</span><br><span class="line">      <span class="attr">"cardinality"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"job.keyword"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Bucket-Size-amp-Top-Hists-Demo"><a href="#Bucket-Size-amp-Top-Hists-Demo" class="headerlink" title="Bucket Size &amp; Top Hists Demo"></a>Bucket Size &amp; Top Hists Demo</h3><ul>
<li>应用场景：当后去分桶后，桶内最匹配的顶部文档列表</li>
<li>Size : 按年龄分桶，找出指定数据量的分桶信息</li>
<li>Top Hits：查看各个工种中，年纪最大的 3 名员工</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定 bucket 的 size</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"ages_5"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"age"</span>,</span><br><span class="line">        <span class="attr">"size"</span>:<span class="number">3</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定size，不同工种中，年纪最大的3个员工的具体信息</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"job.keyword"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">        <span class="attr">"old_employee"</span>:&#123;</span><br><span class="line">          <span class="attr">"top_hits"</span>:&#123;</span><br><span class="line">            <span class="attr">"size"</span>:<span class="number">3</span>,</span><br><span class="line">            <span class="attr">"sort"</span>:[</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">"age"</span>:&#123;</span><br><span class="line">                  <span class="attr">"order"</span>:<span class="string">"desc"</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="优化-Terms-聚合的性能"><a href="#优化-Terms-聚合的性能" class="headerlink" title="优化 Terms 聚合的性能"></a>优化 Terms 聚合的性能</h3><p>在聚合经常发生，性能高的，索引不断写入</p>
<p><img src="/images/big-data/es-06/22.jpg" alt="22"></p>
<blockquote>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/tune-for-search-speed.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/tune-for-search-speed.html</a></p>
</blockquote>
<h3 id="Range-amp-Histogram-聚合"><a href="#Range-amp-Histogram-聚合" class="headerlink" title="Range &amp; Histogram 聚合"></a>Range &amp; Histogram 聚合</h3><ul>
<li>按照数字的范围，进行分桶</li>
<li>在 Range Aggregation 中，可以自定义 Key</li>
<li>Demo：<ul>
<li>按照工资的 Range 分桶</li>
<li>按照工资的间隔（Histogram）分桶</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Salary Ranges 分桶，可以自己定义 key</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"salary_range"</span>: &#123;</span><br><span class="line">      <span class="attr">"range"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"salary"</span>,</span><br><span class="line">        <span class="attr">"ranges"</span>:[</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"to"</span>:<span class="number">10000</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"from"</span>:<span class="number">10000</span>,</span><br><span class="line">            <span class="attr">"to"</span>:<span class="number">20000</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"key"</span>:<span class="string">"&gt;20000"</span>,</span><br><span class="line">            <span class="attr">"from"</span>:<span class="number">20000</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Salary Histogram,工资0到10万，以 5000一个区间进行分桶</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"salary_histrogram"</span>: &#123;</span><br><span class="line">      <span class="attr">"histogram"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"salary"</span>,</span><br><span class="line">        <span class="attr">"interval"</span>:<span class="number">5000</span>,</span><br><span class="line">        <span class="attr">"extended_bounds"</span>:&#123;</span><br><span class="line">          <span class="attr">"min"</span>:<span class="number">0</span>,</span><br><span class="line">          <span class="attr">"max"</span>:<span class="number">100000</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Bucket-Metric-Aggregation"><a href="#Bucket-Metric-Aggregation" class="headerlink" title="Bucket + Metric Aggregation"></a>Bucket + Metric Aggregation</h3><ul>
<li>Bucket 聚合分析允许通过添加子聚合分析进一步分析，子聚合分析可以是<ul>
<li>Bucket</li>
<li>Metric</li>
</ul>
</li>
<li>Demo<ul>
<li>按照工作类型进行分桶，并统计工资信息</li>
<li>先按照工作类型分桶，然后按性别分桶，并统计工资信息</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 嵌套聚合1，按照工作类型分桶，并统计工资信息</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"Job_salary_stats"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"job.keyword"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"salary"</span>: &#123;</span><br><span class="line">          <span class="attr">"stats"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"Job_gender_stats"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"job.keyword"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"gender_stats"</span>: &#123;</span><br><span class="line">          <span class="attr">"terms"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"gender"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">            <span class="attr">"salary_stats"</span>: &#123;</span><br><span class="line">              <span class="attr">"stats"</span>: &#123;</span><br><span class="line">                <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Pipeline-聚合分析"><a href="#Pipeline-聚合分析" class="headerlink" title="Pipeline 聚合分析"></a>Pipeline 聚合分析</h2><h3 id="一个例子：Pipeline：min-bucket"><a href="#一个例子：Pipeline：min-bucket" class="headerlink" title="一个例子：Pipeline：min_bucket"></a>一个例子：Pipeline：min_bucket</h3><ul>
<li>在员工数最多的工种里，找出平均工资最低的工种</li>
</ul>
<p><img src="/images/big-data/es-06/23.jpg" alt="23"></p>
<h3 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h3><ul>
<li>管道的概念：支持对聚合分析的结果，再次进行聚合分析</li>
<li>Pipeline 的分析结果会输出到原结果汇总，根据位置的不同，分为两类<ul>
<li>Sibling - 结果和现有分析结果同级<ul>
<li>Max, min, Avg &amp; Sum Bucket</li>
<li>Stats, Extened Status Bucket</li>
<li>Percentiles Bucket</li>
</ul>
</li>
<li>Parent - 结果内嵌到现有的聚合分析结果之中<ul>
<li>Derivative（求导）</li>
<li>Cumultive Sum（累计求和）</li>
<li>Moving Function（滑动窗口）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Sibling-Pipeline-的例子"><a href="#Sibling-Pipeline-的例子" class="headerlink" title="Sibling Pipeline 的例子"></a>Sibling Pipeline 的例子</h3><ul>
<li>对不同类型工作的，平均工资<ul>
<li>求最大</li>
<li>平均</li>
<li>统计信息</li>
<li>百分位数</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">DELETE employees</span><br><span class="line">PUT /employees/_bulk</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"1"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Emma"</span>,<span class="attr">"age"</span>:<span class="number">32</span>,<span class="attr">"job"</span>:<span class="string">"Product Manager"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>:<span class="number">35000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"2"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Underwood"</span>,<span class="attr">"age"</span>:<span class="number">41</span>,<span class="attr">"job"</span>:<span class="string">"Dev Manager"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">50000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"3"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Tran"</span>,<span class="attr">"age"</span>:<span class="number">25</span>,<span class="attr">"job"</span>:<span class="string">"Web Designer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>:<span class="number">18000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"4"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Rivera"</span>,<span class="attr">"age"</span>:<span class="number">26</span>,<span class="attr">"job"</span>:<span class="string">"Web Designer"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>: <span class="number">22000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"5"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Rose"</span>,<span class="attr">"age"</span>:<span class="number">25</span>,<span class="attr">"job"</span>:<span class="string">"QA"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>:<span class="number">18000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"6"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Lucy"</span>,<span class="attr">"age"</span>:<span class="number">31</span>,<span class="attr">"job"</span>:<span class="string">"QA"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>: <span class="number">25000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"7"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Byrd"</span>,<span class="attr">"age"</span>:<span class="number">27</span>,<span class="attr">"job"</span>:<span class="string">"QA"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>:<span class="number">20000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"8"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Foster"</span>,<span class="attr">"age"</span>:<span class="number">27</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">20000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"9"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Gregory"</span>,<span class="attr">"age"</span>:<span class="number">32</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>:<span class="number">22000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"10"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Bryant"</span>,<span class="attr">"age"</span>:<span class="number">20</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">9000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"11"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Jenny"</span>,<span class="attr">"age"</span>:<span class="number">36</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>:<span class="number">38000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"12"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Mcdonald"</span>,<span class="attr">"age"</span>:<span class="number">31</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">32000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"13"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Jonthna"</span>,<span class="attr">"age"</span>:<span class="number">30</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>:<span class="number">30000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"14"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Marshall"</span>,<span class="attr">"age"</span>:<span class="number">32</span>,<span class="attr">"job"</span>:<span class="string">"Javascript Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">25000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"15"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"King"</span>,<span class="attr">"age"</span>:<span class="number">33</span>,<span class="attr">"job"</span>:<span class="string">"Java Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>:<span class="number">28000</span> &#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"16"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Mccarthy"</span>,<span class="attr">"age"</span>:<span class="number">21</span>,<span class="attr">"job"</span>:<span class="string">"Javascript Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">16000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"17"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Goodwin"</span>,<span class="attr">"age"</span>:<span class="number">25</span>,<span class="attr">"job"</span>:<span class="string">"Javascript Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">16000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"18"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Catherine"</span>,<span class="attr">"age"</span>:<span class="number">29</span>,<span class="attr">"job"</span>:<span class="string">"Javascript Programmer"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>: <span class="number">20000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"19"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Boone"</span>,<span class="attr">"age"</span>:<span class="number">30</span>,<span class="attr">"job"</span>:<span class="string">"DBA"</span>,<span class="attr">"gender"</span>:<span class="string">"male"</span>,<span class="attr">"salary"</span>: <span class="number">30000</span>&#125;</span><br><span class="line">&#123; <span class="attr">"index"</span> : &#123;  <span class="attr">"_id"</span> : <span class="string">"20"</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">"name"</span> : <span class="string">"Kathy"</span>,<span class="attr">"age"</span>:<span class="number">29</span>,<span class="attr">"job"</span>:<span class="string">"DBA"</span>,<span class="attr">"gender"</span>:<span class="string">"female"</span>,<span class="attr">"salary"</span>: <span class="number">20000</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 平均工资最低的工作类型</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"job.keyword"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">          <span class="attr">"avg"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"min_salary_by_job"</span>:&#123;</span><br><span class="line">      <span class="attr">"min_bucket"</span>: &#123;</span><br><span class="line">        <span class="attr">"buckets_path"</span>: <span class="string">"jobs&gt;avg_salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平均工资最高的工作类型</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"job.keyword"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">          <span class="attr">"avg"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"max_salary_by_job"</span>:&#123;</span><br><span class="line">      <span class="attr">"max_bucket"</span>: &#123;</span><br><span class="line">        <span class="attr">"buckets_path"</span>: <span class="string">"jobs&gt;avg_salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平均工资的平均工资</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"job.keyword"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">          <span class="attr">"avg"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"avg_salary_by_job"</span>:&#123;</span><br><span class="line">      <span class="attr">"avg_bucket"</span>: &#123;</span><br><span class="line">        <span class="attr">"buckets_path"</span>: <span class="string">"jobs&gt;avg_salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平均工资的统计分析</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"job.keyword"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">          <span class="attr">"avg"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"stats_salary_by_job"</span>:&#123;</span><br><span class="line">      <span class="attr">"stats_bucket"</span>: &#123;</span><br><span class="line">        <span class="attr">"buckets_path"</span>: <span class="string">"jobs&gt;avg_salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平均工资的百分位数</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"job.keyword"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">          <span class="attr">"avg"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"percentiles_salary_by_job"</span>:&#123;</span><br><span class="line">      <span class="attr">"percentiles_bucket"</span>: &#123;</span><br><span class="line">        <span class="attr">"buckets_path"</span>: <span class="string">"jobs&gt;avg_salary"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Parent-Pipeline-Derivative"><a href="#Parent-Pipeline-Derivative" class="headerlink" title="Parent Pipeline: Derivative"></a>Parent Pipeline: Derivative</h3><p>按年龄、对工资进行求导（看工资发展的趋势）</p>
<p><img src="/images/big-data/es-06/24.jpg" alt="24"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按照年龄对平均工资求导 </span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">"aggs"</span>: &#123;</span><br><span class="line">  <span class="attr">"age"</span>: &#123;</span><br><span class="line">    <span class="attr">"histogram"</span>: &#123;</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"age"</span>,</span><br><span class="line">      <span class="attr">"min_doc_count"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"interval"</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">      <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">        <span class="attr">"avg"</span>: &#123;</span><br><span class="line">          <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"derivative_avg_salary"</span>:&#123;</span><br><span class="line">        <span class="attr">"derivative"</span>: &#123;</span><br><span class="line">          <span class="attr">"buckets_path"</span>: <span class="string">"avg_salary"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//return </span></span><br><span class="line">"aggregations" : &#123;</span><br><span class="line">  "age" : &#123;</span><br><span class="line">    "buckets" : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"key"</span> : <span class="number">20.0</span>,</span><br><span class="line">        <span class="attr">"doc_count"</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"avg_salary"</span> : &#123;</span><br><span class="line">          <span class="attr">"value"</span> : <span class="number">9000.0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"key"</span> : <span class="number">21.0</span>,</span><br><span class="line">        <span class="attr">"doc_count"</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"avg_salary"</span> : &#123;</span><br><span class="line">          <span class="attr">"value"</span> : <span class="number">16000.0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"derivative_avg_salary"</span> : &#123;</span><br><span class="line">          <span class="attr">"value"</span> : <span class="number">7000.0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Parent-Pipeline"><a href="#Parent-Pipeline" class="headerlink" title="Parent Pipeline"></a>Parent Pipeline</h3><ul>
<li>年龄直方图划分的平均工资<ul>
<li>Cumulative Sum</li>
<li>Moving Function</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cumulative_sum</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"age"</span>: &#123;</span><br><span class="line">      <span class="attr">"histogram"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"age"</span>,</span><br><span class="line">        <span class="attr">"min_doc_count"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"interval"</span>: <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">          <span class="attr">"avg"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cumulative_salary"</span>:&#123;</span><br><span class="line">          <span class="attr">"cumulative_sum"</span>: &#123;</span><br><span class="line">            <span class="attr">"buckets_path"</span>: <span class="string">"avg_salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Moving Function</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"age"</span>: &#123;</span><br><span class="line">      <span class="attr">"histogram"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"age"</span>,</span><br><span class="line">        <span class="attr">"min_doc_count"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"interval"</span>: <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">          <span class="attr">"avg"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"moving_avg_salary"</span>:&#123;</span><br><span class="line">          <span class="attr">"moving_fn"</span>: &#123;</span><br><span class="line">            <span class="attr">"buckets_path"</span>: <span class="string">"avg_salary"</span>,</span><br><span class="line">            <span class="attr">"window"</span>:<span class="number">10</span>,</span><br><span class="line">            <span class="attr">"script"</span>: <span class="string">"MovingFunctions.min(values)"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="聚合的作用范围及排序"><a href="#聚合的作用范围及排序" class="headerlink" title="聚合的作用范围及排序"></a>聚合的作用范围及排序</h2><h3 id="聚合的作用范围"><a href="#聚合的作用范围" class="headerlink" title="聚合的作用范围"></a>聚合的作用范围</h3><ul>
<li>ES 聚合分析的默认作用范围是 query 的查询结果集</li>
<li>同时 ES 还支持以下方式改变聚合的作用范围<ul>
<li>Filter</li>
<li>Post_Filter</li>
<li>Global</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Query</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"range"</span>: &#123;</span><br><span class="line">      <span class="attr">"age"</span>: &#123;</span><br><span class="line">        <span class="attr">"gte"</span>: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"job.keyword"</span></span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p><img src="/images/big-data/es-06/25.jpg" alt="25"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Filter</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"older_person"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>:&#123;</span><br><span class="line">        <span class="attr">"range"</span>:&#123;</span><br><span class="line">          <span class="attr">"age"</span>:&#123;</span><br><span class="line">            <span class="attr">"from"</span>:<span class="number">35</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">         <span class="attr">"jobs"</span>:&#123;</span><br><span class="line">           <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"job.keyword"</span></span><br><span class="line">      &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    <span class="attr">"all_jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"job.keyword"</span></span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Post-Filter"><a href="#Post-Filter" class="headerlink" title="Post_Filter"></a>Post_Filter</h3><ul>
<li>是对聚合分析后的文档进行再次过滤</li>
<li>Size 无需设置为 0</li>
<li>使用场景<ul>
<li>一条语句，获取聚合信息 + 获取符合条件的文档</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"job.keyword"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"post_filter"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"job.keyword"</span>: <span class="string">"Dev Manager"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Global"><a href="#Global" class="headerlink" title="Global"></a>Global</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// global</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"range"</span>: &#123;</span><br><span class="line">      <span class="attr">"age"</span>: &#123;</span><br><span class="line">        <span class="attr">"gte"</span>: <span class="number">40</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"job.keyword"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"all"</span>:&#123;</span><br><span class="line">      <span class="attr">"global"</span>: &#123;&#125;, <span class="comment">// Golbal，无视query，对全部文档进行统计</span></span><br><span class="line">      <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">        <span class="attr">"salary_avg"</span>:&#123;</span><br><span class="line">          <span class="attr">"avg"</span>:&#123;</span><br><span class="line">            <span class="attr">"field"</span>:<span class="string">"salary"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="排序-1"><a href="#排序-1" class="headerlink" title="排序"></a>排序</h3><ul>
<li>指定 order，按照 count 和 key 排序<ul>
<li>默认情况，按照 count 降序排序</li>
<li>指定 size，就能返回相应的桶</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 排序 order</span></span><br><span class="line"><span class="comment">// count正序 and key倒叙</span></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line">  <span class="attr">"range"</span>: &#123;</span><br><span class="line">    <span class="attr">"age"</span>: &#123;</span><br><span class="line">      <span class="attr">"gte"</span>: <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"aggs"</span>: &#123;</span><br><span class="line">  <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">    <span class="attr">"terms"</span>: &#123;</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"job.keyword"</span>,</span><br><span class="line">      <span class="attr">"order"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"_count"</span>: <span class="string">"asc"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"_key"</span>: <span class="string">"desc"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基于子聚合的值排序"><a href="#基于子聚合的值排序" class="headerlink" title="基于子聚合的值排序"></a>基于子聚合的值排序</h3><ul>
<li>基于子聚合的数值进行排序</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">"aggs"</span>: &#123;</span><br><span class="line">  <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">    <span class="attr">"terms"</span>: &#123;</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"job.keyword"</span>,</span><br><span class="line">      <span class="attr">"order"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"avg_salary"</span>: <span class="string">"desc"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">      <span class="attr">"avg_salary"</span>: &#123;</span><br><span class="line">        <span class="attr">"avg"</span>: &#123;</span><br><span class="line">          <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用子聚合，Aggregation name</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">"aggs"</span>: &#123;</span><br><span class="line">  <span class="attr">"jobs"</span>: &#123;</span><br><span class="line">    <span class="attr">"terms"</span>: &#123;</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"job.keyword"</span>,</span><br><span class="line">      <span class="attr">"order"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"stats_salary.min"</span>: <span class="string">"desc"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">      <span class="attr">"stats_salary"</span>: &#123;</span><br><span class="line">        <span class="attr">"stats"</span>: &#123;</span><br><span class="line">          <span class="attr">"field"</span>: <span class="string">"salary"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="聚合分析的原理及精准度问题"><a href="#聚合分析的原理及精准度问题" class="headerlink" title="聚合分析的原理及精准度问题"></a>聚合分析的原理及精准度问题</h2><h3 id="分布式系统的近似统计算法"><a href="#分布式系统的近似统计算法" class="headerlink" title="分布式系统的近似统计算法"></a>分布式系统的近似统计算法</h3><p><img src="/images/big-data/es-06/26.jpg" alt="26"></p>
<h3 id="Min-聚合分析的执行流程"><a href="#Min-聚合分析的执行流程" class="headerlink" title="Min 聚合分析的执行流程"></a>Min 聚合分析的执行流程</h3><p><img src="/images/big-data/es-06/28.jpg" alt="28"></p>
<h3 id="Terms-Aggregation-的返回值"><a href="#Terms-Aggregation-的返回值" class="headerlink" title="Terms Aggregation 的返回值"></a>Terms Aggregation 的返回值</h3><ul>
<li>在 Terms Aggregation 的返回中有两个特殊的数值<ul>
<li>doc_count_error_upper_bound：被遗漏的 term 分桶，包含的文档，有可能的最大值</li>
<li>sum_other_doc_count: 除了返回结果 bucket 的 terms 以外，其他 terms 的文档总数（总数 - 返回的总数）</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/29.jpg" alt="29"></p>
<h3 id="Terms-聚合分析的执行流程"><a href="#Terms-聚合分析的执行流程" class="headerlink" title="Terms 聚合分析的执行流程"></a>Terms 聚合分析的执行流程</h3><p><img src="/images/big-data/es-06/30.jpg" alt="30"></p>
<h3 id="Terms-不正确的案例"><a href="#Terms-不正确的案例" class="headerlink" title="Terms 不正确的案例"></a>Terms 不正确的案例</h3><p><img src="/images/big-data/es-06/31.jpg" alt="31"></p>
<h3 id="如何解决-Terms-不准的问题：提升-shard-size-的参数"><a href="#如何解决-Terms-不准的问题：提升-shard-size-的参数" class="headerlink" title="如何解决 Terms 不准的问题：提升 shard_size 的参数"></a>如何解决 Terms 不准的问题：提升 shard_size 的参数</h3><ul>
<li>Terms 聚合分析不准的原因，数据分散在多个分片上，Coordinating Node 无法获取数据全貌</li>
<li>解决方案 1：当数据量不大时，设置 Primary Shard 为 1；实现准确性</li>
<li>解决方案 2：在分布式数据上，设置 shard_size 参数，提高精确度<ul>
<li>原理：每次从 Shard 上额外多获取数据，提升准确率</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/32.jpg" alt="32"></p>
<h3 id="打开-show-term-doc-count-error"><a href="#打开-show-term-doc-count-error" class="headerlink" title="打开 show_term_doc_count_error"></a>打开 show_term_doc_count_error</h3><p><img src="/images/big-data/es-06/33.jpg" alt="33"></p>
<h3 id="shard-size-设定"><a href="#shard-size-设定" class="headerlink" title="shard_size 设定"></a>shard_size 设定</h3><ul>
<li>调整 shard size 大小，降低 doc_count_error_upper_bound 来提升准确度<ul>
<li>增加整体计算量，提高了准确率，但会降低相应时间</li>
</ul>
</li>
<li>Shard Size 默认大小设定<ul>
<li>shard size = size * 1.5 +10</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.2/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-approximate-counts" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.2/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-approximate-counts</a></li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_flights</span><br><span class="line">PUT my_flights</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"number_of_shards"</span>: <span class="number">20</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"properties"</span> : &#123;</span><br><span class="line">        <span class="attr">"AvgTicketPrice"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"float"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Cancelled"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"boolean"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Carrier"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Dest"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"DestAirportID"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"DestCityName"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"DestCountry"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"DestLocation"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"geo_point"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"DestRegion"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"DestWeather"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"DistanceKilometers"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"float"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"DistanceMiles"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"float"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"FlightDelay"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"boolean"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"FlightDelayMin"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"FlightDelayType"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"FlightNum"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"FlightTimeHour"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"FlightTimeMin"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"float"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Origin"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"OriginAirportID"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"OriginCityName"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"OriginCountry"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"OriginLocation"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"geo_point"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"OriginRegion"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"OriginWeather"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"dayOfWeek"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"timestamp"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"date"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"source"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"kibana_sample_data_flights"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dest"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"my_flights"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET kibana_sample_data_flights/_count</span><br><span class="line">GET my_flights/_count</span><br><span class="line"></span><br><span class="line">get kibana_sample_data_flights/_search</span><br><span class="line"></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"weather"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"OriginWeather"</span>,</span><br><span class="line">        <span class="attr">"size"</span>:<span class="number">5</span>,</span><br><span class="line">        <span class="attr">"show_term_doc_count_error"</span>:<span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"weather"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"OriginWeather"</span>,</span><br><span class="line">        <span class="attr">"size"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"shard_size"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"show_term_doc_count_error"</span>:<span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="对象及-Nested-对象"><a href="#对象及-Nested-对象" class="headerlink" title="对象及 Nested 对象"></a>对象及 Nested 对象</h2><h3 id="数据的关联关系"><a href="#数据的关联关系" class="headerlink" title="数据的关联关系"></a>数据的关联关系</h3><ul>
<li>真实世界中有很多重要的关联关系<ul>
<li>博客、作者、评论</li>
<li>银行账户有多次交易记录</li>
<li>客户有很多银行账户</li>
<li>目录文件有很多文件和子目录</li>
</ul>
</li>
</ul>
<h3 id="关系型数据库的范式化设计"><a href="#关系型数据库的范式化设计" class="headerlink" title="关系型数据库的范式化设计"></a>关系型数据库的范式化设计</h3><ul>
<li>范式化设计（Normalization）的主要目标是 “减少不必要的更新”</li>
<li>副作用：一个完全范式化设计的数据库经常面临 “查询缓慢” 的问题<ul>
<li>数据库越范式化，就需要 Join 越多的表</li>
</ul>
</li>
<li>范式化节省了储存空间，但是储存空间越来越便宜</li>
<li>范式化简化了更新，但是数据 “读” 取操作可能越多</li>
</ul>
<p><img src="/images/big-data/es-06/34.jpg" alt="34"></p>
<h3 id="Denormalization"><a href="#Denormalization" class="headerlink" title="Denormalization"></a>Denormalization</h3><ul>
<li>反范式化设计<ul>
<li>数据 “Flattening”, 不使用关联关系，而是在文档中保存冗余的数据拷贝</li>
</ul>
</li>
<li>优点：无需处理 Joins 操作，数据读取性能好<ul>
<li>Elasticsearch 通过压缩_source 字段，减少磁盘空间的开销</li>
</ul>
</li>
<li>缺点：不适合在数据频繁修改的场景<ul>
<li>一条数据（用户名）的改动，可能会引起很多数据的更新</li>
</ul>
</li>
</ul>
<h3 id="在-Elasticsearch-中处理关联关系"><a href="#在-Elasticsearch-中处理关联关系" class="headerlink" title="在 Elasticsearch 中处理关联关系"></a>在 Elasticsearch 中处理关联关系</h3><ul>
<li>关系型数据库，一般会考虑 Normalize 数据；在 Elasticsearch，往往考虑 Denormalize 数据<ul>
<li>Denormalize 的好处：读的速度变快、无需表连接、无需行锁</li>
</ul>
</li>
<li>Elasticsearch 并不擅长处理关联关系，我们一般采用以下四种方法处理关联<ul>
<li>对象类型</li>
<li>嵌套对象（Nested Object）</li>
<li>父子关联关系（Parent / Child）</li>
<li>应用端关联</li>
</ul>
</li>
</ul>
<h3 id="案例-1：博客和其作者信息"><a href="#案例-1：博客和其作者信息" class="headerlink" title="案例 1：博客和其作者信息"></a>案例 1：博客和其作者信息</h3><ul>
<li>对象类型<ul>
<li>在每个博客的问下中都保留作者的信息</li>
<li>如果作者信息发生变化，需要修改相关的博客文档</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">DELETE blog</span><br><span class="line"><span class="comment">// 设置blog的 Mapping</span></span><br><span class="line">PUT /blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"content"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"time"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"date"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"user"</span>: &#123;</span><br><span class="line">        <span class="attr">"properties"</span>: &#123;</span><br><span class="line">          <span class="attr">"city"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"userid"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"username"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入一条 Blog 信息</span></span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"I like Elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"time"</span>:<span class="string">"2019-01-01T00:00:00"</span>,</span><br><span class="line">  <span class="attr">"user"</span>:&#123;</span><br><span class="line">    <span class="attr">"userid"</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attr">"username"</span>:<span class="string">"Jack"</span>,</span><br><span class="line">    <span class="attr">"city"</span>:<span class="string">"Shanghai"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过一条查询语句即可获取到博客和作者信息</span></span><br><span class="line"><span class="comment">// 查询 Blog 信息</span></span><br><span class="line">POST blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        &#123;<span class="attr">"match"</span>: &#123;<span class="attr">"content"</span>: <span class="string">"Elasticsearch"</span>&#125;&#125;,</span><br><span class="line">        &#123;<span class="attr">"match"</span>: &#123;<span class="attr">"user.username"</span>: <span class="string">"Jack"</span>&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例-2：包含对象数组的文档"><a href="#案例-2：包含对象数组的文档" class="headerlink" title="案例 2：包含对象数组的文档"></a>案例 2：包含对象数组的文档</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_movies</span><br><span class="line"><span class="comment">// 电影的Mapping信息</span></span><br><span class="line">PUT my_movies</span><br><span class="line">&#123;</span><br><span class="line">      <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"properties"</span> : &#123;</span><br><span class="line">        <span class="attr">"actors"</span> : &#123;</span><br><span class="line">          <span class="attr">"properties"</span> : &#123;</span><br><span class="line">            <span class="attr">"first_name"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"last_name"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"title"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入一条电影信息</span></span><br><span class="line">POST my_movies/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"Speed"</span>,</span><br><span class="line">  <span class="attr">"actors"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"first_name"</span>:<span class="string">"Keanu"</span>,</span><br><span class="line">      <span class="attr">"last_name"</span>:<span class="string">"Reeves"</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"first_name"</span>:<span class="string">"Dennis"</span>,</span><br><span class="line">      <span class="attr">"last_name"</span>:<span class="string">"Hopper"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询电影信息</span></span><br><span class="line">POST my_movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        &#123;<span class="attr">"match"</span>: &#123;<span class="attr">"actors.first_name"</span>: <span class="string">"Keanu"</span>&#125;&#125;,</span><br><span class="line">        &#123;<span class="attr">"match"</span>: &#123;<span class="attr">"actors.last_name"</span>: <span class="string">"Hopper"</span>&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="为啥会搜到不需要的结果？"><a href="#为啥会搜到不需要的结果？" class="headerlink" title="为啥会搜到不需要的结果？"></a>为啥会搜到不需要的结果？</h3><ul>
<li>储存时，内部对象的边界没有在考虑在内，JSON 格式被处理成扁平键值对的结构</li>
<li>当对多个字段进行查询时，导致了意外的搜索结果</li>
<li>可以用 Nested Data Type 解决这个问题</li>
</ul>
<h3 id="Nested-Data-Type"><a href="#Nested-Data-Type" class="headerlink" title="Nested Data Type"></a>Nested Data Type</h3><ul>
<li>Nested 数据类型：允许对象数组中的对象被独立索引</li>
<li>使用 nested 和 properties 关键词，将所有 actors 索引到多个分隔的文档</li>
<li>在内部，Nested 文档会被保存在两个 Lucene 文档中，查询时做 Join 处理</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT my_movies</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">    <span class="attr">"properties"</span> : &#123;</span><br><span class="line">      <span class="attr">"actors"</span> : &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">        <span class="attr">"properties"</span> : &#123;</span><br><span class="line">          <span class="attr">"first_name"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"keyword"</span>&#125;,</span><br><span class="line">          <span class="attr">"last_name"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"keyword"</span>&#125;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line">      <span class="attr">"title"</span> : &#123;</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"fields"</span> : &#123;<span class="attr">"keyword"</span>:&#123;<span class="attr">"type"</span>:<span class="string">"keyword"</span>,<span class="attr">"ignore_above"</span>:<span class="number">256</span>&#125;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="嵌套查询"><a href="#嵌套查询" class="headerlink" title="嵌套查询"></a>嵌套查询</h3><p>在内部，Nested 文档被保存在两个 Lucene 文档中，会在查询时做 Join 处理</p>
<p><img src="/images/big-data/es-06/35.jpg" alt="35"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Nested 查询</span></span><br><span class="line">POST my_movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must"</span>: [</span><br><span class="line">        &#123;<span class="attr">"match"</span>: &#123;<span class="attr">"title"</span>: <span class="string">"Speed"</span>&#125;&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"nested"</span>: &#123;</span><br><span class="line">            <span class="attr">"path"</span>: <span class="string">"actors"</span>,</span><br><span class="line">            <span class="attr">"query"</span>: &#123;</span><br><span class="line">              <span class="attr">"bool"</span>: &#123;</span><br><span class="line">                <span class="attr">"must"</span>: [</span><br><span class="line">                  &#123;<span class="attr">"match"</span>: &#123;</span><br><span class="line">                    <span class="attr">"actors.first_name"</span>: <span class="string">"Keanu"</span></span><br><span class="line">                  &#125;&#125;,</span><br><span class="line">                  &#123;<span class="attr">"match"</span>: &#123;</span><br><span class="line">                    <span class="attr">"actors.last_name"</span>: <span class="string">"Hopper"</span></span><br><span class="line">                  &#125;&#125;</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//返回</span></span><br><span class="line"> "hits" : &#123;</span><br><span class="line">    "total" : &#123;</span><br><span class="line">      "value" : 0,</span><br><span class="line">      "relation" : "eq"</span><br><span class="line">    &#125;,</span><br><span class="line">    "max_score" : null,</span><br><span class="line">    "hits" : [ ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="嵌套聚合"><a href="#嵌套聚合" class="headerlink" title="嵌套聚合"></a>嵌套聚合</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># Nested Aggregation</span><br><span class="line">POST my_movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"actors"</span>: &#123;</span><br><span class="line">      <span class="attr">"nested"</span>: &#123;</span><br><span class="line">        <span class="attr">"path"</span>: <span class="string">"actors"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">        <span class="attr">"actor_name"</span>: &#123;</span><br><span class="line">          <span class="attr">"terms"</span>: &#123;</span><br><span class="line">            <span class="attr">"field"</span>: <span class="string">"actors.first_name"</span>,</span><br><span class="line">            <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 普通 aggregation不工作</span></span><br><span class="line">POST my_movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"NAME"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"actors.first_name"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="文档的父子关系"><a href="#文档的父子关系" class="headerlink" title="文档的父子关系"></a>文档的父子关系</h2><h3 id="Parent-Child"><a href="#Parent-Child" class="headerlink" title="Parent / Child"></a>Parent / Child</h3><ul>
<li>对象和 Nested 对象的局限性<ul>
<li>每次更新，需要重新索引整个对象（包括跟对象和嵌套对象）</li>
</ul>
</li>
<li>ES 提供了类似关系型数据库中 Join 的实现。使用 Join 数据类型实现，可以通过维护 Parent / Child 的关系，从而分离两个对象<ul>
<li>父文档和子文档是两个独立的文档</li>
<li>更新父文档无需重新索引整个子文档。子文档被新增，更改和删除也不会影响到父文档和其他子文档。</li>
</ul>
</li>
</ul>
<h3 id="父子关系"><a href="#父子关系" class="headerlink" title="父子关系"></a>父子关系</h3><ul>
<li>定义父子关系的几个步骤<ul>
<li>设置索引的 Mapping</li>
<li>索引父文档</li>
<li>索引子文档</li>
<li>按需查询文档</li>
</ul>
</li>
</ul>
<h3 id="设置-Mapping"><a href="#设置-Mapping" class="headerlink" title="设置 Mapping"></a>设置 Mapping</h3><p><img src="/images/big-data/es-06/36.jpg" alt="36"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_blogs</span><br><span class="line"><span class="comment">// 设定 Parent/Child Mapping</span></span><br><span class="line">PUT my_blogs</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"number_of_shards"</span>: <span class="number">2</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"blog_comments_relation"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"join"</span>,</span><br><span class="line">        <span class="attr">"relations"</span>: &#123;</span><br><span class="line">          <span class="attr">"blog"</span>: <span class="string">"comment"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"content"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"title"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="索引父文档"><a href="#索引父文档" class="headerlink" title="索引父文档"></a>索引父文档</h3><p><img src="/images/big-data/es-06/37.jpg" alt="37"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT my_blogs/_doc/blog1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"Learning Elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"learning ELK @ geektime"</span>,</span><br><span class="line">  <span class="attr">"blog_comments_relation"</span>:&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"blog"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_blogs/_doc/blog2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"Learning Hadoop"</span>,</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"learning Hadoop"</span>,</span><br><span class="line">    <span class="attr">"blog_comments_relation"</span>:&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"blog"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="索引子文档"><a href="#索引子文档" class="headerlink" title="索引子文档"></a>索引子文档</h3><ul>
<li>父文档和子文档必须存在相同的分片上<ul>
<li>确保查询 join 的性能</li>
</ul>
</li>
<li>当指定子文档时候，必须指定它的父文档 ID<ul>
<li>使用 route 参数来保证，分配到相同的分片</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/38.jpg" alt="38"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 索引子文档</span></span><br><span class="line">PUT my_blogs/_doc/comment1?routing=blog1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"comment"</span>:<span class="string">"I am learning ELK"</span>,</span><br><span class="line">  <span class="attr">"username"</span>:<span class="string">"Jack"</span>,</span><br><span class="line">  <span class="attr">"blog_comments_relation"</span>:&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"comment"</span>,</span><br><span class="line">    <span class="attr">"parent"</span>:<span class="string">"blog1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_blogs/_doc/comment2?routing=blog2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"comment"</span>:<span class="string">"I like Hadoop!!!!!"</span>,</span><br><span class="line">  <span class="attr">"username"</span>:<span class="string">"Jack"</span>,</span><br><span class="line">  <span class="attr">"blog_comments_relation"</span>:&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"comment"</span>,</span><br><span class="line">    <span class="attr">"parent"</span>:<span class="string">"blog2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_blogs/_doc/comment3?routing=blog2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"comment"</span>:<span class="string">"Hello Hadoop"</span>,</span><br><span class="line">  <span class="attr">"username"</span>:<span class="string">"Bob"</span>,</span><br><span class="line">  <span class="attr">"blog_comments_relation"</span>:&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"comment"</span>,</span><br><span class="line">    <span class="attr">"parent"</span>:<span class="string">"blog2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Parent-Child-所支持的查询"><a href="#Parent-Child-所支持的查询" class="headerlink" title="Parent / Child 所支持的查询"></a>Parent / Child 所支持的查询</h3><ul>
<li>查询所有文档</li>
<li>Parent Id 查询</li>
<li>Has Child 查询</li>
<li>Has Parent 查询</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询所有文档</span></span><br><span class="line">POST my_blogs/_search</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据父文档ID查看</span></span><br><span class="line">GET my_blogs/_doc/blog2</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parent Id 查询,返回所有子文档</span></span><br><span class="line"><span class="comment">// 查询 ID 为 blog2 父文档的所有子文档</span></span><br><span class="line">POST my_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line">  <span class="attr">"parent_id"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"comment"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"blog2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Has Child 查询，返回父文档</span></span><br><span class="line"><span class="comment">// 查询 user 包含 Jack 的所有子文档的父文档</span></span><br><span class="line">POST my_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line">  <span class="attr">"has_child"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"comment"</span>,</span><br><span class="line">    <span class="attr">"query"</span> : &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">              <span class="attr">"username"</span> : <span class="string">"Jack"</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Has Parent 查询，返回相关的子文档</span></span><br><span class="line"><span class="comment">// 查询 title 包含 Learning Hadoop 的父文档的所有子文档</span></span><br><span class="line">POST my_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">"query"</span>: &#123;</span><br><span class="line">  <span class="attr">"has_parent"</span>: &#123;</span><br><span class="line">    <span class="attr">"parent_type"</span>: <span class="string">"blog"</span>,</span><br><span class="line">    <span class="attr">"query"</span> : &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">              <span class="attr">"title"</span> : <span class="string">"Learning Hadoop"</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-has-child-查询"><a href="#使用-has-child-查询" class="headerlink" title="使用 has_child 查询"></a>使用 has_child 查询</h3><ul>
<li>返回父文档</li>
<li>通过对子文档进行查询<ul>
<li>返回具体相关子文档的父文档</li>
<li>父子文档在相同的分片上，因此 Join 效率高</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/39.jpg" alt="39"></p>
<h3 id="使用-has-parent-查询"><a href="#使用-has-parent-查询" class="headerlink" title="使用 has_parent 查询"></a>使用 has_parent 查询</h3><ul>
<li>返回相关性的子文档</li>
<li>通过对父文档进行查询<ul>
<li>返回相关的子文档</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/40.jpg" alt="40"></p>
<h3 id="使用-parent-id-查询"><a href="#使用-parent-id-查询" class="headerlink" title="使用 parent_id 查询"></a>使用 parent_id 查询</h3><ul>
<li>返回所有相关子文档</li>
<li>通过对付文档 Id 进行查询<ul>
<li>返回所有相关的子文档</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/41.jpg" alt="41"></p>
<h3 id="访问子文档"><a href="#访问子文档" class="headerlink" title="访问子文档"></a>访问子文档</h3><p>需指定父文档 routing 参数</p>
<p><img src="/images/big-data/es-06/42.jpg" alt="42"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过ID ，访问子文档</span></span><br><span class="line">GET my_blogs/_doc/comment2</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过ID和routing ，访问子文档</span></span><br><span class="line">GET my_blogs/_doc/comment3?routing=blog2</span><br></pre></td></tr></table></figure>

<h3 id="更新子文档"><a href="#更新子文档" class="headerlink" title="更新子文档"></a>更新子文档</h3><p>更新子文档不会影响到父文档</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新子文档</span></span><br><span class="line">PUT my_blogs/_doc/comment3?routing=blog2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"comment"</span>: <span class="string">"Hello Hadoop??"</span>,</span><br><span class="line">    <span class="attr">"blog_comments_relation"</span>: &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"comment"</span>,</span><br><span class="line">      <span class="attr">"parent"</span>: <span class="string">"blog2"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多子文档-和-多级父子文档"><a href="#多子文档-和-多级父子文档" class="headerlink" title="多子文档 和 多级父子文档"></a>多子文档 和 多级父子文档</h3><p>除了上面常见的父子文档类型，ES Join 还支持 多子文档 和 多级父子文档 的设置。如下：</p>
<p><strong>构建多个子文档</strong></p>
<p>Join 类型一个父文档可以配置多个子文档，创建方式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"my_join_field"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"join"</span>,</span><br><span class="line">        <span class="attr">"relations"</span>: &#123;</span><br><span class="line">          <span class="attr">"question"</span>: [<span class="string">"answer"</span>, <span class="string">"comment"</span>]  </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>构建多级父子关系</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"my_join_field"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"join"</span>,</span><br><span class="line">        <span class="attr">"relations"</span>: &#123;</span><br><span class="line">          <span class="attr">"question"</span>: [<span class="string">"answer"</span>, <span class="string">"comment"</span>],  </span><br><span class="line">          <span class="attr">"answer"</span>: <span class="string">"vote"</span> </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面创建的父子文档层级如下图所示：</p>
<p><img src="/images/big-data/es-06/63.jpg" alt="63"></p>
<h3 id="父子关系的应用"><a href="#父子关系的应用" class="headerlink" title="父子关系的应用"></a>父子关系的应用</h3><ul>
<li>如果要更改文档的父文档，不能仅仅 update 或者 reindex 旧文档(新的父文档可能在不同分片上)，需要先删除旧文档再重新索引。</li>
<li>看到 parent-child 关系，我们很容易想到的是像 SQL 那样的各种 JOIN 操作——比如查询某个文档并一并取回所有的父或子文档等。</li>
<li>然而，ES 中不支持类似的 JOIN 查询。在 ES 中的 parent-child 关系基本可以理解为仅仅是一个过滤条件。</li>
</ul>
<h3 id="嵌套对象-v-s-父子文档"><a href="#嵌套对象-v-s-父子文档" class="headerlink" title="嵌套对象 v.s 父子文档"></a>嵌套对象 v.s 父子文档</h3><table>
<thead>
<tr>
<th align="left"></th>
<th align="left">Nested Object</th>
<th align="left">Parent / Child</th>
</tr>
</thead>
<tbody><tr>
<td align="left">优点</td>
<td align="left">文档存储在一起，读取性能高</td>
<td align="left">父子文档可以独立更新</td>
</tr>
<tr>
<td align="left">缺点</td>
<td align="left">更新嵌套的子文档时，需要更新整个文档</td>
<td align="left">需要额外的内存去维护关系。读取性能相对差</td>
</tr>
<tr>
<td align="left">适用场景</td>
<td align="left">子文档偶尔更新，以查询为主</td>
<td align="left">子文档更新频繁</td>
</tr>
</tbody></table>
<h2 id="Update-By-Query-amp-Reindex-API"><a href="#Update-By-Query-amp-Reindex-API" class="headerlink" title="Update By Query &amp; Reindex API"></a>Update By Query &amp; Reindex API</h2><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>一般在以下几种情况时，我们需要重建索引：<ul>
<li>索引的 Mappings 发生变更：字段类型更改，分词器及字典更新</li>
<li>索引的 Setting 发生变更：索引的主分片数发生改变</li>
<li>集群内，集群间需要做数据迁移</li>
</ul>
</li>
<li>ElastiicSearch 的内置提供的 API<ul>
<li>Update By Query : 在现有索引上重建</li>
<li>Reindex：在其他索引上重建索引</li>
</ul>
</li>
</ul>
<h3 id="案例一：为索引增加子字段"><a href="#案例一：为索引增加子字段" class="headerlink" title="案例一：为索引增加子字段"></a>案例一：为索引增加子字段</h3><ul>
<li>改变 Mapping ， 增加子字段，使用英文分词器</li>
<li>此时尝试对子字段进行查询</li>
<li>虽然有数据已经存在，但是没有返回结果</li>
</ul>
<p><img src="/images/big-data/es-06/43.jpg" alt="43"></p>
<h3 id="Update-By-Query"><a href="#Update-By-Query" class="headerlink" title="Update By Query"></a>Update By Query</h3><ul>
<li>执行 Update By Query</li>
<li>尝试对 Multi-Fields 查询查询</li>
<li>返回结果</li>
</ul>
<p><img src="/images/big-data/es-06/44.jpg" alt="44"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写入文档</span></span><br><span class="line">PUT blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"Hadoop is cool"</span>,</span><br><span class="line">  <span class="attr">"keyword"</span>:<span class="string">"hadoop"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改 Mapping，增加子字段，使用英文分词器</span></span><br><span class="line">PUT blogs/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span> : &#123;</span><br><span class="line">    <span class="attr">"content"</span> : &#123;</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">      <span class="attr">"fields"</span> : &#123;</span><br><span class="line">        <span class="attr">"english"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"analyzer"</span>:<span class="string">"english"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入文档</span></span><br><span class="line">PUT blogs/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"Elasticsearch rocks"</span>,</span><br><span class="line">  <span class="attr">"keyword"</span>:<span class="string">"elasticsearch"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询新写入文档</span></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"content.english"</span>: <span class="string">"Elasticsearch"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询 Mapping 变更前写入的文档</span></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"content.english"</span>: <span class="string">"hadoop"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update所有文档</span></span><br><span class="line">POST blogs/_update_by_query</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例二：更改已有字段类型的-Mappings"><a href="#案例二：更改已有字段类型的-Mappings" class="headerlink" title="案例二：更改已有字段类型的 Mappings"></a>案例二：更改已有字段类型的 Mappings</h3><ul>
<li>ES 不允许在原有 Mapping 上对字段类型进行修改</li>
<li>只能创建新的索引，并设定正确的字段类型，在重新导入数据</li>
</ul>
<p><img src="/images/big-data/es-06/45.jpg" alt="45"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建新的索引并且设定新的Mapping</span></span><br><span class="line">PUT blogs_fix/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"content"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">          <span class="attr">"english"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"analyzer"</span>: <span class="string">"english"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"keyword"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reindx API</span></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"source"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dest"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs_fix"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET  blogs_fix/_doc/1</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试 Term Aggregation</span></span><br><span class="line">POST blogs_fix/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"blog_keyword"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reindex-API"><a href="#Reindex-API" class="headerlink" title="Reindex API"></a>Reindex API</h3><ul>
<li>Reindex API 支持把文档从一个索引拷贝到另外一个索引</li>
<li>使用 Reindex API 的一些场景<ul>
<li>修改索引的主分片数</li>
<li>改变字段的 Mapping 中的字段类型</li>
<li>集群中数据迁移、跨集群的数据迁移</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Reindx API，version Type Internal</span></span><br><span class="line">POST  _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"source"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dest"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs_fix"</span>,</span><br><span class="line">    <span class="attr">"version_type"</span>: <span class="string">"internal"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文档版本号增加</span></span><br><span class="line">GET  blogs_fix/_doc/1</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reindx API，version Type Internal</span></span><br><span class="line">POST  _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"source"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dest"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs_fix"</span>,</span><br><span class="line">    <span class="attr">"version_type"</span>: <span class="string">"external"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reindx API，version Type Internal</span></span><br><span class="line">POST  _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"source"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dest"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs_fix"</span>,</span><br><span class="line">    <span class="attr">"version_type"</span>: <span class="string">"external"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"conflicts"</span>: <span class="string">"proceed"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="两个注意点"><a href="#两个注意点" class="headerlink" title="两个注意点"></a>两个注意点</h3><ul>
<li>索引的 mapping _source 要开启</li>
<li>先创建一个新索引，然后在执行 reindex</li>
</ul>
<h3 id="OP-Type"><a href="#OP-Type" class="headerlink" title="OP Type"></a>OP Type</h3><ul>
<li>_reindex 指挥创建不存在的文档</li>
<li>文档如果存在，会导致版本冲突</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Reindx API，version Type Internal</span></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"source"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dest"</span>: &#123;</span><br><span class="line">    <span class="attr">"index"</span>: <span class="string">"blogs_fix"</span>,</span><br><span class="line">    <span class="attr">"op_type"</span>: <span class="string">"create"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="跨集群-ReIndex"><a href="#跨集群-ReIndex" class="headerlink" title="跨集群 ReIndex"></a>跨集群 ReIndex</h3><p><img src="/images/big-data/es-06/46.jpg" alt="46"></p>
<h3 id="查看-Task-API"><a href="#查看-Task-API" class="headerlink" title="查看 Task API"></a>查看 Task API</h3><p><img src="/images/big-data/es-06/47.jpg" alt="47"></p>
<h3 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h3><ul>
<li>Update By Query 使用场景： 为字段新增子字段；字段更改分词器；更新分词器词库</li>
<li>Reindex API 使用场景：修改字段类型<ul>
<li>需要先对新索引设置 Mapping，索引的设置和映射关系不会被复制</li>
</ul>
</li>
<li>通过查看 Task API，了解 Reindex 的状况</li>
<li>Remote ReIndex ，需要修改 elasticsearch.yml 配置并且重启</li>
<li>一定要尽量使用 Index Alias 读写数据。即便发生 Reindex，也能实现零停机维护</li>
</ul>
<h2 id="Ingest-Pipeline-与-Painless-Script"><a href="#Ingest-Pipeline-与-Painless-Script" class="headerlink" title="Ingest Pipeline 与 Painless Script"></a>Ingest Pipeline 与 Painless Script</h2><h3 id="需求：修复与增强写入的数据"><a href="#需求：修复与增强写入的数据" class="headerlink" title="需求：修复与增强写入的数据"></a>需求：修复与增强写入的数据</h3><ul>
<li>Tags 字段中，逗号分割的文本应该是数组，而不是一个字符串</li>
<li>需求：后期需要对 Tags 进行 Aggregation 统计信息</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Blog数据，包含3个字段，tags用逗号间隔</span></span><br><span class="line">PUT tech_blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"Introducing big data......"</span>,</span><br><span class="line">  <span class="attr">"tags"</span>:<span class="string">"hadoop,elasticsearch,spark"</span>,</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"You konw, for big data"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Ingest-Node"><a href="#Ingest-Node" class="headerlink" title="Ingest Node"></a>Ingest Node</h3><ul>
<li>Elasticsearch 5.0 后，引入的一种新的节点类型。默认配置下，每个节点都是 Ingest Node<ul>
<li>具有预处理数据的能力，可拦截 Index 或者 Bulck API 的请求</li>
<li>对数据进行转换，并重新返回给 Index 和 Bluck API</li>
</ul>
</li>
<li>无需 Logstash ，就可以进行数据的预处理，例如<ul>
<li>为某个字段设置默认值；重命名某个字段的字段名；对字段值进行 Split 操作</li>
<li>支持设置 Painless 脚本，对数据进行更加复杂的加工</li>
</ul>
</li>
</ul>
<h3 id="Pipeline-amp-Processor"><a href="#Pipeline-amp-Processor" class="headerlink" title="Pipeline &amp; Processor"></a>Pipeline &amp; Processor</h3><ul>
<li>Pipeline - 管道会对通过的数据（文档），按照顺序进行加工</li>
<li>Processor - Elasticsearch 对一些加工的行为进行了抽象包装<ul>
<li>Elasticsearch 有很多内置的 Processors。也支持通过插件的方式，实现自己的 Processsor</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/48.jpg" alt="48"></p>
<h3 id="使用-Pipeline-切分字符串"><a href="#使用-Pipeline-切分字符串" class="headerlink" title="使用 Pipeline 切分字符串"></a>使用 Pipeline 切分字符串</h3><p><img src="/images/big-data/es-06/49.jpg" alt="49"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试split tags</span></span><br><span class="line">POST _ingest/pipeline/_simulate</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"pipeline"</span>: &#123;</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"to split blog tags"</span>,</span><br><span class="line">    <span class="attr">"processors"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"split"</span>: &#123;</span><br><span class="line">          <span class="attr">"field"</span>: <span class="string">"tags"</span>,</span><br><span class="line">          <span class="attr">"separator"</span>: <span class="string">","</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"docs"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"_index"</span>: <span class="string">"index"</span>,</span><br><span class="line">      <span class="attr">"_id"</span>: <span class="string">"id"</span>,</span><br><span class="line">      <span class="attr">"_source"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"Introducing big data......"</span>,</span><br><span class="line">        <span class="attr">"tags"</span>: <span class="string">"hadoop,elasticsearch,spark"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"You konw, for big data"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"_index"</span>: <span class="string">"index"</span>,</span><br><span class="line">      <span class="attr">"_id"</span>: <span class="string">"idxx"</span>,</span><br><span class="line">      <span class="attr">"_source"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"Introducing cloud computering"</span>,</span><br><span class="line">        <span class="attr">"tags"</span>: <span class="string">"openstack,k8s"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"You konw, for cloud"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="为文档增加字段"><a href="#为文档增加字段" class="headerlink" title="为文档增加字段"></a>为文档增加字段</h3><p><img src="/images/big-data/es-06/50.jpg" alt="50"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同时为文档，增加一个字段。blog查看量</span></span><br><span class="line">POST _ingest/pipeline/_simulate</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"pipeline"</span>: &#123;</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"to split blog tags"</span>,</span><br><span class="line">    <span class="attr">"processors"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"split"</span>: &#123;</span><br><span class="line">          <span class="attr">"field"</span>: <span class="string">"tags"</span>,</span><br><span class="line">          <span class="attr">"separator"</span>: <span class="string">","</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"set"</span>: &#123;</span><br><span class="line">          <span class="attr">"field"</span>: <span class="string">"views"</span>,</span><br><span class="line">          <span class="attr">"value"</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"docs"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"_index"</span>: <span class="string">"index"</span>,</span><br><span class="line">      <span class="attr">"_id"</span>: <span class="string">"id"</span>,</span><br><span class="line">      <span class="attr">"_source"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"Introducing big data......"</span>,</span><br><span class="line">        <span class="attr">"tags"</span>: <span class="string">"hadoop,elasticsearch,spark"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"You konw, for big data"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"_index"</span>: <span class="string">"index"</span>,</span><br><span class="line">      <span class="attr">"_id"</span>: <span class="string">"idxx"</span>,</span><br><span class="line">      <span class="attr">"_source"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"Introducing cloud computering"</span>,</span><br><span class="line">        <span class="attr">"tags"</span>: <span class="string">"openstack,k8s"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"You konw, for cloud"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pipeline-API"><a href="#Pipeline-API" class="headerlink" title="Pipeline API"></a>Pipeline API</h3><p><img src="/images/big-data/es-06/51.jpg" alt="51"></p>
<h3 id="添加-Pipeline-并测试"><a href="#添加-Pipeline-并测试" class="headerlink" title="添加 Pipeline 并测试"></a>添加 Pipeline 并测试</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为ES添加一个 Pipeline</span></span><br><span class="line">PUT _ingest/pipeline/blog_pipeline</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"a blog pipeline"</span>,</span><br><span class="line">  <span class="attr">"processors"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"split"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"tags"</span>,</span><br><span class="line">        <span class="attr">"separator"</span>: <span class="string">","</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"set"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"views"</span>,</span><br><span class="line">        <span class="attr">"value"</span>: <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查看Pipleline</span></span><br><span class="line">GET _ingest/pipeline/blog_pipeline</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试pipeline</span></span><br><span class="line">POST _ingest/pipeline/blog_pipeline/_simulate</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"docs"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"_source"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"Introducing cloud computering"</span>,</span><br><span class="line">        <span class="attr">"tags"</span>: <span class="string">"openstack,k8s"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"You konw, for cloud"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Index-amp-Update-By-Query"><a href="#Index-amp-Update-By-Query" class="headerlink" title="Index &amp; Update By Query"></a>Index &amp; Update By Query</h3><p><img src="/images/big-data/es-06/52.jpg" alt="52"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不使用pipeline更新数据</span></span><br><span class="line">PUT tech_blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"Introducing big data......"</span>,</span><br><span class="line">  <span class="attr">"tags"</span>:<span class="string">"hadoop,elasticsearch,spark"</span>,</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"You konw, for big data"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用pipeline更新数据</span></span><br><span class="line">PUT tech_blogs/_doc/2?pipeline=blog_pipeline</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Introducing cloud computering"</span>,</span><br><span class="line">  <span class="attr">"tags"</span>: <span class="string">"openstack,k8s"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"You konw, for cloud"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查看两条数据，一条被处理，一条未被处理</span></span><br><span class="line">POST tech_blogs/_search</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//update_by_query 会导致错误</span></span><br><span class="line">POST tech_blogs/_update_by_query?pipeline=blog_pipeline</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//增加update_by_query的条件</span></span><br><span class="line">POST tech_blogs/_update_by_query?pipeline=blog_pipeline</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"must_not"</span>: &#123;</span><br><span class="line">        <span class="attr">"exists"</span>: &#123;</span><br><span class="line">          <span class="attr">"field"</span>: <span class="string">"views"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一些内置的-Processors"><a href="#一些内置的-Processors" class="headerlink" title="一些内置的 Processors"></a>一些内置的 Processors</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/ingest-processors.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/ingest-processors.html</a></p>
<ul>
<li>Split Processor （例如：将给定字段分成一个数组）</li>
<li>Remove / Rename Processor （移除一个重命名字段）</li>
<li>Append（为商品增加一个新的标签）</li>
<li>Convert （将商品价格，从字符串转换成 float 类型）</li>
<li>Date / JSON （日期格式转换，字符串转 JSON 对象）</li>
<li>Date Index Name Processor （将通过该处理器的文档，分配到指定时间格式的索引中）</li>
<li>Fail Processor （一旦出现异常，该 Pipeline 指定的错误信息能返回给用户）</li>
<li>Foreach Process （数组字段，数组的每个元素都会使用到一个相同的处理器）</li>
<li>Grok Processor （日志的日志格式切割）</li>
<li>Gsub / Join / Split （字符串替换、数组转字符串、字符串转数组）</li>
<li>Lowercase / Upcase（大小写转换）</li>
</ul>
<h3 id="Ingest-Node-v-s-Logstash"><a href="#Ingest-Node-v-s-Logstash" class="headerlink" title="Ingest Node v.s Logstash"></a>Ingest Node v.s Logstash</h3><table>
<thead>
<tr>
<th align="left"></th>
<th align="left">Logstash</th>
<th align="left">Ingest Node</th>
</tr>
</thead>
<tbody><tr>
<td align="left">数据输入与输出</td>
<td align="left">支持从不同的数据源读取，并写入不同的数据源</td>
<td align="left">支持从 ES REST API 获取数据，并且写入 ES</td>
</tr>
<tr>
<td align="left">数据源缓冲</td>
<td align="left">实现了简单的数据队列，支持重写</td>
<td align="left">不支持缓冲</td>
</tr>
<tr>
<td align="left">数据处理</td>
<td align="left">支持大量的的插件，也支持定制开发</td>
<td align="left">内置的插件，可以开发 Plugin 进行扩展（Plugin 更新需要重启）</td>
</tr>
<tr>
<td align="left">配置和使用</td>
<td align="left">增加了一定的架构复杂度</td>
<td align="left">无需额外部署</td>
</tr>
</tbody></table>
<blockquote>
<p><a href="https://www.elastic.co/cn/blog/should-i-use-logstash-or-elasticsearch-ingest-nodes" target="_blank" rel="noopener">https://www.elastic.co/cn/blog/should-i-use-logstash-or-elasticsearch-ingest-nodes</a></p>
</blockquote>
<h3 id="Painless-简介"><a href="#Painless-简介" class="headerlink" title="Painless 简介"></a>Painless 简介</h3><ul>
<li>自 ES 5.x 后引入，专门为 ES 设置，扩展了 Java 的语法</li>
<li>6.0 开始，ES 只支持 Painless。Grooby ,JavaScript 和 Python 都不在支持</li>
<li>Painless 支持所有的 Java 的数据类型及 Java API 子集</li>
<li>Painless Script 具备以下特性<ul>
<li>高性能 / 安全</li>
<li>支持显示类型或者动态定义类型</li>
</ul>
</li>
</ul>
<h3 id="Painless-的用途"><a href="#Painless-的用途" class="headerlink" title="Painless 的用途"></a>Painless 的用途</h3><ul>
<li>可以对文档字段进行加工处理<ul>
<li>更新或者删除字段，处理数据聚合操作</li>
<li>Script Field： 对返回的字段提前进行计算</li>
<li>Function Score：对文档的算分进行处理</li>
</ul>
</li>
<li>在 Ingest Pipeline 中执行脚本</li>
<li>在 Reindex API，Update By Query 时，对数据进行处理</li>
</ul>
<h3 id="通过-Painless-脚本访问字段"><a href="#通过-Painless-脚本访问字段" class="headerlink" title="通过 Painless 脚本访问字段"></a>通过 Painless 脚本访问字段</h3><table>
<thead>
<tr>
<th align="left">上下文</th>
<th align="left">语法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Ingestion</td>
<td align="left">ctx.field_name</td>
</tr>
<tr>
<td align="left">Update</td>
<td align="left">ctx._source.field_name</td>
</tr>
<tr>
<td align="left">Search &amp; Aggregation</td>
<td align="left">doc{“field_name”]</td>
</tr>
</tbody></table>
<h3 id="案例-1：Script-Processsor"><a href="#案例-1：Script-Processsor" class="headerlink" title="案例 1：Script Processsor"></a>案例 1：Script Processsor</h3><p><img src="/images/big-data/es-06/53.jpg" alt="53"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加一个 Script Prcessor</span></span><br><span class="line">POST _ingest/pipeline/_simulate</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"pipeline"</span>: &#123;</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"to split blog tags"</span>,</span><br><span class="line">    <span class="attr">"processors"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"split"</span>: &#123;</span><br><span class="line">          <span class="attr">"field"</span>: <span class="string">"tags"</span>,</span><br><span class="line">          <span class="attr">"separator"</span>: <span class="string">","</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"script"</span>: &#123;</span><br><span class="line">          <span class="attr">"source"</span>: <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">          if(ctx.containsKey("</span>content<span class="string">"))&#123;</span></span><br><span class="line"><span class="string">            ctx.content_length = ctx.content.length();</span></span><br><span class="line"><span class="string">          &#125;else&#123;</span></span><br><span class="line"><span class="string">            ctx.content_length=0;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"set"</span>: &#123;</span><br><span class="line">          <span class="attr">"field"</span>: <span class="string">"views"</span>,</span><br><span class="line">          <span class="attr">"value"</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"docs"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"_index"</span>: <span class="string">"index"</span>,</span><br><span class="line">      <span class="attr">"_id"</span>: <span class="string">"id"</span>,</span><br><span class="line">      <span class="attr">"_source"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"Introducing big data......"</span>,</span><br><span class="line">        <span class="attr">"tags"</span>: <span class="string">"hadoop,elasticsearch,spark"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"You konw, for big data"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"_index"</span>: <span class="string">"index"</span>,</span><br><span class="line">      <span class="attr">"_id"</span>: <span class="string">"idxx"</span>,</span><br><span class="line">      <span class="attr">"_source"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"Introducing cloud computering"</span>,</span><br><span class="line">        <span class="attr">"tags"</span>: <span class="string">"openstack,k8s"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"You konw, for cloud"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例-2：文档更新计数"><a href="#案例-2：文档更新计数" class="headerlink" title="案例 2：文档更新计数"></a>案例 2：文档更新计数</h3><p><img src="/images/big-data/es-06/54.jpg" alt="54"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DELETE tech_blogs</span><br><span class="line">PUT tech_blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"Introducing big data......"</span>,</span><br><span class="line">  <span class="attr">"tags"</span>:<span class="string">"hadoop,elasticsearch,spark"</span>,</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"You konw, for big data"</span>,</span><br><span class="line">  <span class="attr">"views"</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST tech_blogs/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"script"</span>: &#123;</span><br><span class="line">    <span class="attr">"source"</span>: <span class="string">"ctx._source.views += params.new_views"</span>,</span><br><span class="line">    <span class="attr">"params"</span>: &#123;</span><br><span class="line">      <span class="attr">"new_views"</span>:<span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看views计数</span></span><br><span class="line">POST tech_blogs/_search</span><br></pre></td></tr></table></figure>

<h3 id="案例-3：搜索时的-Script-字段"><a href="#案例-3：搜索时的-Script-字段" class="headerlink" title="案例 3：搜索时的 Script 字段"></a>案例 3：搜索时的 Script 字段</h3><p><img src="/images/big-data/es-06/55.jpg" alt="55"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET tech_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"script_fields"</span>: &#123;</span><br><span class="line">    <span class="attr">"rnd_views"</span>: &#123;</span><br><span class="line">      <span class="attr">"script"</span>: &#123;</span><br><span class="line">        <span class="attr">"lang"</span>: <span class="string">"painless"</span>,</span><br><span class="line">        <span class="attr">"source"</span>: <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">          java.util.Random rnd = new Random();</span></span><br><span class="line"><span class="string">          doc['views'].value+rnd.nextInt(1000);</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Script-Inline-v-s-Stored"><a href="#Script-Inline-v-s-Stored" class="headerlink" title="Script: Inline v.s Stored"></a>Script: Inline v.s Stored</h3><p><img src="/images/big-data/es-06/56.jpg" alt="56"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存脚本在 Cluster State</span></span><br><span class="line">POST _scripts/update_views</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"script"</span>:&#123;</span><br><span class="line">    <span class="attr">"lang"</span>: <span class="string">"painless"</span>,</span><br><span class="line">    <span class="attr">"source"</span>: <span class="string">"ctx._source.views += params.new_views"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST tech_blogs/_update/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"script"</span>: &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"update_views"</span>,</span><br><span class="line">    <span class="attr">"params"</span>: &#123;</span><br><span class="line">      <span class="attr">"new_views"</span>:<span class="number">1000</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="脚本缓存"><a href="#脚本缓存" class="headerlink" title="脚本缓存"></a>脚本缓存</h3><ul>
<li>编译的开销相较大</li>
<li>Elasticsearch 会将甲苯编译后缓存在 Cache 中<ul>
<li>Inline scripts 和 Stored Scripts 都会被缓存</li>
<li>默认缓存 100 个脚本</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">script.cache.max_size</td>
<td align="left">设置最大缓存数</td>
</tr>
<tr>
<td align="left">script.cache.expire</td>
<td align="left">设置缓存超时</td>
</tr>
<tr>
<td align="left">script.max_compilations_rate</td>
<td align="left">默认5分钟最多75次编译 （75/5m）</td>
</tr>
</tbody></table>
<h2 id="Elasticsearch-数据建模实例"><a href="#Elasticsearch-数据建模实例" class="headerlink" title="Elasticsearch 数据建模实例"></a>Elasticsearch 数据建模实例</h2><h3 id="什么是数据建模"><a href="#什么是数据建模" class="headerlink" title="什么是数据建模"></a>什么是数据建模</h3><ul>
<li>数据建模（Data modeling），是创建数据模型的过程。<ul>
<li>数据模型是对真实世界进行抽象描述的一种工具和方法，实现对现实世界的映射<ul>
<li>博客、作者、用户评论</li>
</ul>
</li>
<li>三个过程：概念模型 =&gt; 逻辑模型 =&gt; 数据模型（第三范式）<ul>
<li>数据模型：结合具体的数据库，在满足业务读写性能等需求的前提下，确定最终的定义</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="数据建模：功能需求-性能需求"><a href="#数据建模：功能需求-性能需求" class="headerlink" title="数据建模：功能需求 + 性能需求"></a>数据建模：功能需求 + 性能需求</h3><p><img src="/images/big-data/es-06/57.jpg" alt="57"></p>
<h3 id="如何对字段进行建模"><a href="#如何对字段进行建模" class="headerlink" title="如何对字段进行建模"></a>如何对字段进行建模</h3><p><img src="/images/big-data/es-06/58.jpg" alt="58"></p>
<h3 id="字段类型-：-Text-v-s-Keyword"><a href="#字段类型-：-Text-v-s-Keyword" class="headerlink" title="字段类型 ： Text v.s Keyword"></a>字段类型 ： Text v.s Keyword</h3><ul>
<li>Text<ul>
<li>用于全文本字段，文本会被 Analyzer 分词</li>
<li>默认不支持聚合分析及排序。需要设置 fielddata 为 true</li>
</ul>
</li>
<li>Keyword<ul>
<li>用于 id ，枚举及不需要分词的文本。例如电话号码，email 地址，手机号码，邮政编码，性别等</li>
<li>适用于 Filter（精确匹配），Sorting 和 Aggregations</li>
</ul>
</li>
<li>设置多字段类型<ul>
<li>默认会为文本类型设置成 text ，并且设置一个 keyword 的子字段</li>
<li>在处理人类语言时，通过增加 “英文”，“拼音” 和 “标准” 分词器，提高搜索结构</li>
</ul>
</li>
</ul>
<h3 id="字段类型：结构化数据"><a href="#字段类型：结构化数据" class="headerlink" title="字段类型：结构化数据"></a>字段类型：结构化数据</h3><ul>
<li>数据类型<ul>
<li>尽量选择贴近的类型。例如可以用 byte，就不要用 long</li>
</ul>
</li>
<li>枚举类型<ul>
<li>设置为 keyword 。即便是数字，也应该设置成 keyword ，获取更好的性能</li>
</ul>
</li>
<li>其他<ul>
<li>日期、布尔、地理信息</li>
</ul>
</li>
</ul>
<h3 id="检索"><a href="#检索" class="headerlink" title="检索"></a>检索</h3><ul>
<li>如不需要检索，排序和聚合分析<ul>
<li>Enable 设置成 false</li>
</ul>
</li>
<li>如不需要检索<ul>
<li>index 设置成 false</li>
</ul>
</li>
<li>对需要检索的字段，可以通过如下配置，设置存储粒度<ul>
<li>Index_options / Norms : 不需要归一化数据时，可以关闭</li>
</ul>
</li>
</ul>
<h3 id="聚合及排序"><a href="#聚合及排序" class="headerlink" title="聚合及排序"></a>聚合及排序</h3><ul>
<li>如不需要检索，排序和聚合分析<ul>
<li>Enable 设置成 false</li>
</ul>
</li>
<li>如不需要排序或者聚合分析功能<ul>
<li>Doc_values / fielddata 设置成 false</li>
</ul>
</li>
<li>更新频繁，聚合查询频繁的 keyword 类型的字段<ul>
<li>推荐将 eager_global_ordinals 设置为 true</li>
</ul>
</li>
</ul>
<h3 id="额外的存储"><a href="#额外的存储" class="headerlink" title="额外的存储"></a>额外的存储</h3><ul>
<li>是否需要专门存储当前字段数据<ul>
<li>Store 设置为 true ，可以存储该字段的原始数据</li>
<li>一般结合 _source 的 enabled 为 false 时候使用</li>
</ul>
</li>
<li>Disable _source ： 节约磁盘，适用于指标型数据<ul>
<li>一般建议先考虑增加压缩比</li>
<li>无法看到 _source 字段，无法做 ReIndex，无法做 Update</li>
<li>Kibana 中无法做 discovery</li>
</ul>
</li>
</ul>
<h3 id="一个数据建模的实例"><a href="#一个数据建模的实例" class="headerlink" title="一个数据建模的实例"></a>一个数据建模的实例</h3><ul>
<li>图书的索引<ul>
<li>书名</li>
<li>简介</li>
<li>作者</li>
<li>发行日期</li>
<li>图书封面</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/59.jpg" alt="59"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">PUT books/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"Mastering ElasticSearch 5.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>:<span class="string">"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins"</span>,</span><br><span class="line">  <span class="attr">"author"</span>:<span class="string">"Bharvi Dixit"</span>,</span><br><span class="line">  <span class="attr">"public_date"</span>:<span class="string">"2017"</span>,</span><br><span class="line">  <span class="attr">"cover_url"</span>:<span class="string">"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg"</span></span><br><span class="line">&#125;</span><br><span class="line">GET books/_mapping</span><br><span class="line"><span class="comment">// return </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"books"</span> : &#123;</span><br><span class="line">    <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"properties"</span> : &#123;</span><br><span class="line">        <span class="attr">"author"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"cover_url"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"description"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"public_date"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"title"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">              <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="优化字段的设定"><a href="#优化字段的设定" class="headerlink" title="优化字段的设定"></a>优化字段的设定</h3><ul>
<li>图书的索引<ul>
<li>书名：支持全文和精确匹配</li>
<li>简介：支持全文</li>
<li>作者：精确值</li>
<li>发行日期：日期类型</li>
<li>图书封面：精确值</li>
</ul>
</li>
</ul>
<p><img src="/images/big-data/es-06/60.jpg" alt="60"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优化字段类型</span></span><br><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">    <span class="attr">"properties"</span> : &#123;</span><br><span class="line">      <span class="attr">"author"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"keyword"</span>&#125;,</span><br><span class="line">      <span class="attr">"cover_url"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"keyword"</span>,<span class="attr">"index"</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">      <span class="attr">"description"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"text"</span>&#125;,</span><br><span class="line">      <span class="attr">"public_date"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"date"</span>&#125;,</span><br><span class="line">      <span class="attr">"title"</span> : &#123;</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"fields"</span> : &#123;</span><br><span class="line">          <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">            <span class="attr">"ignore_above"</span> : <span class="number">100</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Cover URL index 设置成false，无法对该字段进行搜索</span></span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"cover_url"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="string">"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cover URL index 设置成false，依然支持聚合分析</span></span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"cover"</span>: &#123;</span><br><span class="line">      <span class="attr">"terms"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"cover_url"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="需求变更"><a href="#需求变更" class="headerlink" title="需求变更"></a>需求变更</h3><ul>
<li>新需求：增加图书内容的字段，并要求能被搜索同时支持高亮显示</li>
<li>新需求会导致 _source 的内容过大<ul>
<li>Source Filtering 只是传输给客户端进行过滤，Fetch 数据时，ES 节点还是会传输 _source 中的数据</li>
</ul>
</li>
<li>解决方法<ul>
<li>关闭 _source</li>
<li>然后将每个字段的 “store” 设置成 true</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">DELETE books</span><br><span class="line"><span class="comment">// 新增 Content字段。数据量很大。选择将Source 关闭</span></span><br><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">    <span class="attr">"_source"</span>: &#123;<span class="attr">"enabled"</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">    <span class="attr">"properties"</span> : &#123;</span><br><span class="line">      <span class="attr">"author"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"keyword"</span>,<span class="attr">"store"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      <span class="attr">"cover_url"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"keyword"</span>,<span class="attr">"index"</span>: <span class="literal">false</span>,<span class="attr">"store"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      <span class="attr">"description"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"text"</span>,<span class="attr">"store"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">       <span class="attr">"content"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"text"</span>,<span class="attr">"store"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      <span class="attr">"public_date"</span> : &#123;<span class="attr">"type"</span> : <span class="string">"date"</span>,<span class="attr">"store"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">      <span class="attr">"title"</span> : &#123;</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"fields"</span> : &#123;</span><br><span class="line">          <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">            <span class="attr">"ignore_above"</span> : <span class="number">100</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"store"</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询图书：解决字段过大引发的性能问题"><a href="#查询图书：解决字段过大引发的性能问题" class="headerlink" title="查询图书：解决字段过大引发的性能问题"></a>查询图书：解决字段过大引发的性能问题</h3><ul>
<li>返回结果不包含 _source 字段</li>
<li>对于需要显示的信息，可以在查询中指定 “store_fields”</li>
<li>禁止 _source 字段后，还是支持使用 hignlights API ，高亮显示 content 中的匹配的相关信息</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Index 一本书的信息,包含Content</span></span><br><span class="line">PUT books/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>:<span class="string">"Mastering ElasticSearch 5.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>:<span class="string">"Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins"</span>,</span><br><span class="line">  <span class="attr">"content"</span>:<span class="string">"The content of the book......Indexing data, aggregation, searching.    something else. something in the way............"</span>,</span><br><span class="line">  <span class="attr">"author"</span>:<span class="string">"Bharvi Dixit"</span>,</span><br><span class="line">  <span class="attr">"public_date"</span>:<span class="string">"2017"</span>,</span><br><span class="line">  <span class="attr">"cover_url"</span>:<span class="string">"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询结果中，Source不包含数据</span></span><br><span class="line">POST books/_search</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索，通过store 字段显示数据，同时高亮显示 conent的内容</span></span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"stored_fields"</span>: [<span class="string">"title"</span>,<span class="string">"author"</span>,<span class="string">"public_date"</span>],</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"match"</span>: &#123;</span><br><span class="line">      <span class="attr">"content"</span>: <span class="string">"searching"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"highlight"</span>: &#123;</span><br><span class="line">    <span class="attr">"fields"</span>: &#123;</span><br><span class="line">      <span class="attr">"content"</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Mapping-字段的相关设置"><a href="#Mapping-字段的相关设置" class="headerlink" title="Mapping 字段的相关设置"></a>Mapping 字段的相关设置</h3><ul>
<li>Enabled - 设置成 false，仅做存储，不支持搜索和聚合分析 （数据保存在_source 中）</li>
<li>Index - 是否构倒排索引。设置成 false，无法被搜索，但还是支持 aggregation，并出现在 _source<br>中</li>
<li>Norms - 如果字段用来过滤和聚合分析，可以关闭，节约存储</li>
<li>Doc_values - 是否启用 doc_values，用于排序和聚合分析</li>
<li>Field_data - 如果要对 text 类型启用排序和聚合分析， fielddata 需要设置成true</li>
<li>Store - 默认不存储，数据默认存储在 _source</li>
<li>Coerce - 默认开启，是否开启数据类型的自动转换（例如，字符串转数字）</li>
<li>Multifields 多字段特性</li>
<li>Dynamic - true / false / strict 控制 Mapping 的自动更新</li>
</ul>
<blockquote>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html</a></p>
</blockquote>
<h3 id="一些相关的-API"><a href="#一些相关的-API" class="headerlink" title="一些相关的 API"></a>一些相关的 API</h3><ul>
<li>Index Template &amp; Dynamic Template<ul>
<li>根据索引的名字匹配不同的 Mappings 和 Settings</li>
<li>可以在⼀个 Mapping 上动态的设定字段类型</li>
</ul>
</li>
<li>Index Alias<ul>
<li>⽆需停机，⽆需修改程序，即可进⾏修改</li>
</ul>
</li>
<li>Update By Query &amp; Reindex</li>
</ul>
<h2 id="Elasticsearch-数据建模佳实践"><a href="#Elasticsearch-数据建模佳实践" class="headerlink" title="Elasticsearch 数据建模佳实践"></a>Elasticsearch 数据建模佳实践</h2><h3 id="建模建议（一）：如何处理关联关系"><a href="#建模建议（一）：如何处理关联关系" class="headerlink" title="建模建议（一）：如何处理关联关系"></a>建模建议（一）：如何处理关联关系</h3><ul>
<li>Object ： 优先考虑 Denormailzation</li>
<li>Nested ： 当数据包含多数值对象（对个演员），同时有查询需求</li>
<li>Child/Parent: 关联文档更新非常频繁时</li>
</ul>
<h3 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h3><ul>
<li>Kibana 目前暂不支持 nested 类型 和 parent /child 类型，在未来有可能会支持</li>
<li>如果需要使用 Kibana 进行数据分析，在数据建模时仍需要对嵌套和父子关联类型作出取舍</li>
</ul>
<h3 id="建模建议（二）：避免过多字段"><a href="#建模建议（二）：避免过多字段" class="headerlink" title="建模建议（二）：避免过多字段"></a>建模建议（二）：避免过多字段</h3><ul>
<li>一个文档中，最好避免大量的字段<ul>
<li>过多的字段数不容易维护</li>
<li>Mapping 信息保存在 Cluster State 中， 数据量过大，对集群性能会有影响（Cluster State 信息需要和所有的节点同步）</li>
<li>删除或者修改数据需要 reindex</li>
</ul>
</li>
<li>默认最大字段数是 1000，可以设置 <code>index.mapping.total_fields.limit</code> 限制最大的字段数</li>
<li>什么原因会导致文档中会有成百上千的字段？</li>
</ul>
<h3 id="Dynamic-v-s-Strict"><a href="#Dynamic-v-s-Strict" class="headerlink" title="Dynamic v.s Strict"></a>Dynamic v.s Strict</h3><ul>
<li>Dynamic （生产环境中，尽量不要打开 Dynamic）<ul>
<li>true - 未知字段会被自动加入</li>
<li>false - 新字段不会被索引，但是会保存在 _source</li>
<li>strict - 新增字段不会被索引，文档写入失败</li>
</ul>
</li>
<li>Strict<ul>
<li>可以控制到字段级别</li>
</ul>
</li>
</ul>
<h3 id="一个例子：-Cookie-Service-的数据"><a href="#一个例子：-Cookie-Service-的数据" class="headerlink" title="一个例子： Cookie Service 的数据"></a>一个例子： Cookie Service 的数据</h3><ul>
<li>来自 Cookie Service 的数据<ul>
<li>Cookie 的键值对很多</li>
<li>当 Dynamic 设置为 True</li>
<li>同时采用扁平化的设计，必然导致字段数量的膨胀</li>
</ul>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">##索引数据，dynamic mapping 会不断加入新增字段</span><br><span class="line">PUT cookie_service/_doc/1</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">"url"</span>:<span class="string">"www.google.com"</span>,</span><br><span class="line"> <span class="attr">"cookies"</span>:&#123;</span><br><span class="line">   <span class="attr">"username"</span>:<span class="string">"tom"</span>,</span><br><span class="line">   <span class="attr">"age"</span>:<span class="number">32</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT cookie_service/_doc/2</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">"url"</span>:<span class="string">"www.amazon.com"</span>,</span><br><span class="line"> <span class="attr">"cookies"</span>:&#123;</span><br><span class="line">   <span class="attr">"login"</span>:<span class="string">"2019-01-01"</span>,</span><br><span class="line">   <span class="attr">"email"</span>:<span class="string">"xyz@abc.com"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET cookie_service/_mapping</span><br></pre></td></tr></table></figure>

<h3 id="解决方案：Nested-Object-amp-Key-Value"><a href="#解决方案：Nested-Object-amp-Key-Value" class="headerlink" title="解决方案：Nested Object &amp; Key Value"></a>解决方案：Nested Object &amp; Key Value</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">DELETE cookie_service</span><br><span class="line"><span class="comment">// 使用 Nested 对象，增加key/value</span></span><br><span class="line">PUT cookie_service</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"cookies"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"nested"</span>,</span><br><span class="line">        <span class="attr">"properties"</span>: &#123;</span><br><span class="line">          <span class="attr">"name"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"dateValue"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"date"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"keywordValue"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"IntValue"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"url"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">          <span class="attr">"keyword"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">            <span class="attr">"ignore_above"</span>: <span class="number">256</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="写入-amp-查询"><a href="#写入-amp-查询" class="headerlink" title="写入 &amp; 查询"></a>写入 &amp; 查询</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">PUT cookie_service/_doc/1</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">"url"</span>:<span class="string">"www.google.com"</span>,</span><br><span class="line"> <span class="attr">"cookies"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>:<span class="string">"username"</span>,</span><br><span class="line">      <span class="attr">"keywordValue"</span>:<span class="string">"tom"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>:<span class="string">"age"</span>,</span><br><span class="line">      <span class="attr">"intValue"</span>:<span class="number">32</span></span><br><span class="line">    &#125;</span><br><span class="line">   ]</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">PUT cookie_service/_doc/2</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">"url"</span>:<span class="string">"www.amazon.com"</span>,</span><br><span class="line"> <span class="attr">"cookies"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>:<span class="string">"login"</span>,</span><br><span class="line">      <span class="attr">"dateValue"</span>:<span class="string">"2019-01-01"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>:<span class="string">"email"</span>,</span><br><span class="line">      <span class="attr">"IntValue"</span>:<span class="number">32</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Nested 查询，通过bool查询进行过滤</span></span><br><span class="line">POST cookie_service/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"nested"</span>: &#123;</span><br><span class="line">      <span class="attr">"path"</span>: <span class="string">"cookies"</span>,</span><br><span class="line">      <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"bool"</span>: &#123;</span><br><span class="line">          <span class="attr">"filter"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="attr">"term"</span>: &#123;</span><br><span class="line">              <span class="attr">"cookies.name"</span>: <span class="string">"age"</span></span><br><span class="line">            &#125;&#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"range"</span>:&#123;</span><br><span class="line">                <span class="attr">"cookies.intValue"</span>:&#123;</span><br><span class="line">                  <span class="attr">"gte"</span>:<span class="number">30</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过-Nested-对象保存-Key-Value-的一些不足"><a href="#通过-Nested-对象保存-Key-Value-的一些不足" class="headerlink" title="通过 Nested 对象保存 Key / Value 的一些不足"></a>通过 Nested 对象保存 Key / Value 的一些不足</h3><ul>
<li>可以减少字段数量，解决 Cluster State 中 保存过多 Meta 信息的问题，但是<ul>
<li>导致查询语句复杂度增加</li>
<li>Nested 对象 ，不利于在 Kibana 汇总实现可视化分析</li>
</ul>
</li>
</ul>
<h3 id="建模建议（三）：避免正则查询"><a href="#建模建议（三）：避免正则查询" class="headerlink" title="建模建议（三）：避免正则查询"></a>建模建议（三）：避免正则查询</h3><ul>
<li>问题：<ul>
<li>正则，通配符查询，前缀查询属于 Term 查询，但是性能不够好</li>
<li>特别是将通配符放在开头，会导致性能的灾难</li>
</ul>
</li>
<li>案例：<ul>
<li>文档中某个字段包含了 ES 的版本信息，例如 version：“7.1.0”</li>
<li>搜索所有是 bug fix 的版本？每个主要版本号所关联的文档？</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在Mapping中加入元信息，便于管理</span></span><br><span class="line">PUT softwares/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"_meta"</span>: &#123;</span><br><span class="line">      <span class="attr">"software_version_mapping"</span>: <span class="string">"1.0"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET softwares/_mapping</span><br><span class="line">PUT softwares/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"software_version"</span>:<span class="string">"7.1.0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解决方案：将字符串转换为对象"><a href="#解决方案：将字符串转换为对象" class="headerlink" title="解决方案：将字符串转换为对象"></a>解决方案：将字符串转换为对象</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优化, 使用inner object</span></span><br><span class="line">PUT softwares/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"_meta"</span>: &#123;</span><br><span class="line">      <span class="attr">"software_version_mapping"</span>: <span class="string">"1.1"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: &#123;</span><br><span class="line">        <span class="attr">"properties"</span>: &#123;</span><br><span class="line">          <span class="attr">"display_name"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"hot_fix"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"byte"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"marjor"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"byte"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"minor"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"byte"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 Inner Object 写入多个文档</span></span><br><span class="line">PUT softwares/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"version"</span>: &#123;</span><br><span class="line">    <span class="attr">"display_name"</span>: <span class="string">"7.1.0"</span>,</span><br><span class="line">    <span class="attr">"marjor"</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="attr">"minor"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"hot_fix"</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT softwares/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"version"</span>: &#123;</span><br><span class="line">    <span class="attr">"display_name"</span>: <span class="string">"7.2.0"</span>,</span><br><span class="line">    <span class="attr">"marjor"</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="attr">"minor"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"hot_fix"</span>: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT softwares/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"version"</span>: &#123;</span><br><span class="line">    <span class="attr">"display_name"</span>: <span class="string">"7.2.1"</span>,</span><br><span class="line">    <span class="attr">"marjor"</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="attr">"minor"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"hot_fix"</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="搜索过滤"><a href="#搜索过滤" class="headerlink" title="搜索过滤"></a>搜索过滤</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过 bool 查询，实现 filter 过滤，避免正则查询，大大提升性能。</span></span><br><span class="line">POST softwares/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"filter"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"version.marjor"</span>: <span class="number">7</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"version.minor"</span>: <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="建模建议（四）：避免空置引起的聚合不准"><a href="#建模建议（四）：避免空置引起的聚合不准" class="headerlink" title="建模建议（四）：避免空置引起的聚合不准"></a>建模建议（四）：避免空置引起的聚合不准</h3><p><img src="/images/big-data/es-06/61.jpg" alt="61"></p>
<h3 id="使用-Null-Value-解决空值的问题"><a href="#使用-Null-Value-解决空值的问题" class="headerlink" title="使用 Null_Value 解决空值的问题"></a>使用 Null_Value 解决空值的问题</h3><p><img src="/images/big-data/es-06/62.jpg" alt="62"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Not Null 解决聚合的问题</span></span><br><span class="line">DELETE ratings</span><br><span class="line">PUT ratings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"rating"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"float"</span>,</span><br><span class="line">          <span class="attr">"null_value"</span>: <span class="number">1.0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT ratings/_doc/1</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">"rating"</span>:<span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line">PUT ratings/_doc/2</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">"rating"</span>:<span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST ratings/_search</span><br><span class="line">POST ratings/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"aggs"</span>: &#123;</span><br><span class="line">    <span class="attr">"avg"</span>: &#123;</span><br><span class="line">      <span class="attr">"avg"</span>: &#123;</span><br><span class="line">        <span class="attr">"field"</span>: <span class="string">"rating"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST ratings/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"term"</span>: &#123;</span><br><span class="line">      <span class="attr">"rating"</span>: &#123;</span><br><span class="line">        <span class="attr">"value"</span>: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="建模建议（五）：为索引的-Mapping-加入-Meta-的信息"><a href="#建模建议（五）：为索引的-Mapping-加入-Meta-的信息" class="headerlink" title="建模建议（五）：为索引的 Mapping 加入 Meta 的信息"></a>建模建议（五）：为索引的 Mapping 加入 Meta 的信息</h3><ul>
<li>Mappings 设置非常重要，需要从两个维度进行考虑<ul>
<li>功能：索引，聚合，排序</li>
<li>性能：存储的开销；内存的开销；搜索的性能</li>
</ul>
</li>
<li>Mappings 设置是一个迭代的过程<ul>
<li>加入新的字段容易（必要时需要 update_by_query）</li>
<li>更新删除字段不允许（需要 Reindex 重建数据）</li>
<li>最好能对 Mappings 加入 Meta 信息，更好的进行版本管理</li>
<li>可以考虑 Mapping 文件上传 git 进行管理</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在Mapping中加入元信息，便于管理</span></span><br><span class="line">PUT softwares/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"_meta"</span>: &#123;</span><br><span class="line">      <span class="attr">"software_version_mapping"</span>: <span class="string">"1.0"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>《Elasticsearch核心技术与实战》</li>
<li><a href="https://www.elastic.co/cn/blog/a-new-era-for-cluster-coordination-in-elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/blog/a-new-era-for-cluster-coordination-in-elasticsearch</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations-metrics.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations-metrics.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations-bucket.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations-bucket.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations-pipeline.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations-pipeline.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-nested-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-nested-query.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-has-child-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-has-child-query.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-has-parent-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-has-parent-query.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-parent-id-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/query-dsl-parent-id-query.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/docs-reindex.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/docs-reindex.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/docs-update-by-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/docs-update-by-query.html</a></li>
<li><a href="https://www.elastic.co/cn/blog/should-i-use-logstash-or-elasticsearch-ingest-nodes" target="_blank" rel="noopener">https://www.elastic.co/cn/blog/should-i-use-logstash-or-elasticsearch-ingest-nodes</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/ingest-apis.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/ingest-apis.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/ingest-processors.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/ingest-processors.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.1/painless-lang-spec.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/painless/7.1/painless-lang-spec.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.1/painless-api-reference.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/painless/7.1/painless-api-reference.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/general-recommendations.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/general-recommendations.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/tune-for-disk-usage.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/tune-for-disk-usage.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.1/tune-for-search-speed.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.1/tune-for-search-speed.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html</a></li>
</ul>
<style>
  img {
    zoom: 50%;
  }
</style>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Elastic-Stack/" rel="tag"># Elastic Stack</a>
              <a href="/tags/ES/" rel="tag"># ES</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/back-end/big-data/es-05/" rel="prev" title="重学 Elastic Stack 之 Elasticsearch 深入了解(一)">
      <i class="fa fa-chevron-left"></i> 重学 Elastic Stack 之 Elasticsearch 深入了解(一)
    </a></div>
      <div class="post-nav-item">
    <a href="/back-end/big-data/es-07/" rel="next" title="重学 Elastic Stack 之 Elasticsearch 集群管理">
      重学 Elastic Stack 之 Elasticsearch 集群管理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#集群分布式模型与选主与脑裂问题"><span class="nav-number">1.</span> <span class="nav-text">集群分布式模型与选主与脑裂问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式特性"><span class="nav-number">1.1.</span> <span class="nav-text">分布式特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#节点"><span class="nav-number">1.2.</span> <span class="nav-text">节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Coordinating-Node"><span class="nav-number">1.3.</span> <span class="nav-text">Coordinating Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-Node"><span class="nav-number">1.4.</span> <span class="nav-text">Data Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Master-Node"><span class="nav-number">1.5.</span> <span class="nav-text">Master Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Master-Eligible-Nodes-amp-选主流程"><span class="nav-number">1.6.</span> <span class="nav-text">Master Eligible Nodes &amp; 选主流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群状态"><span class="nav-number">1.7.</span> <span class="nav-text">集群状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Master-Eligbile-Nodes-amp-选主的过程"><span class="nav-number">1.8.</span> <span class="nav-text">Master Eligbile Nodes &amp; 选主的过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#脑裂问题"><span class="nav-number">1.9.</span> <span class="nav-text">脑裂问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何避免脑裂问题"><span class="nav-number">1.10.</span> <span class="nav-text">如何避免脑裂问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么高可用是奇数节点？"><span class="nav-number">1.11.</span> <span class="nav-text">为什么高可用是奇数节点？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式共识算法"><span class="nav-number">1.12.</span> <span class="nav-text">分布式共识算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置节点类型"><span class="nav-number">1.13.</span> <span class="nav-text">配置节点类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分片与集群的故障转移"><span class="nav-number">2.</span> <span class="nav-text">分片与集群的故障转移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Primary-Shard-提升系统存储容量"><span class="nav-number">2.1.</span> <span class="nav-text">Primary Shard - 提升系统存储容量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Replica-Shard-提高数据可用性"><span class="nav-number">2.2.</span> <span class="nav-text">Replica Shard - 提高数据可用性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分片数的设置"><span class="nav-number">2.3.</span> <span class="nav-text">分片数的设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#单节点集群"><span class="nav-number">2.4.</span> <span class="nav-text">单节点集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#增加一个数据节点"><span class="nav-number">2.5.</span> <span class="nav-text">增加一个数据节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在增加一个节点"><span class="nav-number">2.6.</span> <span class="nav-text">在增加一个节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障转移"><span class="nav-number">2.7.</span> <span class="nav-text">故障转移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群健康状态"><span class="nav-number">2.8.</span> <span class="nav-text">集群健康状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档分布式存储"><span class="nav-number">3.</span> <span class="nav-text">文档分布式存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文档储存在分片上"><span class="nav-number">3.1.</span> <span class="nav-text">文档储存在分片上</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文档到分片的路由算法"><span class="nav-number">3.2.</span> <span class="nav-text">文档到分片的路由算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新文档"><span class="nav-number">3.3.</span> <span class="nav-text">更新文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除一个文档"><span class="nav-number">3.4.</span> <span class="nav-text">删除一个文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分片及其生命周期"><span class="nav-number">4.</span> <span class="nav-text">分片及其生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分片的内部原理"><span class="nav-number">4.1.</span> <span class="nav-text">分片的内部原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#倒排索引的不可变性"><span class="nav-number">4.2.</span> <span class="nav-text">倒排索引的不可变性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lucence-index"><span class="nav-number">4.3.</span> <span class="nav-text">Lucence index</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Refresh"><span class="nav-number">4.4.</span> <span class="nav-text">Refresh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transaction-Log"><span class="nav-number">4.5.</span> <span class="nav-text">Transaction Log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flush"><span class="nav-number">4.6.</span> <span class="nav-text">Flush</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Merge"><span class="nav-number">4.7.</span> <span class="nav-text">Merge</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#剖析分布式查询及相关性算法"><span class="nav-number">5.</span> <span class="nav-text">剖析分布式查询及相关性算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式搜索的运行机制"><span class="nav-number">5.1.</span> <span class="nav-text">分布式搜索的运行机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-阶段"><span class="nav-number">5.2.</span> <span class="nav-text">Query 阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fetch-阶段"><span class="nav-number">5.3.</span> <span class="nav-text">Fetch 阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-Then-Fetch-潜在的问题"><span class="nav-number">5.4.</span> <span class="nav-text">Query Then Fetch 潜在的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决算分不准的方法"><span class="nav-number">5.5.</span> <span class="nav-text">解决算分不准的方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关性算分问题-Demo"><span class="nav-number">5.6.</span> <span class="nav-text">相关性算分问题 Demo</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#排序及-Doc-Values-amp-Field-Data"><span class="nav-number">6.</span> <span class="nav-text">排序及 Doc Values &amp; Field Data</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#排序"><span class="nav-number">7.</span> <span class="nav-text">排序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多字段进行排序"><span class="nav-number">7.1.</span> <span class="nav-text">多字段进行排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对-Text-类型排序"><span class="nav-number">7.2.</span> <span class="nav-text">对 Text 类型排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#排序的过程"><span class="nav-number">7.3.</span> <span class="nav-text">排序的过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Doc-Values-vs-Field-Data"><span class="nav-number">7.4.</span> <span class="nav-text">Doc Values vs. Field Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打开-Fielddata"><span class="nav-number">7.5.</span> <span class="nav-text">打开 Fielddata</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭-Doc-Values"><span class="nav-number">7.6.</span> <span class="nav-text">关闭 Doc Values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取-Doc-Values-amp-Fielddata-中储存的内容"><span class="nav-number">7.7.</span> <span class="nav-text">获取 Doc Values &amp; Fielddata 中储存的内容</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分页与遍历-From-Size-Search-After-amp-Scorll-API"><span class="nav-number">8.</span> <span class="nav-text">分页与遍历 - From, Size, Search After &amp; Scorll API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#From-Size"><span class="nav-number">8.1.</span> <span class="nav-text">From &#x2F; Size</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式系统中深度分页的问题"><span class="nav-number">8.2.</span> <span class="nav-text">分布式系统中深度分页的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Search-After-避免深度分页的问题"><span class="nav-number">8.3.</span> <span class="nav-text">Search After 避免深度分页的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Search-After-是如何解决深度分页的问题"><span class="nav-number">8.4.</span> <span class="nav-text">Search After 是如何解决深度分页的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scoll-API"><span class="nav-number">8.5.</span> <span class="nav-text">Scoll API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不同的搜索类型和使用场景"><span class="nav-number">8.6.</span> <span class="nav-text">不同的搜索类型和使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理并发读写操作"><span class="nav-number">9.</span> <span class="nav-text">处理并发读写操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#并发控制的必要性"><span class="nav-number">9.1.</span> <span class="nav-text">并发控制的必要性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES-的乐观并发控制"><span class="nav-number">9.2.</span> <span class="nav-text">ES 的乐观并发控制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bucket-amp-Metric-聚合分析及嵌套聚合"><span class="nav-number">10.</span> <span class="nav-text">Bucket &amp; Metric 聚合分析及嵌套聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Bucket-amp-Metric-Aggregation"><span class="nav-number">10.1.</span> <span class="nav-text">Bucket &amp; Metric Aggregation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Aggregation-的语法"><span class="nav-number">10.2.</span> <span class="nav-text">Aggregation 的语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mertric-Aggregation"><span class="nav-number">10.3.</span> <span class="nav-text">Mertric Aggregation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Metric-聚合的具体-Demo"><span class="nav-number">10.4.</span> <span class="nav-text">Metric 聚合的具体 Demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bucket"><span class="nav-number">10.5.</span> <span class="nav-text">Bucket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Terms-Aggregation"><span class="nav-number">10.6.</span> <span class="nav-text">Terms Aggregation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cardinality"><span class="nav-number">10.7.</span> <span class="nav-text">Cardinality</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bucket-Size-amp-Top-Hists-Demo"><span class="nav-number">10.8.</span> <span class="nav-text">Bucket Size &amp; Top Hists Demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化-Terms-聚合的性能"><span class="nav-number">10.9.</span> <span class="nav-text">优化 Terms 聚合的性能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Range-amp-Histogram-聚合"><span class="nav-number">10.10.</span> <span class="nav-text">Range &amp; Histogram 聚合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bucket-Metric-Aggregation"><span class="nav-number">10.11.</span> <span class="nav-text">Bucket + Metric Aggregation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pipeline-聚合分析"><span class="nav-number">11.</span> <span class="nav-text">Pipeline 聚合分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一个例子：Pipeline：min-bucket"><span class="nav-number">11.1.</span> <span class="nav-text">一个例子：Pipeline：min_bucket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pipeline"><span class="nav-number">11.2.</span> <span class="nav-text">Pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sibling-Pipeline-的例子"><span class="nav-number">11.3.</span> <span class="nav-text">Sibling Pipeline 的例子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parent-Pipeline-Derivative"><span class="nav-number">11.4.</span> <span class="nav-text">Parent Pipeline: Derivative</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parent-Pipeline"><span class="nav-number">11.5.</span> <span class="nav-text">Parent Pipeline</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#聚合的作用范围及排序"><span class="nav-number">12.</span> <span class="nav-text">聚合的作用范围及排序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#聚合的作用范围"><span class="nav-number">12.1.</span> <span class="nav-text">聚合的作用范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Filter"><span class="nav-number">12.2.</span> <span class="nav-text">Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Post-Filter"><span class="nav-number">12.3.</span> <span class="nav-text">Post_Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Global"><span class="nav-number">12.4.</span> <span class="nav-text">Global</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#排序-1"><span class="nav-number">12.5.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于子聚合的值排序"><span class="nav-number">12.6.</span> <span class="nav-text">基于子聚合的值排序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#聚合分析的原理及精准度问题"><span class="nav-number">13.</span> <span class="nav-text">聚合分析的原理及精准度问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式系统的近似统计算法"><span class="nav-number">13.1.</span> <span class="nav-text">分布式系统的近似统计算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Min-聚合分析的执行流程"><span class="nav-number">13.2.</span> <span class="nav-text">Min 聚合分析的执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Terms-Aggregation-的返回值"><span class="nav-number">13.3.</span> <span class="nav-text">Terms Aggregation 的返回值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Terms-聚合分析的执行流程"><span class="nav-number">13.4.</span> <span class="nav-text">Terms 聚合分析的执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Terms-不正确的案例"><span class="nav-number">13.5.</span> <span class="nav-text">Terms 不正确的案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何解决-Terms-不准的问题：提升-shard-size-的参数"><span class="nav-number">13.6.</span> <span class="nav-text">如何解决 Terms 不准的问题：提升 shard_size 的参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打开-show-term-doc-count-error"><span class="nav-number">13.7.</span> <span class="nav-text">打开 show_term_doc_count_error</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shard-size-设定"><span class="nav-number">13.8.</span> <span class="nav-text">shard_size 设定</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对象及-Nested-对象"><span class="nav-number">14.</span> <span class="nav-text">对象及 Nested 对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据的关联关系"><span class="nav-number">14.1.</span> <span class="nav-text">数据的关联关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关系型数据库的范式化设计"><span class="nav-number">14.2.</span> <span class="nav-text">关系型数据库的范式化设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Denormalization"><span class="nav-number">14.3.</span> <span class="nav-text">Denormalization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在-Elasticsearch-中处理关联关系"><span class="nav-number">14.4.</span> <span class="nav-text">在 Elasticsearch 中处理关联关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例-1：博客和其作者信息"><span class="nav-number">14.5.</span> <span class="nav-text">案例 1：博客和其作者信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例-2：包含对象数组的文档"><span class="nav-number">14.6.</span> <span class="nav-text">案例 2：包含对象数组的文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为啥会搜到不需要的结果？"><span class="nav-number">14.7.</span> <span class="nav-text">为啥会搜到不需要的结果？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nested-Data-Type"><span class="nav-number">14.8.</span> <span class="nav-text">Nested Data Type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#嵌套查询"><span class="nav-number">14.9.</span> <span class="nav-text">嵌套查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#嵌套聚合"><span class="nav-number">14.10.</span> <span class="nav-text">嵌套聚合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档的父子关系"><span class="nav-number">15.</span> <span class="nav-text">文档的父子关系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Parent-Child"><span class="nav-number">15.1.</span> <span class="nav-text">Parent &#x2F; Child</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#父子关系"><span class="nav-number">15.2.</span> <span class="nav-text">父子关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置-Mapping"><span class="nav-number">15.3.</span> <span class="nav-text">设置 Mapping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引父文档"><span class="nav-number">15.4.</span> <span class="nav-text">索引父文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引子文档"><span class="nav-number">15.5.</span> <span class="nav-text">索引子文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parent-Child-所支持的查询"><span class="nav-number">15.6.</span> <span class="nav-text">Parent &#x2F; Child 所支持的查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-has-child-查询"><span class="nav-number">15.7.</span> <span class="nav-text">使用 has_child 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-has-parent-查询"><span class="nav-number">15.8.</span> <span class="nav-text">使用 has_parent 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-parent-id-查询"><span class="nav-number">15.9.</span> <span class="nav-text">使用 parent_id 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问子文档"><span class="nav-number">15.10.</span> <span class="nav-text">访问子文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新子文档"><span class="nav-number">15.11.</span> <span class="nav-text">更新子文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多子文档-和-多级父子文档"><span class="nav-number">15.12.</span> <span class="nav-text">多子文档 和 多级父子文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#父子关系的应用"><span class="nav-number">15.13.</span> <span class="nav-text">父子关系的应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#嵌套对象-v-s-父子文档"><span class="nav-number">15.14.</span> <span class="nav-text">嵌套对象 v.s 父子文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Update-By-Query-amp-Reindex-API"><span class="nav-number">16.</span> <span class="nav-text">Update By Query &amp; Reindex API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用场景"><span class="nav-number">17.</span> <span class="nav-text">使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#案例一：为索引增加子字段"><span class="nav-number">17.1.</span> <span class="nav-text">案例一：为索引增加子字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Update-By-Query"><span class="nav-number">17.2.</span> <span class="nav-text">Update By Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例二：更改已有字段类型的-Mappings"><span class="nav-number">17.3.</span> <span class="nav-text">案例二：更改已有字段类型的 Mappings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reindex-API"><span class="nav-number">17.4.</span> <span class="nav-text">Reindex API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#两个注意点"><span class="nav-number">17.5.</span> <span class="nav-text">两个注意点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OP-Type"><span class="nav-number">17.6.</span> <span class="nav-text">OP Type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨集群-ReIndex"><span class="nav-number">17.7.</span> <span class="nav-text">跨集群 ReIndex</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看-Task-API"><span class="nav-number">17.8.</span> <span class="nav-text">查看 Task API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回顾"><span class="nav-number">17.9.</span> <span class="nav-text">回顾</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ingest-Pipeline-与-Painless-Script"><span class="nav-number">18.</span> <span class="nav-text">Ingest Pipeline 与 Painless Script</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#需求：修复与增强写入的数据"><span class="nav-number">18.1.</span> <span class="nav-text">需求：修复与增强写入的数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ingest-Node"><span class="nav-number">18.2.</span> <span class="nav-text">Ingest Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pipeline-amp-Processor"><span class="nav-number">18.3.</span> <span class="nav-text">Pipeline &amp; Processor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Pipeline-切分字符串"><span class="nav-number">18.4.</span> <span class="nav-text">使用 Pipeline 切分字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为文档增加字段"><span class="nav-number">18.5.</span> <span class="nav-text">为文档增加字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pipeline-API"><span class="nav-number">18.6.</span> <span class="nav-text">Pipeline API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加-Pipeline-并测试"><span class="nav-number">18.7.</span> <span class="nav-text">添加 Pipeline 并测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Index-amp-Update-By-Query"><span class="nav-number">18.8.</span> <span class="nav-text">Index &amp; Update By Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些内置的-Processors"><span class="nav-number">18.9.</span> <span class="nav-text">一些内置的 Processors</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ingest-Node-v-s-Logstash"><span class="nav-number">18.10.</span> <span class="nav-text">Ingest Node v.s Logstash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Painless-简介"><span class="nav-number">18.11.</span> <span class="nav-text">Painless 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Painless-的用途"><span class="nav-number">18.12.</span> <span class="nav-text">Painless 的用途</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过-Painless-脚本访问字段"><span class="nav-number">18.13.</span> <span class="nav-text">通过 Painless 脚本访问字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例-1：Script-Processsor"><span class="nav-number">18.14.</span> <span class="nav-text">案例 1：Script Processsor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例-2：文档更新计数"><span class="nav-number">18.15.</span> <span class="nav-text">案例 2：文档更新计数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例-3：搜索时的-Script-字段"><span class="nav-number">18.16.</span> <span class="nav-text">案例 3：搜索时的 Script 字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Script-Inline-v-s-Stored"><span class="nav-number">18.17.</span> <span class="nav-text">Script: Inline v.s Stored</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#脚本缓存"><span class="nav-number">18.18.</span> <span class="nav-text">脚本缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-数据建模实例"><span class="nav-number">19.</span> <span class="nav-text">Elasticsearch 数据建模实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是数据建模"><span class="nav-number">19.1.</span> <span class="nav-text">什么是数据建模</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据建模：功能需求-性能需求"><span class="nav-number">19.2.</span> <span class="nav-text">数据建模：功能需求 + 性能需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何对字段进行建模"><span class="nav-number">19.3.</span> <span class="nav-text">如何对字段进行建模</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字段类型-：-Text-v-s-Keyword"><span class="nav-number">19.4.</span> <span class="nav-text">字段类型 ： Text v.s Keyword</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字段类型：结构化数据"><span class="nav-number">19.5.</span> <span class="nav-text">字段类型：结构化数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检索"><span class="nav-number">19.6.</span> <span class="nav-text">检索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#聚合及排序"><span class="nav-number">19.7.</span> <span class="nav-text">聚合及排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#额外的存储"><span class="nav-number">19.8.</span> <span class="nav-text">额外的存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一个数据建模的实例"><span class="nav-number">19.9.</span> <span class="nav-text">一个数据建模的实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化字段的设定"><span class="nav-number">19.10.</span> <span class="nav-text">优化字段的设定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#需求变更"><span class="nav-number">19.11.</span> <span class="nav-text">需求变更</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询图书：解决字段过大引发的性能问题"><span class="nav-number">19.12.</span> <span class="nav-text">查询图书：解决字段过大引发的性能问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mapping-字段的相关设置"><span class="nav-number">19.13.</span> <span class="nav-text">Mapping 字段的相关设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些相关的-API"><span class="nav-number">19.14.</span> <span class="nav-text">一些相关的 API</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-数据建模佳实践"><span class="nav-number">20.</span> <span class="nav-text">Elasticsearch 数据建模佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#建模建议（一）：如何处理关联关系"><span class="nav-number">20.1.</span> <span class="nav-text">建模建议（一）：如何处理关联关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kibana"><span class="nav-number">20.2.</span> <span class="nav-text">Kibana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建模建议（二）：避免过多字段"><span class="nav-number">20.3.</span> <span class="nav-text">建模建议（二）：避免过多字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-v-s-Strict"><span class="nav-number">20.4.</span> <span class="nav-text">Dynamic v.s Strict</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一个例子：-Cookie-Service-的数据"><span class="nav-number">20.5.</span> <span class="nav-text">一个例子： Cookie Service 的数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方案：Nested-Object-amp-Key-Value"><span class="nav-number">20.6.</span> <span class="nav-text">解决方案：Nested Object &amp; Key Value</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#写入-amp-查询"><span class="nav-number">20.7.</span> <span class="nav-text">写入 &amp; 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过-Nested-对象保存-Key-Value-的一些不足"><span class="nav-number">20.8.</span> <span class="nav-text">通过 Nested 对象保存 Key &#x2F; Value 的一些不足</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建模建议（三）：避免正则查询"><span class="nav-number">20.9.</span> <span class="nav-text">建模建议（三）：避免正则查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方案：将字符串转换为对象"><span class="nav-number">20.10.</span> <span class="nav-text">解决方案：将字符串转换为对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#搜索过滤"><span class="nav-number">20.11.</span> <span class="nav-text">搜索过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建模建议（四）：避免空置引起的聚合不准"><span class="nav-number">20.12.</span> <span class="nav-text">建模建议（四）：避免空置引起的聚合不准</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Null-Value-解决空值的问题"><span class="nav-number">20.13.</span> <span class="nav-text">使用 Null_Value 解决空值的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建模建议（五）：为索引的-Mapping-加入-Meta-的信息"><span class="nav-number">20.14.</span> <span class="nav-text">建模建议（五）：为索引的 Mapping 加入 Meta 的信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">21.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Richard"
      src="https://avatars3.githubusercontent.com/u/18113256?v=3&s=460">
  <p class="site-author-name" itemprop="name">Richard</p>
  <div class="site-description" itemprop="description">惶者生存，偏执者成功</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">132</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xinlc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/xinlc" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;xinlc" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://learnxinyminutes.com/" title="https:&#x2F;&#x2F;learnxinyminutes.com" rel="noopener" target="_blank">Learn X in Y minutes</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://justjavac.com/" title="http:&#x2F;&#x2F;justjavac.com" rel="noopener" target="_blank">justjavac</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.ruanyifeng.com/blog/" title="http:&#x2F;&#x2F;www.ruanyifeng.com&#x2F;blog&#x2F;" rel="noopener" target="_blank">阮一峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.liaoxuefeng.com/" title="https:&#x2F;&#x2F;www.liaoxuefeng.com" rel="noopener" target="_blank">廖雪峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tech.meituan.com/" title="https:&#x2F;&#x2F;tech.meituan.com" rel="noopener" target="_blank">美团技术</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.v2ex.com/" title="https:&#x2F;&#x2F;www.v2ex.com" rel="noopener" target="_blank">V2EX</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://caniuse.com/" title="https:&#x2F;&#x2F;caniuse.com" rel="noopener" target="_blank">caniuse/工具</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.css88.com/nav/" title="http:&#x2F;&#x2F;www.css88.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">css88/doc</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://overapi.com/" title="http:&#x2F;&#x2F;overapi.com&#x2F;" rel="noopener" target="_blank">OverAPI/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://devdocs.io/" title="http:&#x2F;&#x2F;devdocs.io&#x2F;" rel="noopener" target="_blank">DevDocs/api</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.oschina.net/" title="http:&#x2F;&#x2F;tool.oschina.net&#x2F;" rel="noopener" target="_blank">在线工具/索引</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://tool.lu/" title="http:&#x2F;&#x2F;tool.lu&#x2F;" rel="noopener" target="_blank">ToolBox</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://hao.shejidaren.com/" title="http:&#x2F;&#x2F;hao.shejidaren.com&#x2F;" rel="noopener" target="_blank">设计导航</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richard</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
